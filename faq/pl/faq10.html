<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><title>10 - Zarz±dzanie systemem</title>

<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-2">
<meta http-equiv="Content-Language" content="pl">
<meta name="resource-type" content="document">
<meta name="description" content="the OpenBSD FAQ page">
<meta name="keywords" content="openbsd,faq">
<meta name="distribution" content="global">
<meta name="copyright" content="This document copyright 1998-2007 by OpenBSD."></head>

<body bgcolor= "#ffffff" text= "#000000">

<a href="../../pl/index.html">
<img alt="[OpenBSD]" height="30" width="141" src="../../images/smalltitle.gif" border="0">    
</a>

<p>
<font color= "#0000e0">
<a href="index.html">[Spis tre¶ci]</a>
<a href="faq9.html">[Sekcja 9 - Migracja do OpenBSD]</a>
<a href="faq11.html">[Sekcja 11 - X Window System]</a>
</font>

<h1><font color="#e00000">10 - Zarz±dzanie systemem</font></h1>


<!--
UNCOMMENT ONLY WHEN THE FILE IS OUT OF SYNC

<hr>
<p>
<b><font color="#e00000">Uwaga:</font></b>Zawarto¶æ tego pliku
jest ju¿ bardzo nieaktualna w stosunku do
<a href="../faq10.html">bie¿±cej wersji anglojêzycznej</a>.

<p>
Je¶li chcesz pomóc w aktualizacji tego pliku, zajrzyj na
<a href="../../translation.html">stronê t³umaczeñ</a>.

-->

<hr>

<p>
<h3>Spis tre¶ci</h3>
<ul>
<li><a href="#wheel">10.1 - Dlaczego system odpowiada, ¿e nie
	nale¿ê do odpowiedniej grupy, kiedy próbujê wydaæ polecenie su?</a>
<li><a href="#DupFS">10.2 - Jak zrobiæ kopiê systemu plików?</a>
<li><a href="#rc">10.3 - W jaki sposób automatycznie
	uruchamiaæ demony przy starcie systemu? (Prezentacja rc(8))</a>
<li><a href="#RelayingDenied">10.4 - Dlaczego u¿ytkownicy otrzymuj± 
	komunikat "relaying access denied" gdy próbuj± wys³aæ zdalnie
	pocztê przez moj± maszynê dzia³aj±c± na OpenBSD?</a>
<li><a href="#POP">10.5 - Uruchomi³em serwer POP, ale u¿ytkownicy
	maj± k³opoty z odbiorem maili poprzez ten protokó³. Co mam zrobiæ?</a>
<li><a href="#SendmailDNS">10.6 - Dlaczego Sendmail ignoruje
	plik /etc/hosts?</a>
<li><a href="#HTTPS">10.7 - Konfigurowanie bezpiecznego serwera HTTP
	z wykorzystaniem ssl(8)</a>
<li><a href="#vipw">10.8 - Dokona³em zmian w /etc/passwd, ale
	nie zosta³y one uwzglêdnione. Dlaczego?</a>
<li><a href="#AddDelUser">10.9 - Jaki jest najlepszy sposób na
	dodanie/usuniêcie u¿ytkownika?</a>
<li><a href="#FTPOnly">10.10 - Jak stworzyæ konto umo¿liwiaj±ce 
	logowanie tylko przez FTP?</a>
<li><a href="#Quotas">10.11 - Konfigurowanie kwot dyskowych</a>
<li><a href="#Kerberos">10.12 - Konfigurowanie klientów i serwerów
	KerberosV</a>
<li><a href="#AnonFTP">10.13 - Konfigurowanie anonimowego serwera FTP</a>
<li><a href="#ftpchroot">10.14 - Ograniczanie dostêpu u¿ytkowników
	wy³±cznie do ich katalogów domowych w ftpd(8)</a>
<li><a href="#Patches">10.15 - £atanie systemu OpenBSD</a>
<li><a href="#httpdchroot">10.16 - Zastosowanie ¶rodowiska chroot(2) 
	dla serwera Apache.</a>
<li><a href="#rootshell">10.17 - Mogê zmieniæ pow³okê roota?</a>
<li><a href="#ksh">10.18 - Co jeszcze mo¿na zrobiæ z ksh?</a>
</ul>

<hr>

<p>
<a name= "wheel"></a>
<h2>10.1 - Dlaczego system odpowiada, ¿e nie nale¿ê do odpowiedniej grupy, 
kiedy próbujê wydaæ polecenie su?</h2>

<p>
U¿ytkownicy posiadaj±cy ju¿ konto w systemie musz± zostaæ dopisani do
grupy <kbd>&quot;wheel&quot;</kbd> rêcznie. Robi siê tak dla zwiêkszenia
bezpieczeñstwa, i nale¿y zachowaæ ostro¿no¶æ z tym komu daje siê taki
dostêp. W systemie OpenBSD tylko u¿ytkownicy nale¿±cy do grupy 
<kbd>wheel</kbd> maj± prawo u¿ywaæ polecenia 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=su&amp;sektion=1">su(1)</a> 
w celu uzyskania praw roota. U¿ytkownicy, którzy nie nale¿± do grupy 
<kbd>"wheel"</kbd>, nie mog± korzystaæ z polecenia su(1). Istniej±cego 
u¿ytkownika mo¿na dodaæ do grupy wheel odpowiednio redaguj±c plik 
<kbd>/etc/group</kbd>. Zamieszczony poni¿ej wpis z tego pliku 
uwzglêdnia u¿ytkownika <b>ericj</b> (oraz roota) jako cz³onka 
grupy <kbd>&quot;wheel&quot;</kbd>.

<p>
Dodaj±c nowego u¿ytkownika za pomoc± polecenia 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=adduser&amp;sektion=8">
adduser(8)</a>, mo¿na od razu dodaæ go do grupy wheel po prostu 
wpisuj±c "wheel" w odpowiedzi na pytanie "<tt>Invite <i>user</i> into 
other groups:</tt>". W ten sposób u¿ytkownik zostanie automatycznie
dodany do grupy "wheel" w pliku /etc/group:

<blockquote><pre>wheel:*:0:root,ericj
</pre></blockquote>

<p>
Czêsto chcemy zwiêkszyæ uprawnienia danego u¿ytkownika, ale w sposób 
kontrolowany, nie umieszczaj±c go w grupie <kbd>&quot;wheel&quot;</kbd>. 
Dok³adnie w tym celu zosta³ stworzony program 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sudo&amp;sektion=8">sudo(8)</a>.

<p>
<a name= "DupFS"></a>
<h2>10.2 - Jak zrobiæ kopiê systemu plików?</h2>

<p>
W celu skopiowania systemu plików mo¿na skorzystaæ z programów 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=dump&amp;sektion=8">dump(8)</a> i 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=restore&amp;sektion=8">restore(8)</a>.
Na przyk³ad, aby skopiowaæ zawarto¶æ katalogu <kbd>SRC</kbd> do katalogu
<kbd>DST</kbd> wystarczy wydaæ nastêpuj±ce polecenie:

<blockquote><pre>
# <b>cd /SRC; dump 0f - . | (cd /DST; restore -rf - )</b>
</pre></blockquote>

<p>
Dump zosta³ zaprojektowany tak, aby spe³niaæ ró¿norodne wymagania 
dotycz±ce wykonywania kopii zapasowych i mo¿e byæ zbyt skomplikowanym 
narzêdziem, je¿eli chcemy skopiowaæ tylko czê¶æ (albo nawet ca³o¶æ) 
systemu plików. Dla prostszych zastosowañ szybszy mo¿e okazaæ siê program 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tar&amp;sektion=1">tar(1)</a>. 
Sk³adnia tego polecenia jest bardzo podobna jak w poprzednim przyk³adzie:

<blockquote><pre>
# <b>cd /SRC; tar cf -  . | (cd /DST; tar xpf - )</b>
</pre></blockquote>

<p>
<a name= "rc"></a>
<h2>10.3 - W jaki sposób automatycznie uruchamiaæ demony przy
starcie systemu? (Prezentacja rc(8))</h2>

<p>
OpenBSD uruchamia demony podczas startu sytemu poprzez 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=rc&amp;sektion=8">rc(8)</a>.
Korzysta on przy tym z kilku pomocniczych skryptów i plików
konfiguracyjnych:

<ul>
 <li>/etc/rc - Skrypt g³ówny. Nie powinien byæ modyfikowany.
 <li>/etc/rc.conf - Plik konfiguracyjny u¿ywany przez <i>/etc/rc</i> w 
celu zdefiniowania demonów uruchamianych przy starcie systemu.
 <li>/etc/rc.conf.local - Plik konfiguracyjny, który mo¿e 
byæ wykorzystany w celu zmiany ustawieñ zapisanych w /etc/rc.conf. 
Dziêki temu nie ma potrzeby redagowaæ /etc/rc.conf. Jest to 
szczególnie wygodne gdy aktualizujesz system.
 <li>/etc/netstart - Skrypt u¿ywany do inicjalizowana obs³ugi 
sieci. Nie powinien byæ modyfikowany.
 <li>/etc/rc.local - Skrypt u¿ywany do celów administracji lokalnej.
To tu nale¿y przechowywaæ informacje o nowych demonach i hostach.
 <li>/etc/rc.securelevel - Skrypt wykonuj±cy niezbêdne czynno¶ci przed 
zmian± poziomu bezpieczeñstwa systemu. Przeczytaj 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=init&amp;sektion=8">init(8)</a>
 <li>/etc/rc.shutdown - Skrypt uruchamiany przed zatrzymaniem pracy 
systemu. Wstawia siê tam to, co powinno byæ zrobione przed zamkniêciem 
systemu. Przeczytaj 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=rc.shutdown&amp;sektion=8">rc.shutdown(8)</a>
</ul>

<h3>Jak dzia³a rc(8)?</h3>

<p>
Najwa¿niejszymi plikami, na których powinien skupiæ siê administrator 
systemu s± <i>/etc/rc.conf</i> (albo <i>/etc/rc.conf.local</i>), 
<i>/etc/rc.local</i> oraz <i>/etc/rc.shutdown</i>. Na pocz±tku 
opiszmy jednak poszczególne czynno¶ci wykonywane przez skrypt rc(8):

<p>
Po za³adowaniu j±dra systemu, rozpoczyna pracê <i>/etc/rc</i>:
<ul>
 <li>Dokonywane jest sprawdzenie systemów plików. 
 <li>Z pliku <i>/etc/rc.conf</i>, a potem <i>/etc/rc.conf.local</i> 
odczytywane s± zmienne konfiguracyjne. Ustawienia z pliku rc.conf.local 
nadpisuj± konfiguracjê zapisan± w pliku rc.conf.
 <li>Nastêpuje podmontowanie systemów plików.
 <li>Dokonywane jest wyczyszczenie katalogu <i>/tmp</i> oraz zachowanie 
plików tekstowych redagowanych przed ponownym uruchomieniem systemu.
 <li>Nastêpuje konfiguracja sieci za pomoc± skryptu <i>/etc/netstart</i>
 <ul>
  <li>Konfiguracja interfejsów.
  <li>Ustawienie nazwy hosta, nazwy domeny, itp.
 </ul>
 <li>Uruchomienie demonów systemowych.
 <li>Dokonanie ró¿nego rodzaju sprawdzeñ i dzia³añ (kwoty, savecore, 
itd.)
 <li>Uruchomienie lokalnych demonów z <i>/etc/rc.local</i>
</ul>

<h3>Uruchamianie demonów i us³ug systemowych</h3>

<p>
Wiêkszo¶æ dostarczonych z systemem OpenBSD demonów i us³ug
mo¿na uruchomiæ podczas startu systemu przez prost± modyfikacjê 
pliku konfiguracyjnego <i>/etc/rc.conf</i>. Na pocz±tek przyjrzyjmy siê 
domy¶lnej zawarto¶ci pliku
<a href="http://www.openbsd.org/cgi-bin/cvsweb/~checkout~/src/etc/rc.conf?content-type=text/plain">/etc/rc.conf</a>. 
Znajduj± siê tam linie podobne do tej:

<blockquote><pre>
ftpd_flags=NO           # for non-inetd use: ftpd_flags="-D"
</pre></blockquote>

<p>
Zamieszczony powy¿ej wpis oznacza, ze ftpd nie powinien byæ 
uruchamiany przy starcie systemu (a przynajmniej nie przez rc(8), 
przeczytaj dzia³ <a href="faq10.html#AnonFTP">Konfigurowanie anonimowego 
serwera FTP</a>, by dowiedzieæ siê wiêcej na ten temat). Tak czy
inaczej, ka¿dy wpis zawiera tak¿e komentarz opisuj±cy flagi (opcje) 
<b>NORMALNEJ</b> pracy demona lub us³ugi. Nie oznacza to, ¿e trzeba 
uruchamiaæ tego czy innego demona czy us³ugê z dok³adnie tymi samymi 
ustawieniami. Zawsze mo¿na skorzystaæ z podrêcznika systemowego, aby 
sprawdziæ, jakiej opcji u¿yæ w celu osi±gniêcia zamierzonego efektu.
Na przyk³ad, poni¿sza linia pokazuje domy¶lne ustawienie demona httpd(8).

<blockquote><pre>
httpd_flags=NO          # for normal use: "" (or "-DSSL" after reading ssl(8))
</pre></blockquote>

<p>
Jak widaæ, w tym przypadku httpd mo¿e byæ uruchomiony bez 
jakichkolwiek opcji. A zatem potrzebny by³by tylko taki wpis: 
<b>httpd_flags=""</b>. W przypadku, gdy chcieliby¶my uruchomiæ 
httpd z obs³ug± ssl (patrz 
<a href="#HTTPS">SSL FAQ</a> lub 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ssl&amp;sektion=8">ssl(8)</a>) 
nale¿a³o by napisaæ: httpd_flags="-DSSL".

<p>
Dobrym zwyczajem jest w ogóle nie zmieniaæ 
<i>/etc/rc.conf</i>. Zamiast tego mo¿na utworzyæ plik 
<i>/etc/rc.conf.local</i> i skopiowaæ do niego te linie, które mamy 
zamiar zmieniæ w <i>/etc/rc.conf</i>, a potem dostosowaæ je do w³asnych 
potrzeb. Znacznie u³atwia to proces aktualizacji -- 
wszystkie zmiany s± zapisane bowiem w tym jednym pliku.

<h3>Uruchamianie i konfiguracja lokalnych demonów</h3>

<p>
W przypadku demonów lokalnych, czyli doinstalowanych z portów, pakietów 
czy w dowolny inny sposób, nale¿y korzystaæ z pliku <i>/etc/rc.local</i>. 
Na przyk³ad, je¿eli zainstalowali¶my demona, który znajduje siê w 
/usr/local/sbin/daemonx i chcemy, aby uruchamia³ siê on przy starcie 
systemu, to do pliku <i>/etc/rc.local</i> powinni¶my dodaæ nastêpuj±cy 
wpis:

<blockquote><pre>
if [ -x /usr/local/sbin/daemonx ]; then
	echo -n ' daemonx';       /usr/local/sbin/daemonx
fi
</pre></blockquote>

<p>
(Je¿eli demon nie przechodzi automatycznie do pracy w tle, nale¿y dodaæ
znak "&amp;" po "/usr/local/sbin/daemonx".)

<p>
Od tej pory demon bêdzie uruchamiany zawsze podczas startu systemu. W 
trakcie tej operacji mo¿na zobaczyæ komunikaty o b³êdach (je¿eli siê
takowe pojawi±). Natomiast komunikat bezb³êdnego uruchomienia demona 
bêdzie wygl±da³ mniej wiêcej tak:

<blockquote><pre>
Starting local daemons: daemonx.
</pre></blockquote>

<h3>rc.shutdown</h3>

<p>
<i>/etc/rc.shutdown</i> to skrypt, który jest uruchamiany przed
zatrzymaniem pracy systemu. Wszystkie polecenia, które maj± byæ wykonane przed
zamkniêciem OpenBSD powinny byæ zawarte w tym pliku. Je¿eli wykorzystywane
jest zarz±dzanie energi± (apm), mo¿na tak¿e ustawiæ &quot;powerdown=YES&quot;,
co jest odpowiednikiem komendy &quot;shutdown -p&quot;.

<p>
<a name= "RelayingDenied"></a>
<h2>10.4 - Dlaczego u¿ytkownicy otrzymuj± komunikat "relaying access
denied" gdy próbuj± wys³aæ zdalnie pocztê przez moj± maszynê
dzia³aj±c± na OpenBSD?</h2>

<p>
Proszê spróbowaæ tego:

<blockquote><pre>
# <b>grep relay-domains /etc/mail/sendmail.cf</b>
</pre></blockquote>

<p>
Wynik mo¿e wygl±daæ tak:

<blockquote><pre>
FR-o /etc/mail/relay-domains
</pre></blockquote>

<p>
Je¿eli ten plik nie istnieje, nale¿y go utworzyæ i wpisaæ do niego nazwy 
hostów, którym zezwala siê na przesy³anie poczty przez swój serwer 
stosuj±c nastêpuj±c± sk³adniê:

<blockquote><pre>
.domain.com    #Zezwalaj na przekazywanie poczty z/do ka¿dego hosta w domain.com
sub.domain.com #Zezwalaj na przekazywanie poczty z/do domeny sub.domain.com oraz z ka¿dego hosta w tej domenie 
10.2           #Zezwalaj na przekazywanie poczty ze wszystkich hostów o adresach IP 10.2.*.*
</pre></blockquote>

<p>
Na koniec nale¿y wys³aæ procesowi sendmail sygna³ 'HangUP' (jest 
to sygna³, który zmusza wiêkszo¶æ demonów do ponownego odczytania 
swoich plików konfiguracyjnych):

<blockquote><pre>
# <b>kill -HUP `head -1 /var/run/sendmail.pid`</b>
</pre></blockquote>

<p>

<h3>Dalsze informacje</h3>

<p>
<ul>
<li><a href="http://www.sendmail.org/~ca/email/relayingdenied.html">http://www.sendmail.org/~ca/email/relayingdenied.html</a>
<li><a href="http://www.sendmail.org/tips/relaying.php">http://www.sendmail.org/tips/relaying.php</a>
<li><a href="http://www.sendmail.org/antispam/">http://www.sendmail.org/antispam/</a>
</ul>

<p>
<a name= "POP"></a>
<h2>10.5 - Uruchomi³em serwer POP, ale u¿ytkownicy maj± k³opoty z
odbiorem maili poprzez ten protokó³. Co mam zrobiæ?</h2>

<p>
Wiêkszo¶æ problemów zwi±zanych z protoko³em POP ma swoje ¼ród³a w 
plikach tymczasowych oraz plikach blokady. Je¿eli serwer POP wysy³a 
komunikat o b³êdzie podobny do tego:

<blockquote><pre>
-ERR Couldn't open temporary file, do you own it?
</pre></blockquote>

<p>
to spróbujmy ustawiæ prawa do plików w nastêpuj±cy sposób:

<blockquote><pre>
prawa w  /var
drwxrwxr-x   2 bin     mail     512 May 26 20:08 mail


prawa w  /var/mail
-rw-------   1 username   username        0 May 26 20:08 username
</pre></blockquote>

<p>
Nale¿y upewniæ siê, ¿e dany u¿ytkownik jest w³a¶cicielem 
swojego pliku poczty w katalogu /var/mail (tzn. /var/mail/joe powinien 
nale¿eæ do joe itd.). Teoretycznie nie ma powodu, dla którego mia³o by 
byæ inaczej, ale je¿eli jest, to tu mo¿e tkwiæ problem!

<p>
Oczywi¶cie, przyznanie praw do pisania do /var/mail grupie mail
mo¿e byæ przyczyn± wielu tajemniczych, nie do koñca znanych problemów 
zwi±zanych z
bezpieczeñstwem. Istnieje du¿e prawdopodobieñstwo, ¿e nigdy nie bêdzie
z tym k³opotów, je¶li jednak serwer stanowi znacz±cy punkt na mapie 
Internetu (np. nale¿y do ISP) mog± siê takowe pojawiæ! W kolekcji
portów mo¿na znale¼æ kilka ró¿nych serwerów POP, zalecane jest jednak 
u¿ywanie 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=popa3d&amp;sektion=8">popa3d</a>, 
który jest dostêpny ju¿ w podstawowej instalacji OpenBSD.
Mo¿e siê te¿ zdarzyæ, ¿e zostan± okre¶lone nieodpowiednie opcje 
konfiguracji
serwera POP (np. blokada plików z kropk±). Byæ mo¿e wystarczy jedynie
zmieniæ katalog, który jest blokowany przez serwer (chocia¿ wtedy
blokowanie mia³oby sens tylko dla demona POP).

<p>
<b>Uwaga:</b> Proszê zwróciæ uwagê, ¿e OpenBSD nie tworzy automatycznie
grupy &quot;mail&quot;. Je¿eli zajdzie taka potrzeba,
nale¿y utworzyæ j± w³asnorêcznie dodaj±c do pliku <i>/etc/group</i>. Wpis w
stylu:

<blockquote><pre>
mail:*:6:
</pre></blockquote>

<p>
powinien wystarczyæ.

<a name="SendmailDNS"></a>
<h2>10.6 - Dlaczego Sendmail ignoruje plik <tt>/etc/hosts</tt>?</h2>

<p>
Domy¶lnie Sendmail korzysta z DNS w celu uzyskania informacji o adresach, 
ignoruj±c plik <tt>/etc/hosts</tt>. Zachowanie 
to mo¿na zmieniæ korzystaj±c z pliku <tt>/etc/mail/service.switch</tt>. 

<p>
Je¿eli chcemy aby Sendmail przed wys³aniem zapytania do DNS odczytywa³
plik /etc/hosts, nale¿y utworzyæ plik
<tt>/etc/mail/service.switch</tt>, zawieraj±cy nastêpuj±cy wpis:

<blockquote><pre>
     hosts       files dns
</pre></blockquote>

<p>
Je¿eli za¶ chcemy, by Sendmail odczytywa³ TYLKO plik
/etc/hosts, u¿yjemy nastêpuj±cego wpisu:

<blockquote><pre>
     hosts       files
</pre></blockquote>

<p>
Wysy³amy teraz procesowi Sendmail sygna³ HUP:

<blockquote><pre>     
    # <b>kill -HUP `head -1 /var/run/sendmail.pid`</b>
</pre></blockquote>

<p>
aby zmiany, które wykonali¶my, zosta³y uwzglêdnione.


<p>
<a name= "HTTPS"></a>
<h2>10.7 - Konfigurowanie bezpiecznego serwera HTTP z wykorzystaniem 
SSL(8)</h2>

<p>
OpenBSD jest dostarczany z gotowym do u¿ytku serwerem httpd wyposa¿onym 
w obs³ugê SSL oraz biblioteki RSA. Aby móc korzystaæ z SSL w <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=httpd&amp;sektion=8">
httpd(8)</a>, nale¿y najpierw utworzyæ certyfikat. Bêdzie on 
przechowywany w <i>/etc/ssl/</i>, a odpowiadaj±cy mu klucz w 
<i>/etc/ssl/private/</i>. Opisane poni¿ej kroki zosta³y czê¶ciowo 
zaczerpniête ze strony podrêcznika systemowego <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ssl&amp;sektion=8">
ssl(8)</a>. Tam te¿ znajduj± siê dalsze informacje. Ta sekcja FAQ 
jedynie zarysowuje sposób tworzenia certyfikatów RSA dla serwerów WWW, 
pomija za¶ certyfikaty DSA. Aby dowiedzieæ siê wiêcej na ten temat, 
przeczytaj stronê podrêcznika <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ssl&amp;sektion=8">
ssl(8)</a>.

<p>
Na pocz±tku nale¿y utworzyæ klucz oraz certyfikat serwera korzystaj±c 
z OpenSSL:

<blockquote><pre>
# <b>openssl genrsa -out /etc/ssl/private/server.key 1024</b>
</pre></blockquote>

<p>Je¿eli klucz ma zostaæ zaszyfrowany has³em, które trzeba bêdzie
wpisaæ przy uruchamianiu serwerów, zamiast poprzedniego polecenia 
u¿ywamy tego:

<blockquote><pre>
# <b>openssl genrsa -des3 -out /etc/ssl/private/server.key 1024</b>
</pre></blockquote>


<p>
Kolejnym krokiem jest wygenerowanie pro¶by o podpis certyfikatu
(ang. Certificate Signing Request), która 
jest wykorzystywana przez Instytucjê Uwierzytelniaj±c± (ang. Certifying 
Authority) do podpisania certyfikatu. Robi siê to za pomoc± polecenia:

<blockquote><pre>
# <b>openssl req -new -key /etc/ssl/private/server.key -out /etc/ssl/private/server.csr</b>
</pre></blockquote>

<p>Plik <i>server.csr</i> mo¿e zostaæ nastêpnie przekazany Instytucji
Uwierzytelniaj±cej, która podpisze klucz. Jedn± z takich instytucji jest 
<b>Thawte Certification</b>, której strona znajduje siê pod adresem 
<a href="http://www.thawte.com/">http://www.thawte.com/</a>.

<p>Je¿eli nie staæ Ciê na certyfikat Thawte, albo chcesz sam podpisaæ 
swój certyfikat, mo¿esz to zrobiæ w nastêpuj±cy sposób:

<blockquote><pre>
# <b>openssl x509 -req -days 365 -in /etc/ssl/private/server.csr \
       -signkey /etc/ssl/private/server.key -out /etc/ssl/server.crt</b>
</pre></blockquote>

<p>
Po wygenerowaniu plików <i>/etc/ssl/server.crt</i> oraz 
<i>/etc/ssl/private/server.key</i>, bez przeszkód bêdzie mo¿na 
uruchomiæ <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=httpd&amp;sektion=8">
httpd(8)</a> z opcja <b>-DSSL</b> (patrz <a href="#rc">sekcja nt. 
rc(8)</a> w tym FAQ), co zezwala na przeprowadzanie transakcji na 
porcie 443.

<p>
<a name= "vipw"></a>
<h2>10.8 - Dokona³em zmian w /etc/passwd, ale nie zosta³y one 
uwzglêdnione. Dlaczego?</h2>

<p>
Bezpo¶rednie modyfikacje pliku <i>/etc/passwd</i> zostan± zignorowane.
OpenBSD generuje <i>/etc/passwd</i> dynamicznie za pomoc± 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pwd_mkdb&amp;sektion=8">pwd_mkdb(8)</a>. 
G³ównym plikiem hase³ w systemie OpenBSD jest <i>/etc/master.passwd</i>.
Cytuj±c za pwd_mkdb(8):

<blockquote><pre>PLIKI
     /etc/master.passwd  obecnie obowi±zuj±cy plik hase³
     /etc/passwd         plik hase³ w formacie 6-tej Edycji
     /etc/pwd.db         niezabezpieczony plik bazy hase³
     /etc/pwd.db.tmp     plik tymczasowy
     /etc/spwd.db        zabezpieczony plik bazy hase³
     /etc/spwd.db.tmp    plik tymczasowy
</pre></blockquote>

<p>
W tradycyjnym pliku hase³ w systemach Unix, takim jak /etc/passwd, ca³a 
jego zawarto¶æ, w³±czaj±c w to zaszyfrowane has³o u¿ytkownika, jest 
dostêpna dla ka¿dego, kto posiada konto w systemie (plik ten jest 
g³ównym celem ataków programów takich jak Crack). 4.4BSD wprowadzi³ plik 
master.passwd, który posiada rozszerzony format (z dodatkowymi opcjami 
w stosunku do /etc/passwd) i tylko root posiada 
prawo do odczytu tego pliku. W celu przyspieszenia dostêpu do danych, 
wywo³ania biblioteczne zazwyczaj odczytuj± pliki /etc/pwd.db i 
/etc/spwd.db (zamiast /etc/master.passwd).

<p>OpenBSD posiada narzêdzie, które s³u¿y do modyfikacji pliku 
hase³. Nazywa siê ono vipw(8). Do modyfikacji /etc/master.passwd 
vipw korzysta z vi (albo Twojego ulubionego edytora zdefiniowanego za 
pomoc± zmiennej ¶rodowiskowej $EDITOR). Po dokonaniu zmian vipw 
utworzy na nowo /etc/passwd, 
/etc/pwd.db oraz /etc/spwd.db tak, aby uwzglêdnia³y one wprowadzone 
zmiany. vipw zak³ada tak¿e blokady na te pliki tak, by dwie osoby nie 
modyfikowa³y ich naraz.


<p>
<a name= "AddDelUser"></a>
<h2>10.9 - Jaki jest najlepszy sposób na dodanie/usuniêcie 
u¿ytkownika?</h2>

<p>OpenBSD posiada dwa polecenia pozwalaj±ce w ³atwy sposób dodaæ 
u¿ytkownika do systemu:

<ul>
<li><a href="#adduser">adduser(8)</a>
<li><a href="#user">user(8)</a>
</ul>

Mo¿na tak¿e dodawaæ u¿ytkowników rêcznie za pomoc± 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vipw&amp;sektion=8">vipw(8)</a>,
ale zwykle jest to bardziej skomplikowane.

<a name="adduser"></a><p>Najprostszym sposobem na dodanie u¿ytkownika w 
OpenBSD jest u¿ycie skryptu 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=adduser&amp;sektion=8">adduser(8)</a>. 
Mo¿na go skonfigurowaæ redaguj±c plik <i>/etc/adduser.conf</i>. 
adduser(8) sprawdza spójno¶æ plików <i>/etc/passwd</i>, <i>/etc/group</i> 
oraz baz danych pow³oki. Tworzy tak¿e niezbêdne wpisy oraz katalog $HOME. 
Potrafi nawet wys³aæ u¿ytkownikowi wiadomo¶æ powitaln±. Oto przyk³ad dodania 
u¿ytkownika <b>testuser</b> do systemu. Jego katalog $HOME (domowy) 
bêdzie umieszczony w <i>/home/testuser</i>. Przydzielimy go do grupy 
<b>guest</b>, oraz ustawimy domy¶ln± pow³okê na <i>/bin/ksh</i>.

<blockquote><pre>
# <b>adduser</b>
Use option ``-silent'' if you don't want to see all warnings and questions.

Reading /etc/shells
Reading /etc/login.conf
Check /etc/master.passwd
Check /etc/group

Ok, let's go.
Don't worry about mistakes. I will give you the chance later to correct any input.

Enter username []: <b>testuser</b>
Enter full name []: <b>Test FAQ User</b>
Enter shell csh ksh nologin sh [sh]: <b>ksh</b>
Uid [1002]: <b><i>Enter</i></b>
Login group testuser [testuser]: <b>guest</b>
Login group is `guest''. Invite testuser into other groups: guest no 
[no]: <b>no</b>
Login class auth-defaults auth-ftp-defaults daemon default staff 
[default]: <b><i>Enter</i></b>
Enter password []: <b><i>Type password, then Enter</i></b>
Enter password again []: <b><i>Type password, then Enter</i></b>

Name:        testuser
Password:    ****
Fullname:    Test FAQ User
Uid:         1002
Gid:         31 (guest)
Groups:      guest
Login Class: default
HOME:        /home/testuser
Shell:       /bin/ksh
OK? (y/n) [y]: <b>y</b>
Added user ``testuser''
Copy files from /etc/skel to /home/testuser
Add another user? (y/n) [y]: <b>n</b>

Goodbye!
</pre></blockquote>


<p>
Do skasowania u¿ytkownika z systemu s³u¿y polecenie 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=rmuser&amp;sektion=8">rmuser(8)</a>. 
Usunie ono wszelkie ¶lady bytno¶ci u¿ytkownika w systemie -  wszystkie jego wpisy w 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=crontab&amp;sektion=1">crontab(1)</a>, 
katalog domowy (je¶li jego w³a¶cicielem jest 
u¿ytkownik), jego pocztê. Oczywi¶cie, równie¿ wpisy w <i>/etc/passwd</i> 
oraz <i>/etc/group</i> zostan± usuniête. Oto przyk³ad usuniêcia 
u¿ytkownika dodanego przez nas przed chwil±. Proszê zauwa¿yæ, ¿e 
rmuser(8) pyta siê o login u¿ytkownika oraz czy usuwaæ jego katalog 
domowy.

<blockquote><pre>
# <b>rmuser</b>
Enter login name for user to remove: <b>testuser</b>
Matching password entry:

testuser:$2a$07$ZWnBOsbqMJ.ducQBfsTKUe3PL97Ve1AHWJ0A4uLamniLNXLeYrEie:1002
:31::0:0:Test FAQ User:/home/testuser:/bin/ksh

Is this the entry you wish to remove? <b>y</b>
Remove user's home directory (/home/testuser)? <b>y</b>
Updating password file, updating databases, done.
Updating group file: done.
Removing user's home directory (/home/testuser): done.
</pre></blockquote>


<a name="user"></a>
<h3>Dodawanie u¿ytkowników za pomoc± polecenia user(8)</h3>

<p>
Ni¿ej opisane narzêdzia s± mniej interaktywne ni¿ polecenie 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=adduser&amp;sektion=8">adduser(8)</a>,
co u³atwia korzystanie z nich w skryptach pow³oki. 

<p>
Na narzêdzia te sk³adaj± siê nastêpuj±ce programy:
<ul>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=group&amp;sektion=8">group(8)</a>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=groupadd&amp;sektion=8">groupadd(8)</a>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=groupdel&amp;sektion=8">groupdel(8)</a>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=groupinfo&amp;sektion=8">groupinfo(8)</a>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=groupmod&amp;sektion=8">groupmod(8)</a>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=user&amp;sektion=8">user(8)</a>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=useradd&amp;sektion=8">useradd(8)</a>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=userdel&amp;sektion=8">userdel(8)</a>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=userinfo&amp;sektion=8">userinfo(8)</a>
<li><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=usermod&amp;sektion=8">usermod(8)</a>
</ul>


<h4>Dodawanie u¿ytkowników w praktyce.</h4>

<p>
Poniewa¿ program user(8) nie jest interaktywny, naj³atwiejszym 
sposobem dodania u¿ytkownika jest u¿ycie komendy adduser(8). 
Polecenie <i>/usr/sbin/user</i> to tylko fronton (ang. front-end) 
poleceñ 
<i>/usr/sbin/user*</i>. Dlatego te¿ mo¿na u¿ywaæ zarówno <b>user add</b> 
jak i <b>useradd</b>. Wybór nale¿y do Ciebie - sk³adnia komend pozostaje 
w obu przypadkach identyczna. 

<p>
W kolejnym przyk³adzie dodamy tego samego u¿ytkownika z takimi samymi 
ustawieniami jak w przyk³adzie wy¿ej <a href="#adduser"> prezentuj±cym 
polecenie adduser</a>. useradd(8) bêdzie du¿o prostszy w obs³udze, je¶li 
najpierw zaznajomimy siê z domy¶lnymi ustawieniami. Znajduj± siê one w 
pliku <i>/etc/usermgmt.conf</i>, za¶ wy¶wietliæ je mo¿na pisz±c:

<blockquote><pre>
$ <b>user add -D</b>
group           users
base_dir        /home
skel_dir        /etc/skel
shell           /bin/csh
inactive        0
expire          Null (unset)
range           1000..60000
</pre></blockquote>

<p>
Powy¿sze ustawienia, je¶li nie zostan± zmienione, bêd± wykorzystane 
przy dodawaniu u¿ytkownika z pomoc± poleceñ user add/useradd.
¯eby by³o ciekawiej, w naszym przyk³adzie umie¶cimy u¿ytkownika w grupie 
<b>guest</b>, nie w <b>users</b>. Ostatni± przeszkod±, o jakiej musimy
pamiêtaæ jest fakt, ¿e has³o, które przeka¿emy programowi 
user add/useradd musi byæ ju¿ zaszyfrowane. Zatem najpierw nale¿y u¿yæ
programu 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=encrypt&amp;sektion=1">encrypt(1)</a>, 
s³u¿±cego do szyfrowania hase³. OpenBSD u¿ywa do 
kodowania hase³ sze¶ciorundowego algorytmu Blowfish. 
Oto przyk³ad pokazuj±cy jak mo¿na otrzymaæ zaszyfrowane has³o gotowe do 
wykorzystania w programie useradd(8): 

<blockquote><pre>
$ <b>encrypt -p -b 6</b>
Enter string:
$2a$06$YOdOZM3.4m6MObBXjeZtBOWArqC2.uRJZXUkOghbieIvSWXVJRzlq
</pre></blockquote>

<p>
Mamy ju¿ zakodowane has³o, mo¿emy wiêc dodaæ u¿ytkownika:

<blockquote><pre>
# <b>user add -p '$2a$06$YOdOZM3.4m6MObBXjeZtBOWArqC2.uRJZXUkOghbieIvSWXVJRzlq' -u 1002 \
-s /bin/ksh -c "Test FAQ User" -m -g guest testuser</b>
</pre></blockquote>

<p>
<b>Uwaga:</b> Has³o nale¿y umie¶ciæ w parze apostrofów (' '), a nie 
cudzys³owów (" "); w przeciwnym razie zostanie ono 
zinterpretowane
przez pow³okê przed wys³aniem do user(8). Opcja <b>-m</b> jest konieczna 
by system utworzy³ katalog domowy u¿ytkownika i skopiowa³ do niego pliki 
z <i>/etc/skel</i>.

<p>By sprawdziæ, czy u¿ytkownik zosta³ poprawnie dodany do systemu, mo¿na 
pos³u¿yæ siê wieloma narzêdziami. Zamieszczone poni¿ej przyk³ady 
pokazuj± jak szybko upewniæ siê, ¿e wszystko wykonane zosta³o poprawnie.

<blockquote><pre>
$ <b>ls -la /home</b>
total 14
drwxr-xr-x   5 root      wheel   512 May 12 14:29 .
drwxr-xr-x  15 root      wheel   512 Apr 25 20:52 ..
drwxr-xr-x  24 ericj     wheel  2560 May 12 13:38 ericj
drwxr-xr-x   2 testuser  guest   512 May 12 14:28 testuser
$ <b>id testuser</b>
uid=1002(testuser) gid=31(guest) groups=31(guest)
$ <b>finger testuser</b>
Login: testuser                         Name: Test FAQ User
Directory: /home/testuser               Shell: /bin/ksh
Last login Sat Apr 22 16:05 (EDT) on ttyC2
No Mail.
No Plan.
</pre></blockquote>

<p>
Dodatkowo, user(8) dostarcza w³asne narzêdzie do podgl±du parametrów 
u¿ytkownika o nazwie userinfo(8).

<blockquote><pre>
$ <b>userinfo testuser</b>
login   testuser
passwd  *
uid     1002
groups  guest
change  Wed Dec 31 19:00:00 1969
class
gecos   Test FAQ User
dir     /home/testuser
shell   /bin/ksh
expire  Wed Dec 31 19:00:00 1969
</pre></blockquote>


<h4>Usuwanie u¿ytkowników</h4>
<p>
W celu usuniêcia u¿ytkownika za pomoc± polecenia z zestawu user(8), 
nale¿y skorzystaæ z komendy userdel(8). Jest to bardzo proste, a 
jednocze¶nie przydatne polecenie. By usun±æ u¿ytkownika dodanego w 
poprzednim wystarczy napisaæ:

<blockquote><pre>
# <b>userdel -r testuser</b>
</pre></blockquote>

<p>
Proszê zwróciæ uwagê na opcjê <b>-r</b>, która ka¿e systemowi usun±æ 
nie tylko 
samego u¿ytkownika, ale te¿ jego katalog domowy. Alternatywnie, zamiast 
<b>-r</b> mo¿na u¿yæ flagi <b>-p</b>, która tylko blokuje konto 
u¿ytkownika, bez usuwania jakichkolwiek informacji o nim.


<p>
<a name= "FTPOnly"></a>
<h2>10.10 - Jak stworzyæ konto umo¿liwiaj±ce logowanie tylko przez FTP?</h2>
<p>
Istnieje na to kilka sposobów. Bardzo powszechne jest rozwi±zanie polegaj±ce
na dodaniu pliku "<tt>/usr/bin/false</tt>" do "<tt>/etc/shells</tt>". Je¿eli 
nastêpnie domy¶lna pow³oka u¿ytkownika ustawiona zostanie w³a¶nie na
"<tt>/usr/bin/false</tt>", to nie bêdzie on móg³ zalogowaæ siê do systemu w trybie
interaktywnym. Bêdzie móg³ natomiast zalogowaæ siê przez FTP. 
Mo¿esz tak¿e, korzystaj±c poprzez <a href="#ftpchroot">ftpchroot</a> 
ograniczyæ dostêp u¿ytkowników ftp tylko do ich katalogów domowych.


<p>
<a name= "Quotas"></a>
<h2>10.11 - Konfigurowanie kwot dyskowych</h2>

<p>
Kwoty wykorzystywane s± do ograniczania przestrzeni dyskowej 
dostêpnej u¿ytkownikom. Jest to szczególnie pomocne, gdy zasoby 
dyskowe s± mocno ograniczone. Limity mo¿na narzuciæ zarówno 
pojedynczemu u¿ytkownikowi jak i ca³ej grupie.

<p>
Pierwszym krokiem do ustawienia kwot jest sprawdzenie czy
opcja "<tt>option QUOTA</tt>" zosta³a w³±czona w twojej <a href="faq5.html#Options">
konfiguracji kernela</a>. Jest ona domy¶lnie ustawiona w j±drze GENERIC. 
Nastêpnie nale¿y wskazaæ w pliku
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=fstab&amp;sektion=5"><tt>/etc/fstab</tt></a>,
systemy plików na których chcesz w³±czyæ kwoty.  
Do tego s³u¿± s³owa kluczowe
<tt>userquota</tt> oraz <tt>groupquota</tt>. W korzeniu wybranych 
systemów plików domy¶lnie tworzone s± pliki <tt>quota.user</tt> oraz 
<tt>quota.group</tt>, które zawieraj± niezbêdne informacje o kwotach.
Nie ma przeszkód, by pliki te znajdowa³y siê w dowolnym innym katalogu
lub nawet inaczej siê nazywa³y. Robi siê to dodaj±c w pliku <tt>/etc/fstab</tt>;
przyk³adowo "<tt>userquota=/var/quotas/quota.user</tt>".
Poni¿ej znajduje siê przyk³ad pliku <tt>/etc/fstab</tt> z jednym systemem 
plików z w³±czonymi kwotami i plikiem kwot nie niestandardowej lokalizacji:

<blockquote><pre>
/dev/wd0a / ffs rw,userquota=/var/quotas/quota.user 1 1
</pre></blockquote>

<p>
Teraz mo¿na ju¿ przyznawaæ u¿ytkownikom kwoty. S³u¿y do tego narzêdzie 
o nazwie 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=edquota&amp;sektion=8">edquota(8)</a>. 
Wpisuj±c "<tt>edquota &lt;user&gt;</tt>" 
do konfigurowania kwot u¿yty zostanie edytor vi(1), chyba ¿e za pomoc± 
zmiennej ¶rodowiskowej EDITOR ustawimy jako domy¶lny inny edytor. Dla
przyk³adu:

<blockquote><pre>
# <b>edquota ericj</b>
</pre></blockquote>

<p>
spowoduje wy¶wietlenie mniej wiêcej takiej informacji:

<blockquote><pre>
Quotas for user ericj:
/: blocks in use: 62, limits (soft = 0, hard = 0)
	inodes in use: 25, limits (soft = 0, hard = 0)
</pre></blockquote>

<p>
Aby wprowadziæ ograniczenia wystarczy zredagowaæ ten plik. Np.:

<blockquote><pre>
Quotas for user ericj:
/: blocks in use: 62, limits (soft = 1000, hard = 1050)
	inodes in use: 25, limits (soft = 0, hard = 0)
</pre></blockquote>

<p>
W powy¿szym przyk³adzie ustawili¶my limit miêkki (ang. soft limit) na 
1000 bloków, za¶ limit twardy (ang. hard limit) na 1050 bloków. Ró¿nica 
miêdzy limitem miêkkim a twardym
polega na tym, ¿e ten pierwszy mo¿e zostaæ na jaki¶ czas przekroczony.
Czas ten ustala siê stosuj±c opcjê <b>-t</b> w poleceniu 
edquota(8). Gdy okres ten jednak minie, limit miêkki jest traktowany
identycznie jak limit twardy, co powoduje czêste b³êdy alokacji.

<p>
Po ustawieniu kwot nale¿y je jeszcze w³±czyæ. Robi siê to za pomoc± 
polecenia <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=quotaon&amp;sektion=8">quotaon(8)</a>. 
Przyk³ad:

<blockquote><pre>
# <b>quotaon -a</b>
</pre></blockquote>

<p>
Spowoduje to wczytanie <tt>/etc/fstab</tt> i w³±czenie kwot na wybranych 
systemach plików. Do wy¶wietlania kwot s³u¿y polecenie 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=quota&amp;sektion=1">quota(1)</a>. 
Wywo³anie "<tt>quota &lt;user&gt;</tt>" dostarczy 
informacji na temat kwot wybranego u¿ytkownika. Wywo³anie komendy 
quota(1) bez dodatkowych argumentów zwróci nasze w³asne statystyki. 
Oto przyk³ad:

<blockquote><pre>
# <b>quota ericj</b>
</pre></blockquote>

<p>Spowoduje to wypisanie informacji podobnej do tej:

<blockquote><pre>
Disk quotas for user ericj (uid 1001): 
     Filesystem  blocks   quota   limit   grace   files   quota   limit   grace
              /      62    1000    1050              27       0       0        
</pre></blockquote>

<p>
Kwoty ustawione w <tt>/etc/fstab</tt> w³±czaj± siê domy¶lnie podczas startu 
systemu. Natomiast wy³±czyæ mo¿na je pisz±c:

<blockquote><pre>
# <b>quotaoff -a</b>
</pre></blockquote>


<p>
<a name= "Kerberos"></a>
<h2>10.12 - Konfigurowanie klientów i serwerów KerberosV</h2>

<p>
KerberosV jest domy¶lnie preinstalowanym sk³adnikiem systemu.

<p>
Wiêcej informacji o KerberosV mo¿na uzyskaæ za pomoc± polecenia:

<blockquote><pre>
     # <b>info heimdal</b>
</pre></blockquote>


<p>
<a name= "AnonFTP"></a>
<h2>10.13 - Konfigurowanie anonimowego serwera FTP</h2>

<p>
Dziêki anonimowemu FTP nawet u¿ytkownicy nie posiadaj±cy konta mog± mieæ 
dostêp do naszych plików. Poni¿ej podpowiadamy jak skonfigurowaæ anonimowy
serwer FTP.


<h3>Dodawanie konta FTP</h3>

<p>
Najpierw nale¿y stworzyæ w systemie konto o nazwie <i>ftp</i>. Has³o do tego 
konta nie powinno byæ warto¶ciowe, tzn. nie powinni¶my u¿ywaæ go nigdzie
indziej. W naszym przyk³adzie dla tego konta ustalimy katalog domowy
/home/ftp, ale mo¿na u¿yæ tez innego katalogu. Gdy kto¶ zaloguje siê
na nasz anonimowy serwer FTP, demon ftp zmieni ¶rodowisko za pomoc± 
polecenia chroot, na katalog domowy u¿ytkownika <i>ftp</i>. 
Wiêcej na ten temat mo¿na dowiedzieæ siê na stronach podrêcznika systemowego 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftpd&amp;sektion=8">ftpd(8)</a>
oraz
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=chroot&amp;sektion=2">chroot(2)</a>. 
Oto przyk³ad dodania u¿ytkownika o nazwie <i>ftp</i>.
U¿ywamy tutaj polecenia: 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=adduser&amp;sektion=8">adduser(8)</a>.
Nale¿y tak¿e dodaæ liniê /usr/bin/false do pliku
<i>/etc/shells</i>. Jest to &quot;pow³oka&quot;, któr± nadajemy u¿ytkownikowi
<i>ftp</i>. Dziêki temu nie bêd± siê oni mogli 
zalogowaæ, nawet je¶li ustawimy im puste has³o.

<blockquote><pre>
echo /usr/bin/false &gt;&gt; /etc/shells
</pre></blockquote>

Po czym jeste¶my gotowi na utworzenie u¿ytkownika <i>ftp</i>:

<blockquote><pre>
# <b>adduser</b>
Use option `-silent'' if you don't want to see all warnings and questions.

Reading /etc/shells
Reading /etc/login.conf
Check /etc/master.passwd
Check /etc/group

Ok, let's go.
Don't worry about mistakes. I will give you the chance later to correct any input.
Enter username []: <b>ftp</b>
Enter full name []: <b>anonymous ftp</b>
Enter shell csh false ksh nologin sh tcsh zsh [sh]: <b>false</b>
Uid [1002]: <b><i>Enter</i></b>
Login group ftp [ftp]: <b><i>Enter</i></b>
Login group is `ftp''. Invite ftp into other groups: guest no 
[no]: <b>no</b>
Login class auth-defaults auth-ftp-defaults daemon default staff 
[default]: <b><i>Enter</i></b>
Enter password []: <b><i>Enter</i></b>
Set the password so that user cannot logon? (y/n) [n]: <b>y</b>

Name:        ftp
Password:    ****
Fullname:    anonymous ftp
Uid:         1002
Gid:         1002 (ftp)
Groups:      ftp
Login Class: default
HOME:        /home/ftp
Shell:       /usr/bin/false
OK? (y/n) [y]: <b>y</b>
Added user ``ftp''
Copy files from /etc/skel to /home/ftp
Add another user? (y/n) [y]: <b>n</b>
Goodbye!
</pre></blockquote>


<h3>Konfigurowanie katalogu</h3>

<p>
Mamy ju¿ dodanego u¿ytkownika ftp; stworzony zosta³ tak¿e jego katalog
domowy - <i>/home/ftp</i>. Nale¿y dokonaæ jednak jeszcze kilku zmian,
by konto by³o gotowe do obs³ugi anonimowego FTP. Ponownie odsy³amy do
podrêcznika systemowego programu
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftpd&amp;sektion=8">ftpd(8)</a>.

<p>
<b>Nie</b> ma potrzeby zak³adania katalogów /home/ftp/usr czy 
/home/ftp/bin.

<ul>
<li><i>/home/ftp</i> - G³ówny katalog. Powinien mieæ prawa 555, za¶ jego 
w³a¶cicielem powinien byæ root.

<li><i>/home/ftp/etc</i> - ca³kowicie opcjonalny, a nawet nie zalecany,
jako ¿e jego jedyn± funkcj± jest udzielanie informacji o u¿ytkownikach, 
którzy maj± konto na naszym komputerze. Je¶li chcemy aby informacje o 
plikach znajduj±cych siê w katalogu /home/ftp/pub (patrz akapit ni¿ej) 
zawiera³y nazwy 
u¿ytkowników zamiast tylko ich identyfikatory, to mo¿emy skopiowaæ pliki 
/etc/pwd.db i /etc/group do tego katalogu. Katalog ten powinien mieæ 
prawa dostêpu 511, a wspomniane dwa pliki 444. W pliku pwd.db nie s± 
przechowywane ¿adne has³a, s± one w spwd.db i dlatego nie nale¿y
go tu kopiowaæ.

<li><i>/home/ftp/pub</i> - Zwyczajowy katalog w którym umieszcza siê 
pliki, jakie maj± byæ udostêpnione u¿ytkownikom FTP. Katalogowi temu
równie¿ nadajemy prawa dostêpu 555.

</ul><p>Proszê zwróciæ uwagê na to, by w³a¶cicielem wszystkich katalogów 
by³ root. Oto listing pokazuj±cy jak powinny wygl±daæ 
stworzone katalogi:

<blockquote><pre>
# pwd
/home
# ls -laR ftp
total 5
dr-xr-xr-x  5 root  ftp    512 Jul  6 11:33 .
drwxr-xr-x  7 root  wheel  512 Jul  6 10:58 ..
dr-x--x--x  2 root  ftp    512 Jul  6 11:34 etc
dr-xr-xr-x  2 root  ftp    512 Jul  6 11:33 pub

ftp/etc:
total 43
dr-x--x--x  2 root  ftp    512 Jul  6 11:34 .
dr-xr-xr-x  5 root  ftp    512 Jul  6 11:33 ..
-r--r--r--  1 root  ftp    316 Jul  6 11:34 group
-r--r--r--  1 root  ftp  40960 Jul  6 11:34 pwd.db

ftp/pub:
total 2
dr-xr-xr-x  2 root  ftp  512 Jul  6 11:33 .
dr-xr-xr-x  5 root  ftp  512 Jul  6 11:33 ..
</pre></blockquote>


<h3>Uruchamianie serwera i logowanie</h3>

<p>
W przypadku ftpd mo¿na wybraæ czy uruchamiaæ go z 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=inetd&amp;sektion=8">inetd(8)</a>,
czy ze skryptów <a href="#rc">rc</a>.
Nasze przyk³ady poka¿± jak uruchomiæ demona z pomoc± inetd.conf.
Na pocz±tku musimy jednak poznaæ pewne opcje ftpd. 
Standardowa linia z <i>/etc/inetd.conf</i> wygl±da tak:

<blockquote><pre>
<b>ftp             stream  tcp     nowait  root    /usr/libexec/ftpd       ftpd -US</b>
</pre></blockquote>

<p>
W naszym przypadku ftpd jest przywo³ywany z opcj± <i>-US</i>. Spowoduje 
to logowanie anonimowych po³±czeñ do <i>/var/log/ftpd</i>, za¶ sesji
równoleg³ych do <i>/var/run/utmp</i>. Sprawi to tak¿e, ¿e sesje te bêd± 
widoczne przez polecenie who(8). Mo¿na równie¿ akceptowaæ tylko i 
wy³±cznie anonimowe po³±czenia, korzystaj±c z opcji <i>-A</i>. Oto 
odpowiedni wpis (u¿ywamy tak¿e opcji <i>-ll</i> która powoduje, ¿e ka¿de 
po³±czenie jest logowane do sysloga, w³±czaj±c w to komendy ftp takie
jak get, retrieve itd):

<blockquote><pre>
<b>ftp             stream  tcp     nowait  root    /usr/libexec/ftpd       ftpd -llUSA</b>
</pre></blockquote>


<p>
<b>Uwaga:</b> W przypadku, gdy przewidywane jest bardzo du¿e obci±¿enie 
serwera ftp, zaleca siê nie wywo³ywaæ ftpd z poziomu inetd.conf.
Najlepiej jest wówczas wykomentowaæ odpowiedni± liniê z pliku inetd.conf 
i uruchomiæ ftpd z poziomu rc.conf.local z w³±czon± opcj± <i>-D</i>. 
Sprawi to, ¿e demon bêdzie dzia³a³ szybciej, ni¿ gdyby zosta³ uruchomiony z 
inetd.conf. Oto przyk³ad pokazuj±cy jak uruchomiæ demona ftp z poziomu 
rc.conf.local:

<blockquote><pre>
ftpd_flags="-DllUSA"           # for non-inetd use: ftpd_flags="-D"
</pre></blockquote>

<p>
Zadzia³a to oczywi¶cie tylko wtedy, je¶li wcze¶niej wykomentowano 
odpowiedni wpis z <i>/etc/inetd.conf</i> oraz nakazano demonowi 
intetd ponownie przeczytaæ swój plik konfiguracyjny.

<h3>Inne wa¿ne pliki</h3>

<ul>
<li><i>/etc/ftpwelcome</i> - Zawiera wiadomo¶æ powitaln± wy¶wietlan± 
u¿ytkownikom, którzy po³±czyli siê z serwerem ftp.
<li><i>/etc/motd</i> - Zawiera wiadomo¶æ powitaln± wy¶wietlan± 
u¿ytkownikom, którzy zalogowali siê na serwer ftp.
<li><i>.message</i> - Pliki o takiej nazwie mo¿na zamieszczaæ w 
dowolnych katalogach. Ich zawarto¶æ zostanie wy¶wietlona, gdy u¿ytkownik
wejdzie do danego katalogu.
</ul>



<p>
<a name= "ftpchroot"></a>
<h2>10.14 - Ograniczanie dostêpu u¿ytkowników wy³±cznie do ich 
katalogów domowych w ftpd(8)</h2>

<p>
Domy¶lnie loguj±c siê przez ftp, u¿ytkownicy mog± zmieniæ katalog na
ka¿dy do którego maj± dostêp. W niektórych przypadkach mo¿e to byæ
niepo¿±dane. Istnieje mo¿liwo¶æ ograniczenia tego co u¿ytkownicy widz±
w sesji ftp, poprzez chrootowanie ich w ich katalogach domowych. 

<p>
Je¿eli chcesz zezwoliæ tylko na chrootowane po³±czenia ftp, przyj¿yj siê 
opcji <b>-A</b> w 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftpd&amp;sektion=8">ftpd(8)</a>.

<p>
Je¿eli chcesz ograniczyæ ich bardziej delikatnie,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=login.conf&amp;sektion=5">login.conf(8)</a>.
oraz 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftpd&amp;sektion=8">ftpd(8)</a>.
mog± to u³atwiæ.

<p>
U¿ytkownicy w klasie logowania z ustawion± zmienn± <tt>ftp-chroot</tt>
bêd± chrootowani automatycznie.
Dodatkowo, mo¿esz dodawaæ nazwy u¿ytkowników do pliku <b>/etc/ftpchroot</b>
by chrootowaæ tych u¿ytkowników.
Wystarczy by dany login by³ wpisany w jednej z tych dwóch lokalizacji.

<p>
<a name= "Patches"></a>
<h2>10.15 - £atanie systemu OpenBSD</h2>

<p>
Nawet w OpenBSD zdarzaj± siê b³êdy.
Niektóre b³êdy mog± doprowadziæ problemów z niezawodno¶ci±
(tj. co¶ mo¿e spowodowaæ, ¿e system przestanie pracowaæ jak zaplanowano).
Inne b³êdy mog± doprowadziæ do problemów z bezpieczeñstwem (te mog± 
pozwoliæ innym na "u¿ycie" twojego komputera w niezamierzony sposób).
Gdy zostanie wykryty b³±d krytyczny, poprawka zostaje dodana do 
drzewa ¼ród³owego wersji <i>current</i>, oraz wydawane s± ³atki dla 
ka¿dej <a href="faq5.html#Flavors">wspieranej wersji</a> OpenBSD.
£atki te pojawiaj± siê na <a href="../../errata.html">stronie errat</a> 
i s± dzielone na "wspólne", obejmuj±ce wszystkie 
<a href="../../pl/plat.html">platformy</a> , oraz erraty dzia³aj±ce w ramach
jednej lub kilku, ale nie wszystkich, platform.


<p>
Proszê zwróciæ uwagê na to, ¿e ³atki nie s± jakimi¶ nowymi dodatkami do 
OpenBSD; s± tworzone tylko wtedy, gdy powstanie problem 
zwi±zany z niezawodno¶ci± lub bezpieczeñstwem systemu. Dlatego te¿ ³atki 
z regu³y powinny byæ jak najszybciej aplikowane na objêtych nimi maszynach
(co czêsto NIE oznacza wszystkich maszyn, w zale¿no¶ci od ich przeznaczenia).

<p>
S± trzy mo¿liwo¶ci uaktualnienia systemu z poprawionym kodem:

<ul>
<li><b>Uaktualnienie systemu do wersji 
<a href="current.html"><i>-current</i></a>.</b>
Jako ¿e wszystkie poprawki s± wprowadzane do kodu bazowego <i>-current</i>, 
uaktualnienie twojego systemu do najnowszego "snapshota" jest bardzo dobr± 
drog± do zastosowania poprawionego kodu. Jakkolwiek, korzystanie z <i>-current</i>
nie jest dla wszystkich.
<li><b>Uaktualnienie systemu do wersji <a href="../../pl/stable.html"><i>-stable</i></a>.</b>
Jest to realizowane poprzez dostawianie lub aktualizowanie twojego drzewa ¼ród³owego
korzystaj±c z w³a¶ciwej ga³êzi <i>-stable</i>, oraz rekompilacji j±dra i plików
w przestrzeni u¿ytkownika. Ogólnie jest to prawdopodobnie naj³atwiejsza z dróg, 
aczkolwiek trwa d³u¿ej (a¿ ca³y system nie zostanie zrekompilowany) a tak¿e 
kompletne sprawdzenie ¼róde³ mo¿e zaj±c sporo czasu je¿eli posiadasz ograniczone ³±cze.
<li><b>£atanie, kompilowanie i instalowanie indywidualne plików objêtych ³atk±.</b>
T± metod± pos³u¿ymy siê w omówionym ni¿ej przyk³adzie.
Pomimo i¿ potrzebne jest s³absze ³±cze i zazwyczaj zajmuje to mniej czasu ni¿ 
sprawdzenie/aktualizacja ca³ego drzewa cvs(1) i kompilacja kodu ¼ród³owego, jest
to czasem najbardziej skomplikowana opcja, jako ¿e nie istnieje jeden uniwersalny
zestaw instrukcji wed³ug których mo¿na pod±¿aæ.
Czasami musisz za³ataæ, zrekompilowaæ i zainstalowaæ jedn± aplikacjê, innym razem, 
musisz zrekompilowaæ ca³e sekcje z drzewa, je¿eli problem le¿y w pliku biblioteki.
</ul>

Jeszcze raz, ³atanie poszczególnych plików nie zawsze jest proste, zatem powa¿nie 
pod uwagê mo¿liwo¶æ pod±¿ania za wersj± <a href="../../pl/stable.html"><i>-stable</i></a>
odga³êzienia OpenBSD.

Mieszanie i dopasowywanie ³atek mo¿esz wykonywaæ tylko je¿eli rozumiesz jak 
wszystko dzia³a, ale nowi u¿ytkownicy powinni wybraæ jedn± metodê i tej metody
siê trzymaæ.

<h3>Jak ³atki "erraty" ró¿ni± siê od tego co znajduje siê w drzewie CVS?</h3>

<p>Wszystkie ³atki publikowane na 
<a href="../../errata.html">stronie errat</a> s± 
przeznaczone do aplikowania na wskazany kod ¼ród³owy danej wersji systemu 
(ang. release system). £atki znalezione w najnowszym drzewie CVS mog± 
dodatkowo spowodowaæ zmiany, które by³yby niepo¿±dane w podstawowej 
wersji systemu.


To jest bardzo wa¿ne: je¿eli instalowa³e¶ system ze "snapshota", sprawdzi³e¶
¼ród³a w czasie gdy pobiera³e¶ snapshot i usi³owa³e¶ za³ataæ je korzystaj±c
z opublikowanej ³atki, mo¿e lepiej zachowaj wersjê przed u¿yciem ³aty, jako
¿e kod mo¿e ulec zmianie.

<h3>Nak³adanie ³atki</h3>

<p>
£aty dla systemu OpenBSD s± rozpowszechniane  jako "ujednolicone diff'y",
które s± plikami tekstowymi zawieraj±cymi ró¿nice w stosunku do 
oryginalnego kodu ¼ród³owego. <b>NIE</b> s± dystrybuowane w formie 
binarnej! Oznacza to, ¿e aby za³ataæ swój system musimy mieæ kod 
¼ród³owy wersji <b>RELEASE</b> OpenBSD.
W szczególno¶ci powiniene¶ posiadaæ pe³ne dostêpne drzewo ¼róde³.
Je¿eli korzystasz z wersji dostêpnej z oficjalnych p³yt CD, ¼ród³a
znajduj± siê na p³ycie 3, s± tak¿e dostêpne jako pliki z 
<a href="../../ftp.html">serwerów FTP</a>.
Zak³adamy ¿e posiadasz pe³ne i sprawdzone ¼ród³a.

<p>
W ramach naszego przyk³adu, przyj¿ymy siê ³atce 001 dla OpenBSD 3.6
dotycz±cej sterownika 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=st&amp;sektion=4">st(4)</a>
obs³uguj±cego napêdy ta¶mowe.
Bez wspomnianej ³atki, odzyskiwanie danych z backupu jest do¶æ k³opotliwe.
Osoby korzystaj±ce z napêdów ta¶mowych <i>potrzebuj±</i> tej ³atki,
jakkolwiek w przypadku osób nie korzystaj±cych z napêdu ta¶mowego nie
ma szczególnego powodu na instalowanie tej ³atki.
Przyj¿yjmy siê ³atce:

<blockquote><pre>
# <b>more 001_st.patch</b>
Apply by doing:
        cd /usr/src
	patch -p0 < 001_st.patch
	
Rebuild your kernel.

Index: sys/scsi/st.c
===================================================================
RCS file: /cvs/src/sys/scsi/st.c,v
retrieving revision 1.41
retrieving revision 1.41.2.1
diff -u -p -r1.41 -r1.41.2.1
--- sys/scsi/st.c       1 Aug 2004 23:01:06 -0000       1.41
+++ sys/scsi/st.c       2 Nov 2004 01:05:50 -0000       1.41.2.1
@@ -1815,7 +1815,7 @@ st_interpret_sense(xs)
	u_int8_t skey = sense->flags & SSD_KEY;
        int32_t info;

        if (((sense->flags & SDEV_OPEN) == 0) ||
+       if (((sc_link->flags & SDEV_OPEN) == 0) ||
(serr != 0x70 && serr != 0x71))
return (EJUSTRETURN); /* let the generic code handle it */
</pre></blockquote>

Jak pewnie zauwa¿y³e¶ nag³ówek ³aty zawiera krótkie instrukcjê
jak nale¿y postêpowaæ.
Za³ó¿my ¿e umie¶ci³e¶ t± ³atê w katalogu <tt>/usr/src</tt>, w takiej
sytuacji nastêpnym krokiem jest:

<blockquote><pre>
# <b>cd /usr/src</b>
# <b>patch -p0 < 001_st.patch</b>

Hmm...  Looks like a unified diff to me...
The text leading up to this was:
--------------------------
|Apply by doing:
|       cd /usr/src
|        patch -p0 < 001_st.patch
|
|Rebuild your kernel.
|
|Index: sys/scsi/st.c
|===================================================================
|RCS file: /cvs/src/sys/scsi/st.c,v
|retrieving revision 1.41
|retrieving revision 1.41.2.1
|diff -u -p -r1.41 -r1.41.2.1
|--- sys/scsi/st.c      1 Aug 2004 23:01:06 -0000       1.41
|+++ sys/scsi/st.c      2 Nov 2004 01:05:50 -0000       1.41.2.1
--------------------------
Patching file sys/scsi/st.c using Plan A...
Hunk #1 succeeded at 1815.              <i>&lt;-- Szukaj takiej informacji!</i>
done
</pre></blockquote>

Zwróæ uwagê na komunikat "<tt>Hunk #1 succeeded</tt>".
Oznacza on, poprawne na³o¿enie ³atki.
Wiele ³atek jest znacznie bardziej skomplikowanych ni¿ ta, zatem ilo¶æ 
takich komunikatów bedzie znacznie wiêksza; powiniene¶ sprawdziæ czy
wszystkie fragmenty we wszystkich plikach zosta³y zaktualizowane poprawnie.
Je¶li nie, zazwyczaj oznacza to, ¿e posiadasz niew³a¶ciwe ¼ród³a, nie 
wype³ni³e¶ wszystkich instrukcji uwa¿nie, lub twoja ³atka jest poszarpana.
£aty s± bardzo wra¿liwe na "bia³e znaki" - kopiowanie i wklejanie z twojej
przegl±darki internetowej czêsto zmieni znaki tabulacji na spacje lub odwrotnie,
czyni±c j± bezu¿yteczn±.

<p>
W tym momencie, mo¿esz przyst±piæ do <a href="faq5.html#Building">budowy j±dra</a>,
zainstalowania go i zrestartowania systemu.

<p>
Nie wszystkie ³aty dotycz± j±dra.
W niektórych przypadkach, bêdziesz musia³ przebudowaæ pojedyñcze narzêdzia. 
W innych bêdziesz potrzebowa³ przebudowaæ wszystkie narzêdzia statycznie
zlinkowane z ³atan± bibliotek±.
Zastosuj siê do informacji w nag³ówku ³aty, a gdy masz w±tpliwo¶ci przebuduj 
ca³y system

<p>
£aty nie maj±ce zastosowania dla twojego okre¶lonego systemu, zazwyczaj nie
powinny byæ nak³adane.
Dla przyk³adu, je¿eli nie posiadasz napêdu ta¶mowego, nie odniesiesz ¿adnej
korzy¶ci z opisanej wy¿ej ³aty.
Jakkolwiek, ³aty mog± przypuszczalnie byæ zak³adane "w kolejno¶ci" - istnieje
mo¿liwo¶æ, ¿e pó¼niejsza ³atka jest powi±zana z jedn± z wcze¶niejszych.
B±d¼ uwa¿ny je¿eli postanowisz "grymasiæ" z ³atkami które nak³adasz, i 
w przypadku w±tpliwo¶ci, na³ó¼ je wszystkie w kolejno¶ci.   


<a name="httpdchroot"></a>
<h2>10.16 - Zastosowanie ¶rodowiska chroot(2) dla serwera Apache.</h2>

<p>
W systemie OpenBSD, serwer HTTP Apache
(<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=httpd&amp;sektion=8">
httpd(8)</a>) jest uruchamiany domy¶lnie w ¶rodowisku zmodyfikowanym poleceniem
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=chroot&amp;sektion=2">
chroot(2)</a>. Chocia¿ jest to wspania³e z punktu widzenia bezpieczeñstwa
systemu, mog± siê z tym wi±zaæ pewne niespodzianki dla osób nieprzygotowanych
na tak± zmianê.

<h3>Co to jest chroot?</h3>
Proces dzia³aj±cy w ¶rodowisku zmodyfikowanym poleceniem 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=chroot&amp;sektion=2">
chroot(2)</a> (dalej bêdziemy pisali po prostu: "proces dzia³aj±cy w 
¶rodowisku chroot") jest ograniczony do okre¶lonego katalogu i nie ma 
mo¿liwo¶ci "chodzenia" po reszcie drzewa katalogów. Katalog, w którym 
proces zostaje "zamkniêty", jest postrzegany przez ten proces jako 
katalog "<tt>/</tt>" (root).  W przypadku httpd(8), proces ten startuje, 
otwiera swoje pliki dziennika, pod³±cza siê do swojego portu TCP 
(chocia¿ nie przyjmuje jeszcze danych) i odczytuje swój plik 
konfiguracyjny. Nastêpnie "zamyka siê" w <i>/var/www</i>, oddaje 
przywileje, a potem rozpoczyna przyjmowanie ¿±dañ. Oznacza to, ¿e 
wszystkie pliki wysy³ane b±d¼ odbierane przez serwer Apache musz± 
znajdowaæ siê w katalogu <i>/var/www</i>. 
W domy¶lnej konfiguracji OpenBSD, wszystkie pliki w <i>/var/www</i>
maj± atrybuty tylko do odczytu dla u¿ytkownika <i>www</i> z uprawnieniami
którego chodzi Apache.
Ogromnie pomaga to w podniesieniu bezpieczeñstwa systemu -- 
je¿eli nast±pi³o by w³amanie poprzez serwer Apache, to zniszczenia 
dokonane przez w³amywacza by³yby ograniczone do jednego katalogu z 
prawami "tylko do odczytu" -- bez dostêpu do zasobów, które mo¿na 
by wykorzystaæ do niecnych zamiarów.

<h3>Co to oznacza dla administratora?</h3>

<p>
Nie owijaj±c w bawe³nê trzeba powiedzieæ, ¿e uruchamianie serwera 
Apache w ¶rodowisku chroot(2) jest czym¶ nowym. Dlatego te¿ wiele 
starszych programów czy ustawieñ systemowych przestanie dzia³aæ,
bez kilku przeróbek.
Ponadto musimy pamiêtaæ, ¿e bezpieczeñstwo i wygoda czêsto nie s±
kompatybilnymi za³o¿eniami.
Implementacja Apache w OpenBSD nie jest kompromisem bezpieczeñstwa
wzglêdem funkcjonalno¶ci i "wygody".

<ul>
<li><b>Stare rozk³ady systemu plików:</b> Na serwerach, na których 
dokonywano uaktualnieñ systemu OpenBSD, pewne pliki mog± byæ 
zlokalizowane w katalogach u¿ytkowników. Nie zadzia³a to w 
¶rodowisku chroot(2), poniewa¿ httpd(8) nie uzyska dostêpu 
do katalogu <i>/home</i>. Administratorzy mog± tak¿e nagle odkryæ, ¿e 
partycja /var/www sta³a siê zbyt ma³a by przechowaæ wszystkie pliki WWW. 
Mo¿na wtedy albo przebudowaæ system albo nie zaprzestaæ stosowania 
chroot(2). Oczywi¶cie, dozwolone jest korzystanie z ³±czy 
symbolicznych w katalogach domowych u¿ytkowników wskazuj±cych na 
podkatalogi <i>/var/www</i>. NIE mo¿na jednak u¿ywaæ linków w 
<i>/var/www</i> wskazuj±cych na inne czê¶ci systemu plików -- na to 
przecie¿ nie zezwala chroot(2). Zauwa¿my, ¿e je¿eli zezwolimy 
u¿ytkownikom na <a href="faq10.html#ftpchroot">dostêp do FTP w ¶rodowisku
chroot(2)</a>, to nie zadzia³a to tak, jak oczekujemy, poniewa¿ 
¶rodowisko 
chroot (ponownie) nie zezwoli na dostêp do plików wskazywanych przez 
³±cza symboliczne. Rozwi±zaniem tego problemu jest niekorzystanie z 
katalogów domowych <i>/home</i> dla tych u¿ytkowników, a zamiast tego 
utworzenie ich w katalogu <i>/var/www/users</i> lub podobnym.
Dowi±zania symboliczne mog± byæ u¿ywane w chroot(2), musz± byæ jednak wzglêdne
a nie bezwzglêdne.

<li><b>Rotacja logów:</b> Standardowo, rotacja logów odbywa siê przez 
zmianê nazwy starych plików, a nastêpnie wys³anie httpd(8) sygna³u 
SIGUSR1 w celu zmuszenia Apache do zamkniêcia swoich starych logów i 
otwarcia nowych. W chroot nie jest to mo¿liwe, poniewa¿ httpd(8) nie ma 
mo¿liwo¶ci otwarcia logu do zapisu po oddaniu przywilejów. httpd(8) musi 
byæ zatrzymany i zrestartowany.
Czasem, zakoñczenie procesów potomnych zajmuje kilka sekund, a musi to 
nast±piæ zanim httpd(8) zostanie zrestartowany, zatem jednym z mo¿liwych
sposobów pozwalaaj±cych na rotacjê logów jest:

<blockquote><pre>
# <b>apachectl stop</b>
  <i>zmieñ nazwy swoich logów</i>
# <b>apachectl start ; sleep 10 ; apachectl start</b>
</pre></blockquote>

Tak, ostatnia linia uruchamia ponownie Apache, i w przypadku gdy 
ta operacja siê nie powiedzie, usi³uje to zrobiæ jeszcze raz.
A tak¿e, oznacza, ¿e za kazdym razem jak wykonujesz rotacjê swoich logów,
twój serwer www bêdzie niedostêpny.
Chocia¿ mo¿e to byæ irytuj±ce, jednak ka¿da próba zezwolenia httpd(8)
na ponowne otwarcie plików poza chroot(8)em prze³amuje wiele celów
chroot-a!
Istniej± jeszcze inne sposoby, np. logowanie do 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pipe&amp;sektion=2">
pipe(2)</a> przy korzystaniu z zewnêtrznego programu do rotacji logów, 
czytaj±cego z drugiego koñca pipe(2).

<li><b>Modu³y Apache:</b> Praktycznie wszystkie powinny siê za³adowaæ, 
jednak niektóre nie bêd± dzia³aæ poprawnie w ¶rodowisku chroot(2). W 
szczególno¶ci mo¿e wyst±piæ problem z generuj±cym b³±d poleceniem "<tt>
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=apachectl&amp;sektion=8">apachectl</a>
restart</tt>" które sprawia, ¿e httpd(8) przerywa pracê.

<li><b>Skrypty CGI:</b> Wiêkszo¶æ NIE zadzia³a poprawnie od razu. Mog± 
one bowiem potrzebowaæ programów lub bibliotek znajduj±cych 
siê poza <i>/var/www</i>. W niektórych przypadkach mo¿na temu zaradziæ 
poprzez statyczne ³±czenie (eliminuje to potrzebê korzystania z 
zewnêtrznych bibliotek przez te programy). Kolejnym sposobem, bardzo 
skutecznym, jest umieszczenie kopii potrzebnych plików w katalogu 
<i>/var/www</i>. Jest to jednak zadanie niebanalne, wymagaj±ce sporej 
wiedzy o programie.

<li><b>Opcje montowania systemów plików:</b>
Domy¶lnie w OpenBSD, twoja partycja <i>/var</i> bedzie montowana
z opcjami <tt>nosuid</tt> oraz <tt>nodev</tt>.
Je¿eli zamierzasz korzystaæ z aplikacji w ramach chroot-a, mo¿esz
potrzebowaæ zmieniæ te opcje.
Oczywi¶cie, mo¿esz tak¿e potrzebowaæ zmiany tych opcji, nawet je¿eli nie korzystasz
z chroot-a.

</ul>

Jak wiêc widaæ, w niektórych przypadkach, programy lub ustawienia mog± 
byæ zmienione tak, by dzia³a³y w ¶rodowisku chroot(2).
W innych przypadkach trzeba bêdzie po prostu wy³±czyæ chroot(2) za pomoc± opcji 
<tt>-u</tt> demona httpd(8) w pliku 
<i><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=rc.conf&amp;sektion=8">/etc/rc.conf</a></i>

<h3>Przyk³ad chrootowania w aplikacji wwwcount</h3>
Jako przyk³ad procesu pozwalaj±cego na umieszczenie aplikacji w chroot(2)-cie
we¼miemy wwwcount, prosty licznik odwiedzin stron dostêpny w 
<a href="faq15.html#PkgMgmt">pakiecie</a>.
Bêd±c bardzo wydajnym narzêdziem, wwwcount nie wie nic na temat 
chroot(2)-owanego Apache'a, zatem nie bêdzie pracowa³ w domy¶lnej konfiguracji.

<p>
Na pocz±tek instalujemy pakiet
<a href="http://www.muquit.com/muquit/software/Count/Count.html">wwwcount</a>.
Konfigurujemy go i testujemy, a tak¿e odkrywamy ¿e wydaje siê nie dzia³aæ,
otrzymuj±c b³±d Apache "Internal Server Error".

Nastêpnie zatrzymujemy Apache'a i restartujemy z opcj± <tt>-u</tt>
i sprawdzamy, ¿e problemem jest chroot(2), nie konfiguracja.

<blockquote><pre>
# <b>apachectl stop</b>
/usr/sbin/apachectl stop: httpd stopped
# <b>httpd -u</b>
</pre></blockquote>

Po tym wszystkim, widzimy ¿e licznik dzia³a poprawnie, przynajmniej po 
zmianie w³a¶ciciela katalogu, tak by Apache (oraz CGI) móg³ zapisywaæ 
do plików tam umieszczonych.
Zatem, zdecydowanie mamy problem z chroot'em. Zatrzymujemy wiêc i uruchamiamy
Apache ponownie, z domy¶lmym chrootem.

<blockquote><pre>     
# <b>apachectl stop</b>
/usr/sbin/apachectl stop: httpd stopped
# <b>httpd</b>
</pre></blockquote>

<p>
Dobrym punktem wyj¶cia by³oby za³o¿yæ, ¿e wwwcount u¿ywa bibliotek
i innych plików do których nie ma dostêpu przez chroot.
Mo¿emy u¿yæ polecenia
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ldd&amp;sektion=1">ldd(1)</a>
by sprawdziæ zale¿no¶ci jakich wymaga CGI:

<blockquote><pre>
# <b>cd /var/www/cgi-bin/</b>
# <b>ldd Count.cgi</b>
Count.cgi:
         Start    End      Type Ref Name
         00000000 00000000 exe   1  Count.cgi
         03791000 237ca000 rlib  1  /usr/lib/libc.so.30.3
         03db4000 03db4000 rtld  1  /usr/libexec/ld.so
</pre></blockquote>

Ok, znale¼li¶my problem, dwa pliki które nie s± dostêpne w ¶rodowisku
chroot(2) Apache'a.
Kopiujemy je zatem:

<blockquote><pre>
     # <b>mkdir -p /var/www/usr/lib /var/www/usr/libexec</b>
     # <b>cp /usr/lib/libc.so.30.3 /var/www/usr/lib</b>
     # <b>cp /usr/libexec/ld.so /var/www/usr/libexec</b>
</pre></blockquote>

i sprawdzamy licznik ponownie.
 	 
<p>
Teraz program przynajmniej siê uruchamia i zwraca nam b³±d:
"Unable to open config file for reading".
Mamy postêp, lecz jeszcze nie skoñczyli¶my.
Normalnie plikiem konfiguracyjnym jest <tt>/var/www/wwwcount/conf</tt>, 
jednak w ¶rodowisku chroot wydaje siê  ¿e jest to 
<tt>/wwwcount/conf</tt>.
Mo¿emy wiêc albo przekompilowaæ program tak by korzysta³ z plików 
w miejscu gdzie s± teraz, albo przenie¶æ te dane.
Poniewa¿ zainstalowali¶my program z pakietu, po prostu przeniesiemy pliki.
Aby u¿ywaæ tej samej konfiguracji zarówno w ¶rodowisku chroot(2), jak
i normalnym, mo¿emy zrobiæ dowi±zanie symboliczne:
 	 
<blockquote><pre>
     # <b>mkdir -p /var/www/var/www</b>
     # <b>cd /var/www/var/www</b>
     # <b>ln -s ../../wwwcount wwwcount</b>
</pre></blockquote>

Zauwa¿my, ¿e link symboliczny bêdzie dzia³a³ wewn±trz chroota.
Ponownie testujemy... i znajdujemy jeszcze jedno zagadnienie.
Teraz wwwcount narzeka, ¿e nie mo¿e znale¼æ plików "strip image", 
których u¿ywa przy wy¶wietlaniu wiadomo¶ci.
Po krótkich poszukiwaniach, odnajdujemy je w 
<tt>/usr/local/lib/wwwcount</tt>, zatem musz± zostaæ skopiowane
do chroot'a.

<blockquote><pre>
# <b>tar cf - /usr/local/lib/wwwcount | (cd /var/www; tar xpf - )</b>
</pre></blockquote>

Testujemy ponownie... i wszystko dzia³a!

<p>
Zwróæ uwagê, ¿e skopiowali¶my tylko te pliki które s± absolutnie niezbêdne.
Generalnie, tylko minimalna ilo¶æ plików potrzebna do uruchomienia aplikacji
powinna byæ kopiowana do chroot'a.

<h3>Czy powinienem korzystaæ z funkcjonalno¶ci chroot-a?</h3>
W powy¿szym przyk³adzie, program by³ bardzo prosty, a mimo to natrafili¶my
na kilka ró¿nych problemów.

<p>
<i>Nie ka¿d± aplikacjê mo¿na lub powinno siê chroot(8)-owaæ.</i>

<p>
Celem jest bezpieczny serwer www, chroot(8) jest tylko narzêdziem
doskonal±cym to zadanie, lecz sam nie jest celem.
Pamiêtaj, pocz±tkowa konfiguracja chroot(2)-owanego Apache'a w OpenBSD
oznacza, ¿e u¿ytkownik z uprawnieniami którego dzia³a httpd(8), nie mo¿e
uruchamiaæ ¿adnych programów, nie mo¿e modyfikowaæ ¿adnych plików, 
a tak¿e nie mo¿e przejmowaæ to¿samo¶ci innych u¿ytkowników.
Trac±c te ograniczenia, tracisz bezpieczeñstwo, nie wa¿ne czy chrootowane
czy nie.

<p>
Niektóre aplikacje bywaj± bardzo proste, wiêc chroot(2)-owanie ich ma sens.
Inne bywaj± do¶æ skomplikowane i albo nie s± warte wysi³ku by umie¶ciæ
je w chroot(2), albo podczas kopiowania systemu w chroot, mo¿esz straciæ
korzy¶ci ¶rodowiska chroot(2).
Przyk³adowo, program OpenWebMail wymaga dostêpu do czytania i zapisu katalogów
z poczt±, katalogów domowych u¿ytkowników, a tak¿e musi mieæ mo¿liwo¶æ
dzia³ania jako jakikolwiek u¿ytkownik w systemie.
Usi³owanie wepchniêcia go w chroot jest zupe³nie bezcelowe, poniewa¿ w rezultacie
i tak pozbawisz siê wszystkich zalet chroot(2)-owania.
Nawet w przypadku aplikacji tak prostej jak nasza, musi ona zapisywaæ 
na dysk (by zapamiêtywaæ liczniki), wiêc <i>niektóre</i> korzy¶ci z chroot(2)-a s± tracone.
Generalnie, tylko minimum plików koniecznych by aplikacja dzia³a³a
powinno byæ kopiowane w chroot.

<p>
Usi³owanie chroot(2)-owania jakiejkolwiek aplikacji dzia³aj±cej z uprawnieniami
root-a jest bezcelowe, root generalnie mo¿e uciec z chroot(2)-a.

<p>
Nie zapomninaj tak¿e, ¿e w sytuacji gdy chrootowanie jakiej¶ aplikacji 
oka¿e siê bardzo trudne, mo¿esz nie aktualizowaæ systemu tak czêsto jak
powiniene¶.
Mo¿e to spowodowaæ, ¿e twój system bêdzie MNIEJ bezpieczny, ni¿ bardziej
zarz±dzalny system z wy³±czon± funkcjonalno¶ci± chroota.

<a name="rootshell"></a>
<h2>10.17 - Mogê zmieniæ pow³okê roota?</h2>
Czasem mówiono ¿e nie nale¿y zmieniaæ pow³oki u¿ytkownika root, aczkolwiek w OpenBSD nie
ma powodów by tego nie robiæ.

<p>
Domy¶ln± pow³ok± u¿ytkownika <i>root</i> w 
systemach OpenBSD jest 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ksh&amp;sektion=1">ksh</a>.

<p>
Tradycyjnym przykazaniem administratora Uniksa jest korzystanie 
jako root tylko ze statycznie skompilowanych pow³ok, poniewa¿ kiedy 
system przechodzi w tryb pracy pojedynczego u¿ytkownika (ang. single 
user), partycje nie nale¿±ce do tego u¿ytkownika nie s± montowane, zatem 
dynamicznie ³±czone pow³oki nie bêd± w stanie skorzystaæ z bibliotek 
zlokalizowanych w partycji <tt>/usr</tt>. Nie jest to co¶, o czym 
administrator systemu OpenBSD musi pamiêtaæ, poniewa¿ gdy system 
przejdzie w tryb pojedynczego u¿ytkownika to sam poprosi o wybranie 
pow³oki, za¶ domy¶ln± pow³ok± jest 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sh&amp;sektion=1">sh</a>.
W systemie OpenBSD standardowo znajduj± siê trzy pow³oki 
(<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=csh&amp;sektion=1">csh</a>, 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sh&amp;sektion=1">sh</a> 
oraz <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ksh&amp;sektion=1">ksh</a>). 
Wszystkie z nich s± zlinkowane statycznie, tak wiêc dostêpne s± równie¿ 
w trybie pojedynczego u¿ytkownika.


<a name="ksh"></a>
<h2>10.18 - Co jeszcze mo¿na zrobiæ z <i>ksh</i>? 

</h2>W systemie OpenBSD wywo³ywana poleceniem 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ksh&amp;sektion=1">ksh</a> 
pow³oka to w rzeczywisto¶ci 
<a href="http://web.cs.mun.ca/~michael/pdksh/">pdksh</a> (Public Domain 
Korn Shell). Ksh ma te same binaria co pow³oka 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sh&amp;sektion=1">sh</a>.

<p>U¿ytkownicy pos³uguj±cy siê swobodnie pow³ok± <i>bash</i> (czêsto 
spotykan± w systemie Linux), prawdopodobnie odnajd± w 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ksh&amp;sektion=1">ksh</a> 
wiele podobieñstw. Ksh(1) posiada wiêkszo¶æ funkcji spotykanych 
w pow³oce <i>bash</i>, w³±czaj±c w to dopisywanie nazw plików po 
naci¶niêciu klawisza Tab, redagowanie i przegl±danie listy wydanych 
wcze¶niej poleceñ za pomoc± klawiszy strza³ek oraz przeskakiwanie na 
pocz±tek/koniec redagowanego polecenia za pomoc± klawiszy CTRL-A/CTRL-E. 
Je¿eli potrzebne s± inne funkcje pow³oki <i>bash</i>, <i>bash</i> mo¿na
zainstalowaæ korzystaj±c z <a href="faq15.html#PkgMgmt">pakietów</a> lub 
<a href="faq15.html#Ports">pakietów</a>.

<p>Znak zachêty pow³oki <i>ksh</i> mo¿na z ³atwo¶ci± zmieniæ z 
domy¶lnego "$ " na co¶, co dostarczy u¿ytkownikowi wiêcej informacji 
przez ustawienie zmiennej <tt>PS1</tt>. Na przyk³ad, wstawienie 
nastêpuj±cej linii:

<blockquote><pre>
    export PS1='$PWD $ '
</pre></blockquote>


do pliku <tt>/etc/profile</tt> spowoduje wygenerowanie 
nastêpuj±cego znaku zachêty:

<blockquote><pre>
    /home/nick $
</pre></blockquote>

Zachêcamy te¿ do przeanalizowania pliku 
<a href="http://www.openbsd.org/cgi-bin/cvsweb/~checkout~/src/etc/ksh.kshrc?content-type=text/plain"><tt>/etc/ksh.kshrc</tt></a>,
w którym znajduje siê wiele przyk³adów tego, co mo¿na zamie¶ciæ w pliku 
<tt>.profile</tt>.

<p>
Dostêpna w OpenBSD pow³oka ksh(1) zosta³o rozszerzone o kilka
"specjalnych znaków" dla podstawowego znaku zachêty, PS1, podobnych
do tych wykorzystywanych w bashu.
Dla przyk³adu:
<blockquote>
<tt>\e - </tt>Wstaw znak ASCI - escape.<br>
<tt>\h - </tt>Nazwa hosta, bez nazwy domeny.<br>
<tt>\H - </tt>Pe³na nazwa hosta, ³±cznie z nazwa domeny.<br>
<tt>\n - </tt>Wstaw znak nowej linii.<br>
<tt>\t - </tt>Aktualny czas w formacie: HH:MM:SS (24-godzinnym).<br>
<tt>\u - </tt>Aktualna nazwa u¿ytkownika.<br>
<tt>\w - </tt>Aktualny katalog roboczy. $HOME jest skracany do `~'.<br>
<tt>\W - </tt>Nazwa aktualnego katalogu roboczego bez wiod±cej ¶cie¿ki.<br>
<tt>\$ - </tt>Wy¶wietli "#" dla root-a, "$" dla pozosta³ych u¿ytkowników.
</blockquote>

(na stronie manuala
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ksh&amp;sektion=1">ksh(1)</a>
znajdziesz wiêcej szczegó³ów a tak¿e znacznie wiêcej "znaków specjalnych"!
Zwróæ uwagê ¿e znak "$" ma specjalne znaczenie wewn±trz podwójnego cytowania,
zatem u¿ywaj go ostro¿nie)


<p>
Niektórzy mog± u¿yæ poni¿szego polecenia:

<blockquote><pre>
export PS1="\n\u@\H\n\w \\$ "
</pre></blockquote>

by otrzymaæ zbyt rozwlek³y ale w jaki¶ sposób u¿yteczny prompt.

<p>
<font color= "#0000e0">
<a href="index.html">[Spis tre¶ci]</a>
<a href="faq9.html">[Sekcja 9 - Migracja do OpenBSD]</a>
<a href="faq11.html">[Sekcja 11 - X Window System]</a>
</font>

<p>
<hr>
<a href= "index.html"><img height= "24" width= "24" src= "../../images/back.gif" border= "0" alt="[back]"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: faq10.html,v 1.137 ]<br>
$Translation: faq10.html,v 1.37 2007/11/07 18:13:08 tkniaz Exp $<br>
-->
$OpenBSD: faq10.html,v 1.31 2007/11/12 20:29:58 saad Exp $
</small>
</body></html>
