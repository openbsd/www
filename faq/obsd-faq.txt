
OpenBSD Frequently Asked Questions - Ver. 2.5
     _________________________________________________________________

   [2.4 logo]

   This FAQ is specifically designed for the 2.5 release of OpenBSD, but
   in some cases will work on earlier versions. This FAQ will take you
   through most critical steps to setting up your own OpenBSD system. The
   addressed questions will range from newbie to advanced users.
   Hopefully you will find this FAQ useful.

   This FAQ was recently updated to support the newest version of
   OpenBSD. To view information for previous versions, please refer to
   [1]FAQ section 11.0, or [2]errata.html.

   For some a text version of the faq would be much more handy. So please
   check out [3]obsd-faq.txt. Print it out, pass it to your friends. Add
   to it, (but make sure you send diffs to me).

   Any questions can be directed to: [4]faq@openbsd.org

   The Current FAQ maintainers are:
   [5]Eric Jackson
   [6]Wim Vandeputte
        _________________________________________________________________

  [7]1.0 - Introduction to OpenBSD

     * [8]1.1 - What is OpenBSD?
     * [9]1.2 - What platforms are supported?
     * [10]1.3 - Is OpenBSD really free?
     * [11]1.4 - Why might I want to use OpenBSD?
     * [12]1.5 - How can I help support OpenBSD?
     * [13]1.6 - Who maintains OpenBSD?

  [14]2.0 - Other OpenBSD information resources

     * [15]2.1 - Web Pages
     * [16]2.2 - Mailing Lists
     * [17]2.3 - Manual Pages
     * [18]2.4 - Reporting Bugs

  [19]3.0 - Obtaining OpenBSD

     * [20]3.1 - Buying an OpenBSD CD
     * [21]3.1.1 - Buying OpenBSD T-Shirts
     * [22]3.2 - Downloading via FTP or AFS
     * [23]3.3 - Obtaining Current Source Code

  [24]4.0 - Installation and Disk Setup

     * [25]4.1 - Installing from CD
     * [26]4.2 - Installing from FTP
     * [27]4.3 - Installing via DHCP
     * [28]4.3.1 - Upgrading from various versions of Openbsd
     * [29]4.4 - What files are needed for Installation?
     * [30]4.5 - Using the OpenBSD disklabel
     * [31]4.6 - Using fdisk
     * [32]4.7 - Adding extra disks in OpenBSD
     * [33]4.8 - How to swap to a file
     * [34]4.9 - Soft-updates
     * [35]4.10 - How much space do I need for an OpenBSD installation?
     * [36]4.11 - When I boot after installation of i386 OpenBSD it says
       "partition 3 id 0".
     * [37]4.12 - How do I get a dmesg from a boot floppy?
     * [38]4.13 - I changed scsi controllers and now I cannot boot
       OpenBSD. It just says: "reading boot.. Bad magic" ( Installing
       Boot blocks - i386 specific)
     * [39]4.14 - Multibooting OpenBSD

  [40]5.0 - Kernel Configuration and Setup

     * [41]5.1 - Why do I need a custom kernel?
     * [42]5.2 - Kernel configuration Options
     * [43]5.3 - Building your own kernel
     * [44]5.4 - Boot-time configuration

  [45]6.0 - Networking

     * [46]6.1 - Initial network setup
     * [47]6.2 - IPF, NAT
     * [48]6.3 - IPSEC
     * [49]6.4 - DHCP
     * [50]6.5 - PPP

  [51]7.0 - Keyboard controls

     * [52]7.1 - How do I remap the keyboard?
     * [53]7.2 - Is there gpm or the like in OpenBSD?

  [54]8.0 - General Questions

     * [55]8.1 - What are these kerberos warnings when I first login?
     * [56]8.2 - How do I change virtual terminals?
     * [57]8.3 - I forgot my root password..... WHAT DO I DO?!?
     * [58]8.4 - X craps out when I startup.. what am I doing wrong?
     * [59]8.5 - What is CVS, and how do I use it?
     * [60]8.6 - What is the ports tree?
     * [61]8.7 - What are packages?
     * [62]8.8 - Is there any way to use my floppy drive if it's not
       attached during boot?
     * [63]8.9 - OpenBSD Bootloader (i386 specific)

  [64]9.0 - Migrating from Linux

     * [65]9.1 - Simple tips for ex-linux users
     * [66]9.2 - Dual boot of Linux and OpenBSD

  [67]10.0 - System Administration

     * [68]10.1 - When I try to su to root it says that I'm in the wrong
       group
     * [69]10.2 - How do I duplicate a filesystem?
     * [70]10.3 - How do I get httpd, sendmail, etc to start up with the
       system?
     * [71]10.4 - Why do users get relaying access denied when they are
       remotely sending mail through my OpenBSD system?
     * [72]10.5 - I've set up POP, but I get errors when accessing my
       mail thru POP. What can i do?
     * [73]10.6 - Setting up a Secure HTTP Server using SSL(8)
     * [74]10.7 - I made changes to /etc/passwd with vi(1), but the
       changes didn't seem to take place. Why?
     * [75]10.8 - How do I add a user? or delete a user?
     * [76]10.9 - How do I create a ftp-only account?
     * [77]10.10 - Setting up user disk quota's

  [78]11.0 - OpenBSD 2.4 Specific Information

     * [79]11.1 - Why do I get UserDir errors when running httpd(8)?
     * [80]11.2 - Installing at a partition 4GB or higher (i386 specific)
     * [81]Log24.txt - Specific OpenBSD 2.4 Install Example

  [82]12.0 - Performance Tuning

     * [83]12.1 - Networking
     * [84]12.2 - Disk IO
     _________________________________________________________________

   [85][back] [86]www@openbsd.org
   $OpenBSD: obsd-faq.txt,v 1.5 1999/06/22 18:57:35 ericj Exp $

References

   1. http://www.openbsd.org/faq/faq24.html
   2. http://www.openbsd.org/errata.html
   3. http://www.openbsd.org/faq/obsd-faq.txt
   4. mailto:faq@openbsd.org
   5. mailto:ericj@openbsd.org
   6. mailto:wvdputte@openbsd.org
   7. http://www.openbsd.org/faq/faq1.html
   8. http://www.openbsd.org/faq/faq1.html#1.1
   9. http://www.openbsd.org/faq/faq1.html#1.2
  10. http://www.openbsd.org/faq/faq1.html#1.3
  11. http://www.openbsd.org/faq/faq1.html#1.4
  12. http://www.openbsd.org/faq/faq1.html#1.5
  13. http://www.openbsd.org/faq/faq1.html#1.6
  14. http://www.openbsd.org/faq/faq2.html
  15. http://www.openbsd.org/faq/faq2.html#2.1
  16. http://www.openbsd.org/faq/faq2.html#2.2
  17. http://www.openbsd.org/faq/faq2.html#2.3
  18. http://www.openbsd.org/faq/faq2.html#2.4
  19. http://www.openbsd.org/faq/faq3.html
  20. http://www.openbsd.org/faq/faq3.html#3.1
  21. http://www.openbsd.org/faq/faq3.html#3.1.1
  22. http://www.openbsd.org/faq/faq3.html#3.2
  23. http://www.openbsd.org/faq/faq3.html#3.3
  24. http://www.openbsd.org/faq/faq4.html
  25. http://www.openbsd.org/faq/faq4.html#4.1
  26. http://www.openbsd.org/faq/faq4.html#4.2
  27. http://www.openbsd.org/faq/faq4.html#4.3
  28. http://www.openbsd.org/faq/upgrade-minifaq.html
  29. http://www.openbsd.org/faq/faq4.html#4.4
  30. http://www.openbsd.org/faq/faq4.html#4.5
  31. http://www.openbsd.org/faq/faq4.html#4.6
  32. http://www.openbsd.org/faq/faq4.html#4.7
  33. http://www.openbsd.org/faq/faq4.html#4.8
  34. http://www.openbsd.org/faq/faq4.html#4.9
  35. http://www.openbsd.org/faq/faq4.html#4.10
  36. http://www.openbsd.org/faq/faq4.html#4.11
  37. http://www.openbsd.org/faq/faq4.html#4.12
  38. http://www.openbsd.org/faq/faq4.html#4.13
  39. http://www.openbsd.org/faq/faq4.html#4.14
  40. http://www.openbsd.org/faq/faq5.html
  41. http://www.openbsd.org/faq/faq5.html#5.1
  42. http://www.openbsd.org/faq/faq5.html#5.2
  43. http://www.openbsd.org/faq/faq5.html#5.3
  44. http://www.openbsd.org/faq/faq5.html#5.4
  45. http://www.openbsd.org/faq/faq6.html
  46. http://www.openbsd.org/faq/faq6.html#6.1
  47. http://www.openbsd.org/faq/faq6.html#6.2
  48. http://www.openbsd.org/faq/faq6.html#6.3
  49. http://www.openbsd.org/faq/faq6.html#6.4
  50. http://www.openbsd.org/faq/faq6.html#6.5
  51. http://www.openbsd.org/faq/faq7.html
  52. http://www.openbsd.org/faq/faq7.html#7.1
  53. http://www.openbsd.org/faq/faq7.html#7.2
  54. http://www.openbsd.org/faq/faq8.html
  55. http://www.openbsd.org/faq/faq8.html#8.1
  56. http://www.openbsd.org/faq/faq8.html#8.2
  57. http://www.openbsd.org/faq/faq8.html#8.3
  58. http://www.openbsd.org/faq/faq8.html#8.4
  59. http://www.openbsd.org/faq/faq8.html#8.5
  60. http://www.openbsd.org/faq/faq8.html#8.6
  61. http://www.openbsd.org/faq/faq8.html#8.7
  62. http://www.openbsd.org/faq/faq8.html#8.8
  63. http://www.openbsd.org/faq/faq8.html#8.9
  64. http://www.openbsd.org/faq/faq9.html
  65. http://www.openbsd.org/faq/faq9.html#9.1
  66. http://www.openbsd.org/faq/faq9.html#9.2
  67. http://www.openbsd.org/faq/faq10.html
  68. http://www.openbsd.org/faq/faq10.html#10.1
  69. http://www.openbsd.org/faq/faq10.html#10.2
  70. http://www.openbsd.org/faq/faq10.html#10.3
  71. http://www.openbsd.org/faq/faq10.html#10.4
  72. http://www.openbsd.org/faq/faq10.html#10.5
  73. http://www.openbsd.org/faq/faq10.html#10.6
  74. http://www.openbsd.org/faq/faq10.html#10.7
  75. http://www.openbsd.org/faq/faq10.html#10.8
  76. http://www.openbsd.org/faq/faq10.html#10.9
  77. http://www.openbsd.org/faq/faq10.html#10.10
  78. http://www.openbsd.org/faq/faq24.html
  79. http://www.openbsd.org/faq/faq24.html#11.1
  80. http://www.openbsd.org/faq/faq24.html#11.2
  81. http://www.openbsd.org/faq/log24.txt
  82. http://www.openbsd.org/faq/faq12.html
  83. http://www.openbsd.org/faq/faq12.html#12.1
  84. http://www.openbsd.org/faq/faq12.html#12.2
  85. http://www.openbsd.org/index.html
  86. mailto:www@openbsd.org


   [1][Back to Main Index]

                         1.0 - Introduction to OpenBSD
     _________________________________________________________________

1.1 - What is OpenBSD?

   The [2]OpenBSD project produces a freely available, multi-platform
   4.4BSD-based UNIX-like operating system. Our efforts place emphasis on
   portability, standardization, correctness, and security. [3]OpenBSD
   supports binary emulation of most binaries from SVR4 (Solaris),
   FreeBSD, Linux, BSDI, SunOS, and HPUX.

1.2 - On what systems does OpenBSD run?

   OpenBSD 2.5 will install and run on the following platforms:
     * [4]i386 - bootable
     * [5]sparc - bootable
     * [6]alpha - bootable
     * [7]hp300
     * [8]amiga
     * [9]mac68k
     * [10]powerpc
     * [11]pmax

     * the pmax port is not included on the 2.5 cd. But can be downloaded
       from any of the OpenBSD ftp sites

   * note * - bootable means that for those smart people who bought the
   cd, that it OpenBSD can be booted directly from the CD.

   Previous releases of OpenBSD also had ports for:
     * [12]arc
     * [13]mvme68k

   These were removed from the 2.4 release, but were included in 2.3 if
   you are interested. You can see updated information about specific
   platforms at [14]http://www.openbsd.org/plat.html

1.3 - Is OpenBSD really free?

   OpenBSD is all free. The binaries are free. The source is free. All
   parts of OpenBSD have reasonable copyright terms permitting free
   redistribution. This includes the ability to REUSE most parts of the
   OpenBSD source tree, either for personal or commercial purposes.
   OpenBSD has put NO further restrictions other than those implied by
   the original BSD license, which will allow greater applicability.
   Because of this, software which is written under stricter licenses
   cannot be included in the regular distribution of OpenBSD.

   For futher reading on other popular licenses read:
   [15]http://www.openbsd.org/policy.html.

   The maintainers of OpenBSD support the project largely from their own
   pockets. This includes the time spent programming for the project,
   equipment used to support the many ports, the network resources used
   to distribute OpenBSD to you, and the time spent answering questions
   and investigating users' bug reports. The OpenBSD developers are not
   independently wealthy and even small contributions of time, equipment,
   and resources make a big difference.

1.4 - Why might I want to use OpenBSD?

   New users frequently want to know whether OpenBSD is superior to some
   other free UNIX-like operating system. That question is largely
   un-answerable and is the subject of countless (and useless) religious
   debates. Do not, under any circumstances, ask such a question on an
   OpenBSD mailing list.

   Below are some reasons why we think OpenBSD is a useful operating
   system. Whether OpenBSD is right for you is a question that only you
   can answer.

     * OpenBSD runs on many different hardware platforms.
     * OpenBSD is thought of by many security professionals to be the
       most secure UNIX-like operating system as the result of a
       10-member 1.5-year long comprehensive source code security audit.
     * OpenBSD is a full-featured UNIX-like operating system available in
       source form at no charge.
     * OpenBSD integrates cutting-edge security technology suitable for
       building firewalls and private network services in a distributed
       environment.
     * OpenBSD benefits from strong on-going development in many areas,
       offering opportunities to work with emerging technologies with an
       international community of programmers and end-users.
     * OpenBSD offers opportunities for ordinary people to participate in
       the development and testing of the product.

1.5 - How can I help support OpenBSD?

   We are greatly indebted to the people and organizations that have
   contributed to the OpenBSD project. They are acknowledged by name
   here:

   [16]http://www.openbsd.org/donations.html

   OpenBSD has a constant need for several types of support from the user
   community. If you find OpenBSD useful, you are strongly encouraged to
   find a way to contribute. If none of the suggestions below are right
   for you, feel free to propose an alternative by sending e-mail to
   [17]donations@openbsd.org.

     * Buy an OpenBSD CD. It includes the current full release of
       OpenBSD, and is bootable on many platforms. It also generates
       revenue to support the OpenBSD project, and reduces the strain on
       network resources used to deliver the distribution via the
       Internet. This inexpensive two-CD set includes full source.
       Remember, your friends need their own copy!
     * Donate money. The project has a constant need for cash to pay for
       equipment, network connectivity, and expenses relating to CD
       publishing. Manufacturing CDs requires an up-front out-of-pocket
       investment for the OpenBSD developers, without guaranteed return.
       Send e-mail to [18]donations@openbsd.org to find out how to
       contribute. Even small donations make a profound difference.
     * Donate equipment and parts. The project has a constant need for
       general and specific hardware. Items such as IDE and SCSI disks,
       and various types of RAM are always welcome. For other types of
       hardware such as computer systems and motherboards, you should
       inquire as to current need. Write to [19]donations@openbsd.org to
       arrange for shipment.
     * Donate your time and skills. Programmers who enjoy writing
       operating systems are naturally always welcome, but there are
       literally dozens of other ways that people can be useful. Follow
       mailing lists and help answer new-user questions.
     * Help maintain documentation by submitting new FAQ material (to
       [20]faq@openbsd.org). Form a local user group and get your friends
       hooked on OpenBSD. Make a case to your employer for using OpenBSD
       at work. If you're a student, talk to your professors about using
       OpenBSD as a learning tool for Computer Science or Engineering
       courses. It's also worth mentioning one of the most important ways
       you should not try to "help" The OpenBSD project: do not waste
       your time engaging in operating system flame wars on Usenet
       newsgroups. It does not help the project to find new users and can
       cause substantial harm to important relationships that developers
       have with other developers.

1.6 - Who maintains OpenBSD?

   OpenBSD is maintained by a development team spread across many
   different countries. The project is coordinated by Theo de Raadt,
   located in Canada.

   [21][To Section 2.0 - Other OpenBSD information resources]
     _________________________________________________________________

   [22][back] [23]www@openbsd.org
   $OpenBSD: obsd-faq.txt,v 1.5 1999/06/22 18:57:35 ericj Exp $

References

   1. http://www.openbsd.org/faq/index.html
   2. http://www.openbsd.org/
   3. http://www.openbsd.org/
   4. http://www.openbsd.org/i386.html
   5. http://www.openbsd.org/sparc.html
   6. http://www.openbsd.org/alpha.html
   7. http://www.openbsd.org/hp300.html
   8. http://www.openbsd.org/amiga.html
   9. http://www.openbsd.org/mac68k.html
  10. http://www.openbsd.org/powerpc.html
  11. http://www.openbsd.org/pmax.html
  12. http://www.openbsd.org/arc.html
  13. http://www.openbsd.org/mvme68k.html
  14. http://www.openbsd.org/plat.html
  15. http://www.openbsd.org/policy.html
  16. http://www.openbsd.org/donations.html
  17. mailto:donations@openbsd.org
  18. mailto:donations@openbsd.org
  19. mailto:donations@openbsd.org
  20. mailto:faq@openbsd.org
  21. http://www.openbsd.org/faq/faq2.html
  22. http://www.openbsd.org/faq/index.html
  23. mailto:www@openbsd.org


   [1][Back to Main Index] [2][To Section 1.0 - Introduction to OpenBSD]
   [3][To Section 3.0 - Obtaining OpenBSD]

                   2.0 - Other OpenBSD information resources

2.1 - Web Pages of Interest

   The official website for the OpenBSD project is located at:
   [4]http://www.OpenBSD.org

   A lot of valuable information can be found here regarding about all
   aspects of the OpenBSD project.

   Additional information for laptop users can be found at:
   [5]http://www.monkey.org/openbsd-mobile/ and
   [6]http://www.cpio.net/openbsd/laptops/

2.2 - Mailing Lists

   The OpenBSD project maintains several popular mailing lists which
   users should subscribe to and follow. To subscribe to a mailing list,
   send an e-mail message to [7]majordomo@openbsd.org. That address is an
   automated subscription service. In the body of your message, on a
   single line, you should include a subscribe command for the list you
   wish to join. For example:

   subscribe announce

   The list processor will reply to you, asking for confirmation of your
   intent to join the list. The confirmation you send back to the list
   processor will be included in its reply to you. It will look something
   like this:

   auth 90855167 subscribe announce you@example.com

   Once you have confirmed your intent to join, you will be immediately
   added to the list, and the list processor will notify you that you
   were successfully added.

   To unsubscribe from a list, you will again send an e-mail message to
   [8]majordomo@openbsd.org. It might look like this:

   unsubscribe announce

   If you have any difficulties with the mailing list system, please
   first read the instructions. They can be obtained by sending an e-mail
   message to [9]majordomo@openbsd.org with a message body of "help".
   These are the currently-available OpenBSD mailing lists:

     * announce - Important announcements. This is a low-volume list.
     * tech - General technical discussions
     * misc - User questions and answers
     * bugs - Bugs received via sendbug(1) and discussions about them.
     * source-changes - Automated mailing of CVS source tree changes.
     * ports - Automated mailing of CVS source tree changes.
     * advocacy - Discussion of advocating OpenBSD.

   Archives of the OpenBSD mailing lists can be found by visiting the
   mailing lists web page: [10]http://www.openbsd.org/mail.html
   You can also get mail archives from
   [11]http://www.monkey.org/cgi-bin/wilma ,here they have searchable
   archives of the OpenBSD mailing lists.

   Another mailing list that may be of interest is
   [12]openbsd-mobile@monkey.org. Which is a discussion of the use of
   OpenBSD in mobile computing.

   To subscribe to this list use:

   'echo subscribe | mail "openbsd-mobile-request@monkey.org"'

   The archives for that can be found at:
   [13]http://www.monkey.org/openbsd-mobile/archive/

2.3 - Manual Pages

   OpenBSD comes with extensive documentation in the form of manual
   pages, as well as longer documents relating to specific applications.
   To access the manual pages and other documentation, be sure that you
   installed the man, misc, and text distributions.

   Here is a list of some of the most useful manual pages for new users:

     * [14]afterboot(8) - things to check after the first complete boot
     * [15]boot(8) - system boot strapping procedures
     * [16]passwd.conf(5) - format of the password configuration file
     * [17]adduser_proc(8) - procedure for adding new users
     * [18]adduser(8) - command for adding new users
     * [19]vipw(8) - edit the pass word file
     * [20]man(1) - display the on-line manual pages
     * [21]sendbug(1) - send a problem report (PR) about OpenBSD to a
       central support site.
     * [22]disklabel(8) - Read and write disk pack label.
     * [23]ifconfig(8) - configure network interface parameters.
     * [24]route(8) - manualy manipulate the routing tables.
     * [25]netstat(1) - show network status.
     * [26]reboot, halt(8) - Stopping and restarting the system.
     * [27]shutdown(8) - close down the system at a given time.
     * [28]boot_config(8) - how to change kernel configuration at boot

   Also, If you are one of the people who didn't install the man*.tar.gz
   package, you can find all the OpenBSD man pages on the web at
   [29]http://www.openbsd.org/cgi-bin/man.cgi.

   In general, if you know the name of a command or a manual page, you
   can read it by executing `man command'. For example: `man vi' to read
   about the vi editor. If you don't know the name of the command, or if
   `man command' doesn't find the manual page, you can search the manual
   page database by executing `apropos something' or `man -k something'
   where something is a likely word that might appear in the title of the
   manual page you're looking for. For example:

bsd# apropos "time zone"
tzfile (5) - time zone information
zdump (8) - time zone dumper
zic (8) - time zone compiler

   The parenthetical numbers indicate the section of the manual in which
   that page can be found. In some cases, you may find manual pages with
   identical names living in separate sections of the manual. For
   example, assume that you want to know the format of the configuration
   files for the cron daemon. Once you know the section of the manual for
   the page you want, you would execute `man n command' where n is the
   manual section number.

bsd# man -k cron
cron (8) - daemon to execute scheduled commands (Vixie Cron)
crontab (1) - maintain crontab files for individual users (V3)
crontab (5) - tables for driving cron
bsd# man 5 crontab

   In addition to the UNIX manual pages, there is a typesettable document
   set (included in the misc distribution). It lives in the
   /usr/share/doc directory. If you also installed the text distribution,
   then you can format each document set with a `make' in the appropriate
   subdirectory. The psd subdirectory is the Programmer's Supplementary
   Documents distribution. The smm subdirectory is the System Manager's
   Manual. The usd subdirectory is the UNIX User's Supplementary
   Documents distribution. You can perform your `make' in the three
   distribution subdirectories, or you can select a specific section of a
   distribution and do a `make' in its subdirectory. Some of the
   subdirectories are empty. By default, formatting the documents will
   result in Postscript output, suitable for printing. The Postscript
   output can be quite large -- you should assume 250-300% increase in
   volume. If you do not have access to a Postscript printer or display,
   you may also format the documents for reading on a terminal display.
   In each Makefile you'll need to add the flag -Tascii to each instance
   of the groff commands (or execute it by hand). Some of the documents
   use the ms formatting macros, and some use the me macros. The Makefile
   in each document subdirectory (eg, /usr/share/doc/usd/04.csh/Makefile)
   will tell you which one to use. For example:

bsd# cd /usr/share/doc/usd/04.csh
bsd# groff -Tascii -ms tabs csh.1 csh.2 csh.3 csh.4 csh.a csh.g > csh.txt
bsd# more csh.txt

   The UNIX manual pages are generally more current and trustworthy than
   the typesettable documents. The typesettable documents sometimes
   explain complicated applications in more detail than the manual pages
   do.

2.4 - Reporting Bugs

   Proper bug reporting is one of the most important responsibilities of
   end users. Very detailed information is required to diagnose most
   serious bugs. Developers frequently get bugs reports via e-mail such
   as these:

   Before submitting any bug report, please ready
   [30]http://www.openbsd.org/report.html

From: joeuser@example.com
To: bugs@openbsd.org
Subject: HELP!!!

I have a PC and it won't boot!!!!! It's a 486!!!!!

   Hopefully most people understand why such reports get summarily
   deleted. All bug reports should contain detailed information. If Joe
   User had really wanted his bug investigated, his bug report would have
   looked something like this:

From: smartuser@example.com
To: bugs@openbsd.org
Subject: 2.5 panics on an i386

After installing OpenBSD 2.5 from the CD which I purchased via your outstanding
on-line ordering system, I find that the system halts before the kernel even
gets loaded. After booting with a bootdisk and escaping to a shell. This is the
dmesg output:

OpenBSD 2.5-current (OSHIBANA) #2: Fri Jun  4 11:11:41 EDT 1999
    shinobi@oshibana:/sys/arch/i386/compile/OSHIBANA
cpu0: F00F bug workaround installed
cpu0: Intel Pentium (P54C) ("GenuineIntel" 586-class) 120 MHz
cpu0: FPU,V86,DE,PSE,TSC,MSR,MCE,CX8
BIOS mem  = 654336 conventional, 15728640 extended
real mem  = 16384000
avail mem = 13725696
using 225 buffers containing 921600 bytes of memory
mainbus0 (root)
bios0 at mainbus0: AT/286+(63) BIOS, date 08/20/96
bios0: apminfo 0xf02dc00c diskinfo 0xf02dc034 cksumlen 1 memmap 0xf02dc0b0
apm0 at bios0: Power Management spec V1.1
apm0: battery life expectancy 96%
apm0: AC on, battery charge high, charging, estimated 1:28 minutes
pci0 at mainbus0 bus 0: configuration mode 1 (no bios)
"Toshiba (2nd ID) Host-PCI" rev 0x11 at pci0 dev 0 function 0 not configured
"Chips and Technologies 65550" rev 0x04 at pci0 dev 4 function 0 not configured
isa0 at mainbus0
isadma0 at isa0
wdc0 at isa0 port 0x1f0-0x1f7 irq 14
wd0 at wdc0 drive 0: &ltTOSHIBA MK2720FC>
wd0: 1296MB, 2633 cyl, 16 head, 63 sec, 512 bytes/sec, 2654280 sec total
wd0: using 16-sector 16-bit pio transfers, lba addressing (128KB cache)
sb0 at isa0 port 0x220-0x237 irq 7 drq 1: dsp v3.02
midi0 at sb0: &ltSB MIDI UART>
audio0 at sb0
opl0 at sb0: model OPL3
midi at opl0 not configured
pccom0 at isa0 port 0x3f8-0x3ff irq 4: ns16550a, 16 byte fifo
pccom1 at isa0 port 0x2f8-0x2ff irq 3: ns16550a, 16 byte fifo
pccom2 at isa0 port 0x3e8-0x3ef irq 5: ns16550a, 16 byte fifo
vt0 at isa0 port 0x60-0x6f irq 1: generic VGA, 80 col, color, 8 scr, mf2-kbd
pms0 at vt0 irq 12
fdc0 at isa0 port 0x3f0-0x3f5 irq 6 drq 2
fd0 at fdc0 drive 0: 1.44MB 80 cyl, 2 head, 18 sec
pcic0 at isa0 port 0x3e0-0x3e1 iomem 0xd0000-0xd3fff
pcic0: controller 0 (Intel 82365SL Revision 1) has sockets A and B
pcmcia0 at pcic0 controller 0 socket 0
pcmcia1 at pcic0 controller 0 socket 1
biomask 40c0 netmask 42c0 ttymask 56c2
root on wd0a
pctr: 586-class performance counters and user-level cycle counter enabled
rootdev=0x0 rrootdev=0x300 rawdev=0x302

Thank you!

   If Joe User had a working OpenBSD system from which he wanted to
   submit a bug report, he would have used the sendbug(1) utility to
   submit his bug report to the GNATS problem tracking system. Obviously
   you can't use sendbug(1) when your system won't boot, but you should
   use it whenever possible. You will still need to include detailed
   information about what happened, the exact configuration of your
   system, and how to reproduce the problem. The sendbug(1) command
   requires that your system be able to deliver electronic mail
   successfully on the Internet.

   If you have submitted a bug report and you want to check its current
   status without annoying anyone, the best ways are:

     * Visit the GNATS tracking system:
       [31]http://cvs.openbsd.org/cgi-bin/wwwgnats.pl.
     * Look in the [32]bugs@openbsd.org list archives:
       [33]http://www.openbsd.org/mail.html.

   [34][Back to Main Index] [35][To Section 1.0 - Introduction to
   OpenBSD] [36][To Section 3.0 - Obtaining OpenBSD]
     _________________________________________________________________

   [37][back] [38]www@openbsd.org
   $OpenBSD: obsd-faq.txt,v 1.5 1999/06/22 18:57:35 ericj Exp $

References

   1. http://www.openbsd.org/faq/index.html
   2. http://www.openbsd.org/faq/faq1.html
   3. http://www.openbsd.org/faq/faq3.html
   4. http://www.openbsd.org/
   5. http://www.monkey.org/openbsd-mobile/
   6. http://www.cpio.net/openbsd/laptops/
   7. mailto:majordomo@openbsd.org
   8. mailto:majordomo@openbsd.org
   9. mailto:majordomo@openbsd.org
  10. http://www.openbsd.org/mail.html
  11. http://www.monkey.org/cgi-bin/wilma
  12. mailto:openbsd-mobile@monkey.org
  13. http://www.monkey.org/openbsd-mobile/archive/
  14. http://www.openbsd.org/cgi-bin/man.cgi?query=afterboot&apropos=0&sektion=8&format=html
  15. http://www.openbsd.org/cgi-bin/man.cgi?query=boot&apropos=0&sektion=8&format=html
  16. http://www.openbsd.org/cgi-bin/man.cgi?query=passwd.conf&apropos=0&sektion=5&format=html
  17. http://www.openbsd.org/cgi-bin/man.cgi?query=adduser_proc&apropos=0&sektion=8&format=html
  18. http://www.openbsd.org/cgi-bin/man.cgi?query=adduser&apropos=0&sektion=8&format=html
  19. http://www.openbsd.org/cgi-bin/man.cgi?query=vipw&apropos=0&sektion=8&format=html
  20. http://www.openbsd.org/cgi-bin/man.cgi?query=man&apropos=0&sektion=1&format=html
  21. http://www.openbsd.org/cgi-bin/man.cgi?query=sendbug&apropos=0&sektion=1&format=html
  22. http://www.openbsd.org/cgi-bin/man.cgi?query=disklabel&apropos=0&sektion=8&format=html
  23. http://www.openbsd.org/cgi-bin/man.cgi?query=ifconfig&apropos=0&sektion=8&format=html
  24. http://www.openbsd.org/cgi-bin/man.cgi?query=route&apropos=0&sektion=8&format=html
  25. http://www.openbsd.org/cgi-bin/man.cgi?query=netstat&apropos=0&sektion1&format=html
  26. http://www.openbsd.org/cgi-bin/man.cgi?query=reboot&apropos=0&sektion=8&format=html
  27. http://www.openbsd.org/cgi-bin/man.cgi?query=shutdown&apropos=0&sektion=8&format=html
  28. http://www.openbsd.org/cgi-bin/man.cgi?query=boot_config&apropos=0&sektion=8&format=html
  29. http://www.openbsd.org/cgi-bin/man.cgi
  30. http://www.openbsd.org/report.html
  31. http://cvs.openbsd.org/cgi-bin/wwwgnats.pl
  32. mailto:bugs@openbsd.org
  33. http://www.openbsd.org/mail.html
  34. http://www.openbsd.org/faq/index.html
  35. http://www.openbsd.org/faq/faq1.html
  36. http://www.openbsd.org/faq/faq3.html
  37. http://www.openbsd.org/faq/index.html
  38. mailto:www@openbsd.org


   [1][Back to Main Index] [2][To Section 2.0 - Other OpenBSD information
   resources] [3][To Section 4.0 - Installation and Disk Setup]

                            3.0 - Obtaining OpenBSD

3.1 - Buying an OpenBSD CD

   Purchasing an OpenBSD CD is generally the best way to get started.
   Visit the ordering page to purchase your copy:
   [4]http://www.openbsd.org/orders.html.

   There are many good reasons to own an OpenBSD CD:
     * CD sales support on-going development of OpenBSD.
     * Development of a multi-platform operating system requires constant
       investment in equipment.
     * Your support in the form of a CD purchase has a real impact on
       future development.
     * The CD contains binaries (and source) for all supported platforms.
     * The CD is bootable on several platforms, and can be used to
       bootstrap a machine without a pre-existing installed operating
       system.
     * The CD is useful for bootstrapping even if you choose to install a
       snapshot.
     * Installing from CD is faster! Installing from CD preserves network
       connectivity resources.
     * OpenBSD CD's always come with very nice stickers. You system isn't
       fully complete without these. You can only get these stickers by
       buying a CD set or donating hardware.

   If you're installing a release version of OpenBSD, you should use a
   CD. Snapshot releases can only be installed over the network.

3.1.1 - Buying OpenBSD T-Shirts

   Yes, OpenBSD now has t-shirts for your wearing enjoyment. You can view
   these at [5]http://www.OpenBSD.org/tshirts.html. Enjoy :)

3.2 - Downloading via FTP or AFS

   There are numerous international mirror sites offering FTP access to
   OpenBSD releases and snapshots. AFS access is also available. You
   should always use the site closest to you. Before you begin fetching a
   release or snapshot, you may wish to use ping and traceroute to
   determine which mirror site is nearest to you and whether that nearest
   mirror is performing adequately. Of course, your OpenBSD release CD is
   always closer than any mirror. Access information is here:

   [6]http://www.openbsd.org/ftp.html

3.3 - Obtaining Current Source Code

   Source to OpenBSD is freely redistributable and available at no
   charge. Generally the best way to get started with a current source
   tree is to install the source from the most recent CD and then
   configure AnonCVS to update it regularly. Information about AnonCVS,
   including how to set it up, is available here:

   [7]http://www.openbsd.org/anoncvs.html.

   or check [8]The OpenBSD FAQ

   If you don't have sufficient network bandwidth to support AnonCVS, or
   if your Internet access is via UUCP, you can still keep your source
   current by using CTM instead of AnonCVS. If that's your situation,
   then starting with a recent release CD is even more important.
   Information about CTM, including how to set it up, is available here:

   [9]http://www.openbsd.org/ctm.html.

   [10][Back to Main Index] [11][To Section 2.0 - Other OpenBSD
   information resources] [12][To Section 4.0 - Installation and Disk
   Setup]
     _________________________________________________________________

   [13][back] [14]www@openbsd.org
   $OpenBSD: obsd-faq.txt,v 1.5 1999/06/22 18:57:35 ericj Exp $

References

   1. http://www.openbsd.org/faq/index.html
   2. http://www.openbsd.org/faq/faq2.html
   3. http://www.openbsd.org/faq/faq4.html
   4. http://www.openbsd.org/orders.html
   5. http://www.openbsd.org/tshirts.html
   6. http://www.openbsd.org/ftp.html
   7. http://www.openbsd.org/anoncvs.html
   8. http://www.openbsd.org/faq/faq8.html#8.5
   9. http://www.openbsd.org/ctm.html
  10. http://www.openbsd.org/faq/index.html
  11. http://www.openbsd.org/faq/faq2.html
  12. http://www.openbsd.org/faq/faq4.html
  13. http://www.openbsd.org/faq/index.html
  14. mailto:www@openbsd.org


   [1][Back to Main Index] [2][To Section 3.0 - Obtaining OpenBSD] [3][To
   Section 5.0 - Kernel configuration and Disk Setup]

                      4.0 - Installation and disk setup.

4.1 - Installing from the OpenBSD CD

   Installing from a CD is definatly the BEST choice, but first you must
   have purchased a cd. You can obtain a cd from
   [4]http://www.openbsd.org/orders.html. If you are using either the
   i386, SPARC or Alpha platforms you can boot directly off the CD. If
   not, you will have to create a bootdisk. You can get the boot disk
   from ftp://ftp.openbsd.org/pub/OpenBSD/2.5/$ARCH/floppy25.fs

   To create this boot disk, use either the unix tool [5]dd(1) or MSDOS
   rawrite from the tools directory on the cd. Rawrite doesnt work if you
   are an NT user, so you can also use fdimage or ntrw.exe which are both
   also in the tools directory.

   To use dd, do the following:
# dd if=floppy25.fs of=/dev/fd0a

   or to whichever device you want to write the floppy binary to.

   After that is completed, boot from your media of choice, (cdrom or
   bootdisk) and answer the questions accordingly. Here is an example
   installation.

   [6]Example Install

4.2 - Installation via FTP

   The ftp installation is almost the same as the normal installation.
   The same bootdisk will be used.

   floppy25.fs

   Just like the CD install you will set up your disk, then when you
   specify install media you choose (f)tp. You must take care to give the
   proper settings when you are asked to configure your network. Have
   handy, your ipaddress (see below for dhcp), netmask, nameserver
   addresses, and default route. Once your network is configured
   correctly, you must choose the (f)tp installation option. You will be
   asked a few simple questions about proxys and passive or active
   transfers, and the you will be presented with a list of ftp servers.
   Select the one closest to you, and your on your way.

   Consult the [7]install text for help.

4.3 - Installation via DHCP

   Installation via DHCP is the same as ftp, except your system will use
   DHCP to configure your network. When you arrive at the network config
   option, choose DHCP and your network will be setup accordingly. The
   all you have to do is follow the remainder of the directions from ftp
   install above and you will be set.

   Consult the [8]install text for help.

4.4 - What files are needed for Installation?

   There are many packages containing the OpenBSD binaries, but which
   ones do you need to get your system up and running? Here is an
   overview of each package.

     * base25.tar.gz - Has the BASE OpenBSD system *NEEDED*
     * etc25.tar.gz - Has all the files in /etc *NEEDED*
     * comp25.tar.gz - Has the compiler and its tools, libs. *STRONGLY
       SUGGESTED*
     * man25.tar.gz - Holds man pages *STRONGLY SUGGESTED*
     * misc25.tar.gz - Holds misc info, setup docs
     * game25.tar.gz - Has the Games for OpenBSD *FUN*
     * xbase25.tar.gz - Has the base install for X11
     * xfont25.tar.gz - Holds X11's font server and fonts
     * xlink25.tar.gz - Has the X servers link kit
     * xserv25.tar.gz - Has X11's X servers
     * xshare25.tar.gz - Has manpages, locale settings, includes, etc for
       X

4.5 - Using the OpenBSD disklabel

   Be sure to check the [9]disklabel(8) man page!

   Disklabel is used to identify disk's and/or partitions. The main idea
   behind them is abstraction of disk hardware, since there exists
   several partitioning tables. A disklabel is a universal partitioning
   table. These labels tell the system everything about the disk, from
   the Maker to rpm's to track-to-track seek. This label resides on the
   beginning of the disk, this isto help bootstrap code use them (since
   most ROM based booting reads the first sectors of the first disk). It
   also will show you partitions and their types on your disk. Disklabel
   can, on some systems, be used to install bootstrap code.

   As an additional gain, using disklabels helps overcome architecture
   limitations on disk partitioning. For example on i386 you can only
   have 4 primary partitions, with disklabel you can put several labels
   on one partition (eg. 'swap', '/', '/usr' and '/var'). And you still
   have 3 more partitions available for other OSs!

   You can think of them as 'subpartitions' for installation purposes.
   But they are a necesity for kernel disk access based on geometry. And
   remember to use 'b' for the swap label, and 'a' for root filesystem
   (default names in kernel).

   To just view the current disklabel for your disk just do:
   # disklabel < disk-device name >
   This will give output similar to this:
# using MBR partition 3: type A6 off 64 (0x40) size 16777152 (0xffffc0)
# /dev/rwd0c:
type: ESDI
disk:
label: TOSHIBA MK2720FC
flags:
bytes/sector: 512
sectors/track: 63
tracks/cylinder: 16
sectors/cylinder: 1008
cylinders: 2633
total sectors: 2654064
rpm: 3600
interleave: 1
trackskew: 0
cylinderskew: 0
headswitch: 0           # milliseconds
track-to-track seek: 0  # milliseconds
drivedata: 0

16 partitions:
#        size   offset    fstype   [fsize bsize   cpg]
  a:  2071440    65583    4.2BSD     1024  8192    16   # (Cyl.   65*- 2120)
  b:    65520       63      swap                        # (Cyl.    0*- 65)
  c:  2654064        0    unused        0     0         # (Cyl.    0 - 2632)
  j:   512001  2137023    4.2BSD     1024  8192    16   # (Cyl. 2120*- 2627*)

   In this example, there are 4 labels - A, B, C, J. A is one main
   partition, B is swap, and J is another partition. C in all cases
   represents the full disk. This is helpful in showing what valuses in
   size, cyl, etc you have to work with. But with this command you cannot
   change any values, you can just view.

   To be able to edit your label's interactivly you would use the -E
   flag.
   Example:
# disklabel -E wd0
# using MBR partition 3: type A6 off 64 (0x40) size 16777152 (0xffffc0)

Treating sectors 64-16777216 as the OpenBSD portion of the disk.
You can use the 'b' command to change this.

Initial label editor (enter '?' for help at any prompt)
> ?
Available commands:
        p [unit]  - print label.
        M         - show entire OpenBSD man page for disklabel.
        e         - edit drive parameters.
        a [part]  - add new partition.
        b         - set OpenBSD disk boundaries.
        c [part]  - change partition size.
        d [part]  - delete partition.
        m [part]  - modify existing partition.
        r         - recalculate free space.
        u         - undo last change.
        s [path]  - save label to file.
        w         - write label to disk.
        q         - quit and save changes.
        x         - exit without saving changes.
        ? [cmnd]  - this message or command specific help.
Numeric parameters may use suffixes to indicate units:
        'b' for bytes, 'c' for cylinders, 'k' for kilobytes, 'm' for megabytes,
        'g' for gigabytes or no suffix for sectors (usually 512 bytes).
        Non-sector units will be rounded to the nearest cylinder.
Entering '?' at most prompts will give you (simple) context sensitive help.
> p
device: /dev/rwd0c
type: ESDI
disk:
label: TOSHIBA MK2720FC
bytes/sector: 512
sectors/track: 63
tracks/cylinder: 16
sectors/cylinder: 1008
cylinders: 2633
total sectors: 2654064
free sectors: 14193711
rpm: 3600

16 partitions:
#        size   offset    fstype   [fsize bsize   cpg]
  a:  2071440    65583    4.2BSD     1024  8192    16   # (Cyl.   65*- 2120)
  b:    65520       63      swap                        # (Cyl.    0*- 65)
  c:  2654064        0    unused        0     0         # (Cyl.    0 - 2632)
  j:   512001  2137023    4.2BSD     1024  8192    16   # (Cyl. 2120*- 2627*)
> q
No changes.

   In this example we get into disklabel's interactive mode. From here we
   can issue the command "?" asking for help. This gives us many commands
   we can use to add, delete, edit existing labels.

   There is a new feature on disklabel, to help installation. The '-f'
   flag writes a 'fstab' like file, if given a mount point for a label.
   This is only used at installation.

   To see an example install involving disklabel check [10]log25.txt

4.6 - Using fdisk

   First be sure to check the fdisk main page. [11]fdisk(8)

   Fdisk is a program to help with the maintenance of your partitions.
   This program is used at install time to set up your OpenBSD partition
   (this partition can contain several labels, each with
   filesystems/swap/etc.). It can divide space on your drives and set one
   active. This program will usually be used in Single User Mode ( boot
   -s ). Fdisk also sets the MBR on your various hard disks.

   For installation purposes, most times you'll only need ONE Openbsd
   partition, and then using disklabel to put a swap and a filesystem on
   it.

   To just view your partition table using fdisk just use:
   # fdisk fd0
   Which will give an output similar to this:
         Disk: fd0       geometry: 80/2/18 [2880 sectors]
         Offset: 0       Signatures: 0xAA55,0x0
                  Starting        Ending
          #: id  cyl  hd sec -  cyl  hd sec [     start -       size]
----------------------------------------------------------------------
         *0: A6    0   0   1 -   79   1  18 [         0 -       2880] OpenBSD
          1: 00    0   0   0 -    0   0   0 [         0 -          0] unused
          2: A7    0   0   2 -   79   1  18 [         1 -       2879] NEXTSTEP
          3: 00    0   0   0 -    0   0   0 [         0 -          0] unused

   In this example we are viewing the fdisk output of floppy drive. We
   can see the OpenBSD partition (A6) and its size. The * tells us that
   the OpenBSD partition is a bootable partition.

   In the previous example we just viewed our information. What if we
   want to edit our partition table? Well, to do so we must use the -e
   flag. This will bring up a command line prompt to interact with fdisk.

# fdisk -e wd0
Enter 'help' for information
fdisk: 1> help
        help            Command help list
        manual          Show entire OpenBSD man page for fdisk
        reinit          Re-initialize loaded MBR (to defaults)
        disk            Edit current drive stats
        edit            Edit given table entry
        flag            Flag given table entry as bootable
        update          Update machine code in loaded MBR
        select          Select extended partition table entry MBR
        print           Print loaded MBR partition table
        write           Write loaded MBR to disk
        exit            Exit edit of current MBR, without saving changes
        quit            Quit edit of current MBR, saving current changes
        abort           Abort program without saving current changes
fdisk: 1>

   It is perfectly safe in fdisk to go in and explore, just make sure to
   answer N to saving the changes and *DON'T* use the write command.

   Here is an overview of the commands you can use when you choose the -e
   flag.
     * help Display a list of commands that fdisk understands in the
       interactive edit mode.
     * reinit Initialize the currently selected, in-memory copy of the
       boot block.
     * disk Display the current drive geometry that fdisk has probed. You
       are given a chance to edit it if you wish.
     * edit Edit a given table entry in the memory copy of the current
       boot block. You may edit either in BIOS geometry mode, or in
       sector offsets and sizes.
     * flag Make the given partition table entry bootable. Only one entry
       can be marked bootable. If you wish to boot from an extended
       partition, you will need to mark the partition table entry for the
       extended partition as bootable.
     * update Update the machine code in the memory copy of the currently
       selected boot block.
     * select Select and load into memory the boot block pointed to by
       the extended partition table entry in the current boot block.
     * print Print the currently selected in-memory copy of the boot
       block and its MBR table to the terminal.
     * write Write the in-memory copy of the boot block to disk. You will
       be asked to confirm this operation.
     * exit Exit the current level of fdisk, either returning to the
       previously selected in-memory copy of a boot block, or exiting the
       program if there is none.
     * quit Exit the current level of fdisk, either returning to the
       previously selected in-memory copy of a boot block, or exiting the
       program if there is none. Unlike exit it does write the modified
       block out.
     * abort Quit program without saving current changes.

4.7 - Adding new disks in OpenBSD

   Well once you get your disk installed PROPERLY you need to use
   [12]fdisk(8) and [13]disklabel(8) to set up your disk in OpenBSD.
   Making sure that the partition ID is 'A6'. Once you have done this,
   OpenBSD will be able to recognize the new disk, and you need to create
   the filesystem on that disk using [14]newfs(8).

   bsd# newfs wd1a

   or so on using OpenBSD's disk numbering scheme
  wd0
  wd1
  wd2

   Edit fstab to mount the new disk at a mount point of your choice, and
   reboot.

   If you need to migrate an existing directory like /usr/bin. You should
   mount the new drive in /mnt and use cpio -pdum to copy /usr/bin to the
   /mnt directory. Edit the /etc/fstab file to show that /usr/bin will be
   mounted on the new drive. example:

   /dev/wd1a /usr/bin ffs rw 1 1

   Reboot into single user mode..boot -s Move the existing /usr/bin to
   /usr/bin-backup and create an empty /usr/bin. Then reboot the system,
   and whala!! the files are there!

4.8 - How do I swap to a file?

   With OpenBSD 2.5 came the introduction of [15]swapctl(8), which made
   dealing with swap devices much easier. Swapping to a file doesn't
   require a custom built kernel, But that can still be done, this faq
   will show you how to add swap space both ways.

   To swap to a file permanently, first make a kernel with vnd0c as swap.
   If you have wd0a as root filesystem, wd0b is the previous swap, use
   this line in the kernel configuration file (refer to compiling a new
   kernel if in doubt):

config          bsd     root on wd0a swap on wd0b and vnd0c dumps on wd0b

   Second make the file for swap. If you want a 32MB swapfile named
   /newswap do:

   # dd if=/dev/zero of=/newswap bs=1k count=32768

   Add a line to your /etc/fstab file to indicate where the new swap will
   be.

   /dev/vnd0c none sw 0 0

   Now boot with the new kernel. Then create the vnd0 device to use that
   file as a device:

   # vnconfig -c -v vnd0 /newswap

   And add it now to swap:

   # swapon /dev/vnd0c

   You can now see if it is working with:

   # pstat -s

4.9 - Softupdates

   Softupdates are experimental and are NOT recomended for regular users.

   Over the last few years Krik McKusick has been working on something
   called "soft updates". This is based on an idea proposed by Greg
   Ganger and Yale Patt that imposing a partial ordering on the buffer
   cache opertions would permit the requirement for synchronous writing
   of directory entries to be removed from the FFS code. Thus, a large
   performance increase of disk writing performance.

   To enable Softupdates your kernel must have option

   option FFS_SOFTUPDATES

   then you need to boot into single-user mode:

boot>boot -s
[snip]
bsd# tunefs -s enable <raw device>
bsd# reboot -n

   GOOD LUCK. Please direct all problem reports with as MUCH information
   as possible (kernel coredumps, tracebacks, etc) to [16]Costa. Do not
   waste his time with any other questions or incomplete problem reports.

4.10 - How much space do I need for an OpenBSD installation?

   The following are suggested sub-tree sizes for a full system install.
   The numbers include enough extra space to permit you to run a typical
   home system that is connected to the internet:

SYSTEM          /       /usr    /var    /usr/X11R6
alpha           56M     540M    27M     161M
amiga           45M     399M    24M      36M
arc             47M     268M    20M      60M
hp300           31M     234M    24M      47M
i386            35M     229M    24M      72M
mac68k          29M     232M    24M      36M
mvme68k         48M     448M    24M       -  (no Xserver)
pmax            50M     355M    24M      60M
sparc           40M     259M    24M      49M
powerpc         39M     423M    26M     124M

   When you are in the disklabel editor, you may choose to make your
   entire system have just an 'a' and 'b' partition. The 'a' partition
   you set up in disklabel will become your root partition, which should
   be the sum of all the 3 main values above (/, /usr, and /var) plus
   some space for /tmp. The 'b' partition you set up automatically
   becomes your system swap partition -- we recommend a minimum of 32MB
   but if you have disk to spare make it at least 64MB.

   However, we recommend you use many seperate partitions so that users
   cannot fill up your important partitions as easily, thus causing nasty
   denial of service problems. If you are extra cautious, you will make
   at least the following seperate partitions: / swap /usr /var /tmp
   /var/tmp /home.

4.11 - How do I get rid of in "partition 3 id 0" error on boot?

   This means that your MBR (Master Boot Record) was not installed
   properly or that your BIOS is not compatible with your current MBR. To
   solve this first try to reinstall the OpenBSD boot blocks. To do so
   use [17]intsallboot(8). For example, the most common usage is:

     * Boot from the OpenBSD bootdisk

     * # fsck /dev/rwd0a && mount /dev/wd0a /mnt
     * # cp /usr/mdec/boot /mnt/boot
     * # /usr/mdec/installboot -v /mnt/boot /usr/mdec/biosboot wd0

     Here substitute your disk devices for rwd0a & wd0a. This will
   install the boot blocks again.

     Then Reboot.

   If this doesn't work you still have a few more options. So, luck
   hasn't run out yet. The first is to use a bootloader such as OS-BS.
   The OpenBSD cd has the os-bs bootloader included in the tools
   directory. If you didn't purchase a CD-ROM, you can download os-bs
   from any of the OpenBSD ftp sites.

   pub/OpenBSD/2.5/tools/osbs135.exe

   and take some time to look through the web pages at
   [18]http://www.prz.tu-berlin.de/~wolf/os-bs.html

   There are also other commercial bootloaders or lilo that you can use
   for multi-booting.

   Here is a simple outline of how to get lilo onto your system.

     * Boot a DOS floppy and do a fdisk /MBR. Make sure you do that on
       the drive you'll be booting from.
     * Boot from a linux disk and install LILO & chain it to your OpenBSD
       boot block.

   For further instructions read [19]INSTALL.linux

4.12 - How do I get a dmesg from a boot floppy?

   RAMDISK images (boot floppies) do not ship with the dmesg utility.
   They do, however, have the /kern filesystem mounted. To copy the dmesg
   information to a file, do a:
# cat /kern/msgbuf >mydmesg

4.13 - Installing bootblocks (i386 specific)

   PC BIOS's can only deal with disk geometries with 1024 cylinders or
   less. Since most disks these days have more than 1024 cylinders, most
   PC scsi controllers "translate" the real disk geometry into something
   that fits within the BIOS's parameters. However, not all scsi
   controllers "translate" the geometry in the same way. If you change
   scsi controllers and they use a different "translated" geometry you
   will be unable to load the second stage boot loader (and thus unable
   to load the kernel) because the first stage boot loader contains a
   list of the blocks that comprise /boot in terms of the "translated"
   geometry. To fix this, just boot from a boot floppy and at the boot
   prompt, type "b hd0a:/bsd" to boot from the first hard disk (and not
   the floppy). Your machine should come up normally. You now need to
   update the first stage boot loader (aka the boot block). This is also
   the same way to for any disk device, ide disks and scsi disks in
   OpenBSD.
   To do this, assuming your boot disk is sd0:
cd /usr/mdec; ./installboot /boot biosboot sd0

4.14 - Multibooting OpenBSD

   OpenBSD & NT

   To multiboot OpenBSD and NT, you can use NTloader. The bootloader the
   NT uses. To multi-boot with NT, you need a copy of your OpenBSD pbr.
   After running installboot, you can copy it something like this:

# dd if=/dev/rsd0a of=openbsd.pbr count=1

   Now boot NT and put openbsd.pbr in c:. Add a line like this to the end
   of c:\boot.ini:

c:\openbsd.pbr="OpenBSD"

   When you reboot, you should be able to select OpenBSD from the NT
   loader menu. There is much more information available about NTloader
   at the [20]NTLDR Hacking Guide.

   OpenBSD & Windows or DOS

   To boot OpenBSD along with Windows 3.1, Windows95, or DOS you must
   simply put a boot loader on the system that can handle these OS's.
   Some bootloaders of choice are [21]osbs20b8.zip or [22]The Ranish
   Partition Manager. Both of these are known to be able to boot OpenBSD
   partitions.

   OpenBSD & Linux

   Please refer to [23]INSTALL.linux, which gives indepth instructions on
   getting OpenBSD working with Linux.

   [24][Back to Main Index] [25][To Section 3.0 - Obtaining OpenBSD]
   [26][To Section 5.0 - Kernel configuration and Disk Setup]
     _________________________________________________________________

   [27][back] [28]www@openbsd.org
   $OpenBSD: obsd-faq.txt,v 1.5 1999/06/22 18:57:35 ericj Exp $

References

   1. http://www.openbsd.org/faq/index.html
   2. http://www.openbsd.org/faq/faq3.html
   3. http://www.openbsd.org/faq/faq5.html
   4. http://www.openbsd.org/orders.html
   5. http://www.openbsd.org/cgi-bin/man.cgi?query=dd&apropos=0&sektion=1&format=html
   6. http://www.openbsd.org/faq/log25.txt
   7. http://www.openbsd.org/faq/log25.txt
   8. http://www.openbsd.org/faq/log25.txt
   9. http://www.openbsd.org/cgi-bin/man.cgi?query=disklabel&apropos=0&sektion=8&format=html
  10. http://www.openbsd.org/faq/log25.txt
  11. http://www.openbsd.org/cgi-bin/man.cgi?query=fdisk&apropos=0&sektion=8&format=html
  12. http://www.openbsd.org/cgi-bin/man.cgi?query=fdisk&apropos=0&sektion=8&format=html
  13. http://www.openbsd.org/cgi-bin/man.cgi?query=disklabel&apropos=0&sektion=8&format=html
  14. http://www.openbsd.org/cgi-bin/man.cgi?query=newfs&apropos=0&sektion=8&format=html
  15. http://www.openbsd.org/cgi-bin/man.cgi?query=swapctl&sektion=8&format=html
  16. mailto:csapuntz@openbsd.org
  17. http://www.openbsd.org/cgi-bin/man.cgi?query=installboot&sektion=8&format=html
  18. http://www.prz.tu-berlin.de/~wolf/os-bs.html
  19. http://www.openbsd.org/faq/INSTALL.linux
  20. http://www.dorsai.org/~dcl/publications/NTLDR_Hacking/
  21. http://www.freebird.org/sw-map/bootmanager.html
  22. http://www.users.intercom.com/~ranish/part/
  23. http://www.openbsd.org/faq/INSTALL.linux
  24. http://www.openbsd.org/faq/index.html
  25. http://www.openbsd.org/faq/faq3.html
  26. http://www.openbsd.org/faq/faq5.html
  27. http://www.openbsd.org/faq/index.html
  28. mailto:www@openbsd.org


   [1][Back to Main Index] [2][To Section 4.0 - Installation and Disk
   Setup] [3][To Section 6.0 - Networking]

                   5.0 - Kernel Configuration and Disk Setup

5.1 - Why would I want to create my own custom kernel?

   Its a joyous occasion when you as a user get to configure and build
   your own custom kernel. Why would you want to do this though?

     * You can define which drivers your computer has support for.
     * You can get rid of uneeded drivers in the GENERIC kernel
     * Speed up boot times
     * Remove default options or add options which may not have been
       enabled by default

5.2 - Kernel Configuration Options

   Kernel Configuration Options are options that you add to your kernel
   configuration that place certain features into your kernel. This
   allows you to have exactly the support you want, without having
   support for uneeded devices. There are multitudes of options that
   allow you to customize you kernel. Here we will go over only some of
   them, one's that are most commonly used. Check the [4]options(4) man
   page for a more complete list of options. You can also check the
   example configuration files that are availible for your architecture.

     * [5]Alpha Kernel Conf Files
     * [6]i386 Kernel Configuration files
     * [7]mac68k Kernel Configuration files
     * [8]pmax Kernel Configuration Files
     * [9]sparc Kernel Configuration Files
     * [10]Other Arch's

   Look closely at these files and you will notice a line like:
   include "../../../conf/GENERIC"
   This means that it *IS* referencing yet another configuration file.
   This file stores non arch-dependent options. So when creating your
   Kernel Config be sure to look through [11]/sys/conf/GENERIC and see
   what you want. There ARE options in there that are NEEDED.

   OpenBSD has a great many compatibility options which allow you to use
   binaries from other OS's. Not all are availibly on every
   architechture, so be sure to read the man pages for each option to see
   if your arch is supported.

     * [12]compat_svr4(8) - Compatibility with SVR4 binaries.
     * [13]compat_bsdos(8) - Compatibility with BSD/OS binaries.
     * [14]compat_linux(8) - Compatibility with Linux binaries.
     * [15]compat_sunox(8) - Compatibility with SunOS binaries.
     * [16]compat_ultrix(8) - Compatibility with Ultrix binaries.
     * [17]compat_freebsd(8) - Compatibility with FreeBSD binaries.
     * compat_hpux - Compatibility with HP-UX binaries. Only availible on
       some m68k arch's.
     * [18]compat_ibcs2(8) - Compatibility to run ibcs2 binaries.
     * compat_osf1 - Run Digital Unix binaries. Availible only on Alpha
       platform.

5.3 - Building your own kernel

   Full instructions for creating your own custom kernel are in the
   [19]afterboot(8) man page.

   To compile your kernel from the cdrom do the following:

#cd /somewhere
#cp /usr/src/sys/arch/$ARCH/conf/SOMEFILE .
#vi SOMEFILE (to make the changes you want)
#config -s /usr/src/sys -b . SOMEFILE
#make

   To compile a kernel inside a writeable source tree do the following:

#cd /sys/arch/$ARCH/conf
#vi SOMEFILE (to make any changes you want)
#config SOMEFILE (read more about it here : [20]config(8))
#cd ../compile/SOMEFILE
#make

   Where $ARCH is the architecture you are using (e.g. i386). You can
   also do a make depend to make the dependencies for the next time you
   compile your kernel.

   To move your kernel into place.

#cp /bsd /bsd.old
#cp /sys/arch/$ARCH/compile/SOMEFILE/bsd /bsd

   To revert to your old kernel at boot you need to just

boot>bsd.old

   and your old kernel will be loaded instead of /bsd.

5.4 - Boot Time Configuration

   Sometimes when booting your system you might notice that the kernel
   finds your device but maybe at the wrong IRQ. And maybe you need to
   use this device right away. Well, without rebuilding the kernel you
   can use OpenBSD's boot time kernel configuration. This will only
   correct your problem for one time. If you reboot, you will have to
   repeat this procedure. So, this is only meant as a temporary fix, and
   you should correct the problem by fixing and recompiling your kernel.
   Your kernel does however need option BOOT_CONFIG in the kernel, which
   GENERIC does have.

   Most of this document can be found in the man page [21]boot_config(8)
   To boot into the User Kernel Config, or UKC, at boot time us the -c
   option.

Boot> boot wd0a:/bsd -c

   Or whichever kernel it is you want to boot. Doing this will bring up a
   UKC prompt. From here you can issue commands directly to the kernel
   specifying devices you want to change or disable or even enable.

   Here is a list of common commands in the UKC.

   add device - Add a device through copying another

   change devno | device - Modify one or more devices

   disable devno | device - Disable one or more devices

   enable devno | device - Enable one or more devices

   find devno | device - Find one or more devices

   help - Short summary of these commands

   list - List ALL known devices

   exit/quit - Continue Booting

   show [attr [val]] - Show devices with an attribute and optional with a
   specified value

   Once you get your device configured, use quit or exit and continue
   booting. After so you should correct your Kernel configuration and
   Compile a new kernel. Refer to [22]Building your own kernel for help.

   [23][Back to Main Index] [24][To Section 4.0 - Installation and Disk
   Setup] [25][To Section 6.0 - Networking]
     _________________________________________________________________

   [26][back] [27]www@openbsd.org
   $OpenBSD: obsd-faq.txt,v 1.5 1999/06/22 18:57:35 ericj Exp $

References

   1. http://www.openbsd.org/faq/index.html
   2. http://www.openbsd.org/faq/faq4.html
   3. http://www.openbsd.org/faq/faq6.html
   4. http://www.openbsd.org/cgi-bin/man.cgi?query=options&apropos=0&sektion=4&format=html
   5. http://www.openbsd.org/cgi-bin/cvsweb/src/sys/arch/alpha/conf/
   6. http://www.openbsd.org/cgi-bin/cvsweb/src/sys/arch/i386/conf/
   7. http://www.openbsd.org/cgi-bin/cvsweb/src/sys/arch/mac68k/conf/
   8. http://www.openbsd.org/cgi-bin/cvsweb/src/sys/arch/pmax/conf/
   9. http://www.openbsd.org/cgi-bin/cvsweb/src/sys/arch/sparc/conf/
  10. http://www.openbsd.org/cgi-bin/cvsweb/src/sys/arch/
  11. http://www.openbsd.org/cgi-bin/cvsweb/src/sys/conf/GENERIC
  12. http://www.openbsd.org/cgi-bin/man.cgi?query=compat_svr4&sektion=8&apropos=0&manpath=OpenBSD+Current
  13. http://www.openbsd.org/cgi-bin/man.cgi?query=compat_bsdos&sektion=8&apropos=0&manpath=OpenBSD+Current
  14. http://www.openbsd.org/cgi-bin/man.cgi?query=compat_linux&sektion=8&apropos=0&manpath=OpenBSD+Current
  15. http://www.openbsd.org/cgi-bin/man.cgi?query=compat_sunos&sektion=8&apropos=0&manpath=OpenBSD+Current
  16. http://www.openbsd.org/cgi-bin/man.cgi?query=compat_ultrix&sektion=8&apropos=0&manpath=OpenBSD+Current
  17. http://www.openbsd.org/cgi-bin/man.cgi?query=compat_freebsd&sektion=8&apropos=0&manpath=OpenBSD+Current
  18. http://www.openbsd.org/cgi-bin/man.cgi?query=compat_ibcs2&sektion=8&apropos=0&manpath=OpenBSD+Current
  19. http://www.openbsd.org/cgi-bin/man.cgi?query=afterboot&apropos=0&sektion=8&format=html
  20. http://www.openbsd.org/cgi-bin/man.cgi?query=config&apropos=0&sektion=8&format=html
  21. http://www.openbsd.org/cgi-bin/man.cgi?query=boot_config&apropos=0&sektion=8&format=html
  22. http://www.openbsd.org/faq/faq5.html#5.3
  23. http://www.openbsd.org/faq/index.html
  24. http://www.openbsd.org/faq/faq4.html
  25. http://www.openbsd.org/faq/faq6.html
  26. http://www.openbsd.org/faq/index.html
  27. mailto:www@openbsd.org


   [1][Back to Main Index] [2][To Section 5.0 - Kernel configuration and
   Disk Setup] [3][To Section 7.0 - Keyboard controls]

                               6.0 - Networking
     _________________________________________________________________

6.1 - Initial Network Setup

  Interfaces

   Here we assume you have all your network interfaces working, and a
   basic TCP/IP knowledge. If not, go to the [4]Kernel Configuration and
   Setup section, and/or read a nice intro to TCP/IP. Other recommended
   reading are the [5]ifconfig(8) and [6]netstat(1) man pages.

   All your interfaces should be listed with:

# ifconfig -a

lo0: flags=8009<UP,LOOPBACK,MULTICAST>
        inet 127.0.0.1 netmask 0xff000000
lo1: flags=8008<LOOPBACK,MULTICAST>
xl0: flags=8843<UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST>
        media: Ethernet 100baseTX half-duplex
        inet 10.1.1.1 netmask 0xffffff00 broadcast 10.1.1.255
sl0: flags=c010&ltPOINTOPOINT,LINK2,MULTICAST>
        inet 10.1.1.1 netmask 0xffffff00 broadcast 10.1.1.255
sl0: flags=c010<POINTOPOINT,LINK2,MULTICAST>
sl1: flags=c010<POINTOPOINT,LINK2,MULTICAST>
ppp0: flags=8010<POINTOPOINT,MULTICAST>
ppp1: flags=8010<POINTOPOINT,MULTICAST>
tun0: flags=10<POINTOPOINT>
tun1: flags=10<POINTOPOINT>
enc0: flags=8<LOOPBACK>

   First there is lo0 the loopback interface. It MUST have the assigned
   address of 127.0.0.1 no matter what network setup you use. The next
   important one is xl0 in this example (could be neX or epX depending on
   the brand), which is a board itself. Look it has UP and RUNNING flags
   on, as lo0 but no other interface have them. That means oviously they
   are working. Your interface could be down if you never configured it,
   and look like the other interfaces. The others are not part of this
   section, as sl and ppp are for serial line comunication, tun is a
   pseudo-device for tunneling and enc a pseudo-device for encryption.

   If xl0 was uninitialized, you can assign it an address creating a
   ascii file /etc/hostname.xl0 having a string like this:

inet mona 255.255.255.0 NONE

   Here "mona" is a name that exists as a record in /etc/hosts:

10.1.1.1        mona    mona.openbsd.org.ar

   Now check that you have a file /etc/myname and a file /etc/mygate. If
   you don't have them, you need to create them. If your gateway is a
   machine named "wintermute" wich is also in the /etc/hosts, use this
   commands:

# echo "mona" >> /etc/myname; echo "wintermute" >> /etc/mygate

   Ok, you are done for a standalone system, but to activate your
   configuration now (without rebooting) do:

# sh /etc/netstart

   This will give you a few errors, but don't worry as all them are
   concerning 127.0.0.x (loopback)

   Note: if you want to use the system as a gateway, later there's a
   "Firewall Setup" section, but you need to read all this first.

   Now check your routes are ok (here we use -n aso to make it simpler to
   look at):

# netstat -rn
Routing tables

Internet:
Destination        Gateway            Flags     Refs     Use    Mtu
Interface
default            10.1.1.254         UGS         0        0      -  xl0
10.1.1/24          link#1             UC          0        0      -  xl0
10.1.1.1           127.0.0.1          UGHS        0        0      -  lo0
10.1.1.254         link#1             UHL         1        0      -  xl0
127/8              127.0.0.1          UGRS        0        0      -  lo0
127.0.0.1          127.0.0.1          UH          3       24      -  lo0
224/8              link#1             UCS         0        0      -  xl0

Encap:
Source address/netmask          Port  Destination address/netmask     Port Prot
o SA(Address/SPI/Proto)

   (The gateway here is shown as 10.1.1.254)

  IP Aliasing

   If you want to map more than one IP address on a single network
   interface, you need to assign an "alias" to it. The way to do it on
   OpenBSD is simply assigning the interface another IP with the "alias"
   option like this:

# ifconfig xl0 alias 10.1.1.2 netmask 255.255.255.255

   Here ne2 is assigned another IP number (remember it already has
   10.1.1.1). Note the netmask used! Don't use 255.255.255.0 in this kind
   of cases (both numbers are on the same subnet), only ONE address shoud
   handle the subnet. If you do such kind of misconfiguration the
   following error appears:

ifconfig:SIOCAIFADDR: File exists

   Now let's change the configuration file for this, /etc/ifaliases. Add
   to it this line:

xl0   10.1.1.2 255.255.255.255

  DNS Client Setup

   Let's assume your DNS servers are 125.2.3.4 and 125.2.3.5, and your
   machine name belongs to the domain yourdomain.com. Add the following
   lines to your /etc/resolv.conf file:

domain yourdomain.com
nameserver 125.2.3.4
nameserver 125.2.3.5

  Gateway Setup

   This is a minimal explanation, only for internal/secure networks! Read
   Firewall Setup if you plan to put a gateway to internet.

   If you want to put a host that connects two subnets, and you want it
   to "forward" any packet from them modify /etc/sysctl.conf line that
   toggles the forwarding variable on bootup:

net.inet.forwarding=1

   To make the changes without booting:

# sysctl -w net.inet.ip.forwarding=1
net.inet.ip.forwarding: 0 -> 1

   Now modify the routes on the other hosts on both sides.

6.2 - IPF/NAT Setup

  IPF and IPNAT Setup

   The IPFilter package was created to handle with two tasks, dealing
   with packet level forwarding permissions and mapping hosts/subnets to
   a range of external addresses. The configuration files are
   /etc/ipf.rules and /etc/ipnat.rules, and also part of /etc/

   rc.conf to activate them at boot time. You also need to have
   net.inet.ip.forwarding=1! You also need a kernel compiled with option
   IPFILTER and IPFILTER_LOG (the GENERIC one present in the installation
   have them).

   There are a lot of nice examples on /usr/share/ipf/ for both. We
   recommend you to choose the one closer to what you want, and modify it
   to fit your needs.

  IPF

   Modify rc.conf so it has IPFILTER=YES. The file /etc/ipf.rules has a
   simple yet powerful syntax. Here we deal with the most common ways of
   usage, for a more strict definition see man 5 ipf. Here is assumed xl0
   as the external interface to internet, on this one uses to have more
   rules than internal interfaces.

   Configurations usually start letting everything come and go, and then
   apply the necesary rules to block offending packets. So this is first:

pass out from any to any
pass in from any to any

   Now lets block any incoming connection to port 82 tcp (eg. there's an
   internal network report agent using http running on several hosts):

block in on xl0 proto tcp from any to any port = 82

   This rule means:

   "Block all incoming packets on xl0 interface whose protocol is TCP no
   matter destination/origin using port 82"

   If you want to log all rejected packets add "log" after "block in", or
   "log quick" if you don't want it to send a message to every console
   root is logged in.

   Also a typical rule is to block rpc portmap:

block in log on xl0 proto udp from any to any port = sunrpc

  IPNAT

   Based on RFC 1631, ipnat provides an easy way to map internal networks
   on a range of external addresses. This is very useful if you don't
   have officially asigned addresses for every host on your internal
   network. When you set up private/internal networks you can take
   advantage of reserved address blocks like:

10.0.0.0, 192.168.0.0, and 172.16.0.0

   If you have an internal network using 192.168.0.0 and you want to give
   them access to internet using OpenBSD (of course!) and a ppp
   connection using address 200.1.2.3, use this rule:

map ppp0 192.168.0.0/16 -> 200.1.2.3/32

   Note the /16 and /32, this means:

   "Any outgoing connection whose comming from an address matching the
   first 16 bits of 192.168.0.0 should be mapped on local address
   200.1.2.3 (only one address since /32 means every bit)"

   But here arises a problem. You are assigning a lot of addresses to
   only ona (or a few) address. The way to go arount it is to map TCP and
   UDP ports to a certain range with the option "portmap". But remember
   ICMP doesnt work this way, it only has an ID field (usually based on
   process number). So now its like this:

map ppp0 192.168.0.0/16 -> 200.1.2.3/32 portmap tcp/udp 1024:65000
map ppp0 192.168.0.0/16 -> 200.1.2.3/32

   This way things work better. If you have a dynamic address assignment
   (like regular dialup modem account), you can do this:

map ppp0 192.168.0.0/16 -> ppp0/32 portmap tcp/udp 1024:65000
map ppp0 192.168.0.0/16 -> ppp0/32

  Redirecting ports

   This is another very handy feature of IPNAT. If you have a host on the
   internal network (using private addresses), and you want to let
   incoming connections to it, you just need a simple redirect rule. For
   example, if you have a web server on internal network at 10.2.2.7
   listening on port 80, and want it to be accesible from the outside
   simply redirecting external IP 120.2.3.4 on xl0, just add this rule to
   /etc/ipnat.rules:

rdr xl0 120.2.3.4 port 80 -> 10.2.2.7 port 80

   This is a little graph:

Internet <--> (xl0) OpenBSD (xl1) <--> LAN <--> 10.2.2.7
            128.2.3.4      whatever  10.2.2.0   Web server

   Remember to activate kernel must have option IP FORWARDING. Also
   remember that EVERY packet MUST pass through the OpenBSD box, i.e. you
   can't redirect ports to hosts on the same network and address external
   to the OpenBSD box.

6.3 - IPSEC

   Be sure to check [7]vpn man page.

   You can also check [8]Codetalker

6.4 - DHCP

   This section is not yet completed. Please Check back soon.

6.5 - PPP

   PPP is generally an easy thing to set up. What follows is a basic
   intro based on the information provided in /etc/ppp and the [9]ppp(8)
   manual pages. These are highly suggested reading before attempting to
   setup PPP or even reading this FAQ entry. If you have read these the
   following should look farmiliar because it is that info with a little
   bit of elaboration.

   First you will need to find out a little bit about how your ISP sets
   up its PPP connections. Does it use scripted login, PAP, CHAP, do you
   have a dynamic or static IP etc. This along with some basic info about
   your modem will allow us to easily create a PPP dial in script for
   your ISP.

   First we will create a PPP conf using what is already in
   /etc/ppp/ppp.conf.sample as a guide. The first section we come to is
   the section labeled default. This is the best place to specify logging
   options, your modem device and dial options. It will always be
   executed when ppp is run. The following is the default section that
   comes standard with /etc/ppp/ppp.conf.sample and an explanation of
   what each parameter does:
   <Default Section>
default:
set log Phase Chat LCP IPCP CCP tun command      #This parameter tells PPP to l
og output which pertains
                                                 #to the arguments you give the
 parameter.

set device /dev/cua01                            #This will set the default mod
em device on the system
                                                 #which here is comm 2.

set speed 115200                                 #This parameter sets the speed
 of the serial device.

set dial "ABORT BUSY ABORT NO\\sCARRIER TIMEOUT 5 \"\" AT OK-AT-OK ATE1Q0 OK \\
dATDT\\T TIMEOUT 40 CONNECT"
                                                 #This will set the commands to
 follow when certian actions
                                                 #take place while dialing.  Ab
ort the call if the number is
                                                 #busy, abort the call if there
 is no carrier.  Wait 5 seconds for
                                                 #carrier. Issue AT and wait fo
r response. If AT is ok then dial the
                                                 #number and timeout if not con
nected in 40 seconds. Once dialed
                                                 #in wait for the CONNECT messa
ge to tell us we are connected.

   Now that the default modem options are set we will need to create a
   section in the ppp.conf for our ISP. Below are a few examples of what
   could be in there and what type of isp they are tailored for.
   <MyISP Section>
myisp:
set phone 1234567                        #This of course sets the number to dia
l for your isp.

set login "ABORT NO\\sCARRIER TIMEOUT 5 ogin:--ogin: ppp word: ppp"
                                         #This sets the login options.  It will
 abort login if
                                         #there is no carrier with a timeout of
 5 seconds.  It
                                         #will then wait for the login: prompt
and send
                                         #your login name, and then it will wai
t for the password
                                         #prompt and send your password.

set timeout 120                          #This sets the timeout for the entire
login process.

set ifaddr 10.0.0.1/0 10.0.0.2/0 255.255.255.0 0.0.0.0
                                         #This will set the ip address you expe
ct your your side
                                         #and for the remote side of the connec
tion. The /0 bit
                                         #tells the connection that no bits of
this ip address
                                         #need to match and the whole thing can
 be replaced.
                                         #This also sets your default netmask a
nd gateway.

add default HISADDR                      #This will make the default gateway th
e remote end of
                                         #the ppp connection.

enable dns                               #This tells ppp to ask the peer for th
e nameserver
                                         #addresses that should be used. This i
snt always supported,
                                         #but if it is /etc/resolv.conf will au
tomatically be updated.

   <Pap/Chap Section>

   What if your ISP uses PAP or CHAP? Here is a configuration that will
   work with both PAP or CHAP, PPP will decide which it needs to use.
myispPAPCHAP:
set PHONE 1234567                        #This line sets the phone number.

set LOGIN                                #PPP will be waiting for the peer to s
uggest the use of
                                         #either PAP or CHAP.

set authname MyName                      #This is where you specify your userna
me.

set authkey MyKey                        #This is where you specify your passwo
rd.

set timeout 120                          #This sets the login timeout to 120 se
conds.

   And then procede with the standard commands from above.
   <Static Ip Section>

   All you need to do is change the ifaddr parameter like so:

set ifaddr 209.115.93.18 209.115.93.20

   In this example, your ip is 209.115.93.18, and the peer side ip is
   209.115.93.20.

   [10][Back to Main Index] [11][To Section 5.0 - Kernel configuration
   and Disk Setup] [12][To Section 7.0 - Keyboard controls]
     _________________________________________________________________

   [13][back] [14]www@openbsd.org
   $OpenBSD: obsd-faq.txt,v 1.5 1999/06/22 18:57:35 ericj Exp $

References

   1. http://www.openbsd.org/faq/index.html
   2. http://www.openbsd.org/faq/faq5.html
   3. http://www.openbsd.org/faq/faq7.html
   4. http://www.openbsd.org/faq/faq5.html
   5. http://www.openbsd.org/cgi-bin/man.cgi?query=ifconfig&apropos=0&sektion=8&format=html
   6. http://www.openbsd.org/cgi-bin/man.cgi?query=netstat&apropos=0&sektion=1&format=html
   7. http://www.openbsd.org/cgi-bin/man.cgi?query=vpn&apropos=0&sektion=0&format=html
   8. http://www.codetalker.com/greenbox/docs/vpn-24-minifaq.html
   9. http://www.openbsd.org/cgi-bin/man.cgi?query=ppp&apropos=0&sektion=8&format=html
  10. http://www.openbsd.org/faq/index.html
  11. http://www.openbsd.org/faq/faq5.html
  12. http://www.openbsd.org/faq/faq7.html
  13. http://www.openbsd.org/faq/index.html
  14. mailto:www@openbsd.org


   [1][Back to Main Index] [2][To Section 6.0 - Networking] [3][To
   Section 8.0 - General Questions]

                            7.0 - Keyboard controls

7.1 - How do I remap the keyboard?

   By using kcon(1), "kcon - keyboard control and remapping for the pcvt
   driver"

   Example:

   bsd# kcon -m gb will load the keycap file for Great Britain.

7.2 - Is there gpm or the like in OpenBSD?

   No. But if you are willing to make a port. Please share. :)

   [4][Back to Main Index] [5][To Section 6.0 - Networking] [6][To
   Section 8.0 - General Questions]
     _________________________________________________________________

   [7][back] [8]www@openbsd.org
   $OpenBSD: obsd-faq.txt,v 1.5 1999/06/22 18:57:35 ericj Exp $

References

   1. http://www.openbsd.org/faq/index.html
   2. http://www.openbsd.org/faq/faq6.html
   3. http://www.openbsd.org/faq/faq8.html
   4. http://www.openbsd.org/faq/index.html
   5. http://www.openbsd.org/faq/faq6.html
   6. http://www.openbsd.org/faq/faq8.html
   7. http://www.openbsd.org/faq/index.html
   8. mailto:www@openbsd.org


   [1][Back to Main Index] [2][To Section 7.0 - Keyboard controls] [3][To
   Section 9.0 - Tips for linux users]

                            8.0 - General Questions

8.1 - What are these Kerberos warning when I first login?

   When you first install your system you will most likely notice a
   warning message that is something like this:

   Warning: no Kerberos tickets issued.

   THIS WARNING IS COMPLETELY IRRELEVANT AND SHOULD ONLY BE REMOVED IF
   COMPLETELY NECESSARY

   Well since you probably haven't set up Kerberos on your system, you
   wouldn't be getting a ticket. If you do have Kerberos running, you
   need to check into that. If you can't STAND that warning and never
   plan on using Kerberos here is how to get rid of it for good.

     * Make sure you have the source code.
     * Edit /usr/share/mk/bsd.own.mk and set KERBEROS to 'no', or create
       an /etc/mk.conf file that does this.
     * cd /usr/src/usr.bin/login ; make clean ; make ; make install

8.2 - How do I change virtual terminals?

   Simply type [ctrl] - [alt] - [One of the function keys] or just hit
   [f9]-[f12] which are just mapped to [ctrl] - [alt]
   functions. (i386)

   Only the i386 arch has virtual terminal capabilities. You can also use
   virtual terminals when using X. For example, If you start X on term 1,
   and switch with [ctrl]-[alt]-[F2] to term 2, X will seem to disapear
   and will not come back by simply switching back to term 1. You must
   [ctrl]-[alt]-[F5] to get your X display back.

8.3 - I forgot my root password, what do I do now?

   A few steps to recovery
    1. Boot into single user mode. For i386 arch type boot -s at the boot
       prompt.
    2. mount the drives.
          + bsd# fsck -p / && mount -u /
          + if /usr is on a different partition you need to mount that
            also
    3. type passwd
    4. boot into mulituser mode.. and REMEMBER your password .

8.4 - X wont start, I get tons of error messages

   If you have X completely set up and you are using an XF86Config that
   you know works then the problem most likely lies in the
   machdep.allowapature. You also need to make sure that both:

option XSERVER
option APERTURE

   are in you kernel configuration. [BOTH these are in the GENERIC
   kernel]

   Then you need to edit /etc/sysctl.conf
   and set machdep.allowaperture=1. This will allow X to access the
   aperture driver. This would be set up if the question during install
   about whether or not you would be running X was answered correctly.
   OpenBSD 2.4 requires for all X servers that the aperture driver be
   set, because it controls access to the I/O ports on video boards.

   For other X problems on the i386, consult the XFree86 FAQ at
   [4]http://www.xfree86.org/FAQ/.

8.5 - What is CVS? and How do I use it?

   CVS is what the OpenBSD project uses to control changes to the source
   code. CVS stands for Concurrent Versions System. You can read more
   about CVS at [5]http://www.cyclic.com/. CVS can be used by the end
   user to keep up to date with source changes, and changes in the ports
   tree.

   CVS makes it extremely simple to download the source via one of the
   many CVS mirrors for the project.

   Here are some simple commands to get you going on CVS.

   For all these commands a CVSROOT variable must be set. You can do this
   by:

   If you use csh or tcsh use:
   bsd# setenv CVSROOT anoncvs@anoncvs.ca.openbsd.org:/cvs

   or if you use sh or ksh use:
   bsd# export CVSROOT="anoncvs@anoncvs.ca.openbsd.org:/cvs"

   It is best to try to find a mirror that is closest to you. You can
   obtain a list of CVS mirrors from
   [6]http://www.openbsd.org/anoncvs.html.

   All these commands are run from the /usr directory if you do not have
   the source code already. The source or ports however can be initially
   downloaded in tarred and gzipped form from any of the ftp servers.
   They are set and ready to be used with CVS.

     * bsd# cvs -q get -PAd src [to get source code] or
     * bsd# cvs -q get -PAd ports [to get the ports tree]

   If you already have an existing source or ports tree:
     * bsd# cvs -q up -PAd src
     * bsd# cvs -q up -PAd ports

   For some, bandwidth and time are serious problems when updating
   repository's such as these. So CVS has a -z[1-9] option which uses
   gzip to compress the data. To use it, do -z[compression-level], for
   instance, -z3 for a compression level of 3.

   There are many different connections you can make to a CVS mirror.
   This is to accompany people from all types of networks, whether you
   are behind a firewall, etc.

   You can make either a ssh, rsh, or pserver connection to the servers.
   Many mirrors also run ssh on port 2022.

   To do this you can use the variable $CVS_RSH. rsh(1) is what CVS uses
   by default, but using the $CVS_RSH environment variable you can have
   CVS use ssh.
   An example:

   #setenv CVS_RSH /usr/local/bin/ssh
   or
   #export CVS_RSH=/usr/local/bin/ssh

8.6 - What is the ports tree?

   The ports tree is a set of Makefiles that download, patch, configure
   and install userland programs so you can run them an OpenBSD
   environment without having to do all that by hand. You can get the
   ports tree from any of the OpenBSD ftp servers in
   /pub/OpenBSD/2.5/ports.tar.gz or try the latest updates in
   /pub/OpenBSD/snapshots/ports.tar.gz.

   If you want to run one of the latest ports collections, you'll need to
   update your /usr/share/mk/ directory. CVS up your /usr/src/ directory
   and do a:
# cd /usr/src/share/mk/
# make install

   first.

   In 2.5-current this information is now stored in the ports tree. In
   ports/infrastructure/ all thats left in /usr/src/share/mk for ports is
   just a pointer to this new area.

   Ports are set up to be EXTREMELY easy to make and install. Here is an
   example install for someone wanting to install the X11 program xfig.
   You'll notice the dependencies are automaticly detected and completed:

fenetyllin:/usr/ports/graphics/xfig# make install
===>  Extracting for xfig-3.2.2
===>  xfig-3.2.2 depends on shared library: jpeg.62. - /usr/local/lib/libjpeg.s
o.62.0 found
===>  xfig-3.2.2 depends on shared library: Xaw3d.6. - not found
===>  Verifying install for Xaw3d.6. in /usr/ports/x11/Xaw3d
>> Xaw3d-1.3.tar.gz doesn't seem to exist on this system.
>> Attempting to fetch from ftp://crl.dec.com/pub/X11/contrib/widgets/Xaw3d/R6.
1/.
Connected to crl.dec.com.
220 crl.dec.com FTP server (Digital UNIX Version 5.60) ready.
331 Guest login ok, send ident as password.
230 Guest login ok, access restrictions apply.
Remote system type is UNIX.
Using binary mode to transfer files.
200 Type set to I.
250 CWD command successful.
250 CWD command successful.
Retrieving pub/X11/contrib/widgets/Xaw3d/R6.1/Xaw3d-1.3.tar.gz
local: Xaw3d-1.3.tar.gz remote: Xaw3d-1.3.tar.gz
227 Entering Passive Mode (192,58,206,2,5,14)
150 Opening BINARY mode data connection for Xaw3d-1.3.tar.gz (0.0.0.0,0) (29027
7 bytes).
100% |**************************************************|   283 KB    00:00 ETA
226 Transfer complete.
290277 bytes received in 101.09 seconds (2.80 KB/s)
221 Goodbye.
===>  Extracting for Xaw3d-1.3
/bin/mkdir -p /usr/ports/x11/Xaw3d/work/xc/lib/Xaw3d/X11/Xaw3d
cd /usr/ports/x11/Xaw3d/work/xc/lib/Xaw3d/X11/Xaw3d; ln -sf ../../*.h .
===>  Patching for Xaw3d-1.3
===>  Configuring for Xaw3d-1.3
mv -f Makefile Makefile.bak
imake -DUseInstalled -I/usr/X11R6/lib/X11/config
make Makefiles
[snip]

   You can see a list of both ports and packages by using the pkg_info
   command.
bsd# /usr/sbin/pkg_info
zsh-3.0.5           The Z shell.
screen-3.7.4        A multi-screen window manager.
ssh-1.2.21          Secure shell client and server (remote login program).
emacs-20.2          GNU editing macros.
lynx-2.7.1ac-0.107  An alphanumeric display oriented World-Wide Web Client.
tcsh-6.07.02        An extended C-shell with many useful features.
bash-2.01           The GNU Borne Again Shell.
zip-2.2             Create/update ZIP files compatabile with pkzip.
mm-2.7              Implementation of MIME, the Multipurpose Internet Mail Exte
n
ircii-2.8.2-epic3.004 An enhanced version of ircII, the Internet Relay Chat cli
ent
ispell-3.1.20       An interactive spelling checker.
tin-1.3.970930      TIN newsreader (termcap based)
procmail-3.11p7     A local mail delivery agent.
strobe-1.03         Fast scatter/gather TCP port scanner
lsof-4.15           Lists information about open files.
xntp3-5.92          Network Time Protocol Implementation.
ncftp-2.4.3
 nmh-0.27            The New MH mail handling program
bzip2-0.1p12        A block-sorting file compressor

   If you are looking for a specific program in the ports tree, you can
   try
fenetyllin:/usr/ports/# make search key="xfig"
Port:   xfig-3.2.2
Path:   /home/ports/graphics/xfig
Info:   A drawing program for X11
Maint:  angelos@openbsd.org
Index:  graphics x11
B-deps: Xaw3d-1.3 jpeg-6b
R-deps: Xaw3d-1.3 ghostscript-5.10 gv-3.5.8 jpeg-6b png-1.0.2 transfig-3.2.1
Archs:  any

Port:   transfig-3.2.1
Path:   /home/ports/print/transfig
Info:   Tools to convert Xfig's .fig files.
Maint:  angelos@openbsd.org
Index:  print
B-deps: jpeg-6b
R-deps: ghostscript-5.10 jpeg-6b png-1.0.2
Archs:  any
[snip]

   More information about the ports can be found in the ports man page

   Our ports tree is constantly being expanded, and if you would like to
   help please see: [7]http://www.openbsd.org/ports.html

8.7 - What are packages?

   Packages are the precompiled binaries of some of the most used
   programs. They are ready for use on an OpenBSD system. Again, like the
   ports, packages are very easy to maintain and update. Packages are
   constantly being added so be sure to check each release for additional
   packages.

   Here is a list of tools used in managing packages.
     * pkg_add (1) - a utility for installing software package
       distributions
     * pkg_create (1) - a utility for creating software package
       distributions
     * pkg_delete (1) - a utility for deleting previously installed
       software package distributions
     * pkg_info (1) - a utility for displaying information on software
       packages

   Here is a sample user installing ispell via a package:

   bsd# pkg_add
   ftp://ftp.openbsd.org/pub/OpenBSD/2.5/packages/${arch}/ispell-3.1.20.t
   gz
   where ${arch} is your architecture

   Again, like with ports you can use the pkg_info(1) program to view
   what is already installed on your system.

   To delete packages you will want to use the pkg_delete(1) command. It
   is used the same way as pkg_add(1).

   bsd# /usr/sbin/pkg_delete ispell-3.1.20

   and it is gone.

   Packages can be found on any of the OpenBSD ftp mirror sites.
   [8]Http://www.OpenBSD.org/ftp.html
   or they can be found on your OpenBSD CD's.

8.8 - Is there any way to use my floppy drive if it's not attached during boot?

   Sure. You need to add "flags 0x20" at the end of the fd* entry and
   recompile your kernel. The line should be read:
   fd* at fdc? drive ? flags 0x20

   After that you would be able to use the floppy drive all the time. It
   doesn't matter if you plugged it later after boot.

8.9 - Boot time Options - Using the OpenBSD bootloader

   When booting your OpenBSD system, many of you have probobly noticed
   the boot prompt.

   boot>

   For most people, you won't have to do anything here. It will
   automatically boot if no commands are given. But sometimes problems
   arise, or special functions are needed. Thats where these options will
   come in handy. To start of, you should read through the [9]boot(8) man
   page. Here we will go over the most common used commands for the
   bootloader.

   To start off, if no commands are issued, the bootloader will
   automatially try to boot /bsd. If that fails it will try /obsd, and so
   on till it finds a bootable kernel. You can specify this by hand by
   typing:

   boot> boot wd0a:/bsd
   or
   boot> b /bsd

   This will work if device wd0a is configured as your root device.

   Here is a quick overview of options to be used with the boot
       parameter.
     * -a : This will allow you to specify an alternate root device after
       booting the kernel.
     * -c : This allows you to enter the boot time configuration. Check
       the [10]Boot Time Config section of the faq.
     * -s : This is the option to boot into single user mode.
     * -d : This option is used to dump the kernel into ddb. Keep in mind
       that you must have DDB built into the kernel.
     * -b : Shortcut for RB_HALT.

   These are entered in the format of:
   boot [ image [-abcds]]

   For further reading you can read [11]boot_i386(8) man page

   [12][Back to Main Index] [13][To Section 7.0 - Keyboard controls]
   [14][To Section 9.0 - Tips for linux users]
     _________________________________________________________________

   [15][back] [16]www@openbsd.org
   $OpenBSD: obsd-faq.txt,v 1.5 1999/06/22 18:57:35 ericj Exp $

References

   1. http://www.openbsd.org/faq/index.html
   2. http://www.openbsd.org/faq/faq7.html
   3. http://www.openbsd.org/faq/faq9.html
   4. http://www.xfree86.org/FAQ/
   5. http://www.cyclic.com/
   6. http://www.openbsd.org/anoncvs.html
   7. http://www.openbsd.org/ports.html
   8. http://www.openbsd.org/ftp.html
   9. http://www.openbsd.org/cgi-bin/man.cgi?query=boot&sektion=8&format=html
  10. http://www.openbsd.org/faq/faq5.html#5.4
  11. http://www.OpenBSD.org/cgi-bin/man.cgi?query=boot_i386&sektion=8&format=html
  12. http://www.openbsd.org/faq/index.html
  13. http://www.openbsd.org/faq/faq7.html
  14. http://www.openbsd.org/faq/faq9.html
  15. http://www.openbsd.org/faq/index.html
  16. mailto:www@openbsd.org


   [1][Back to Main Index] [2][To Section 8.0 - General Questions] [3][To
   Section 10.0 - System Administration]

                          9.0 - Migrating from Linux
     _________________________________________________________________

9.1 - Simple tips for Linux users

   There are several differences between OpenBSD and Linux. These
   differences include but are not limited to, bootup procedure, network
   interface usage and disk management. Most differences are well
   documented, but involve searching manpages. This document tries to be
   an index of those differences.

     * OpenBSD has a ports tree. This is to accomodate the fact that at
       this point not many applications are native to the OpenBSD
       environment. This is both an attempt to get applications to work
       on OpenBSD for end-users and to get more applications made with
       OpenBSD in mind. Eventually this ports tree will be used to make a
       nice set of binary packages.
     * OpenBSD uses CVS for source changes. Unlike Linux which is done
       primarily thru separate distributions, OpenBSD uses CVS which
       allows anyone to extract the full source tree at ANY given time.
       OpenBSD also does periodically release snapshots for various
       architectures and makes a CD release every 6 months.
     * OpenBSD contains STRONG CRYPTO, which USA based OS's can't
       contain. (See [4]http://www.openbsd.org/crypto.html) OpenBSD has
       also gone thru heavy security auditing and many security features
       have already been implemented into the source tree. (IPSEC,
       KERBEROS).
     * OpenBSD's kernel is /bsd.
     * The names of hard disks are usually /dev/wd and /dev/sd (ATA/SCSI)
     * /sbin/ifconfig with no arguments in Linux gives the state of all
       the interfaces. Under OpenBSD you need the -a flag.
     * /sbin/route with no arguments in Linux gives the state of all the
       active routes. Under OpenBSD you need the "show" parameter, or do
       a netstat -r (nice).
     * IP-Masquerading is done through ipnat. ([5]ipnat(1))
     * ipfwadm is done through ipf ([6]ipf(1), [7]ipf(5))
     * Interface address is stored in /etc/hostname.<interfacename>. It
       can be a name instead of an IP address.
     * The machine name is in /etc/myname
     * The default gateway is in /etc/mygate
     * The network interface aliases are in /etc/ifaliases
     * OpenBSD's default shell is csh. Shells such as bash and tcsh can
       be added as packages or installed from the ports tree.
     * Password management changes a lot. The main files are different.
       ([8]passwd(1), [9]passwd(5))

9.2 - Dual booting Linux and OpenBSD

   Yes! it is possible!

   Read [10]INSTALL.linux

   [11][Back to Main Index] [12][To Section 8.0 - General Questions]
   [13][To Section 10.0 - System Administration]
     _________________________________________________________________

   [14][back] [15]www@openbsd.org
   $OpenBSD: obsd-faq.txt,v 1.5 1999/06/22 18:57:35 ericj Exp $

References

   1. http://www.openbsd.org/faq/index.html
   2. http://www.openbsd.org/faq/faq8.html
   3. http://www.openbsd.org/faq/faq10.html
   4. http://www.openbsd.org/crypto.html
   5. http://www.openbsd.org/cgi-bin/man.cgi?query=ipnat&apropos=0&sektion=1&format=html
   6. http://www.openbsd.org/cgi-bin/man.cgi?query=ipf&apropos=0&sektion=1&format=html
   7. http://www.openbsd.org/cgi-bin/man.cgi?query=ipnat&apropos=0&sektion=5&format=html
   8. http://www.openbsd.org/cgi-bin/man.cgi?query=passwd&apropos=0&sektion=1&format=html
   9. http://www.openbsd.org/cgi-bin/man.cgi?query=passwd&apropos=0&sektion=5&format=html
  10. http://www.openbsd.org/faq/INSTALL.linux
  11. http://www.openbsd.org/faq/index.html
  12. http://www.openbsd.org/faq/faq8.html
  13. http://www.openbsd.org/faq/faq10.html
  14. http://www.openbsd.org/faq/index.html
  15. mailto:www@openbsd.org


   [1][Back to Main Index] [2][To Section 9.0 - Migrating from Linux]
   [3][To Section 11.0 - OpenBSD 2.4 Specific Information]

                         10.0 - System Administration
     _________________________________________________________________

10.1 - Why does it say that I'm in the wrong group when I su to root?

   To be able to use [4]su(1) to root you must be in group 0, "wheel".
   This MUST be placed specifically in /etc/group. It isn't enough to
   have them listed in /etc/passwd. Once this is done you should be able
   to su correctly.

10.2 - How do I duplicate a filesystem?

   Use dump/restore. For example. To duplicate everything under directory
   SRC to directory DST, do a:
# cd /SRC; dump 0f - . | (cd /DST; restore -rf - )

10.3 - How do I get httpd, sendmail, etc to startup with the system?

   OpenBSD uses rc-style startup to control starting applications with
   the system. For common daemons you can simply edit [5]/etc/rc.conf.
   For example: To have ftpd started on boot change -
ftpd_flags=NO -- > ftpd_flags="-D"

   You can add any flags that you wish ftpd to start with.

   If you have your own daemon's that you want to be started, here is a
   simple entry that you can put into /etc/rc.local.
if [ -x /usr/local/sbin/mydaemon ]; then
        echo -n ' mydaemon';       /usr/local/sbin/mydaemon
fi

   Once in there, it will come up with the system each time.

10.4 - Why do users get relaying access denied when they are remotely sending
mail through my OpenBSD system?

   Try this:
cat /etc/sendmail.cf | grep relay-domains

   The output may look something like this:
FR-o /etc/mail/relay-domains

   If this file doesn't exist, create it. You will need to enter the
   users who are sending mail remotely with the following syntax:
.domain.com    #if it is dynamic
sub.domain.com #if static

   Don't forget to:
kill -1 `cat /var/run/sendmail.pid`

10.5 - I've set up POP, but users have trouble accessing mail thru POP. What
can i do?

   Most issues dealing with pop are accessing files, mainly temp files.
   Some clients give errors such as:
-ERR Couldn't open temporary file, do you own it?K

   Try setting up your permissions as such:
permission in  /var
drwxrwxr-x   2 bin     mail     512 May 26 20:08 mail


permissions in  /var/mail
-rw-------   1 username   username        0 May 26 20:08 username

   Double check that the user owns his file in /var/mail , this should be
   done by default.

10.6 - Setting up a Secure HTTP server with SSL(8)

   This will take you through all the steps it takes to set up your own
   Secure HTTP server. Since the OpenBSD 2.5 release, OpenBSD has shipped
   with ssleay. Because of copyrighted RSA algorigthms, these cannot be
   shipped with OpenBSD. libssl includes support for SSL version 2, SSL
   version 3, and TLS version 1. So for now, because of copyright
   restictions, OpenBSD must ship without a fully-functional libssl. But
   it is still completely useable. If you are able to use the RSA
   patented library's you can easily upgrade your libssl with a command
   like this.

   #pkg_add
   ftp://ftp.openbsd.org/pub/OpenBSD/${ver}/packages/${arch}/libssl-1.1.t
   gz
   Where ${ver} is the OpenBSD version number, and ${arch} is your
   architecture.

   The steps shown here are taken pretty much from the [6]ssl(8) man
   page. So you can refer to that for further information. Also, this faq
   will only go over creating a RSA certificate for web servers, not a
   DSA server certificate. To find out how to do so, please refer to the
   ssl(8) man page.

   I will no show how to create your key and certificate. These will go
   to /etc/ssl/private/. This means that you will have to have upgraded
   your libssl. Now we can create our key. You can do so with a line like
   such:

   # ssleay genrsa -out /etc/ssl/private/server.key 1024

   This will create a key of 1024 bits. Next you need to create a
   Certificate Signing Request which is used to get a CA or Certificate
   Authority to sign your key. Here is the command to do so.

   # ssleay req -new -key /etc/ssl/private/server.key -out
   /etc/ssl/private/server.csr

   You would now give /etc/ssl/private/server.csr to the CA to get it
   signed. Or you could also sign the certificate for yourself. Here is
   how you would do this.

   # ssleay x509 -req -days 365 -in /etc/ssl/private/server.csr -signkey
   /etc/ssl/private/server.key -out /etc/ssl/server.crt

   This will sign your key, and it will be valid for up to 365 days. With
   this done you can now start the httpd server. To start httpd(8) with
   ssl you must start the daemon with the -DSSL flag. You can start this
   on boot in /etc/rc.conf by changing the httpd line to look like so:

httpd_flags="-DSSL"

   This server will run on port 443.

10.7 - I edited /etc/passwd with vi(1), but the changes didn't seem to take
place. Why?

   Changes will not be made right away because OpenBSD has a user
   database which needs updated when changes are made in /etc/passwd.
   Tools are made to do this immediatly for you though. You should use
   vipw(8) to edit the passwd file by hand. This will allow for checking
   of the passwd file before entering it into the database and after the
   check is done it will automatically execute pwd_mkdb(8). If you have
   made changes, without using a tool such as vipw, you can run
   pwd_mkdb(8) by hand.

10.8 - What is the best way to add users? and delete them?

   The best way to add a user in OpenBSD is to use the [7]adduser(8)
   script. You can configure this to work however you like by editing
   /etc/adduser.conf. You can add users by hand, but this is the
   recommended way to addusers. adduser(8) allows for consistancy checks
   on /etc/passwd, /etc/group, and shell databases. It will create then
   entries for you, and HOME directory, and even send a message to the
   user welcoming them. This can be changed to meet your needs. For
   further instructions on adding users read the [8]adduser_proc(8) man
   page.

   To delete users you should use the [9]rmuser(8) utility. This will
   remove all existance of a user. It will remove any crontab(1) entries,
   their HOME dir (if it is owned by the user). Along with their
   /etc/passwd and /etc/group entries.

10.9 - How do i create an ftp-only account?

   There are a few ways to do this, but a very common way to do such is
   to add /usr/bin/false into /etc/shells. Then when you create the user
   set his shell to /usr/bin/false, this they he will not be able to get
   a shell but will be able to keep their ftp capabilities. adduser(8)
   will give them a home dir by default of /home/foo. If this is what you
   desire it doesn't need to be changed, however you can set this to
   whatever directory you wish.

10.10 - Setting up Quota's

   Quota's are used to limit users space that they have available to them
   on your drives. It can be very helpfull in situations of limited
   resources. quota's can be set in two different ways.

     * 1 - User Quota's
     * 2 - Group Quota's

   The first step to setting up quota's is to make sure that option QUOTA
   is in your Kernel Configuration. This option is in the GENERIC kernel.
   After this you need to mark in /etc/fstab the filesystems which will
   have quota's enabled. The keywords userquota and groupquota should be
   used to mark each fs that you will be using quota's on. By default the
   files quota.user and quota.group will be created at the root of that
   filesystem to hold the quota information. This default can be
   overwritten by doing, userquota=/var/quotas/quota.user. Or whatever
   file you want to use for holding quota information. Here is an example
   /etc/fstab that has one filesystem with userquota's enabled.

/dev/wd0a / ffs rw,userquota=/var/quotas/quota.user 1 1

   Now it's time to set the users quota's. To do so you use the utility
   [10]edquota(8) . A simple use is just edquota < user >. edquota(8)
   will use vi(1) to edit the quota's unless the environmental variable
   EDITOR is set to a different editor. For example:

   #edquota ericj

   This will give you output similar to this:

Quotas for user ericj:
/: blocks in use: 62, limits (soft = 0, hard = 0)
        inodes in use: 25, limits (soft = 0, hard = 0)

   To add limits, edit it to something similar to this:

Quotas for user ericj:
/: blocks in use: 62, limits (soft = 1000, hard = 1050)
        inodes in use: 25, limits (soft = 0, hard = 0)

   In this the softlimit is set to 1000 blocks and the hardlimit is set
   to 1050 blocks. A softlimit is a limit where the user is just warned
   when they cross it and have until their grace period is up to get
   their disk usage below their limit. Grace period's can be set by using
   the -t option on edquota(8). After the grace period is over the
   softlimit is handled as a hardlimit. This usually results in an
   allocation failure.

   Now that the quota's are set you, you need to turn the quota's on. To
   do this use [11]quota(1). Using a command of quota < user > will give
   that users info. quota with no arguments will give your quota
   statistics. For example:

# quota ericj

   Will result in output similar to this:

Disk quotas for user ericj (uid 1001):
     Filesystem  blocks   quota   limit   grace   files   quota   limit   grace
              /      62    1000    1050              27       0       0

   By default quota's set in /etc/fstab will be started on boot. To turn
   them of use quotaoff -a

   [12][Back to Main Index] [13][To Section 9.0 - Migrating from Linux]
   [14][To Section 11.0 - OpenBSD 2.4 Specific Information]
     _________________________________________________________________

   [15][back] [16]www@openbsd.org
   $OpenBSD: obsd-faq.txt,v 1.5 1999/06/22 18:57:35 ericj Exp $

References

   1. http://www.openbsd.org/faq/index.html
   2. http://www.openbsd.org/faq/faq9.html
   3. http://www.openbsd.org/faq/faq24.html
   4. http://www.openbsd.org/cgi-bin/man.cgi?query=su&apropos=0&sektion=1&format=html
   5. http://www.openbsd.org/cgi-bin/cvsweb/src/etc/rc.conf?rev=1.35
   6. http://www.openbsd.org/cgi-bin/man.cgi?query=ssl&apropos=0&sektion=8&format=html
   7. http://www.openbsd.org/cgi-bin/man.cgi?query=adduser&sektion=8&format=html
   8. http://www.openbsd.org/cgi-bin/man.cgi?query=adduser_proc&sektion=8&format=html
   9. http://www.openbsd.org/cgi-bin/man.cgi?query=rmuser&sektion=8&format=html
  10. http://www.openbsd.org/cgi-bin/man.cgi?query=edquota&sektion=8&format=html
  11. http://www.openbsd.org/cgi-bin/man.cgi?query=quotaon&sektion=8&format=html>quotaon(8)</a>.Forexample:</p><p><pre># quotaon -a </pre> </p> <p> This will go thru /etc/fstab to turn on the filesystems with quota options. Now that quota's are up and running, you can view them by the <a href=
  12. http://www.openbsd.org/faq/index.html
  13. http://www.openbsd.org/faq/faq9.html
  14. http://www.openbsd.org/faq/faq24.html
  15. http://www.openbsd.org/faq/index.html
  16. mailto:www@openbsd.org


   [1][Back to Main Index] [2][To Section 10.0 - System Administration]
   [3][To Section 12.0 - Performance Tuning]

                    11.0 - OpenBSD 2.4 Specific Information
     _________________________________________________________________

11.1 - In 2.4 why do I get UserDir error when running httpd?

   It seems as though userdir support was left out of 2.4. Make sure to
   pick up the patch at:

   [4]http://www.openbsd.org/errata.html

11.2 - Installing at a partition 4GB or higher

   The 2.4 cd's shipped with a problem in installboot. A patch can be
   obtained here [5]http://www.openbsd.org/errata.html. This is fixed in
   -current.

   To place the partition boot record, installboot used a 32 bit
   multiplication for the sectors times the sectorsize which is larger
   than 2^32 -1 (i.e. multiplication overflow) when the partition starts
   at 4 GB or higher. This means the pbr is installed in the reall
   partition address modulo 4GB. It's still possible to install at >= 4GB
   with some effort:

   You have 2 Options for doing so with OpenBSD 2.4. If you have Linux or
   any other unix like OS, you should back up the sectors first before
   trying anything.

     * Suppose the partition starts at cylinder 611, and the drive has
       255 heads, 63 sectors: offset for the obsd partition is
       611*255*63= 9815715 sectors. multiply this by 512 and you get:
       5025646080. 5025646080 mod 2^32 = 730678784
       (You can just subtract 2^32 on a hand calculator...) dividing by
       512 gives sector 1427107.
       Ok, suppose were now in linux (where cylinder numbers are 1 higher
       btw..) and that the obsd partition is DOS partition 4:
       dd if=/dev/hda of=backup.txt skip=1427107 bs=512 count=1
       will backup the data that installboot will nuke ..
       Now install OpenBSD. Return to Linux.
       Now we're going to copy the partition boot record to the right
       place.
       dd if=/dev/hda of=pbr.txt skip=1427107 bs=512 count=1
       dd if=/pbr.txt of=/dev/hda4 bs=512 count=1
       (adding obsd to lilo should now work)
       Now write back the nuked sector:
       dd if=/backup.txt of=/dev/hda seek=1427107 bs=512 count=1
       Caveat: make sure that whatever gets nuked by installboot isn't
       essential to running dd (and starting the other OS). Backing up
       the affected partition is recommended.
     * Use a correct version of installboot (compiled for you by another
       OBSD'er ..):
       put it on another partition, e.g. a DOS partition. Suppose wd0j is
       the DOS partition (see disklabel wd0, this is in case of IDE
       disks), and installboot is named installb there.
       After booting from floppy/CD, press ^C to get into the shell:
          + mkdir dos
          + mount /dev/wd0j dos
          + cp dos/tmp/installb /usr/mdec/installboot

   Now enter 'install' and the installation procedure should use the new
   installboot.

   [6][Back to Main Index] [7][To Section 10.0 - System Administration]
   [8][To Section 12.0 - Performance Tuning]
     _________________________________________________________________

   [9][back] [10]www@openbsd.org
   $OpenBSD: obsd-faq.txt,v 1.5 1999/06/22 18:57:35 ericj Exp $

References

   1. http://www.openbsd.org/faq/index.html
   2. http://www.openbsd.org/faq/faq10.html
   3. http://www.openbsd.org/faq/faq12.html
   4. http://www.openbsd.org/errata.html#userdir
   5. http://www.openbsd.org/errata.html#installboot
   6. http://www.openbsd.org/faq/index.html
   7. http://www.openbsd.org/faq/faq24.html
   8. http://www.openbsd.org/faq/faq12.html
   9. http://www.openbsd.org/faq/index.html
  10. mailto:www@openbsd.org

$OpenBSD: obsd-faq.txt,v 1.5 1999/06/22 18:57:35 ericj Exp $

Warning: this document is currently being reviewed. It's not yet complete,
and probably contains loads of errors. As an example, I can't figure out
why Linux doesn't need mkswap as it shares the exact same blocks with
OpenBSD.


   Linux + OpenBSD: it's possible

   by Marc Espie --  Marc.Espie@OpenBSD.org

It is perfectly possible to have Linux and OpenBSD on the same disk.
As of this writing, OpenBSD can read and write Linux' partitions, whereas
Linux cannot access OpenBSD partitions (they differ from NetBSD partitions).

You can even install OpenBSD from an ext2fs partition (choose install from
disk... ext2fs does not appear in the choices, but `default' it is).

First, make a bootable floppy of Linux.  Then, you  have to find some room
for OpenBSD.  Don't worry about swap space: you can share Linux' swap
partition.

If you want to grab space from a Windows/DOS partition, use fips.
Fips20 knows all about FAT32, so windows 95 is no longer a problem.

Other sources of information, especially concerning other BSD systems,
must be taken with a healthy does of scepticism.

First principles
----------------
OpenBSD does not use the DOS partitions for more than booting.  You just
need a small DOS partition to put your OpenBSD root.  Afterwards, OpenBSD
heeds some other information entirely, called the BSD disklabel.  This
disklabel is another completely distinct description of your hard disk.
It does not even have to be consistent with the usual DOS partitions
information.

Throughout this document, we will distinguish between DOS partitions and
BSD partitions whenever this is necessary.

For consistency, it's better if all parts of the disks that
are actually used by OpenBSD are flagged as occupied, type A6, though it
is not necessary.  The only part of the disk that should appear both as a BSD
partition and as a DOS partition is the root partition: it MUST begin on
the same sector for the boot process to work.

One way to visualize things is to picture OpenBSD embedded inside DOS
partitions: the DOS partitions used by OpenBSD may each contain several
OpenBSD partitions. As long as the DOS partition table has the right
start and length for each partition it will be kept happy.

The OpenBSD disklabel is just another mechanism that yield another
description of the disk. It is vitally important that the BSD root
partition start precisely where the corresponding DOS partition is supposed
to start, and it is better when all BSD partitions stay inside their
DOS partitions boundaries.  Apart from OpenBSD partitions proper, the
BSD disklabel can contain a BSD description of other DOS partitions, but
this is not mandatory. If you don't have any constraints, having a correct
description of all partitions is better, but with bigger disks, keep in mind
that OpenBSD disklabels can't hold more than 16 partitions.

Contrarily to popular belief, OpenBSD does *NOT* need one contiguous chunk
of the disk (a `slice' in FreeBSD lingo).  It is probably the simplest setup,
but other considerations (such as the need to boot several OS, and to have
several small primary partitions that all within the first  1024 BIOS
cylinders) may lead you to use two chunks for OpenBSD.

If you can, it is MUCH better to devote a full disk to OpenBSD: this limits
the number of mistakes you can do. Admittedly there are some cases where
this isn't a option (my machine is a laptop... I have to cope with the
hard disk I have).

Mapping your disk
-----------------
Starting from Linux, get a grasp of your partitions. Use df to check which
is what, then fdisk to get the actual setup of the disk.
Here is my disk:
--
Disk /dev/hda: 128 heads, 63 sectors, 993 cylinders
Units = cylinders of 8064 * 512 bytes

   Device Boot   Begin    Start      End   Blocks   Id  System
/dev/hda1            1        1      260  1048288+   6  DOS 16-bit >=32M
/dev/hda2          261      261      273    52416   83  Linux native
/dev/hda4          287      287      601  1270080    5  Extended
/dev/hda5          287      287      303    68512   82  Linux swap
/dev/hda6          304      304      456   616864+  83  Linux native
/dev/hda7          457      457      520   258016+  83  Linux native
/dev/hda8          521      521      537    68512+  83  Linux native
/dev/hda9          538      538      601   258016+  83  Linux native

(In case you're wondering, yes this is a big disk. The Linux playground is
large, the OpenBSD area will be huge. As a developer, I usually have loads
of source & binaries lying around... a simple OpenBSD installation can fit
within 300 Mb with room to spare.)
In my setup hda2 is /, hda6 is /usr, hda7 is /usr/local, hda8 is /var, and
hda9 is /home.

Get the display to sectors with u, and jot down the corresponding
information as well:
--
Disk /dev/hda: 128 heads, 63 sectors, 993 cylinders
Units = sectors of 1 * 512 bytes

   Device Boot   Begin    Start      End   Blocks   Id  System
/dev/hda1           63       63  2096639  1048288+   6  DOS 16-bit >=32M
/dev/hda2      2096640  2096640  2201471    52416   83  Linux native
/dev/hda4      2306304  2306304  4846463  1270080    5  Extended
/dev/hda5      2306368  2306368  2443391    68512   82  Linux swap
/dev/hda6      2443455  2443455  3677183   616864+  83  Linux native
/dev/hda7      3677247  3677247  4193279   258016+  83  Linux native
/dev/hda8      4193343  4193343  4330367    68512+  83  Linux native
/dev/hda9      4330431  4330431  4846463   258016+  83  Linux native

Okay, finally switch to expert mode, and note the corresponding data.
Disk /dev/hda: 128 heads, 63 sectors, 993 cylinders

Nr AF  Hd Sec  Cyl  Hd Sec  Cyl   Start    Size ID
 1 00   1   1    0 127  63  259      63 2096577 06
 2 00   0   1  260 127  63  272 2096640  104832 83
 3 00   0   0    0   0   0    0       0       0 00
 4 00   0   1  286 127  63  600 2306304 2540160 05
 5 00   1   2  286 127  63  302      64  137024 82
 6 00   1   1  303 127  63  455      63 1233729 83
 7 00   1   1  456 127  63  519      63  516033 83
 8 00   1   1  520 127  63  536      63  137025 83
 9 00   1   1  537 127  63  600      63  516033 83

Note that this is STILL the same data. The good point about this last
display is that it is almost what you're going to see in OpenBSD fdisk !

There are some differences though, mostly because Linux fdisk has made
some rather confusing choices:
- in simple mode it starts numbering cylinders at 1... whereas
everything else starts from 0.
- in simple mode it shows blocks of 1024 bytes, which makes for half-blocks
(marked with a +) and sizes halved from the real block size.
- in expert mode it shows extended partitions offset from the start
of the extended partition.
- the hd/sec/cyl is a confusing order, as the sector number is computed
from cyl/hd/sec, in that order.
- it never shows and doesn't care about the real disk geometry.

You will notice that the 3rd primary partition is empty... this is where
I intend to stick my OpenBSD root partition (both DOS and BSD partitions),
and that I have left cylinders 601--992 empty... this is where I intend to
stick the rest of OpenBSD.
After OpenBSD is installed, partition 3 will show up as:
/dev/hda3          274      274      286    52416   a6  Unknown
/dev/hda3      2201472  2201472  2306303    52416   a6  Unknown

(recent Linux fdisk will display a6 as OpenBSD, but they still don't know
how to deal with the disklabel. Important: NEVER use Linux fdisk to fiddle
with OpenBSD disklabels.)


Before starting to install OpenBSD, now would be a good time to check the
INSTALL.pt document...  Especially note the alignment restriction of
partitions (first sector of a partition must be at head 0, sector 1 of a
cylinder). This is enforced by Linux' fdisk.

The other point to note is that extended partitions are actually linked
lists. This will show up in OpenBSD' fdisk.

Your clock and OpenBSD
----------------------
OpenBSD expects your hardware clock to be in universal time, and uses
time zones to give you local time. With Linux, this depends...
most distributions use a small program called hwclock to set up the
system time from the hardware clock when booting... there is a --utc
option if your hardware clock is in universal time, but this is not
always what happens by default.

For instance, on a redhat 5.1 system, this happens in /etc/rc.d/rc.sysinit
which loads an /etc/sysconfig/clock that defines a variable called UTC, and
then proceeds calling hwclock.
- ensure UTC is set to true,
- adjust your hardware clock from the system time if necessary, e.g.,
hwclock --systohc --utc.

The Linux partition table and OpenBSD
-------------------------------------
There is a problem with many Linux rc that do mount all file systems even
in single-user mode.  After you've installed OpenBSD, if your Linux kernel
knows about BSD disklabels, it may insert lots of BSD partitions in its
list. Then, at the next reboot, you're in trouble. The simplest way around
this problem is probably to make sure you can boot from a Linux kernel
that doesn't know about disklabels.   Otherwise, you may wish to check
your inittab and your rc to make deadly sure that single-user boot
will work.

The OpenBSD installation
------------------------
If you've got the space, you can install from your ext2fs partitions. This
is what I did, as I have a slip connection to the rest of the world, and
the OpenBSD install floppy does not include slip.

REMEMBER TO BACKUP ALL IMPORTANT DATA ON YOUR DISK BEFORE DOING THE
INSTALLATION !!!

So you cp floppy*.fs /dev/fd0, then reboot...

First, the BSD kernel + ram disk loads, then there is a boot prompt, and
five seconds later, the boot proper starts.

After a while, you will see your disk configuration scroll by.  I got:
  wd0 at wdc0 drive 0: <TOSHIBA MK4006MAV>
  wd0: 3909MB, 7944 cyl, 16 head, 63 sec, 512 bytes/sec, 8007552 sec total
  wd0: using 16-sector 16-bit pio transfers, lba addressing

at which point I got somewhat confused, especially as this is a configuration w
ith
more than 1024 cylinders.  In fact, this is the actual disk geometry, when
you inquire about it, but the geometry that the BIOS does see IS the fdisk
geometry, with 993 cylinders.  As the 1024 cylinders is purely a BIOS
limitation, there is no actual trouble.

If you want to be sure, enquire at the boot prompt:
boot>machine diskconfig
before the automatic boot sequence continues.


Then I got into fdisk, and I proceeded to enter my new OpenBSD partition.
This is what the fdisk dump looked after my changes:

Disk: wd0       geometry: 992/128/63 [7999488 sectors]
Offset: 0       Signatures: 0xAA55,0x0
         Starting        Ending
 #: id  cyl  hd sec -  cyl  hd sec [     start -       size]
-------------------------------------------------------------------------
 0: 06    0   1   1 -  259 127  63 [        63 -    2096577] DOS > 32MB
 1: 83  260   0   1 -  272 127  63 [   2096640 -     104832] Linux files*
 2: A6  273   0   1 -  285 127  63 [   2201472 -     104832] OpenBSD
 3: 05  286   0   1 -  600 127  63 [   2306304 -    2540160] Extended DOS

Selected extended partition 3
New MBR at offset 2306304.
Offset: 2306304 Signatures: 0xAA55,0x0
         Starting        Ending
 #: id  cyl  hd sec -  cyl  hd sec [     start -       size]
-------------------------------------------------------------------------
 0: 82  286   1   2 -  302 127  63 [   2306368 -     137024] Linux swap
 1: 05  303   0   1 -  455 127  63 [   2443392 -    1233792] Extended DOS
 2: 00    0   0   0 -    0   0   0 [   2306304 -          0] unused
 3: 00    0   0   0 -    0   0   0 [   2306304 -          0] unused

Selected extended partition 1
New MBR at offset 2443392.
Offset: 2443392 Signatures: 0xAA55,0x0
         Starting        Ending
 #: id  cyl  hd sec -  cyl  hd sec [     start -       size]
-------------------------------------------------------------------------
 0: 83  303   1   1 -  455 127  63 [   2443455 -    1233729] Linux files*
 1: 05  456   0   1 -  519 127  63 [   3677184 -     516096] Extended DOS
 2: 00    0   0   0 -    0   0   0 [   2443392 -          0] unused
 3: 00    0   0   0 -    0   0   0 [   2443392 -          0] unused

Selected extended partition 1
New MBR at offset 3677184.
Offset: 3677184 Signatures: 0xAA55,0x0
         Starting        Ending
 #: id  cyl  hd sec -  cyl  hd sec [     start -       size]
-------------------------------------------------------------------------
 0: 83  456   1   1 -  519 127  63 [   3677247 -     516033] Linux files*
 1: 05  520   0   1 -  536 127  63 [   4193280 -     137088] Extended DOS
 2: 00    0   0   0 -    0   0   0 [   3677184 -          0] unused
 3: 00    0   0   0 -    0   0   0 [   3677184 -          0] unused

Selected extended partition 1
New MBR at offset 4193280.
Offset: 4193280 Signatures: 0xAA55,0x0
         Starting        Ending
 #: id  cyl  hd sec -  cyl  hd sec [     start -       size]
-------------------------------------------------------------------------
 0: 83  520   1   1 -  536 127  63 [   4193343 -     137025] Linux files*
 1: 05  537   0   1 -  600 127  63 [   4330368 -     516096] Extended DOS
 2: 00    0   0   0 -    0   0   0 [   4193280 -          0] unused
 3: 00    0   0   0 -    0   0   0 [   4193280 -          0] unused

Selected extended partition 1
New MBR at offset 4330368.
Offset: 4330368 Signatures: 0xAA55,0x0
         Starting        Ending
 #: id  cyl  hd sec -  cyl  hd sec [     start -       size]
-------------------------------------------------------------------------
 0: 83  537   1   1 -  600 127  63 [   4330431 -     516033] Linux files*
 1: 00    0   0   0 -    0   0   0 [         0 -          0] unused
 2: 00    0   0   0 -    0   0   0 [   4330368 -          0] unused
 3: 00    0   0   0 -    0   0   0 [   4330368 -          0] unused

Nothing to it... you just follow the extended partition links using select,
jot down whatever you need, add the OpenBSD partition to look like you want
it to, and save everything.

After you leave fdisk, you get to the interesting part: the disklabel
itself. If all goes well, OpenBSD synthesizes a nice disklabel out of what
it can deduce from the disk, including the ext2fs partitions.

There are only a few subtleties to take care of:
- initially, you can ONLY edit the disklabel part that matches the OpenBSD
DOS partition (a `slice' in FreeBSD lingo). You have to use b 0 *  before
you can edit the whole disk.
- the real disk geometry becomes relevant. The Berkeley fast file system
can't use partial cylinder groups, hence BSD partitions should start
on cylinder boundaries, as any remaining sectors  will be lost anyway.
- units for size and offset can be given as sectors (default) or cylinders.

After edition, this is what my disklabel looks like:

# using MBR partition 2: type A6 off 2201472 (0x219780) size 104832 (0x19980)
# /dev/rwd0c:
type: ESDI
disk:
label: TOSHIBA MK4006M
flags:
bytes/sector: 512
sectors/track: 63
tracks/cylinder: 16
sectors/cylinder: 1008
cylinders: 7944
total sectors: 8007552
rpm: 3600
interleave: 1
trackskew: 0
cylinderskew: 0
headswitch: 0           # milliseconds
track-to-track seek: 0  # milliseconds
drivedata: 0

16 partitions:
#        size   offset    fstype   [fsize bsize   cpg]
  a:   104832  2201472    4.2BSD     1024  8192    16   # (Cyl. 2184 - 2287)
  b:   137024  2306368      swap                        # (Cyl. 2288 - 2423*)
  c:  8007552        0    unused        0     0         # (Cyl.    0 - 7943)
  d:   409248  4846464    4.2BSD     1024  8192    16   # (Cyl. 4808 - 5213)
  e:   511056  5255712    4.2BSD     1024  8192    16   # (Cyl. 5214 - 5720)
  f:   204624  5766768    4.2BSD     1024  8192    16   # (Cyl. 5721 - 5923)
  g:  1073520  5971392    4.2BSD     1024  8192    16   # (Cyl. 5924 - 6988)
  h:   962640  7044912    4.2BSD     1024  8192    16   # (Cyl. 6989 - 7943)
  i:  2096577       63     MSDOS                        # (Cyl.    0*- 2079*)
  j:   104832  2096640    ext2fs                        # (Cyl. 2080 - 2183)
  l:  1233729  2443455    ext2fs                        # (Cyl. 2424*- 3647*)
  m:   516033  3677247    ext2fs                        # (Cyl. 3648*- 4159*)
  n:   137025  4193343    ext2fs                        # (Cyl. 4160*- 4295*)
  o:   516033  4330431    ext2fs                        # (Cyl. 4296*- 4807*)

Things to check:
- this disklabel is saved in MBR2 (basic DOS partition 2), as expected.
- all the BSD partitions proper are aligned on a cylinder boundary.
the root partition begins at the precise same offset the corresponding DOS
partition begins, and it extends for the same length.
Other BSD partitions don't show up in the DOS partition setup, hence they
begin precisely on cylinder 601/4808.
- the ext2fs partitions have the exact same layout under the OpenBSD
disklabel.

One point that is somewhat laborious is that the disklabel -E mode
(which you are currently using) tends to move partitions around to ensure
that ALL defined partitions are contiguous. Hence, you may need some fiddling
around and printing to ensure that Linux partitions do show up where they
should.  In my case, disklabel moved the swap and all the ext2fs partitions
slightly, and I add to adjust them manually...

Once the disklabel is written to disk, the installation proceeds as usual.

ext2fs partitions are perfectly usable from OpenBSD. My /home partition
is ext2fs, I have been using it for a week now without any trouble.

Booting
-------
First time I booted my system back, I did not get into OpenBSD as expected...
I plain forgot I had installed lilo in the master boot block, and lilo
does not heed the active partition flag. The fix was rather simple: from
the Linux system, I just had to edit lilo.conf to add the obsd entry:

boot=/dev/hda
map=/boot/map
install=/boot/boot.b
prompt
timeout=50
image=/boot/myvmlinuz
   label=linux
   root=/dev/hda2
   vga=4
   read-only
image=/boot/vmlinuz-2.0.34-1
   label=redhat
   root=/dev/hda2
   read-only
other=/dev/hda1
   label=dos
   table=/dev/hda
other=/dev/hda3
   label=obsd
   table=/dev/hda

rerun lilo, and voila, OpenBSD was able to boot !

Linux and OpenBSD partitions
----------------------------
As of 2.0.35/2.1.122, Linux does not support OpenBSD partitions. The way
the Linux kernel works is reasonably straightforward (code in
drivers/block/genhd.c): when detecting a BSD partition (type A5),
it checks and parses the first block for a disklabel, and use that
information to instantiate some new partitions,
that will show up in that drive's partition list, exactly like extended
partitions do show up. Unfortunately, that check is hard coded for a type A5
(NetBSD/FreeBSD) partition, and it recognizes 8 partitions disklabels only
anyway.

Just hacking the Linux code to recognize A6 is not quite enough.  You also
need to trim down the resulting list of partitions, as your ext2fs
partitions will now show up twice !
I'm experimenting with the following patch, which should make it to linux-kerne
l
soon:
--------------------------------------------------------------
diff -ur linux.orig/drivers/block/genhd.c linux/drivers/block/genhd.c
--- linux.orig/drivers/block/genhd.c
Mon Aug  4 20:45:35 1997
+++ linux/drivers/block/genhd.c
Thu Sep 24 18:55:31 1998
@@ -205,11 +206,46 @@
 }

 #ifdef CONFIG_BSD_DISKLABEL
+static void check_and_add_bsd_partition(struct gendisk *hd, struct bsd_partiti
on *bsd_p)
+{
+
struct hd_struct *lin_p;
+

/* check relative position of partitions.  */
+
for (lin_p = hd->part + 1; lin_p - hd->part < current_minor; lin_p++) {
+


/* no relationship -> try again */
+

if (lin_p->start_sect + lin_p->nr_sects <= bsd_p->p_offset
+


|| lin_p->start_sect >= bsd_p->p_offset + bsd_p->p_size)
+


continue;

+


/* equal -> no need to add */
+

if (lin_p->start_sect == bsd_p->p_offset &&
+


lin_p->nr_sects == bsd_p->p_size)
+


return;
+


/* bsd living within dos partition */
+

if (lin_p->start_sect <= bsd_p->p_offset && lin_p->start_sect
+


+ lin_p->nr_sects >= bsd_p->p_offset + bsd_p->p_size) {
+#ifdef DEBUG_BSD_DISKLABEL
+


printk("w: %d %ld+%ld,%d+%d",
+



lin_p - hd->part, lin_p->start_sect, lin_p->nr_sects,
+



bsd_p->p_offset, bsd_p->p_size);
+#endif
+


break;
+

}
+


/* ouch: bsd and linux overlap. Don't even try for that partition */
+#ifdef DEBUG_BSD_DISKLABEL
+

printk("???: %d %ld+%ld,%d+%d",
+


lin_p - hd->part, lin_p->start_sect, lin_p->nr_sects,
+


bsd_p->p_offset, bsd_p->p_size);
+#endif
+

printk("???");
+

return;
+
} /* if the bsd partition is not described by DOS, we end up there */
+
add_partition(hd, current_minor, bsd_p->p_offset, bsd_p->p_size);
+
current_minor++;
+}
 /*
  * Create devices for BSD partitions listed in a disklabel, under a
  * dos-like partition. See extended_partition() for more information.
  */
-static void bsd_disklabel_partition(struct gendisk *hd, kdev_t dev)
+static void bsd_disklabel_partition(struct gendisk *hd, kdev_t dev, int max_pa
rtitions)
 {

struct buffer_head *bh;

struct bsd_disklabel *l;
@@ -225,19 +261,15 @@


return;

}

-
p = &l->d_partitions[0];
-
while (p - &l->d_partitions[0] <= BSD_MAXPARTITIONS) {
+
if (l->d_npartitions < max_partitions)
+

max_partitions = l->d_npartitions;
+
for (p = l->d_partitions; p - l->d_partitions <  max_partitions; p++) {


if ((current_minor & mask) >= (4 + hd->max_p))



break;
-
-

if (p->p_fstype != BSD_FS_UNUSED) {
-


add_partition(hd, current_minor, p->p_offset, p->p_size);
-


current_minor++;
-

}
-

p++;
+

if (p->p_fstype != BSD_FS_UNUSED)
+


check_and_add_bsd_partition(hd, p);

}

brelse(bh);
-
 }
 #endif

@@ -248,6 +280,11 @@

struct partition *p;

unsigned char *data;

int mask = (1 << hd->minor_shift) - 1;
+#ifdef CONFIG_BSD_DISKLABEL
+
/* no bsd disklabel as a default */
+
kdev_t bsd_kdev = 0;
+
int bsd_maxpart;
+#endif
 #ifdef CONFIG_BLK_DEV_IDE

int tested_for_xlate = 0;

@@ -365,13 +402,29 @@




hd->part[minor].nr_sects = 2;


}
 #ifdef CONFIG_BSD_DISKLABEL
+


/* tag first disklabel for late recognition */


if (SYS_IND(p) == BSD_PARTITION) {
-


printk(" <");
-


bsd_disklabel_partition(hd, MKDEV(hd->major, minor));
-


printk(" >");
+


printk("!");
+


if (!bsd_kdev) {
+



bsd_kdev = MKDEV(hd->major, minor);
+



bsd_maxpart = BSD_MAXPARTITIONS;
+


}
+

} else if (SYS_IND(p) == OPENBSD_PARTITION) {
+


printk("!");
+


if (!bsd_kdev) {
+



bsd_kdev = MKDEV(hd->major, minor);
+



bsd_maxpart = OPENBSD_MAXPARTITIONS;
+


}


}
 #endif

}
+#ifdef CONFIG_BSD_DISKLABEL
+
if (bsd_kdev) {
+

printk(" <");
+

bsd_disklabel_partition(hd, bsd_kdev, bsd_maxpart);
+

printk(" >");
+
}
+#endif

/*

 *  Check for old-style Disk Manager partition table

 */
diff -ur linux.orig/include/linux/genhd.h linux/include/linux/genhd.h
--- linux.orig/include/linux/genhd.h
Wed Mar 18 20:25:30 1998
+++ linux/include/linux/genhd.h
Thu Sep 24 18:55:43 1998
@@ -69,12 +70,19 @@
 #ifdef CONFIG_BSD_DISKLABEL
 /*
  * BSD disklabel support by Yossi Gottlieb <yogo@math.tau.ac.il>
+ *
+ * updated by Marc Espie <Marc.Espie@openbsd.org>
  */

+/* check against BSD src/sys/sys/disklabel.h for consistency */
+
 #define BSD_PARTITION

0xa5
/* Partition ID */
+#define OPENBSD_PARTITION
0xa6

 #define BSD_DISKMAGIC
(0x82564557UL)
/* The disk magic number */
 #define BSD_MAXPARTITIONS
8
+#define OPENBSD_MAXPARTITIONS 16
+
 #define BSD_FS_UNUSED

0
/* disklabel unused partition entry ID */
 struct bsd_disklabel {

__u32
d_magic;

/* the magic number */
----------------------------------------------------------------------
It does:
- trigger the recognition of OpenBSD disklabels,
- force bsd partitions to appear at the end of the partition list,
- check the bsd disklabel for redundancy and consistency with the dos
partition table, so that the same partition does not show up twice.

You also need a working ufs, such as
<ftp://sunsite.unc.edu/pub/Linux/ALPHA/ufs/u2fs-0.4.3.tar.gz>
This package yields a new module, plus a small patch to tie the module
with the rest of the Linux kernel. I would recommend checking that patch
manually, as Linux module information tends to vary widely, and it is
pretty trivial to add by hand anyway.

Running Linux binaries under OpenBSD
------------------------------------
You just have to recompile your BSD kernel with COMPAT_LINUX, and set up
/emul/linux as explained in compat_linux(1).

It's a good idea to mount your Linux file system under another point, then
make symbolic links so that you can control what gets used precisely.
Don't bother with the ports emul/linux_lib entry: it's only a set of Linux
libraries for people who don't have a Linux system running.

As of this writing, most applications work, apart from sound.

The Linux sound devices use differing ioctl from OpenBSD, hence anything that
needs to change the audio mode won't work, and produce audio garbage at best.

A small detail that may cause problems: uname still says `OpenBSD', even
under Linux compatibility.  The reason behind that is that we don't want
netscape to tell it was run from a Linux box, when it is used under
OpenBSD.

Some programs, for instance maple, do depend on uname answering `Linux'.
For maple, this is straigthforward: you just have to fudge
/usr/local/maple/bin/maple.system.type to check OpenBSD in the same
class with Linux.

Similar shell scripts are easy to fix.  Binary programs that don't run
suid can be coerced by using LD_PRELOAD.

As a rule, this should be achieved on a program-by-program basis.
The more networking programs that do tell they're running under OpenBSD,
the merrier !



   [1][Back to Main Index] [2][To Section 11.0 - OpenBSD 2.4 Specific
   Information]

                           12.0 - Performance Tuning
     _________________________________________________________________

12.1 - Networking

   If you run a busy gateway or firewall, you should make sure you
   prevent memory starvation.

   Add these to your kernel config and compile a custom kernel:

     * option "NMBCLUSTERS=8192"
     * option "MAX_KMAP=120"
     * option "MAX_KMAPENT=6000"
     * option "NKMEMCLUSTERS=8192"

12.2 - Disk I/O

   Disk I/O is, on any system, a main factor in the overall speed of the
   computer. And is also a part of any system that needs protected the
   most. OpenBSD has a couple of options you can choose from when it
   comes to disk fault tolerence.

   The first option is the use of [3]ccd(4). CCD(4) is what is called a
   Concatenated Disk Driver. This basically allows you to combine one or
   more disks into what is called a "virtual disk" As in, the system
   see's it as one disk, and uses it as such. This concept is similar to
   that of LVM, which is found in many commercial flavors. To start setup
   of CCD, you need to add support for it in your kernel. A line such as:

pseudo-device   ccd     4       # concatenated disk devices

   would allow for 4 CCD devices. Which happens to be the MAX number of
   CCD devices allowed.

   NOTE: Support is in the GENERIC Kernel.

   One of the many things you can do through the use of CCD is provide
   for "striping", which can definately give a performance boost.

   Another solution is [4]raid(4) which will have you use [5]raidctl(8).
   to control your raid devices. Through the use of RAIDframe devices you
   can achieve both striping and mirroring. OpenBSD has support for RAID
   levels of 0, 1, 4, and 5. With raid, as with CCD, support must be in
   the KERNEL.

pseudo-device   raid   4       # RAIDframe disk device

   As with the CCD kernel support, Support is in the GENERIC kernel.

   For fileservers with enough memory, you can increase BUFCACHEPERCENT.
   To do this you should add a line to your kernel configuration like
   this:

   option BUFCACHEPERCENT=50

   Or whatever number you want it set too.

   Another tool that can be used to speed up your is softupdates. You can
   read more about these at the [6]softupdates FAQ entry.

   [7][Back to Main Index] [8][To Section 11.0 - OpenBSD 2.4 Specific
   Information]
     _________________________________________________________________

   [9][back] [10]www@openbsd.org
   $OpenBSD: obsd-faq.txt,v 1.5 1999/06/22 18:57:35 ericj Exp $

References

   1. http://www.openbsd.org/faq/index.html
   2. http://www.openbsd.org/faq/faq24.html
   3. http://www.openbsd.org/cgi-bin/man.cgi?query=ccd&apropos=0&sektion=4&format=html
   4. http://www.openbsd.org/cgi-bin/man.cgi?query=raid&apropos=0&sektion=4&format=html
   5. http://www.openbsd.org/cgi-bin/man.cgi?query=raidctl&apropos=0&sektion=8&format=html
   6. http://www.openbsd.org/faq/faq4.html#4.9
   7. http://www.openbsd.org/faq/index.html
   8. http://www.openbsd.org/faq/faq24.html
   9. http://www.openbsd.org/faq/index.html
  10. mailto:www@openbsd.org


MINI-FAQ: Upgrading OpenBSD

  Latest OpenBSD Version - 2.5

    Kjell Wooding <[1]kwooding@codetalker.com>

   Last Update - 03 Jun 1999

     If you've ever tried compiling the -current sources from an older
     OpenBSD release, you're aware that the process isn't always
     straightforward. This Mini-FAQ is an attempt to address the most
     common issues encountered when upgrading between OpenBSD releases,
     or from the releases to -current

  1.0: General Upgrade Questions

   [2]1.1: Terminology. What is -current? What are Snapshots?
   [3]1.2: What is the easiest way to upgrade to -current?
   [4]1.3: I looked, but didn't see any snapshots on the FTP site. Where
   did they go?
   [5]1.4: How do I get the latest source?
   [6]1.5: Okay, I have the tree. How do I build it.
   [7]1.6: My make build stopped halfway. Do I have to redo the whole
   thing?

  2.0: Upgrading from 2.3

   [8]2.1: What are the major problems upgrading from 2.3 to 2.4?
   [9]2.2: I tried the build, but it failed when trying to compile
   ssleay.
   [10]2.3: I tried the build, but it failed when trying to make
   something for the PowerPC.

  3.0: Upgrading from 2.4

   [11]3.1: What are the major problems upgrading from 2.4 to 2.5?
   [12]3.2: I tried the build, but it failed on cap_mkdb.

  4.0: Upgrading from 2.5

   [13]4.1: What are the major problems upgrading from 2.5 to -current?
   [14]4.2: How do I upgrade gcc to egcs

     [15]4.2.1 - i386 and sparc are no longer #define'ed
     [16]4.2.2 - Build fails in xlint
     [17]4.2.3 - Core Dump on uthread_autoinit.c
     [18]4.2.4 - egcs seems much slower than gcc
     [19]4.2.5 - egcs generates larger code than gcc
     [20]4.2.6 - After installing egcs I have very little disk space
     left

   [21]4.3: My make build dies with unimplemented syscall errors.

                           _____________________

  1.0: General Upgrade Questions

    1.1: Terminology. What is -current? What are Snapshots?

   Unlike Operating System projects like Linux and FreeBSD, OpenBSD
   development happens from a single source tree. On approximately
   six-month intervals, OpenBSD releases are produced. These are numbered
   in the conventional (2.x) manner. The current OpenBSD release is 2.5.

   -current, short for openbsd-current, refers to the up-to-the-minute
   version of the source tree contained in the CVS repository. This is
   the tree most commonly used by OpenBSD developers. The -current tree
   contains all the code that is planned for the next release. From time
   to time, brave souls will abandon the formal releases and run
   openbsd-current, usually to take advantage of features that have not
   yet made it into the formal releases. Because of its uncertain nature,
   however, upgrading to -current is not recommended for non-technical
   users.

   Between formal releases, a series of snapshot releases are [22]made
   available. Snapshots are test releases of the -current source tree.
   Because they reflect the current state of development, there is no
   guarantee that snapshot releases will work correctly (or even at all).
   Snapshots are quite useful when moving from a formal release (or older
   version of -current) to the current tree.

    1.2: What is the best way to upgrade to -current?

   Due to changes in the underlying libraries, moving directly from a
   release to -current is not always easy. The most painless way to move
   up to -current is to first upgrade to the latest snapshot (usually,
   via an FTP install). Once the snapshot is installed, the latest source
   can be [23]fetched and [24]built. This procedure should eliminate most
   toolchain and library problems.

    1.3: I looked, but didn't see any snapshots on the FTP site. Where did they
    go?

   The snapshots used to be taken temporarily offline right around the
   release time of a new version. This is no longer the OpenBSD policy.

   Snapshots may be removed as they become old (or no longer relevant).
   If no snapshot is available, you should upgrade to the most recent
   release and build the remainder of the way from source.

    1.4: How do I get the latest source?

   Short answer: [25]http://www.openbsd.org/anoncvs.html

   For example. To retrieve the entire tree via CVS: (using the bash
   shell. Others substitute setenv for export)
 # export CVSROOT=anoncvs@anoncvs.ca.openbsd.org:/cvs
 # export CVS_RSH=/usr/local/bin/ssh
 # cd /usr
 # cvs -q get -PA src

    1.5: Okay, I have the tree. How do I build it.

   Basic instructions are in /usr/src/Makefile. This is a slightly
   expanded version.

1. Clean out the old object files.

   If you created a separate /usr/obj directory, clean that, and
   rebuild the symbolic links:

   # rm -rf /usr/obj
   # mkdir /usr/obj
   # cd /usr/src
   # make obj

   If you're worried there are object files in your source tree,
   do this:

   # cd /usr/src
   # find . -type l -name obj | xargs rm
   # make cleandir
   # rm -rf /usr/obj
   # mkdir /usr/obj
   # make obj

2. Perform any verion-specific configuration changes. For example,
   2.3 users must add the named user and group before
   moving to 2.4 or later. See the specific Mini-FAQ section for
   your version.

3. Make sure all the appropriate directories are created. This
   is especially important when upgrading from older versions, but is
   sometimes necessary in other cases. The easiest way to do this is:

   # cd /usr/src/etc && make DESTDIR=/ distrib-dirs

4. Compile a new kernel.

   # cd /usr/src/sys/arch/`machine`/conf
   # cp GENERIC MYKERNEL
   # vi MYKERNEL
   (edit MYKERNEL to your liking)
   # config MYKERNEL
   # cd ../compile/MYKERNEL
   # make clean && make depend && make
   (arc architecture only) copy bsd.ecoff to your FAT partition
   # cp /bsd /bsd.old && cp bsd /bsd
   # chown root.wheel /bsd (if you compiled as someone else)
   (reboot)

5. Compile the system.

   # cd /usr/src
   # make build

6. Update /etc and /dev by hand. These are not updated
   automatically. Choose a directory with enough space to
   hold /, /dev, /var, and /etc. Here I'll use /home/newroot
   (Note: make sure the directory hierarchy you choose
   does not have group write (g+w) or other write (o+w)
   permissions or sendmail will complain during this step.
   This makes /tmp a bad choice):

   # mkdir /home/newroot
   # export DESTDIR=/home/newroot
   # cd /usr/src/etc && make distribution-etc-root-var

   Now compare the files in /home/newroot with their
   installed counterparts. Replace or update the files as
   necessary.

   # rm -rf /home/newroot   (when done)

7. Reboot to make sure the new /etc files are correct

    1.6: My make build stopped halfway. Do I have to redo the whole thing?

   I would, but if you really want to pick up where you left off, do a:
 # cd /usr/src
 # make -n build

   This will show you what make build is doing. For example, mine tells
   me:
 (cd /usr/src/share/mk &&  make install)
 (cd /usr/src/include;  make includes)
 make cleandir
 (cd /usr/src/lib && make depend && make &&   make install)
 (cd /usr/src/gnu/lib && make depend && make &&   make install)
 (cd /usr/src/kerberosIV && make build)
 make depend && make &&  make install

   To pick up where you left off, just reissue the commands from the
   point where the compile died.

   If you do this procedure a lot, you may want to create a new target in
   your makefile. Simply copy the entry for build (to build-noclean, for
   example), and remove the make cleandir reference.

  2.0: Upgrading from 2.3

    2.1: What are the major problems upgrading from 2.3 to 2.4?

    New User: named

   After 2.3, the named DNS daemon was moved to a chroot jail. To make
   this change possible, the named user was created. If you do not have
   it already, you will need to create this user to ensure that all
   directories get created properly during the build process.

   Add the following entry to /etc/passwd using vipw
   named:*:70:70::0:0:BIND Daemon:/var/named:/sbin/nologin

   Add the following to /etc/group:
   named:*:70:

    2.2: I tried the build, but it failed when trying to compile ssleay.

   You are likely missing an entry for the named user in your password
   file.

   Short Answer:

   Create this user prior to the build.

   Long Answer:

   The named user is required in order to set permissions correctly. If
   this user is missing, part of the build process fails. If you capture
   your build to a file (say, with a make build &>/tmp/build.log) you
   will notice the following message:
  (cd /usr/src/etc && make DESTDIR=/ distrib-dirs)
  install -d -o root -g wheel -m 755 /
  mtree -def mtree/4.4BSD.dist -p // -u

  mtree: unknown user named
  mtree: failed at line 1632 of the specification
  *** Error code 1 (ignored)

   Unfortunately for us, the build continued happily on its way, totally
   ignoring the fact that an error occurred.

   If the named user exists, mtree works properly:
  missing: ./var/named (created)
  missing: ./var/named/dev (created)
  missing: ./var/named/etc (created)
  missing: ./etc/afs (created)
  missing: ./etc/ssl (created)
  missing: ./etc/ssl/private (created)
  missing: ./usr/obj (not created: File exists)
  missing: ./usr/share/doc/html (created)
  missing: ./usr/share/doc/html/lynx_help (created)
  missing: ./usr/share/doc/html/lynx_help/keystrokes (created)
  missing: ./usr/share/doc/usd/13.viref (created)
  missing: ./usr/share/man/cat4/powerpc (created)
  missing: ./usr/share/man/man4/alpha (created)
  missing: ./usr/share/man/man4/pmax (created)
  missing: ./usr/share/man/man4/powerpc (created)
  missing: ./usr/share/tmac/mdoc (created)
  missing: ./var/www/htdocs/manual/vhosts (created)
  missing: ./usr/include/ssl (created)

   The reason for the fail, then, is that the /usr/include/ssl directory
   was never created. Without the header files, the ssleay build fails.

   Fix:

   Create the named user and group. Remove /usr/include/ssl, /var/named,
   and any other directory from the list above that was mistakenly
   created as a normal file by the make build.

    2.3: I tried the build, but it failed when trying to make something for the
    PowerPC.

   Your directory tree is incomplete. Specifically, the
   /usr/share/man/cat4/powerpc directory is missing.

   Quick Fix:

   Create this directory and proceed with the compilation

   Complete Fix:

   Create the entire directory tree. Do a:
  # cd /usr/src/etc && make DESTDIR=/ distrib-dirs

   You will likely see an output like the following:
  install -d -o root -g wheel -m 755 /
  mtree -def mtree/4.4BSD.dist -p // -u

  missing: ./var/named (created)
  missing: ./var/named/dev (created)
  missing: ./var/named/etc (created)
  missing: ./etc/afs (created)
  missing: ./etc/ssl (created)
  missing: ./etc/ssl/private (created)
  missing: ./usr/obj (not created: File exists)
  missing: ./usr/share/doc/html (created)
  missing: ./usr/share/doc/html/lynx_help (created)
  missing: ./usr/share/doc/html/lynx_help/keystrokes (created)
  missing: ./usr/share/doc/usd/13.viref (created)
  missing: ./usr/share/man/cat4/powerpc (created)
  missing: ./usr/share/man/man4/alpha (created)
  missing: ./usr/share/man/man4/pmax (created)
  missing: ./usr/share/man/man4/powerpc (created)
  missing: ./usr/share/tmac/mdoc (created)
  missing: ./var/www/htdocs/manual/vhosts (created)
  missing: ./usr/include/ssl (created)

   Note that /usr/share/man/cat4/powerpc was one of the directories
   created by this process.

  3.0: Upgrading from 2.4

    3.1: What are the major problems upgrading from 2.4 to 2.5?

    cap_mkdb

   The syntax for invoking cap_mkdb has changed slightly. Before doing a
   make build, rebuild cap_mkdb from the latest source:
# cd /usr/src/usr.bin/cap_mkdb
# make clean && make && make install

   The make build should then run to completion

    Man Page Changes

   Several man pages were moved from section 1 to later sections
   Unfortunately, if the old man pages are left in section 1, unwary
   users will not see the latest version of the page.

   The following pages should be removed:
/usr/share/man/cat1/ipf.0
/usr/share/man/cat1/ipnat.0
/usr/share/man/cat1/ipsecadm.0

    Snake

   You will need to remove the contents of the obj directory before
   upgrading /usr/src/games/snake.

    3.2: I tried the build, but it failed on cap_mkdb.

   Symptom:

   A make build resulted in an error like this:
  cap_mkdb -i -f terminfo terminfo.src
  cap_mkdb: illegal option -- i
  usage: cap_mkdb [-v] [-f outfile] file1 [file2 ...]
  *** Error code 1

   Quick Fix:

   You need to build a new cap_mkdb. See [26]3.1.

  4.0: Upgrading from 2.5

    4.1: What are the major problems upgrading from 2.5 to -current?

      perl and make

   The latest version of Perl (5.005_03) requires a new version of make
   to compile properly. You must rebuild make before building the new
   Perl. Do a:
# cd /usr/src/usr.bin/make
# make clean && make && make install

   Then go ahead and rebuild the new Perl. You will need to clean out the
   Perl obj directory by hand before building.

   Perl developers should take note of the latest changes. From
   millert@openbsd.org:
The version of perl in the OpenBSD source tree (post 2.5) has been
upgraded to 5.005_03.  The build method has changed somewhat but
most of that should be invisible.  The important changes that affect
people are as follows:

    1) Perl lib files have moved from /usr/lib/perl5 to the more correct
       /usr/libdata/perl5
    2) The default site_perl directories now live in /usr/local.  Ie:
       if you install a perl module, it will place itself in
       /usr/local/libdata/perl5/site_lib.  This makes it easy to
       see what non-stock modules you have.  It also means that we
       can have perl modules in the ports system easily.
    3) The perl library man pages are now install in /usr/share/man/cat3p
       You'll need to update your man.conf based on the src/etc/man.conf
       to take advantage of them.  This means you can now do
       "man 3p less" and get info on the less pragma but "man less"
       will still get you the less pager manpage.

If you have modules or other non-stock perl files the simplest thing
to do is to move /usr/lib/perl5 to /usr/libdata/perl5 and add a link
from /usr/lib/perl5 to /usr/libdata/perl5.  Alternately, you could
just edit the installed Config.pm file and fix up the paths there.

      Compiler Change: egcs replaces gcc

   This change is likely the most significant change you will encounter.
   For detailed instructions, see section [27]4.2.

      Kernel Structure - statfs - changed

   The statfs structure has changed as of May 31. You must rebuild your
   kernel before attempting a make build. See [28]4.3 for details.

    4.2: How do I upgrade gcc to egcs

   The safest way will be to upgrade to a recent snapshot, once one is
   available. Until then (or for the brave of heart) read the following
   carefully.

   First, note that some platforms have not been bootstrapped
   successfully yet. To date, the following should work, if you are
   careful:
     * i386
     * sparc
     * m68k
     * alpha

   mips and rs6000 have problems.

   To test whether your platform can be bootstrapped, grab and install
   the egcs-snapshot, available from the [29]ports collection. If this
   works, the in-tree version likely will, too. This is the safest method
   of proceeding.

   Now, before going any futher, ensure that your copies of binutils,
   gas, and ld are up to date. Note that there are two copies of gas and
   ld in the tree. On i386 and sparc, the binutils versions are not used.
   Check /usr/src/gnu/usr.bin/gas and /usr/src/gnu/usr.bin/ld instead.

   To bootstrap to the in-tree egcs, read the following carefully.

   From espie@openbsd.org:

Today, the compiler changes.

Exit gcc 2.8.1, enter egcs... or more precisely, gcc 2.95 prerelease.

This is probably going to be a rough ride, but I can't work out all
the kinks on every architecture by myself.

I'm going to start importing stuff *now*. There will be a second message
to tech@ once things are settled...

Thanks to everyone who helped me sorting stuff out, most especially
niklas, turan, and millert.

Why the switch
--------------
as most of you already know, egcs is now the *official* compiler supported
by the FSF.  The upcoming july release as been re-christened gcc 2.95.

Just looking at the log messages will show you many improvements:
support for newer processors is better, C++ is more accurately matching
the ANSI/ISO standards, Fortran 77 is more closely integrated.
There are also countless bug-fixes and code generation improvements.

Also the development is more open. There is a cvs tree, there are several
mailing-lists available, and we are cooperating closely with the egcs
team. More precisely, I've been feeding patches back to the egcs team
so that OpenBSD configurations are officially supported.
Also, the development team is highly responsive to bug-reports, and problems
get fixed.

There also is a band-wagon phenomenon: everyone is switching to egcs,
which means lots of code to test the compiler on, and that we can benefit
from related projects.

Why now
-------
egcs-1.1 was unfit for some purposes. Specifically, code size on i386
was larger than gcc 2.8.1, which yielded floppy-disks problems.
At 2.5 freeze, the only code fit to include was a somewhat unstable
snapshot.  In the interest of stability, after much pondering, egcs was
not put into 2.5.

Right now, the egcs project is going through a release cycle which will
yield egcs 1.2.  Judging from their time schedule, there is ample margin
between egcs 1.2 and the next release of OpenBSD.  Also, we want to get
in now, so that we get a chance to report problems on less frequently
used architectures, and get everything fixed for 1.2.

egcs `feature freeze' is supposed to occur on may 7th, and the current
snapshot 19990502 looks solid.

What works and what doesn't
---------------------------
egcs runs an i386 OpenBSD system without problems.  m68k works as well,
with a few work-arounds linked to obscure bugs that will get fixed.
sparc seems to be running as well.  There is some linker trouble on some
other arches that needs to be fixed before our next release.

Right now, constructors across dynamic libraries are not quite ready.

egcs now features a stand-alone cpp which is going to be better than
the current hackish solution we use. This means a few interface changes
and possibly weird warnings.

Keeping gcc 2.8.1 ?
-------------------
due to size constraints, as soon as egcs is imported, gcc is going
to move to cvs Attic.  If you don't want to deal with egcs now, you'll
have to be careful through your cvs updates.
Some Makefiles are bound to change: includes, gnu/usr.bin, and gnu/lib.
xlint and cpp.sh are going to change as well.

How to bootstrap the compiler
-----------------------------
the simplest way is probably to trust the various arch maintainers
and download a snapshot.

If you want to do stuff the hard way, you must first remake proper
obj dirs:
cd /usr/src
make obj

If you run i386, gas must be up-to-date.
If you run sparc, ld must be up-to-date.

then build libiberty:
cd /usr/src/gnu/egcs/libiberty
make -f Makefile.bsd-wrapper clean
make -f Makefile.bsd-wrapper depend
make -f Makefile.bsd-wrapper
make -f Makefile.bsd-wrapper install

then the C compiler:
cd /usr/src/gnu/egcs/gcc
make -f Makefile.bsd-wrapper clean
make -f Makefile.bsd-wrapper depend
make -f Makefile.bsd-wrapper
make -f Makefile.bsd-wrapper install

rebuild the C compiler with the new version:
cd /usr/src/gnu/egcs/gcc
make -f Makefile.bsd-wrapper clean
make -f Makefile.bsd-wrapper depend
make -f Makefile.bsd-wrapper
make -f Makefile.bsd-wrapper install

rebuild the includes
cd /usr/src/include
make includes

build all egcs libraries and install them
cd /usr/src/gnu/egcs
make -f Makefile.bsd-wrapper clean
make -f Makefile.bsd-wrapper depend
make -f Makefile.bsd-wrapper
make -f Makefile.bsd-wrapper install

install the new cpp driver
cd /usr/src/usr.bin/cpp
make install

then you're all set, and a standard make build should work...

     [author note: Actually, it doesn't quite work. xlint will fail to
     build. The fix is simple though. Simply do a make && make install
     in the /usr/src/usr.bin/xlint/xlint directory before you attempt a
     make build and proceed. See [30]4.2.2.]
If it doesn't, you're using an arch that didn't go through make build yet.
The most probably occurrence is an Internal Compiler Error, as known as an
ICE.

First try to see if the ICE will go away with -O1 or -O0. In that case, you
can put a work-around in the Makefile until it's fixed
(see /usr/src/lib/libm/Makefile for an example of how to put in such
work-arounds for m68k).

Then the error needs to be reported to the egcs-bugs mailing list.

At a minimum, you must run the source through the same compiler invocation,
with an addition of -v -save-temps to the options.

-v yields the precise sequence of commands invoked by gcc. -save-temps
will give you a pre-processed C file (.i) or C++ (.ii) that the egcs people
can make sense of... you can't ask them to run OpenBSD on their boxes.

If you have more time, you can try to trim down the pre-processed C file to
the bare minimum that triggers the bug. Dichotomy works nicely.

   If you made it through this procedure, and everything is still
   working, congratulations. If not, check the following sections for
   advice. Problems not listed here should be posted to tech@openbsd.org.

      4.2.1 - i386 and sparc are no longer #define'ed

   This is true. egcs uses the cleaner __i386__ and __sparc__. If you
   need to compile code that relies on the old defines, add a -Dsparc or
   -Di386 to the appropriate location of your Makefile.

      4.2.2 - Build fails in xlint

   This is due to semantic differences in cpp. The workaround is simple,
   and similar to the cap_mkdb issue described in [31]3.1.

   Do a:
# cd /usr/src/usr.bin/xlint/xlint
# make && make install

   now re-run make, and the build should continue.

      4.2.3 - Core Dump on uthread_autoinit.c

   You have fallen victim to a linker bug. Here's a relevant message:
   From: Marc Espie
   Subject: egcs core-dumping on uthread_autoinit.c

   If this happens to you, this is a known linker problem... the cc1 you have
   was linked in a weird way.

   Initially, I made cc1 link against static /usr/lib/libiberty.a to avoid this
   problem, but this was cutting things too close, and the bug reappeared,
   probably thanks to unrelated changes in libc or elsewhere...

   The tree has been patched with a work-around in

   src/gnu/egcs/f/lang-options.h

   make sure you have the kludged version of that file (at least rev 1.2),
   recompile and reinstall cc1, the problem should go away.

   What's going on is that the 386 linker gets something wrong because of
   the huge strings array in toplev.c, and something gets mislinked, so
   that
   void f(void) __attribute((constructor)) {}
   kills cc1.

   As a work-around, I've killed Fortran options help texts, until someone find
s
   where the linker errs.

      4.2.4 - egcs seems much slower than gcc

   It is, but there is a reason. egcs performs more optimizing passes.
   Data alignment and other such functionality will be better with
   egcs-generated code.

      4.2.5 - egcs generates larger code than gcc

   Yes it does. This is especially noticable with the old -O2 gcc switch.
   egcs introduces a new option, -Os which optimizes for space. This is
   roughly comparable to the old -O2 behavior.

      4.2.6 - After installing egcs I have very little disk space left

   egcs installs into a different subdirectory than gcc 2.8.1. You may
   remove gcc once egcs is bootstrapped and working. (on a related note,
   the perl changes mentioned in [32]4.1 mean that you can remove the
   /usr/lib/perl5 directory. The new location for this data is
   /usr/libdata/perl5.)

    4.3: My make build dies with unimplemented syscall errors.

   Short Answer:

   The kernel structure statfs has changed. You will need to recompile
   the kernel before attempting a make build.

   Long Answer:

   The kernel structure statfs has changed. The new struct statfs has the
   following features:
     * Has a u_int32_t flags field--now softdep can have a real flag.
     * Uses u_int32_t instead of longs (nicer on the alpha). Note: the
       man page used to lie about setting invalid/unused fields to -1.
       SunOS does that but our code never has.
     * Gets rid of f_type completely. It hasn't been used since NetBSD
       0.9 and having it there but always 0 is confusing. It is
       conceivable that this may cause some old code to not compile but
       that is better than silently breaking.
     * Adds a mount_info union that contains the FSTYPE_args struct. This
       means that mount can now tell you all the options a filesystem was
       mounted with. This is especially nice for NFS.

   Other changes:
     * The linux statfs emulation didn't convert between BSD fs names and
       linux f_type numbers. Now it does, since the BSD f_type number is
       useless to linux apps (and has been removed anyway)
     * FreeBSD's struct statfs is different from our (both old and new)
       and thus needs conversion. Previously, the OpenBSD syscalls were
       used without any real translation.
     * mount(8) will now show extra info when invoked with no arguments.
       However, to see everything you need to use the -v (verbose) flag.

   --
   $OpenBSD: obsd-faq.txt,v 1.5 1999/06/22 18:57:35 ericj Exp $
   Copyright  1998-1999, Kjell Wooding.
   Please send any comments, questions, or suggestions to
   [33]kwooding@codetalker.com

References

   1. mailto:kwooding@codetalker.com
   2. http://www.openbsd.org/faq/upgrade-minifaq.html#1.1
   3. http://www.openbsd.org/faq/upgrade-minifaq.html#1.2
   4. http://www.openbsd.org/faq/upgrade-minifaq.html#1.3
   5. http://www.openbsd.org/faq/upgrade-minifaq.html#1.4
   6. http://www.openbsd.org/faq/upgrade-minifaq.html#1.5
   7. http://www.openbsd.org/faq/upgrade-minifaq.html#1.6
   8. http://www.openbsd.org/faq/upgrade-minifaq.html#2.1
   9. http://www.openbsd.org/faq/upgrade-minifaq.html#2.2
  10. http://www.openbsd.org/faq/upgrade-minifaq.html#2.3
  11. http://www.openbsd.org/faq/upgrade-minifaq.html#3.1
  12. http://www.openbsd.org/faq/upgrade-minifaq.html#3.2
  13. http://www.openbsd.org/faq/upgrade-minifaq.html#4.1
  14. http://www.openbsd.org/faq/upgrade-minifaq.html#4.2
  15. http://www.openbsd.org/faq/upgrade-minifaq.html#4.2.1
  16. http://www.openbsd.org/faq/upgrade-minifaq.html#4.2.2
  17. http://www.openbsd.org/faq/upgrade-minifaq.html#4.2.3
  18. http://www.openbsd.org/faq/upgrade-minifaq.html#4.2.4
  19. http://www.openbsd.org/faq/upgrade-minifaq.html#4.2.5
  20. http://www.openbsd.org/faq/upgrade-minifaq.html#4.2.6
  21. http://www.openbsd.org/faq/upgrade-minifaq.html#4.3
  22. ftp://ftp.openbsd.org/pub/OpenBSD/snapshots/
  23. http://www.openbsd.org/faq/upgrade-minifaq.html#1.4
  24. http://www.openbsd.org/faq/upgrade-minifaq.html#1.5
  25. http://www.openbsd.org/anoncvs.html
  26. http://www.openbsd.org/faq/upgrade-minifaq.html#3.1
  27. http://www.openbsd.org/faq/upgrade-minifaq.html#4.2
  28. http://www.openbsd.org/faq/upgrade-minifaq.html#4.3
  29. http://www.openbsd.org/ports.html
  30. http://www.openbsd.org/faq/upgrade-minifaq.html#4.2.2
  31. http://www.openbsd.org/faq/upgrade-minifaq.html#3.1
  32. http://www.openbsd.org/faq/upgrade-minifaq.html#4.1
  33. mailto:kwooding@codetalker.com

