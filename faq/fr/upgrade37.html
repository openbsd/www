<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>OpenBSD Upgrade Guide</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq">
<meta name="distribution"  content="global">
<meta name="copyright"     content="This document copyright 2005 by OpenBSD">
</head>

<body bgcolor="#ffffff" text="#000000">
<a href="../index.html">
<img alt="[OpenBSD]" height=30 width=141
src="../../images/smalltitle.gif" border="0"></a>
<p>
<font color="#0000e0">
<a href="upgrade35.html">[3.4 -> 3.5]</a> |
<a href="upgrade36.html">[3.5 -> 3.6]</a> |
<a href="index.html">[FAQ Index]</a>
</font>

<h1><font color="#e00000">Guide de Mise à niveau : 3.6 à 3.7</font></h1>
<hr>

<i>Remarque : Les mises à niveau ne sont supportées que d'une release à
la suivante.
Ne sautez pas les releases.</i>

<p>
La mise à niveau est un moyen commode afin d'avoir votre système à jour
avec la version la plus récente.
Cependant, les résultats escomptés ne sont pas censés être précisément
ceux d'une installation de zéro.
Les fichiers d'anciennes librairies en particulier ne sont pas supprimés
lors du processus de mise à niveau, car ils pourraient être requis par
de plus anciennes applications pouvant être ou non mise à jour à ce
moment précis.
Si vous voulez vraiment vous débarrasser de ces anciens fichiers, vous
feriez probablement mieux de réinstaller complètement voytre système.

<h2>Avant de mettre à niveau...</h2>
Avant de mettre à niveau, certains utilisateurs choisissent de supprimer
tous les <a href="faq8.html#Packages">packages</a>, et d'installer de
nouvelles versions après la mise à niveau.
<b>Si votre plateforme est l'une de celles qui sont passées à gcc3
(macppc, i386), vous DEVRIEZ faire ceci.</b>


<p>
Pour supprimer rapidement tous les packages de votre système :
<blockquote><pre>
pkg_delete -q /var/db/pkg/*
</pre></blockquote>
Après la mise à niveau, installez les nouvelles versions de ces
applications.

<p>

Notez qu'avec OpenBSD 3.7, les pkg tools supportent à présent la mise à
jour "sur place" en utilisant <code>pkg_add -r</code>. Le fonctionnement
a été vérifié avec la plupart des packages, en particulier avec les
packages des CDs de 3.5 ou 3.6.
Quelques points importants :
<ul>
<li><code>pkg_add -r</code> ne gère pas les mises à jour globales, et il
faut lui indiquer les noms de packages à mettre à jour. Notez les noms
de packages installés avec pkg_info, consultez les noms des nouveaux
packages correspondant, et le lancement de <code>pkg_add -r -q
list_of_new_pkgs</code> devrait fonctionner dans la plupart des cas.
<li>Les instances de mozilla sont une exception. Tous les packages
mozilla, bloatzilla et firefox DOIVENT utiliser l'ancienne procédure :
lancez tout d'abord pkg_delete, puis lancez pkg_add avec le nouveau
package.
</ul>

<p>
<b>Utilisateurs i386 et macppc :</b>
A cause du passage à gcc3, vous devez supprimer le répertoire
<tt>/usr/include/g++</tt> avant la mise à niveau, que vous utilisiez les
médias d'installation ou non.

<blockquote><pre>
rm -rf /usr/include/g++
</pre></blockquote>

<p>
<h2>Mise à niveau sans media d'installation</h2>
<i>Ce n'est pas la solution recommandée. Utilisez le media
d'installation le plus souvent possible !</i>

<p>
On a parfois besoin de mettre à niveau une machine mais on ne peut pas
utiliser le processus classique de mise à niveau. On peut alors réaliser
une mise à niveau basée sur les sources :

<ul>
<li><b>Placez les fichiers d'installation dans un "bon" endroit</b>.
Assurez vous d'avoir la place suffisante !

<li><b>Installez le(s) nouveau(x) noyau(x)</b>
<blockquote><pre>
cd /<i>path</i>
rm /obsd && ln /bsd /obsd && cp bsd /nbsd && mv /nbsd /bsd
cp bsd.rd bsd.mp /
</pre></blockquote>

Notez les étapes additionnelles pour copier par dessus un premier noyau
: celles-ci sont réalisées afin de s'assurer qu'il y ai toujours une
copie valide du noyau sur le disque que le système puisse booter sans
quoi il pourrait y avoir un problème de synchronisation ou une panne
vraiment désagréable.

<li><b>Installez les nouveaux fichiers <tt>/etc/firmware</tt> :</b>
A cause du fait que certains "firmware" ajoutés ont été déplacés du
noyau vers des fichiers dans le répertoire <tt>/etc/firmware</tt>, il y
a quelques drivers qui seront inutilisables s'il n'y a pas de fichier
firmware pouvant être chargés lorsque le nouveau noyau démarre. Ceci
concerne les utilisateurs de certains périphériques, bien que tout
utilisateur devrait considérer cette étape.
Afin d'extraire les fichiers firmware de <tt>base37.tgz</tt>, faites en
étant root les commandes suivantes :

<blockquote><pre>
cd /
tar xzpf /<i>path</i>/base37.tgz "*etc/firmware/*"
</pre></blockquote>

avant la prochaine étape.
</blockquote>

<li><b>Redémarrez votre système avec le nouveau noyau</b><br>
Il peut être tentant de sauter cette étape, mais ceci devrait être fait
dès à présent, ou le nouveau noyau lancera d'anciennes applications
utilisateur (tel que la commande <tt>reboot</tt> ! qui sera importante
pour la suite). Signalons qu'un nouveau "userland" ne marchera PAS sur
un ancien noyau dans la plupart des cas.

<li><b>Arrêtez toutes les applications qui pourraient causer des
       problèmes lors des étapes suivantes.</b>

<li><b>Installez les nouvelles applications du userland</b>
<blockquote><pre>
cd /
tar xzpf /<i>path</i>/base37.tgz
tar xzpf /<i>path</i>/comp37.tgz
tar xzpf /<i>path</i>/game37.tgz
tar xzpf /<i>path</i>/man37.tgz
tar xzpf /<i>path</i>/misc37.tgz
tar xzpf /<i>path</i>/xbase37.tgz
tar xzpf /<i>path</i>/xfont37.tgz
tar xzpf /<i>path</i>/xserv37.tgz
tar xzpf /<i>path</i>/xshare37.tgz
</pre></blockquote>
Remarque : tous les jeux de fichiers ne devront pas être installés pour
toutes les applications, cependant, si vous aviez installé originalement
un jeu de fichiers, vous devrez certainement le mettre à niveau avec le
nouveau jeu de fichiers.
Notez également que <tt>etc37.tgz</tt> N'EST pas décompressé ici, étant
gérés séparément.
Notez aussi que les fichiers dans <tt>/etc</tt> sont gérés séparemment,
<tt>etc37.tgz</tt> et <tt>xetc37.tgz</tt> ne sont pas extraits ici.

<li><b>Mettre à jour <tt>/dev</tt>.</b>
Le nouveau fichier
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=MAKEDEV&amp;sektion=8&amp;arch=i386">MAKEDEV</a>
sera copié dans /dev par l'installation de <tt>base37.tgz</tt>, vous
n'avez ainsi qu'a faire ce qui suit :
<blockquote><pre>
cd /dev
./MAKEDEV all
</pre></blockquote>
Consultez aussi les notes ci-dessous qui sont spécifiques aux versions.

<li><b>Mise à niveau de <tt>/etc</tt> comme ci-dessous</b>.

<li><b>Redémarrez</b>
</ul>

Pendant ce processus,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sendmail&amp;sektion=8">sendmail(8)</a>
pourrait produire des messages d'erreur comme :
<pre>
	Nov 1 12:47:05 puffy sm-mta[16733]: filesys_update failed: No such
	file or directory, fs=., avail=-1, blocksize=380204
</pre>
Ces messages peuvent être ignorés sans risque, mais vous pourriez
vouloir arrêter sendmail(8) pendant la mise à niveau.

<hr>
<p>
<a name="etcUpdates"></a>
<h2>Mises à Jour de <tt>/etc</tt></h2>

Si vous mettez à niveau en utilisant un media d'installation et
faites une "mise à niveau" formelle, ou faites une mise à niveau
binaire "sur place", il y a certaines étapes manuelles qui doivent
être réalisées.
 
<a name="users"></a>
<h4>Nouveaux utilisateurs et groupes</h4>
Le démon FTP a été retravaillé afin d'abandonner ses privilèges, et le
démon OSPF a été ajouté, de nouveaux utilisateurs et groupes sont ainsi
requis.

En étant <i>root</i>, ajoutez les utilisateurs et groupes suivants,
en utilisant
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=useradd&amp;sektion=8">useradd(8)</a>:

<blockquote><pre>
useradd -u84 -g=uid -c"FTP Daemon" -d/var/empty -s/sbin/nologin _ftp
useradd -u85 -g=uid -c"OSPF Daemon" -d/var/empty -s/sbin/nologin _ospfd
</pre></blockquote>

Ces étapes ajouteront à la fois les nouveaux utilisateurs et leurs
groupes correspondant. Votre environnement pourrait vous autoriser à
copier/coller ces commandes.

<a name="apps"></a>
<h4>Applications du Userland</h4>

<p>
<b>X.org remplace XFree86 :</b>
A cause du changement de licence du projet XFree86, OpenBSD a migré vers
le projet X Window System <a href="http://www.x.org">X.org</a>.
Les fichiers de configuration de X11 doivent cependant être mis à jour.
Beaucoup d'utilisateurs peuvent simplement extraire <tt>xetc37.tgz</tt>
sans attention particulière :

<blockquote><pre>
cd /
tar xzpf /<i>path</i>/xetc37.tgz
</pre></blockquote>

Si vous avez pour une quelconque raison fait d'importants changements
sur les fichiers de <tt>/etc/X11</tt>, vous NE devriez PAS extraire le
fichier <tt>xetc37.tgz</tt> comme ci-dessus, mais plutôt fusionner
manuellement vos changements avec les nouveaux fichiers.

<p>
Si vous avez un fichier <tt>/etc/X11/XF86Config</tt> qui fonctionne sur
OpenSBD 3.6, le renommer en <tt>/etc/X11/xorg.conf</tt> vous donnera
probablement un système X Window complètement fonctionnel sur OpenBSD
3.7.
Vous pourriez aussi trouver que les nouvelles versions de X se
configurent davantage par elles-même et, selon votre matériel, vous
pourriez ne pas avoir du tout besoin d'un fichier
<tt>/etc/X11/xorg.conf</tt>.

<p>
<b>changement du comportement de bgpd(8) :</b>
Le nouveau <i>rde route-age [evaluate|ignore]</i> a changé le
comportement de bgpd.
Jusqu'alors, <i>evaluate</i> était l'option implicite par défaut mais
cette option par défaut est devenu <i>ignore</i>. L'évaluation route age
n'est pas spécifiée dans la RFC 1771 et les résultats de décisions non
déterministes sont préférables pour des liens plus stables.

<p>
<b>pfsync prend syncdev au lieu de syncif :</b>
Lors de la configuration du périphérique
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfsync&amp;sektion=4">pfsync</a>,
utilisez 'syncdev' en remplacement du mot clé désuet 'syncif'.

<p>
<b>OpenNTPD règle à présent immédiatement l'heure au démarrage :</b>
Dans OpenBSD 3.7, OpenNTPD est capable de réaliser des corrections
conséquentes, et il n'est plus nécessaire d'utiliser rdate(8) pour
régler l'heure avant de lancer ntpd(8).
Vous pourriez souhaiter désactiver rdate(8) dans votre fichier
rc.conf.local (ou rc.conf) si vous avez opté pour ceci.

<a name="etcfiles"></a>
<h4>Changement de fichiers dans <tt>/etc</tt></h4>
Vous voudrez extraire <tt>etc37.tgz</tt> dans un répertoire temporaire :
<blockquote><pre>
cd /tmp
tar xzpf /<i>path</i>/etc37.tgz
</pre></blockquote>


Fichiers pouvant probablement être copiés de <tt>etc37.tgz</tt> "en
l'état" :

<blockquote><pre>
changelist
daily
fbtab
moduli
netstart
ospfd.conf
rc
security
services
mtree/*
</pre></blockquote>

Notez qu'il est possible de modifier ces fichiers localement, si ceci a
été fait, une fusion manuelle pourrait être nécessaire.
Voici les lignes copiées/collées pour copier ces fichiers, à la
condition que vous ayez extrait <tt>etc37.tgz</tt> dans les répertoires
conseillés ci-dessous :

<blockquote><pre>
cd /tmp/etc
cp changelist daily fbtab moduli netstart ospfd.conf rc security services /etc
cp mtree/* /etc/mtree/
</pre></blockquote>

<p>
Fichiers devant être fusionnés manuellement, en respectant tout
changement local effectué sur ceux-ci :

<blockquote><pre>
ftpusers
rc.conf
spamd.conf
sysctl.conf
mail/aliases
skel/dot.cshrc
skel/dot.profile
</pre></blockquote>

Enfin, utilisez
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=mtree&amp;sektion=8">mtree(8)</a>
pour créer les nouveaux répertoires :
<blockquote><pre>
mtree -qdef /etc/mtree/4.4BSD.dist -p / -u
</pre></blockquote>

<p>
<font color="#0000e0">
<a href="upgrade35.html">[3.4 -> 3.5]</a> |
<a href="upgrade36.html">[3.5 -> 3.6]</a> |
<a href="index.html">[FAQ Index]</a>
</font>

<p>
<hr>
<a href="index.html"><img height="24" width="24"
src="../../images/back.gif" border="0" alt="[back]"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: upgrade37.html,v 1.9 ]<br>
$Translation: upgrade37.html,v 1.11 2005/05/02 21:20:14 aanriot Exp $<br>
-->
$OpenBSD: upgrade37.html,v 1.2 2005/05/19 18:23:05 jufi Exp $
</small>

</body>
</html>
