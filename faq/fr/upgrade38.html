<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>Guide de Mise à Niveau d'OpenBSD</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq">
<meta name="distribution"  content="global">
<meta name="copyright"     content="This document copyright 2005 by OpenBSD">
</head>

<body bgcolor="#ffffff" text="#000000">
<a href="../../fr/index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../images/smalltitle.gif" border="0">    
</a>
<p>
<font color="#0000e0">
<a href="upgrade35.html">[3.4 -> 3.5]</a> |
<a href="upgrade36.html">[3.5 -> 3.6]</a> |
<a href="upgrade37.html">[3.6 -> 3.7]</a> |
<a href="index.html">[Index de la FAQ]</a>
</font>

<h1><font color="#e00000">Guide de Mise à niveau : 3.7 à 3.8</font></h1>
<hr>

<i>Remarque : Les mises à niveau ne sont supportées que d'une release à
la suivante.
Ne sautez pas les releases.</i>

<p><i>
Il est hautement recommandé de lire entièrement la présente page et de
bien comprendre la procédure de mise à jour avant de l'appliquer.
Si vous comptez mettre à jour une machine critique ou physiquement
distante, il est recommandé d'essayer la procédure ci-après sur un
système local d'abord afin d'en vérifier le succès.
</i>

<p>
La mise à niveau est un moyen commode afin d'avoir votre système à jour
avec la version la plus récente.
Cependant, les résultats escomptés ne sont pas censés être précisément
ceux d'une installation de zéro.
Les fichiers d'anciennes librairies en particulier ne sont pas supprimés
lors du processus de mise à niveau, car ils pourraient être requis par
de plus anciennes applications pouvant être ou non mises à jour à ce
moment précis.
Si vous voulez vraiment vous débarrasser de ces anciens fichiers, vous
feriez probablement mieux de réinstaller complètement votre système.

<h2>Before upgrading...</h2>
Avant de mettre à niveau, certains utilisateurs choisissent de supprimer
tous les <a href="../faq15.html#PkgMgmt">packages</a>, et d'installer de
nouvelles versions après la mise à niveau.
<p>
Pour supprimer rapidement tous les packages de votre système :
<blockquote><pre>
pkg_delete -q /var/db/pkg/*
</pre></blockquote>
Après la mise à niveau, installez les nouvelles versions de ces
applications.

<p>

Notez qu'avec OpenBSD 3.8, les pkg tools supportent à présent la mise à
jour "sur place" en utilisant <code>pkg_add -r</code>. Le fonctionnement
a été vérifié avec la plupart des packages, en particulier avec les
packages des CDs de 3.6 ou 3.7.
Quelques points importants :
<ul>
<li><code>pkg_add -r</code> ne gère pas les mises à jour globales, et il
faut lui indiquer les noms de packages à mettre à jour. <code>pkg_add
-u</code>, une nouvelle option, peut être utilisée pour trouver la liste
exacte des packages à transmettre à <code>pkg_add -r</code>.
<li><code>pkg_add -r -F update -F updatedepends -q list_of_new_pkgs</code>
devrait fonctionner dans la plupart des cas.
<li>Les packages Mozilla de 3.7 peuvent être mis à jour en toute
sécurité vers la version 3.8.
</ul>

<h2>Mise à niveau sans media d'installation</h2>
La manière la plus facile et la plus sûre pour effectuer une mise à jour
à partir de fichiers binaires consiste à démarrer depuis un média
d'installation et de suivre les étapes de mise à jour; étapes fortement
similaires à celles décrites dans la <a href="faq4.html">procédure
d'installation</a>. Ensuite, il ne vous restera plus que
<a href="#etcUpdates">la mise à jour de
<tt>/etc</tt></a> à faire comme indiqué plus loin.

<h2>Mise à niveau sans media d'installation</h2>
<i>Ce n'est pas la solution recommandée. Utilisez le media
d'installation le plus souvent possible !</i>

<p>
On a parfois besoin de mettre à niveau une machine mais on ne peut pas
utiliser le processus classique de mise à niveau. On peut alors réaliser
une mise à niveau depuis les sources :

<ul>
<li><b>Placez les fichiers d'installation dans un "bon" endroit</b>.
Assurez vous d'avoir la place suffisante !

<li><b>Stopper toutes les applications "insécurisées" de démarrage au
boot :</b>
Il y aura un moment ou PF ne sera pas le bienvenu pendant le processus
de mise à jour, mais vos applications continueront de démarrer et de
s'arrêter correctement.
Toute application dependante de PF pour la sécurité devrait être
désactivée avant qu'un problème ne se produise, et ne devrait pas être
réactivée avant que le fonctionnement de PF après la mise à jour ait été
vérifié.
Il pourrait également y avoir d'autres applications que vous devriez
suspendre lors de la mise à jour, arrêtez et désactivez les de la même
manière.

<li><b>Installez le(s) nouveau(x) noyau(x)</b>
<blockquote><pre>
cd /<i>path</i>
rm /obsd ; ln /bsd /obsd && cp bsd /nbsd && mv /nbsd /bsd
cp bsd.rd bsd.mp /
</pre></blockquote>

Notez les étapes additionnelles pour copier par dessus un premier noyau
: celles-ci sont réalisées afin de s'assurer qu'il y ai toujours une
copie valide du noyau sur le disque que le système puisse booter sans
quoi il pourrait y avoir un problème de synchronisation ou une panne
vraiment désagréable.

<li><b>Installez les nouveaux fichiers <tt>/etc/firmware</tt> :</b>
A cause du fait que certains "firmware" ajoutés ont été déplacés du
noyau vers des fichiers dans le répertoire <tt>/etc/firmware</tt>, il y
a quelques drivers qui seront inutilisables s'il n'y a pas de fichier
firmware pouvant être chargés lorsque le nouveau noyau démarre. Ceci
concerne les utilisateurs de certains périphériques, bien que tout
utilisateur devrait considérer cette étape.
Afin d'extraire les fichiers firmware de <tt>base38.tgz</tt>, faites en
étant root les commandes suivantes :

<blockquote><pre>
cd /
tar xzpf /<i>path</i>/base38.tgz "*etc/firmware/*"
</pre></blockquote>

avant la prochaine étape.

<li><b>Redémarrez votre système avec le nouveau noyau</b>
Il peut être tentant de sauter cette étape, mais ceci devrait être fait
dès à présent, ou le nouveau noyau lancera d'anciennes applications
utilisateur (tel que la commande <tt>reboot</tt> ! qui sera importante
pour la suite). Signalons qu'un nouveau "userland" ne marchera PAS sur
un ancien noyau dans la plupart des cas.

<li><b>Installez les nouvelles applications du userland</b>
<i>Ne PAS installer <tt>etc38.tgz</tt> et <tt>xetc38.tgz</tt> maintenant
!</i>
<blockquote><pre>
cd /
tar xzpf /<i>path</i>/base38.tgz
tar xzpf /<i>path</i>/comp38.tgz
tar xzpf /<i>path</i>/game38.tgz
tar xzpf /<i>path</i>/man38.tgz
tar xzpf /<i>path</i>/misc38.tgz
tar xzpf /<i>path</i>/xbase38.tgz
tar xzpf /<i>path</i>/xfont38.tgz
tar xzpf /<i>path</i>/xserv38.tgz
tar xzpf /<i>path</i>/xshare38.tgz
</pre></blockquote>
Remarque : tous les jeux de fichiers ne devront pas être installés pour
toutes les applications, cependant, si vous aviez installé originalement
un jeu de fichiers, vous devrez certainement le mettre à niveau avec le
nouveau jeu de fichiers.

<p>
Remarque : les fichiers appartenant à <tt>/etc</tt> sont gérés
séparément. C'est pourquoi les archives <tt>etc38.tgz</tt> et
<tt>xetc38.tgz</tt> ne sont PAS ouvertes à cette étape.

<li><b>Mettre à jour <tt>/dev</tt>.</b>
Le nouveau fichier
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=MAKEDEV&amp;sektion=8&amp;arch=i386">MAKEDEV</a>
sera copié dans /dev par l'installation de <tt>base37.tgz</tt>, vous
n'avez ainsi qu'a faire ce qui suit :
<blockquote><pre>
cd /dev
./MAKEDEV all
</pre></blockquote>
Consultez aussi les notes ci-dessous qui sont spécifiques aux versions.

<li><b>Mise à niveau de <tt>/etc</tt> comme ci-dessous</b>.

<li><b>Redémarrez</b>

</ul>

Pendant ce processus,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sendmail&amp;sektion=8">sendmail(8)</a>
pourrait produire des messages d'erreur comme :
<pre>
        Nov 1 12:47:05 puffy sm-mta[16733]: filesys_update failed: No such
        file or directory, fs=., avail=-1, blocksize=380204
</pre>
Ces messages peuvent être ignorés sans risque, mais vous pourriez
vouloir arrêter sendmail(8) pendant la mise à niveau.

<hr>
<p>
<a name="etcUpdates"></a>
<h2>Mises à Jour de <tt>/etc</tt></h2>

Si vous mettez à niveau en utilisant un media d'installation et
faites une "mise à niveau" formelle, ou faites une mise à niveau
binaire "sur place", il y a certaines étapes manuelles qui doivent
être réalisées.

<a name="users"></a>
<h4>Nouveaux utilisateurs et groupes</h4>
Le démon FTP a été retravaillé afin d'abandonner ses privilèges, et le
démon OSPF a été ajouté, de nouveaux utilisateurs et groupes sont ainsi
requis.

En étant <i>root</i>, ajoutez les utilisateurs et groupes suivants,
en utilisant
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=useradd&amp;sektion=8">useradd(8)</a>:

<blockquote><pre>
useradd -u86 -g=uid -c"HostAP Daemon" -d/var/empty -s/sbin/nologin _hostapd
</pre></blockquote>

Ces étapes ajouteront à la fois les nouveaux utilisateurs et leurs
groupes correspondant. Votre environnement pourrait vous autoriser à
copier/coller ces commandes.

<a name="apps"></a>
<h4>Applications du Userland</h4>

<a name="etcfiles"></a>
<h4>Changement de fichiers dans <tt>/etc</tt></h4>
Vous voudrez extraire <tt>etc38.tgz</tt> dans un répertoire temporaire :
<blockquote><pre>
cd /tmp
tar xzpf /<i>path</i>/etc38.tgz
</pre></blockquote>


Fichiers pouvant probablement être copiés de <tt>etc38.tgz</tt> "en
l'état" :

<blockquote><pre>
hostapd.conf
netstart
pf.os
rc
services
mtree/*
</pre></blockquote>

Notez qu'il est possible de modifier ces fichiers localement, si ceci a
été fait, une fusion manuelle pourrait être nécessaire.
Voici les lignes copiées/collées pour copier ces fichiers, à la
condition que vous ayez extrait <tt>etc38.tgz</tt> dans le répertoire
conseillé ci-dessus :

<blockquote><pre>
cd /tmp/etc
cp hostapd.conf netstart pf.os rc services /etc
cp mtree/* /etc/mtree/
</pre></blockquote>

<p>
Fichiers devant être fusionnés manuellement, en respectant tout
changement local effectué sur ceux-ci :

<blockquote><pre>
ftpusers
inetd.conf
login.conf
rc.conf
sysctl.conf
syslog.conf
mail/aliases
</pre></blockquote>

Les modifications effectuées sur ces fichiers se trouvent dans <a
href="../upgrade38.patch">fichier "patch"</a>.
Vous pouvez essayer de l'utiliser en exécutant la commande suivante avec
les privilèges root :
<blockquote><pre>
cd /
patch -C -p0 &lt;upgrade38.patch
</pre></blockquote>

Ceci aura pour effet de tester le "patch" pour voir s'il s'applique bien
à VOTRE système. Pour l'appliquer, supprimer l'option "<tt>-C</tt>" de
la commande précédente.
Si vous avez effectué des modifications locales sur ces fichiers ou si
vous ne les avez pas gardé aussi à jour que possible par rapport aux
versions officielles, ou si vous effectuez la mise à jour depuis un
snapshot de la version 3.7, il se peut que le "patch" ne passe pas
correctement.
Vous devriez alors intervenir manuellement.
Merci de bien vouloir tester ce procédé avant de vous y fier pour une
machine à laquelle vous ne pouvez avoir accès facilement.

<p>
Les fichiers suivants contiennent des modifications à considérer.
Cependant, une copie ou une comparaison sont peu probables. Dans le cas
de pf.conf par exemple, considérez les changements de stratégie s'il y a
lieu et déterminez si ces changements sont adaptés à l'utilisation que
vous faites de PF.

<blockquote><pre>
pf.conf
spamd.conf
/root/.profile
</pre></blockquote>

Enfin, utilisez
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=mtree&amp;sektion=8">mtree(8)</a>
pour créer les nouveaux répertoires :
<blockquote><pre>
mtree -qdef /etc/mtree/4.4BSD.dist -p / -u
</pre></blockquote>

<p>
<font color="#0000e0">
<a href="upgrade35.html">[3.4 -> 3.5]</a> |
<a href="upgrade36.html">[3.5 -> 3.6]</a> |
<a href="upgrade37.html">[3.6 -> 3.7]</a> |
<a href="index.html">[Index de la FAQ]</a>
</font>

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../images/back.gif" border="0" alt="[back]"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: upgrade38.html,v 1.15 ]<br>
$Translation: upgrade38.html,v 1.9 2006/02/03 14:31:14 ajacoutot Exp $<br>
-->
$OpenBSD: upgrade38.html,v 1.7 2006/02/04 11:51:24 jufi Exp $
</small>

</body>
</html>
