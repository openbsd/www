<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>OpenBSD Upgrade Guide</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq">
<meta name="distribution"  content="global">
<meta name="copyright"     content="This document copyright 2006 by OpenBSD">
</head>

<body bgcolor="#ffffff" text="#000000">
<a href="../../fr/index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../images/smalltitle.gif" border="0">    
</a>
<p>
<font color="#0000e0">
<a href="upgrade35.html">[3.4 -> 3.5]</a> |
<a href="upgrade36.html">[3.5 -> 3.6]</a> |
<a href="upgrade37.html">[3.6 -> 3.7]</a> |
<a href="upgrade38.html">[3.7 -> 3.8]</a> |
<a href="upgrade39.html">[3.8 -> 3.9]</a> |
<a href="index.html">[FAQ Index]</a>
</font>

<h1><font color="#e00000">Guide de Mise à niveau : 3.9 à 4.0</font></h1>
<hr>

<i>Remarque : Les mises à niveau ne sont supportées que d'une release à
la suivante.
Ne sautez pas les releases.</i>

<p><i>
Il est hautement recommandé de lire entièrement la présente page et de
bien comprendre la procédure de mise à jour avant de l'appliquer.
Si vous comptez mettre à jour une machine critique ou physiquement
distante, il est recommandé d'essayer la procédure ci-après sur un
système local d'abord afin d'en vérifier le succès.
</i>

<p>
La mise à niveau est un moyen commode afin d'avoir votre système à jour
avec la version la plus récente.
Cependant, les résultats escomptés ne sont pas censés être précisément
ceux d'une installation de zéro.
Les fichiers d'anciennes bibliothèques en particulier ne sont pas
supprimés lors du processus de mise à niveau, car ils pourraient être
requis par de plus anciennes applications pouvant être ou non mises à
jour à ce moment précis.
Si vous voulez VRAIMENT vous débarrasser de ces anciens fichiers, vous
feriez probablement mieux de réinstaller complètement votre système.

<p>
Table des matières :
<ul>
<li><a href="#before">Avant de mettre à jour</a>
<li><a href="#upgrade">Procédure de mise à jour</a>
<li><a href="#final">Etapes finales</a>
</ul>

<hr>
<p>
<a name="before"></a>
<h2>Avant de mettre à jour</h2>

<!-- XXX add new stuff -->

<p>
Vérifiez si vous avez effectué des modifications à votre noyau.
Par exemple vous pourriez avoir modifié un périphérique réseau afin que
celui-ci utilise un paramètre non standard en utilisant config(8).
Notez vos changements afin d'être en mesure de les reproduire sur le
noyau 4.0.

<p>
<hr>
<a name="upgrade"></a>
<h2>Procédure de mise à jour</h2>

<h3>Mise à niveau avec media d'installation</h3>
La manière la plus facile et la plus sûre pour effectuer une mise à jour
à partir de fichiers binaires consiste à démarrer depuis un média
d'installation et de suivre les étapes de mise à jour; étapes fortement
similaires à celles décrites dans la <a href="faq4.html">procédure
d'installation</a>. Ensuite, terminez la mise à jour en suivant les
<a href="#final">étapes finales</a> ci-dessous.


<h3>Mise à niveau sans media d'installation</h3>
<i>Ce n'est pas la solution recommandée. Utilisez le media
d'installation le plus souvent possible !</i>

<p>
On a parfois besoin de mettre à niveau une machine mais on ne peut pas
utiliser le processus classique de mise à niveau. On peut alors réaliser
une mise à niveau depuis les sources :

<ul>
<li><b>Placez les fichiers d'installation dans un "bon" endroit</b>.
Assurez vous d'avoir la place suffisante !

<li><b>Stopper toutes les applications "insécurisées" de démarrage au
boot :</b>
Il y aura un moment ou PF ne sera pas le bienvenu pendant le processus
de mise à jour, mais vos applications continueront de démarrer et de
s'arrêter correctement.
Toute application dépendante de PF pour la sécurité devrait être
désactivée avant qu'un problème ne se produise, et ne devrait pas être
réactivée avant que le fonctionnement de PF après la mise à jour ait été
vérifié.
Il pourrait également y avoir d'autres applications que vous devriez
suspendre lors de la mise à jour, arrêtez et désactivez les de la même
manière.

<li><b>Vérification du noyau :</b>
Bien que <b>la plupart des gens peuvent sauter cette étape</b>, si vous
aviez un noyau modifié en 3.9 il est probable que vous devrez modifier
le noyau 4.0 de base. Surtout si vous effectuez une mise à jour à
distance, maintenant est le bon moment pour vérifier que le nouveau
noyau fonctionnera après le redémarrage de la machine. Si une
modification du noyau doit être effectuée, la façon la plus sûre est
de l'effectuer sur un système 4.0 local.
Cela peut être aussi simple que de modifier un périphérique spécifique
avec config(8) ou il peut est nécessaire de recompiler le noyau si
l'option que vous souhaitez n'est pas incluse dans le noyau GENERIC.
Consultez la section <a href="faq5.html">FAQ 5 - Construire le Système à
partir des Sources</a> avant d'envisager une recompilation de votre
noyau.

<li><b>Installez le(s) nouveau(x) noyau(x)</b>
<blockquote><pre>
<b>export RELEASEPATH=<i>/yourpath</i></b>
<b>cd ${RELEASEPATH}</b>
<b>rm /obsd ; ln /bsd /obsd && cp bsd /nbsd && mv /nbsd /bsd</b>
<b>cp bsd.rd bsd.mp /</b>
</pre></blockquote>

Notez les étapes additionnelles pour copier par dessus un premier noyau
: celles-ci sont réalisées afin de s'assurer qu'il y ai toujours une
copie valide du noyau sur le disque et que le système puisse booter en
cas de coupure électrique ou de panne du système.

<li><b>Installez les nouveaux fichiers <tt>/etc/firmware</tt> :</b>
parce que certains "firmwares" aient pu être mis à jour, il est possible
que vous deviez mettre à jour le dossier <tt>/etc/firmware</tt>. Ceci
concerne les utilisateurs de certains périphériques, bien que tout
utilisateur devrait considérer cette étape.
Afin d'extraire les fichiers firmware de <tt>base40.tgz</tt>, tapez en
étant root les commandes suivantes :

<blockquote><pre>
<b>cd /</b>
<b>tar xzpf ${RELEASEPATH}/base40.tgz "*etc/firmware/*"</b>
</pre></blockquote>

<b>Remarque :</b> si votre adaptateur sans-fil utilise le pilote
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=iwi&amp;sektion=4">iwi(4)</a>,
vous <i>devez</i> mettre à jour les fichiers du firmware à la version
3.0. A cause de problèmes de license, le firmware n'est pas distribué
avec OpenBSD. Le firmware peut être installé à l'aide des outils pkg en
utilisant le paquetage disponible à
<a href="http://damien.bergamini.free.fr/iwifw/OpenBSD/iwi-firmware-3.0.tgz"
>http://damien.bergamini.free.fr/iwifw/OpenBSD/iwi-firmware-3.0.tgz</a>.

<li><b>Redémarrez votre système avec le nouveau noyau :</b>
Il peut être tentant de sauter cette étape, mais ceci devrait être fait
dès à présent, le nouveau noyau lancera d'anciennes applications
utilisateur (tel que la commande <tt>reboot</tt> ! qui sera importante
pour la suite) mais souvent un nouveau "userland" ne fonctionnera PAS
sur un ancien noyau.

<li><b>Installez les nouvelles applications du userland</b>
<i>Ne PAS installer <tt>etc40.tgz</tt> ni <tt>xetc40.tgz</tt>
maintenant, car cela écrasera vos fichiers de configuration actuels
!</i>

<blockquote><pre>
<b>export RELEASEPATH=/<i>yourpath</i></b>
<b>cd /</b>
<b>tar xzpf ${RELEASEPATH}/base40.tgz</b>
<b>tar xzpf ${RELEASEPATH}/comp40.tgz</b>
<b>tar xzpf ${RELEASEPATH}/game40.tgz</b>
<b>tar xzpf ${RELEASEPATH}/man40.tgz</b>
<b>tar xzpf ${RELEASEPATH}/misc40.tgz</b>
<b>tar xzpf ${RELEASEPATH}/xbase40.tgz</b>
<b>tar xzpf ${RELEASEPATH}/xfont40.tgz</b>
<b>tar xzpf ${RELEASEPATH}/xserv40.tgz</b>
<b>tar xzpf ${RELEASEPATH}/xshare40.tgz</b>
</pre></blockquote>

Remarque : tous les jeux de fichiers ne devront pas être installés pour
toutes les applications, cependant, si vous aviez installé originalement
un jeu de fichiers, vous devrez certainement le mettre à niveau avec le
nouveau jeu de fichiers.

<p>
Remarque : les fichiers appartenant à <tt>/etc</tt> sont gérés
séparément. C'est pourquoi les archives <tt>etc40.tgz</tt> et
<tt>xetc40.tgz</tt> ne sont PAS ouvertes à cette étape.

<li><b>Mettre à jour <tt>/dev</tt>.</b>
Le nouveau fichier
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=MAKEDEV&amp;sektion=8&amp;arch=i386">MAKEDEV</a>
sera copié dans /dev par l'installation de <tt>base40.tgz</tt>, vous
n'avez ainsi qu'à faire ce qui suit :
<blockquote><pre>
<b>cd /dev</b>
<b>./MAKEDEV all</b>
</pre></blockquote>

<li><b>Mise à niveau de <tt>/etc</tt> comme ci-dessous</b>.

<li><b>Redémarrez</b>
</ul>

Pendant ce processus,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sendmail&amp;sektion=8">sendmail(8)</a>
pourrait produire des messages d'erreur comme :
<pre>
        Nov 1 12:47:05 puffy sm-mta[16733]: filesys_update failed: No such
        file or directory, fs=., avail=-1, blocksize=380204
</pre>
Ces messages peuvent être ignorés sans risque, mais vous pourriez
vouloir arrêter sendmail(8) pendant la mise à niveau.

<p>

<hr>
<a name="final"></a>
<h2>Etapes finales</h2>

<a name="etcUpgrade"></a>
<h3>1. Mise à Jour de <tt>/etc</tt></h3>

Si vous mettez à niveau en utilisant un media d'installation et faites
une "mise à niveau" formelle, ou faites une mise à niveau binaire "sur
place", il y a certaines étapes manuelles qui doivent être réalisées.

<a name="users"></a>
<h4>1.1. Nouveaux utilisateurs et groupes</h4>
<ul>
<li>Le remplacement de mrouted(8) a débuté et afin d'utiliser ce nouveau
daemon, un nouveau couple d'utilisateur et groupe est nécessaire.

En tant que <i>root</i>, ajoutez les utilisateurs et groupes suivants en
utilisant
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=useradd&amp;sektion=8">useradd(8)</a> :

<blockquote><pre>
# useradd -u87 -g=uid -c"DVMRP Daemon" -d/var/empty -s/sbin/nologin _dvmrpd
</pre></blockquote>

This step will add both the new user and its corresponding group.
Your environment may allow you to copy/paste those commands.
</ul>

<a name="apps"></a>
<h4>1.2. Applications du Userland</h4>
<ul>
<li><b>IPsec now configured by ipsecctl(8)</b>
<p>
La configuration d'IPsec est désormais totalement supportée par
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsecctl&amp;sektion=8">ipsecctl(8)</a>.
L'utilitaire
<em><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsecadm&amp;sektion=8&amp;manpath=OpenBSD+3.9">ipsecadm(8)</a></em>
est désormais obsolète et a été supprimé de l'arbre CVS.
Référez-vous au manuel d'
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsec.conf&amp;sektion=5">ipsec.conf(5)</a>
pour des exemples de configuration.
<p>

<li><b>wicontrol(8) removed</b>
<p>
La configuration sans-fil pour
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=wi&amp;sektion=4">wi(4)</a>
est désormais totalement supportée par
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ifconfig&amp;sektion=8">ifconfig(8)</a>.
L'utilitaire
<em><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=wicontrol&amp;sektion=
8&amp;manpath=OpenBSD+3.9">wicontrol(8)</a></em>
est désormais obsolète et a été supprimé de l'arbre CVS.
<p>

<li><b>spppcontrol(8) removed</b>
<p>
A présent, la configuration de PPP en mode noyau est totalement
supportée par
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ifconfig&amp;sektion=8">ifconfig(8)</a>.
L'utilitaire
<em><a href="http://www.openbsd.org/cgi-bin/man.cgi?query=spppcontrol&amp;sektion=8&amp;manpath=OpenBSD+3.9">spppcontrol(8)</a></em>
est désormais obsolète et a été retiré de l'arbre des sources.
Référez-vous aux manuels de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sppp&amp;sektion=4">sppp(4)</a>
et
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pppoe&amp;sektion=4">pppoe(4)</a>
pour des exemples de configuration.
<p>
Précédemment, le fichier /etc/hostname.pppoe0 ressemblait à :
<pre>
pppoedev ne0
!/sbin/ifconfig ne0 up
!/usr/sbin/spppcontrol \$if myauthproto=pap myauthname=testcaller \
        myauthkey=donttell
!/sbin/ifconfig \$if inet 0.0.0.0 0.0.0.1 netmask 0xffffffff
!/sbin/route add default 0.0.0.1
up
</pre>
Il devra être mis à jour de la façon suivante :
<pre>
inet 0.0.0.0 255.255.255.255 0.0.0.1 pppoedev ne0 \
        authproto pap authname testcaller authkey donttell up
!/sbin/route add default 0.0.0.1
</pre>
Et l'interface physique doit être marquée comme active ("UP") :
<pre>
# echo "up" > /etc/hostname.ne0
</pre>

</ul>

<a name="etcfiles"></a>
<h4>1.3. Changement de fichiers dans <tt>/etc</tt></h4>
Il vous faut extraire <tt>etc40.tgz</tt> dans un répertoire temporaire :
<blockquote><pre>
<b>cd /tmp</b>
<b>tar xzpf ${RELEASEPATH}/etc40.tgz</b>
</pre></blockquote>

Fichiers pouvant probablement être copiés de <tt>etc40.tgz</tt> "en
l'état" :

<blockquote><pre>
... (TBD)
<!-- chio.conf
dvmrpd.conf
netstart
pf.os
ppp.conf.sample

mail/helpfile
mail/localhost.cf
mail/sendmail.cf
mail/submit.cf

mtree/* -->
</pre></blockquote>

Notez qu'il EST possible de modifier ces fichiers localement, si ceci a
été fait, une fusion manuelle pourrait être nécessaire.
Voici les lignes copiées/collées pour copier ces fichiers, à la
condition que vous ayez extrait <tt>etc40.tgz</tt> dans le répertoire
conseillé ci-dessus :

<blockquote><pre>
<b>cd /tmp/etc</b>
<b>cp ... /etc</b>
<b>cp mtree/* /etc/mtree/</b>
</pre></blockquote>

<p>
Fichiers devant être fusionnés manuellement, en respectant tout
changement local effectué sur ceux-ci s'ils ont été modifiés par rapport
à la configuration par défaut ; sinon, copiez-les simplement :

<blockquote><pre>
... (TBD) 
<!-- changelist
ftpusers


mail/aliases

rc.conf
ssh/ssh_config
ssh/sshd_config
sysctl.conf -->
</pre></blockquote>

Les modifications effectuées sur ces fichiers se trouvent dans le <a
href="../upgrade40.patch">fichier "patch"</a>.
Vous pouvez essayer de l'utiliser en exécutant la commande suivante avec
les privilèges root :
<blockquote><pre>
<b>cd /</b>
<b>patch -C -p0 &lt; upgrade40.patch</b>
</pre></blockquote>

Ceci aura pour effet de tester le "patch" pour voir s'il s'applique bien
à VOTRE système. Pour l'appliquer, supprimer l'option "<tt>-C</tt>" de
la commande précédente.
Si vous avez effectué des modifications locales sur ces fichiers ou si
vous ne les avez pas gardées aussi à jour que possible par rapport aux
versions officielles, ou si vous effectuez la mise à jour depuis un
snapshot de la version 3.9, il se peut que le "patch" ne passe pas
correctement.
Vous devriez alors intervenir manuellement.
Merci de bien vouloir tester ce procédé avant de vous y fier pour une
machine à laquelle vous ne pouvez avoir accès facilement.

<p>
Les fichiers suivants contiennent des modifications à considérer.
Cependant, une copie ou une comparaison sont peu probables (dans le cas
de pf.conf par exemple, considérez les changements de stratégie s'il y a
lieu et déterminez si ces changements sont adaptés à votre utilisation). 

<blockquote><pre>
... (TBD) 
<!-- hostapd.conf
ipsec.conf
rc.local -->
</pre></blockquote>

Enfin, utilisez
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=mtree&amp;sektion=8">mtree(8)</a>
pour créer les nouveaux répertoires :
<blockquote><pre>
<b>mtree -qdef /etc/mtree/4.4BSD.dist -p / -u</b>
</pre></blockquote>

<h3>2. Vérification du noyau</h3>
Remarque : <b>la plupart des gens peuvent sauter cette étape !</b>
<p>
Si vous avez suivi les instructions de mise à niveau sans media
d'installation vous aurez déjà accompli cette étape.
En revanche, si vous utilisez le media d'installation et si vous aviez
un noyau modifié en 3.9 il est probable que vous devriez modifier le
noyau 4.0 de base. Cela peut être aussi simple que de modifier un
périphérique spécifique abev config(8) ou il peut est nécessaire de
recompiler le noyau si l'option que vous souhaitez n'est pas incluse
dans le noyau GENERIC.
Consultez la section <a href="faq5.html">FAQ 5 - Construire le Système à
partir des Sources</a> avant d'envisager une recompilation de votre
noyau.

<h3>3. Mise à jour des paquetages</h3>
Si vous avez installé des paquetages sur votre machine vous allez pouvoir
les mettre à jour après la mise à niveau de votre système de base.
Les utilitaires de gestion des paquetages ("pkg tools") supportent la
mise à jour avec la commande <tt>pkg_add -u</tt>.
Par exemple, pour mettre à jour tous vos paquetages, soyez certains que
<tt>PKG_PATH</tt> pointe bien vers le répertoire contenant les paquetages
4.0 sur votre CD ou un proche miroir FTP et utilisez une commande du
type

<blockquote><pre>
<b># pkg_add -ui -F update -F updatedepends</b>
</pre></blockquote>

où <tt>-u</tt> indique le mode mise à jour et <tt>-i</tt> le mode
interactif, ainsi pkg_add vous demandera ce que vous souhaitez faire
lorsque celui-ci rencontrera une ambiguïté. Lisez le manuel de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pkg_add&amp;sektion=1&amp;manpath=OpenBSD+4.0">pkg_add(1)</a>
et le chapitre de la FAQ sur la <a href="../faq15.html#PkgMgmt">gestion
des paquetages</a> pour de plus amples informations.


<p>
<font color="#0000e0">
<a href="upgrade35.html">[3.4 -> 3.5]</a> |
<a href="upgrade36.html">[3.5 -> 3.6]</a> |
<a href="upgrade37.html">[3.6 -> 3.7]</a> |
<a href="upgrade38.html">[3.7 -> 3.8]</a> |
<a href="upgrade39.html">[3.8 -> 3.9]</a> |
<a href="index.html">[FAQ Index]</a>
</font>

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../images/back.gif" border="0" alt="[back]"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: upgrade40.html,v 1.4 ]<br>
$Translation: upgrade40.html,v 1.5 2006/09/21 22:26:17 saad Exp $<br>
-->
$OpenBSD: upgrade40.html,v 1.4 2006/09/21 22:44:37 saad Exp $
</small>

</body>
</html>
