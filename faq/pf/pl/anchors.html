<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Zakotwiczenia</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-2">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003-2005 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif" border="0">
</a>

<p>
[<a href="scrub.html">Wstecz: Scrub (normalizacja pakietów)</a>]
[<a href="index.html">Spis tre¶ci</a>]
[<a href="queueing.html">Dalej: Kolejkowanie</a>]

<p>
<h1><font color="#e00000">PF: Zakotwiczenia</font></h1>

<hr>

<h3>Spis tre¶ci</h3>
<ul>
<li><a href="#intro">Wprowadzenie</a>
<li><a href="#anchors">Zakotwiczenia</a>
<li><a href="#options">Opcje zakotwiczeñ</a>
<li><a href="#manip">Manipulowanie zakotwiczeniami</a>
</ul>

<hr>

<a name="intro"></a>
<h2>Wprowadzenie</h2>
Poza g³ównym zestawem regu³, PF mo¿e przetwarzaæ tak¿e podzestawy.
Poniewa¿ podzestawy mog± byæ modyfikowane w trakcie dzia³ania przy pomocy
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+3.7"
>pfctl(8)</a>, mog± stanowiæ wygodny sposób dynamicznego
zarz±dzania aktywnym zestawem regu³. Podczas gdy
<a href="tables.html">tabele</a> s± wykorzystywane do
przechowywania dynamicznych list adresów, podzestawy
regu³ mog± przechowywaæ dynamiczne zestawy regu³ filtruj±cych,
<tt>nat</tt>, <tt>rdr</tt>, i <tt>binat</tt>.

<p>
Podzestawy regu³ s± do³±czane do g³ównego zestawu regu³ przy pomocy
zakotwiczeñ (ang. anchors). S± cztery typy regu³ zakotwiczeñ <tt>anchor</tt>:
<ul>
<li><tt>anchor <i>name</i></tt> - przetwarza wszystkie regu³y
<a href="filter.html">filtruj±ce</a>
w zakotwiczeniu <i><tt>name</tt></i>
<li><tt>binat-anchor <i>name</i></tt> - przetwarza wszystkie
regu³y <a href="nat.html#binat"><tt>binat</tt></a>
w zakotwiczeniu <i><tt>name</tt></i>
<li><tt>nat-anchor <i>name</i></tt> - przetwarza wszystkie regu³y
<a href="nat.html"><tt>nat</tt></a>
w zakotwiczeniu <i><tt>name</tt></i>
<li><tt>rdr-anchor <i>name</i></tt> - przetwarza wszystkie regu³y
<a href="rdr.html"> <tt>rdr</tt></a>
w zakotwiczeniu <i><tt>name</tt></i>
</ul>

Zakotwiczenia mog± byæ zagnie¿d¿ane co pozwala by zestawy podregu³ wi±za³y
siê wzajemnie.
Regu³y zakotwiczeñ bêd± oceniane wzglêdem zakotwiczenia w którym
zosta³y za³adowane.
Na przyk³ad, zakotwiczone zestawy
regu³ w g³ównym zestawie regu³ utworz± punkty zakotwiczenia w tym
zestawie, jako zestawie nadrzêdnym, a regu³y zakotwiczeñ w podpiêtych
z dyrektyw± <tt>load anchor</tt> plikach regu³ utworz± punkty
zakotwiczenia w danym podzestawie, jako ich zestawie nadrzêdnym.

<a name="named"></a>
<a name="anchors"></a>
<h2>Zakotwiczenia</h2>
Zakotwiczona to kolekcje regu³ filtruj±cych, translacji, tabel i innych
zakotwiczeñ, które maj± przyporz±dkowan± nazwê.
Gdy PF natrafi na jak±¶ regu³ê <tt>anchor</tt> w g³ównym zestawie
regu³, w momencie gdy jest przetwarzany g³ówny zestaw regu³ zostan±
przetworzone wszystkie zawarte w nim regu³y.
Porównywanie regu³ bêdzie nastêpnie kontynuowane, chyba ¿e pakiet
zostanie dopasowany do regu³y korzystaj±cej z opcji <tt>quick</tt>
lub regu³y translacyjnej w tym zakotwiczeniu, kiedy to dopasowanie
bêdzie uznane za ostateczne i spowoduje zaniechanie dalszego
porównywania regu³ w samym, zakotwiczeniu jak i g³ównym zestawie
regu³.

<p>
Na przyk³ad:
<blockquote>
<tt>
ext_if = "fxp0"<br>
<br>
block on $ext_if all<br>
pass &nbsp;out on $ext_if all keep state<br>
anchor goodguys
</tt>
</blockquote>

<p>
Ten zestaw regu³ sankcjonuje politykê domy¶lnego blokowania dla
zarówno przychodz±cego jak i wychodz±cego ruchu. Ruch jest
nastêpnie przepuszczany na zewn±trz wraz z ¶ledzeniem stanu po³±czenia,
a tak¿e tworzone jest zakotwiczenie nazwane <tt>goodguys</tt>.
Zakotwiczenia mog± byæ wype³niane regu³ami na dwa sposoby:
<ul>
<li>korzystaj±c z regu³y <tt>load</tt>
<li>korzystaj±c z
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+3.7"
>pfctl(8)</a>
</ul>

<p>
Regu³a <tt>load</tt> powoduje, ¿e <tt>pfctl</tt> wype³nia regu³ami
dane zakotwiczenie i nazwany zestaw regu³ poprzez ich odczyt z pliku
tekstowego. 
Regu³a <tt>load</tt> musi byæ umieszczona po regule <tt>anchor</tt>.
Na przyk³ad:
<blockquote>
<tt>
anchor goodgays<br>
load anchor goodguys:ssh from "/etc/anchor-goodguys-ssh"
</tt>
</blockquote>

<p>
Aby dodaæ regu³y do zakotwiczenia przy pomocy <tt>pfctl</tt>, mo¿e
zostaæ u¿yta komenda skonstruowana podobnie do poni¿szej: 
<blockquote>
<tt>
# echo "pass in proto tcp from 192.0.2.3 to any port 22" \<br>
&nbsp;&nbsp;&nbsp;| pfctl -a goodguys/ssh -f -
</tt>
</blockquote>

<p>
Regu³y mog± byæ tak¿e zapisywane i odczytywane z pliku tekstowego:
<blockquote>
<tt>
# cat &gt;&gt; /etc/anchor-goodguys-www<br>
pass in proto tcp from 192.0.2.3 to any port 80<br>
pass in proto tcp from 192.0.2.4 to any port { 80 443 }<br>
<br>
# pfctl -a goodguys -f /etc/anchor-goodguys-www<br>
</tt>
</blockquote>

<p>
Regu³y filtruj±ce i translacyjne mog± byæ za³adowane z nazwanego
zestawu regu³ z wykorzystaniem tych samych opcji i sk³adni, co
przy ³adowaniu z g³ównego zestawu regu³.
Z zastrze¿eniem, i¿ wykorzystywane <a href="macros.html">makra</a> 
musz± byæ zdefiniowane w danym zestawie, a makra g³ównego
zestawu regu³ <i>nie</i> bêd± widoczne w nazwanych zestawach regu³.

<p>
Odk±d zakotwiczenie mo¿e byæ gniazdem, mo¿liwe jest sprecyzowanie, ¿e
wszystkie potomne zakotwiczenia wewn±trz sprecyzowanego, bêd± oceniane:
     
<blockquote>
<tt>
anchor "spam/*"
</tt>
</blockquote>

<p>
Ta sk³adnia powoduje, ¿e ka¿da regu³a wewn±trz ka¿dego zakotwiczenia 
pod³±czonego do zakotwiczenia <tt>spam</tt> bêdzie oceniana.
Zakotwiczenia potomne bêd± szacowane w kolejno¶ci alfabetycznej
jednak nie bêd± schodzi³y rekurencyjnie.
Zakotwiczenia zawsze bêd± oceniane wzglêdem zakotwiczenia w którym
zosta³y zdefiniowane.

<p>
Ka¿de zakotwiczenie , podobnie jak i g³ówny zestaw regu³
funkcjonuje niezale¿nie od innych zestawów. Operacje wykonywane
na pojedynczym zestawie, takie jak wyczyszczenie (ang. flush),
nie maj± wp³ywu na pozosta³e zestawy regu³. Ponad to, usuniêcie
zakotwiczenia z g³ównego zestawu regu³ nie niszczy zakotwiczenia,
ani ¿adnego zakotwiczenia potomnego, który jest do niego podpiêty.
Zakotwiczenie nie jest niszczone a¿ do momentu wyczyszczenia
wszystkich regu³ przy pomocy
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+3.7"
>pfctl(8)</a>, w sytuacji w której nie istniej± ¿adne zakotwiczenia
potomne wewn±trz.

<a name="options"></a>
<h2>Opcje zakotwiczeñ</h2>
Opcjonalnie, regu³y <tt>anchor</tt> mog± precyzowaæ interfejs sieciowy,
protokó³, adres ¼ród³owy i docelowy itp przy pomocy tej samej sk³adni co
regu³y filtruj±ce. Je¶li takie informacje s± podawane, regu³y
<tt>anchor</tt> s± przetwarzane jedynie gdy pakiet pasuje do definicji
danej regu³y <tt>anchor</tt>.
Na przyk³ad:
<blockquote>
<tt>
ext_if = "fxp0"<br>
<br>
block on $ext_if all<br>
pass &nbsp;out on $ext_if all keep state<br>
anchor ssh in on $ext_if proto tcp from any to any port 22<br>
</tt>
</blockquote>

<p>
Regu³y zakotwiczenia <tt>ssh</tt> s± przetwarzane jedynie
dla pakietów TCP o docelowym porcie 22, i które nadchodz± przez
<tt>fxp0</tt>.
Regu³y s± nastêpnie dodawane do zakotwiczenia <tt>anchor</tt>
w nastêpuj±cy sposób:
<blockquote>
<tt>
# echo "pass in from 192.0.2.10 to any" | pfctl -a ssh -f -
</tt>
</blockquote>

<p>
Mimo i¿ regu³y filtruj±ce nie precyzuj± interfejsu, protoko³u
czy portu, jedynie host 192.0.2.10 bêdzie mia³ prawo ³±czyæ siê
przy pomocy SSH ze wzglêdu na definicje zakotwiczenia <tt>anchor</tt>.

<a name="manip"></a>
<h2>Manipulowanie zakotwiczeniami</h2>
Manipulowanie zakotwiczeniami odbywa siê poprzez <tt>pfctl</tt>.
Program ten mo¿e byæ wykorzystywany do dodawania
i usuwania regu³ z zestawu bez konieczno¶ci prze³adowywania
g³ównego zestawu regu³.

<p>
Aby wy¶wietliæ wszystkie regu³y zakotwiczenia nazwanego <tt>ssh</tt>:
<blockquote>
<tt>
# pfctl -a ssh -s rules
</tt>
</blockquote>

<p>
Aby wyczy¶ciæ wszystkie regu³y z tego samego zakotwiczenia:
<blockquote>
<tt>
# pfctl -a ssh -F rules
</tt>
</blockquote>

<p>
Pe³na lista komend znajduje siê na stronach man
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+3.7"
>pfctl(8)</a>.

<p>
[<a href="scrub.html">Wstecz: Scrub (normalizacja pakietów)</a>]
[<a href="index.html">Spis tre¶ci</a>]
[<a href="queueing.html">Dalej: Kolejkowanie</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[wstecz]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: anchors.html,v 1.17 ]<br>
$Translation: anchors.html,v 1.12 2005/08/24 11:41:58 pl-team Exp $<br>
-->
$OpenBSD: anchors.html,v 1.10 2005/08/24 12:58:45 saad Exp $
</small>
</body>
</html> 
