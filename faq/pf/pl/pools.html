<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Pule adresów i kierowanie ruchem</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-2">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, 2004 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="queueing.html">Wstecz: Kolejkowanie</a>]
[<a href="index.html">Spis tre¶ci</a>]
[<a href="tagging.html">Dalej: Packet Tagging</a>]

<p>
<h1>
<font color="#e00000">PF: Pule adresów i kierowanie ruchem</font>
</h1>

<hr>

<h3>Spis tre¶ci</h3>
<ul>
<li><a href="#intro">Wstêp</a>
<li><a href="#nat">Pula adresowa dla NAT</a>
<li><a href="#incoming">Równowa¿enie obci±¿enia dla po³±czeñ przychodz±cych</a>
<li><a href="#outgoing">Równowa¿enie obci±¿enia ruchu wychodz±cego</a>
	<ul>
	<li><a href="#outexample">Przyk³adowy zestaw regu³</a>
	</ul>
</ul>

<hr>

<a name="intro"></a>
<h2>Wstêp</h2>
Pula adresów jest zbiorem dwóch lub wiêcej adresów, które, w razie
konieczno¶ci, s± dzielone pomiêdzy u¿ytkowników. Znajduj± one zastosowanie jako
zestawy adresów dla przekierowañ w regu³ach <a href="rdr.html"><tt>rdr</tt></a>,
jako adresy u¿yte przy translacji adresów w regu³kach
<a href="nat.html"><tt>nat</tt></a>, lub te¿ jako adresy docelowe przy opcjach
<a href="filter.html">filtra pakietów</a>: <tt>route-to</tt>, <tt>reply-to</tt>
oraz <tt>dup-to</tt>.

<p>
Istniej± cztery metody u¿ywania pul adresów:
<ul>
<li><tt>bitmask</tt> - w tej metodzie czê¶æ adresu IP wskazuj±ca na sieæ
pobierana jest z puli adresowej i umieszczana w adresie, który ma zostaæ
zmodyfikowany (adres ¼ród³owy dla regu³ <tt>nat</tt>, docelowy dla regu³
<tt>rdr</tt>). Na przyk³ad: je¶li pula adresowa zawiera w sobie sieæ
192.0.2.1/24, a modyfikowany adres to 10.0.0.50, wiêc wynikiem bêdzie adres
192.0.2.50. Je¶li pul± adresow± bêdzie sieæ 192.0.2.1/25, modyfikowyany adres
to 10.0.0.130, otrzymany adres bêdzie wygl±da³ nastêpuj±co: 192.0.2.2.
<li><tt>random</tt> - adresy z puli adresowej wybierane s± w sposób losowy.
<li><tt>source-hash</tt> - u¿ycie funkcji mieszaj±cej na adresie ¼ród³owym do
okre¶lenia, który adres z puli ma zostaæ wykorzystany. Ta metoda daje gwarancje,
¿e dla tego samego adresu ¼ród³owego bêdzie przypisany zawsze ten sam adres z
puli adresowej. Klucz u¿ywany przez algorytm mieszaj±cy, mo¿e byæ opcjonalnie
podany po s³owie kluczowym <tt>source-hash</tt> w formacie szesnastkowym lub
jako tekst. Domy¶lnie
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+3.7"
>pfctl(8)</a> generuje nowy klucz za ka¿dym razem gdy zestaw regu³ jest ³adowany.
<li><tt>round-robin</tt> - wykorzystanie wszystkich adresów kolejno. Jest to
domy¶lna metoda, a tak¿e jedyna dostêpna w przypadku podania puli adresowej
przy u¿yciu <a href="tables.html"tabeli</a>.
</ul>

<p>
Dla wiêkszo¶ci z wy¿ej wymienionych sposobów, pule adresów musz± byæ podane jako
bloki sieci w formacie 
<a href="http://public.pacbell.net/dedicated/cidr.html">CIDR</a> (Classless
Inter-Domain Routing). jedynie metoda <tt>round-robin</tt> akceptuje wiele
pojedyñczych adresów IP podanych jako
<a href="macros.html#lists">lista</a> b±d¼ <a href="tables.html">tabela</a>.

<p>
Opcja <tt>sticky-address</tt> mo¿e byæ u¿ywana wraz pulami <tt>random</tt>
lub <tt>round-robin</tt> aby zapewniæ, ¿e dany adres ¼ród³owy jest
zawsze mapowany do tego samego adresu przy przekierowaniu.

<a name="nat"></a>
<h2>Pula adresowa dla NAT</h2>
Pula adresowa mo¿e byæ u¿ywana jako adres do mapowania w regu³ach
<a href="nat.html"><tt>nat</tt></a>. Po³±czenia obs³ugiwane przez NAT bêd± mia³y
adres ¼ród³owy zamieniony, przy u¿yciu jednej z wcze¶niej opisanych metod, na
adres z puli adresowej. Takie wykorzystanie puli adresowej jest niezwykle
u¿yteczna w sytuacjach gdy PF jest u¿ywany do mapowania adresów w bardzo du¿ej
sieci. Poniewa¿ ilo¶æ mapowanych po³±czeñ dla jednego adresu zewnêtrznego jest
ograniczona, dodanie kilku adresów wykorzystywanych do obs³ugi NAT pozwala
zwiêkszyæ ilo¶æ obs³ugiwanych u¿ytkowników.

<p>
Poni¿szy przyk³ad przedstawia wykorzystanie puli sk³adaj±cej siê z dwóch adresów
do translacji wychodz±cych pakietów. Dla ka¿dego po³±czenia PF bêdzie
przypisywa³, na zmianê, jeden z adresów wchodz±cych w sk³ad puli, zgodnie z
metod± round-robin.

<blockquote>
<tt>
nat on $ext_if inet from any to any -&gt; { 192.0.2.5, 192.0.2.10 }
</tt>
</blockquote>

<p>
Jedn± z wad tej metody jest fakt, ¿e kolejne po³±czenia z tego samego adresu z
sieci wewnêtrznej nie zawsze bêd± mapowane na ten sam adres zewnêtrzny. Mo¿e to
powodowaæ problemy, na przyk³ad, podczas przegl±dania stron, które ¶ledz±
u¿ytkowników na podstawie adresu IP. Alternatywnym rozwi±zaniem problemu mo¿e
byæ wykorzystanie metody <tt>source-hash</tt>, w której dla danego adresu
wewnêtrznego przypisywany jest dok³adnie ten sam adres zewnêtrzny. Aby
wykorzystaæ t± metodê niezbêdne jest zdefiniowanie puli adresowej jako bloku
sieci w formacie
<a href="http://public.pacbell.net/dedicated/cidr.html">CIDR</a>.

<blockquote>
<tt>
nat on $ext_if inet from any to any -&gt; 192.0.2.4/31 source-hash
</tt>
</blockquote>

<p>
Ta przyk³adowa regu³a <tt>nat</tt> u¿ywa puli adresowej 192.0.2.4/31 (192.0.2.4
- 192.0.2.5) do translacji adresów dla wychodz±cych pakietów. Dany wewnêtrzny
adres bêdzie zawsze przet³umaczony na ten sam adres zewnêtrzny poniewa¿ zosta³o
u¿yte s³owo kluczowe <tt>source-hash</tt>.

<a name="incoming"></a>
<h2>Równowa¿enie obci±¿enia dla po³±czeñ przychodz±cych</h2>
Pule adresowe znajduj± tak¿e zastosowanie przy równowa¿eniu obci±¿enia serwerów
obs³uguj±cych nadchodz±ce wywo³ania. Na przyk³ad ¿±dania dla serwera stron
www mog± byæ roz³o¿one na ró¿ne serwery posiadaj±ce te same zasoby: 
<blockquote>
<tt>
web_servers = "{ 10.0.0.10, 10.0.0.11, 10.0.0.13 }"<br>
<br>
rdr on $ext_if proto tcp from any to any port 80 -&gt; $web_servers \<br>
&nbsp;&nbsp;&nbsp;&nbsp;round-robin sticky-address
</tt>
</blockquote>

Nawi±zane po³±czenia bêd± przekierowywane do danego serwera zgodnie z
metod± round-robin. Tak d³ugo jak d³ugo istnieje wpis w tabeli stanów
odno¶nie danego po³±czenia, tak d³ugo opcja <tt>sticky-address</tt>
powodowaæ bêdzie, ¿e ten sam adres ¼ród³owy przekierowany bêdzie
do tego samego serwera. Po wyga¶niêciu wpisu w tabeli, nowe po³±czenie
mo¿e byæ przekierowane do nastêpnego serwera.

<p>
Tak samo jak w przypadku przyk³adu dla NAT, je¶li serwery www bêd± znajdowaæ siê
w jednym bloku CIDR, opcja <tt>source-hash</tt> mo¿e byæ u¿yta do zapewnienia,
¿e wywo³ania z danego adresu IP bêd± zawsze przekierowane do tego samego
serwera. Takie zachowanie mo¿e byæ wymagane do utrzymania sesji podczas
przegl±dania strony www.

<a name="outgoing"></a>
<h2>Równowa¿enie obci±¿enia ruchu wychodz±cego</h2>
Pule adresowe, w po³±czeniu z opcja <tt>route-to</tt> filtra pakietów, doskonale
nadaj± siê do równowa¿enia ruchu wychodz±cego pomiêdzy dwa (lub wiêcej)
interfejsy zapewniaj±ce po³±czenia z Internetem, kiedy ¿aden z odpowiednich
protoko³ów wyznaczania tras (jak np.:
<a href="http://www.rfc-editor.org/rfc/rfc1771.txt">BGP4</a>) jest niedostêpny.
U¿ycie opcji <tt>route-to</tt> wraz z pul± adresow± obs³ugiwan± metod±
<tt>round-robin</tt> sprawia, ¿e po³±czenia wychodz±ce mog± byæ równomiernie
roz³o¿one pomiêdzy ró¿ne zewnêtrzne interfejsy sieciowe.

<p>
Informacj± niezbêdn± do wykonania równowa¿enia ruchu wychodz±cego jest adres IP
granicznego routera dla ka¿dego po³±czenia z Internetem. Jest to niezbêdne dla
opcji <tt>route-to</tt> do okre¶lenia miejsca przeznaczenia dla wychodz±cych
pakietów.

<p>
Poni¿szy przyk³ad prezentuje równowa¿anie ruchu wychodz±cego do Internetu
poprzez dwa interfejsy sieciowe:
<blockquote>
<tt>
lan_net = "192.168.0.0/24"<br>
int_if &nbsp;= "dc0"<br>
ext_if1 = "fxp0"<br>
ext_if2 = "fxp1"<br>
ext_gw1 = "68.146.224.1"<br>
ext_gw2 = "142.59.76.1"<br>
<br>
pass in on $int_if route-to \<br>
&nbsp;&nbsp;&nbsp;{ ($ext_if1 $ext_gw1), ($ext_if2 $ext_gw2) } round-robin \<br>
&nbsp;&nbsp;&nbsp;from $lan_net to any keep state
</tt>
</blockquote>

<p>
Opcja <tt>route-to</tt> jest u¿ywana dla ruchu <i>przychodz±cego</i> na 
<i>wewnêtrznym</i> interfejsie do okre¶lenia zewnêtrznego interfejsu sieciowego,
poprzez który maj± zostaæ skierowane pakiety, których adres ¼ród³owy zostanie
podmieniony na adres okre¶lonej bramki. Proszê zauwa¿yæ, ¿e opcja
<tt>route-to</tt> musi zostaæ okre¶lona dla <i>ka¿dej</i> regu³ki, która
definiuje równowa¿enie obci±¿enia. Powracaj±ce pakiety bêd± skierowane do tego
samego interfejsu zewnêtrznego, przez który wysz³y na ¶wiat (realizuje to
dostawca us³ug internetowych), a nastêpnie do wewnêtrznego interfejsu
sieciowego.

<p>
Aby zapewniæ, ¿e pakiety z adresem ¼ród³owym nale¿±cym do interfejsu
<tt>$ext_if1</tt> by³y przekazywane do interfejsu <tt>$ext_gw1</tt> (oraz
odpowiednio dla <tt>$ext_if2</tt> i <tt>$ext_gw2</tt>), dwie poni¿sze linie
powinny zostaæ w³±czone do zestawu regu³:

<blockquote>
<tt>
pass out on $ext_if1 route-to ($ext_if2 $ext_gw2) from $ext_if2 \<br>
&nbsp;&nbsp;&nbsp;to any<br>
pass out on $ext_if2 route-to ($ext_if1 $ext_gw1) from $ext_if1 \<br>
&nbsp;&nbsp;&nbsp;to any 
</tt>
</blockquote>

<p>
I na koñcu, NAT powinien zostaæ w³±czony na ka¿dym wychodz±cym interfejsie:
<blockquote>
<tt>
nat on $ext_if1 from $lan_net to any -&gt; ($ext_if1)<br>
nat on $ext_if2 from $lan_net to any -&gt; ($ext_if2)
</tt>
</blockquote>

<a name="outexample"></a>
<p>
Kompletny, przyk³adowy zestaw regu³, który bêdzie równowa¿yæ obci±¿enie
ruchu wychodz±cego mo¿e wygl±daæ mniej wiêcej tak:

<p>
<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
lan_net = "192.168.0.0/24"
int_if  = "dc0"
ext_if1 = "fxp0"
ext_if2 = "fxp1"
ext_gw1 = "68.146.224.1"
ext_gw2 = "142.59.76.1"

# w³±czenie NAT dla ka¿dego wychodz±cego interfejsu
nat on $ext_if1 from $lan_net to any -&gt; ($ext_if1)
nat on $ext_if2 from $lan_net to any -&gt; ($ext_if2)

# domy¶lne blokowanie 
block in  from any to any
block out from any to any

# przepuszczenie wszystkich wychodz±cych pakietów na interfejsie wewnêtrznym
pass out on $int_if from any to $lan_net
# natychmiastowe przepuszczenie wszystkich pakietów skierowanych do routera
pass in quick on $int_if from $lan_net to $int_if
# równowa¿enie wychodz±cego ruchu na protokole TCP z sieci wewnêtrznej
pass in on $int_if route-to \
    { ($ext_if1 $ext_gw1), ($ext_if2 $ext_gw2) } round-robin \
    proto tcp from $lan_net to any flags S/SA modulate state
# równowa¿enie wychodz±cego ruchu na protoko³ach ICMP i UDP z sieci wewnêtrznej
pass in on $int_if route-to \
    { ($ext_if1 $ext_gw1), ($ext_if2 $ext_gw2) } round-robin \
    proto { udp, icmp } from $lan_net to any keep state

# przepuszczenie wychodz±cych pakietów na interfejsach zewnêtrznych
pass out on $ext_if1 proto tcp from any to any flags S/SA modulate state
pass out on $ext_if1 proto { udp, icmp } from any to any keep state
pass out on $ext_if2 proto tcp from any to any flags S/SA modulate state
pass out on $ext_if2 proto { udp, icmp } from any to any keep state

# skierowanie pakietów z dowolnego IP na interfejsie $ext_if1 do $ext_gw1 i
# tak samo dla $ext_if2 i $ext_gw2
pass out on $ext_if1 route-to ($ext_if2 $ext_gw2) from $ext_if2 to any 
pass out on $ext_if2 route-to ($ext_if1 $ext_gw1) from $ext_if1 to any 
</pre>
</td></tr>
</table>

<p>
[<a href="queueing.html">Wstecz: Kolejkowanie</a>]
[<a href="index.html">Spis tre¶ci</a>]
[<a href="tagging.html">Dalej: Packet Tagging</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[wstecz]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
Originally [OpenBSD: pools.html,v 1.15 ]<br>
$Translation: pools.html,v 1.11 2005/08/12 07:54:08 pl-team Exp $<br>
$OpenBSD: pools.html,v 1.11 2005/08/21 22:37:28 saad Exp $
</small>
</body>
</html> 
