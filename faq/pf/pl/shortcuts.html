<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Skracanie zestawów regu³</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-2">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
<meta name="copyright"     content="This document copyright 2003 by OpenBSD.">
</head>

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif">
<p>
[<a href="anchors.html">Wstecz: Zakotwiczenia i nazwane zestawy (pod)regu³</a>]
[<a href="index.html">Spis tre¶ci</a>]
[<a href="pools.html">Dalej: Pule adresów i kierowanie ruchem</a>]

<p>
<h1>
<font color="#e00000">PF: Skracanie zestawów regu³</font>
</h1>

<hr>

<h3>Spis tre¶ci</h3>
<ul>
<li><a href="#intro">Wstêp</a>
<li><a href="#macros">Makra</a>
<li><a href="#lists">Listy</a>
<li><a href="#grammar">Sk³adnia PF</a>
	<ul>
	<li><a href="#elim">Skracanie regu³ek</a>
	<li><a href="#return">Uproszczenie regu³ki <tt>return</tt></a>
	<li><a href="#order">Kolejno¶æ s³ów kluczowych</a>
	</ul>
</ul>

<hr>

<a name="intro"></a>
<h2>Wstêp</h2>
PF oferuje kilka sposobów na uproszczenie zestawu regu³. Na pocz±tek warto
obejrzeæ parê dobrych przyk³adów u¿ycia <a href="macros.html#macros">makr</a>
i <a href="macros.html#lists">list</a>. Dodatkowo sk³adnia PF umo¿liwia u¿ywanie
skrótów pozwalaj±cych na dalsze uproszczenie pliku konfiguracyjnego. W praktyce
prostszy zapis regu³ jest ³atwiejszy do zrozumienia i zarz±dzania nim. 

<a name="macros"></a>
<h2>Makra</h2>
Podstawow± zalet± makr jest mo¿liwo¶æ zast±pienia wystêpuj±cych w pliku
konfiguracyjnym adresów IP, numerów portów, nazw interfejsów itp., przez nazwy
symboliczne. Je¶li zmieni siê adres IP serwera, wystarczy tylko uaktualniæ
definicjê makra, bez konieczno¶ci marnowania czasu i energii na znajdywanie 
i modyfikowanie wszystkich wyst±pieñ tego adresu w zestawie regu³.

<p>
Powszechnym zwyczajem w zestawie regu³ PF jest definiowanie makra dla ka¿dego
interfejsu sieciowego. Za ka¿dym razem gdy karta sieciowa bêdzie wymieniona na
inn±, korzystaj±c± z innego sterownika, na przyk³ad wymiana karty firmy 3Com na
kartê firmy Intel, wystarczy uaktualniæ makrodefinicjê i filtr znów bêdzie
pracowa³. Podobnie sprawa ma siê gdy u¿ywa siê ten sam zestaw regu³ na ró¿nych
komputerach. Niektóre posiadaj± inne karty sieciowe, wiêc u¿ycie makra do
okre¶lenia interfejsów sieciowych pozwala na zastosowanie tego samego zestawu
regu³ bez wielkich zmian. Korzystanie z makrodefinicji w plikach
konfiguracyjnych do okre¶lania adresów IP, nazw interfejsów czy numerów portów
jest dobrym nawykiem.

<blockquote>
<tt>
# makrodefinicja dla ka¿dego interfejsu sieciowego<br>
IntIF = "dc0"<br>
ExtIF = "fxp0"<br>
DmzIF = "fxp1"
</tt>
</blockquote>

<p>
Inn±, szeroko stosowan±, praktyk± jest u¿ywanie makr do definiowania adresów IP
oraz bloków sieci. Takie podej¶cie doskonale obni¿a ilo¶æ modyfikacji, które
nale¿y przeprowadziæ na zestawie regu³, w przypadku zmiany adresu IP.

<blockquote>
<tt>
# zdefiniowanie sieci<br>
IntNet = "192.168.0.0/24"<br>
ExtAdd = "24.65.13.4"<br>
DmzNet = "10.0.0.0/24"
</tt>
</blockquote>

<p>
Za ka¿dym razem gdy wewnêtrzna sieæ zostanie powiêkszona lub zmieni siê jej
adres, wystarczy tylko zaktualizowaæ makro:
<blockquote>
<tt>
IntNet = "{ 192.168.0.0/24, 192.168.1.0/24 }"
</tt>
</blockquote>

<p>
Gdy tylko zestaw regu³ zostanie prze³adowany, wszystko bêdzie dzia³aæ jak
poprzednio

<a name="lists"></a>
<h2>Listy</h2>
Poni¿szy zestaw regu³, którego umieszczenie we w³asnym zestawie regu³ jest
bardzo dobrym rozwi±zaniem, blokuje adresy opisane w 
<a href="http://www.geektools.com/rfc/rfc1918.txt">RFC 1918</a>, z których
ruch nigdy nie powinny znale¼æ siê w Internecie, a je¶li ju¿ tak siê zdarzy
najczê¶ciej powoduje to problemy.
<blockquote>
<tt>
block in quick on tl0 inet from 127.0.0.0/8 to any<br>
block in quick on tl0 inet from 192.168.0.0/16 to any<br>
block in quick on tl0 inet from 172.16.0.0/12 to any<br>
block in quick on tl0 inet from 10.0.0.0/8 to any<br>
block out quick on tl0 inet from any to 127.0.0.0/8<br>
block out quick on tl0 inet from any to 192.168.0.0/16<br>
block out quick on tl0 inet from any to 172.16.0.0/12<br>
block out quick on tl0 inet from any to 10.0.0.0/8
</tt>
</blockquote>

<p>
A teraz sposób na uproszczenie powy¿szego zapisu:
<blockquote>
<tt>
block in quick on tl0 inet from { 127.0.0.0/8, 192.168.0.0/16, \<br>
&nbsp;&nbsp;&nbsp;172.16.0.0/12, 10.0.0.0/8 } to any<br>
block out quick on tl0 inet from any to { 127.0.0.0/8, \<br>
&nbsp;&nbsp;&nbsp;192.168.0.0/16, 172.16.0.0/12, 10.0.0.0/8 }
</tt>
</blockquote>

<p>
W bardzo prosty sposób zestaw regu³ z o¶miu linii zosta³ zredukowany do dwóch.
Jeszcze lepszym rozwi±zaniem jest u¿ycie makr w po³±czeniu z list±:
<blockquote>
<tt>
NoRouteIPs = "{ 127.0.0.0/8, 192.168.0.0/16, 172.16.0.0/12, \<br>
&nbsp;&nbsp;&nbsp;10.0.0.0/8 }"
<br>
ExtIF = "tl0"<br>
block in quick on $ExtIF from $NoRouteIPs to any<br>
block out quick on $ExtIF from any to $NoRouteIPs
</tt>
</blockquote>

<p>
Nale¿y wzi±æ pod uwagê, ¿e makrodefinicje i listy upraszczaj± plik
<tt>/etc/pf.conf</tt>, ale jest on pó¼niej rozwijany przez 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+3.3">
pfctl(8)</a> w zestaw wielu regu³. Powy¿szy przyk³ad po rozwiniêciu przyjmie
nastêpuj±c± postaæ:
<blockquote>
<tt>
block in quick on tl0 inet from 10.0.0.0/8 to any<br>
block in quick on tl0 inet from 172.16.0.0/12 to any<br>
block in quick on tl0 inet from 192.168.0.0/16 to any<br>
block in quick on tl0 inet from 127.0.0.0/8 to any<br>
block out quick on tl0 inet from any to 10.0.0.0/8<br>
block out quick on tl0 inet from any to 172.16.0.0/12<br>
block out quick on tl0 inet from any to 192.168.0.0/16<br>
block out quick on tl0 inet from any to 127.0.0.0/8
</tt>
</blockquote>

<p>
Jak mo¿na zobaczyæ, rozszerzenia PF s± udogodnieniem jedynie dla osoby pisz±cej i
utrzymuj±cej plik <tt>/etc/pf.conf</tt>, natomiast nie jest to uproszczenie
regu³ sprawdzanych przez
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4&amp;manpath=OpenBSD+3.3">
pf(4)</a>.

<p>
Makra mog± byæ nie tylko pomoc± w przypadku adresów i portów, mog± byæ u¿ywane
w dowolnym miejscu pliku <tt>/etc/pf.conf</tt>, np.:
<blockquote>
<tt>
pre  = "pass in quick on ep0 inet proto tcp from "<br>
post = "to any port { 80, 6667 } keep state"<br>
<br>
# klasa Davida<br>
$pre 21.14.24.80 $post<br>
<br>
# dom Nicka<br>
$pre 24.2.74.79 $post<br>
$pre 24.2.74.178 $post
</tt>
</blockquote>

<p>
Powy¿szy zapis zostanie rozwiniêty do nastêpuj±cej postaci:
<blockquote>
<tt>
pass in quick on ep0 inet proto tcp from 21.14.24.80 to any \<br>
&nbsp;&nbsp;&nbsp;port = 80 keep state<br>
pass in quick on ep0 inet proto tcp from 21.14.24.80 to any \<br>
&nbsp;&nbsp;&nbsp;port = 6667 keep state<br>
pass in quick on ep0 inet proto tcp from 24.2.74.79 to any \<br>
&nbsp;&nbsp;&nbsp;port = 80 keep state<br>
pass in quick on ep0 inet proto tcp from 24.2.74.79 to any \<br>
&nbsp;&nbsp;&nbsp;port = 6667 keep state<br>
pass in quick on ep0 inet proto tcp from 24.2.74.178 to any \<br>
&nbsp;&nbsp;&nbsp;port = 80 keep state<br>
pass in quick on ep0 inet proto tcp from 24.2.74.178 to any \<br>
&nbsp;&nbsp;&nbsp;port = 6667 keep state
</tt>
</blockquote>

<a name="grammar"></a>
<h2>Sk³adnia PF</h2>
Wraz z nadej¶ciem OpenBSD 3.3, sk³adnia PF zosta³a jeszcze bardziej dopracowana
aby uzyskaæ wiêksz± elastyczno¶æ podczas definiowania regu³. PF posiada zdolno¶æ
wywnioskowania w³a¶ciwego s³owa kluczowego, które nie zosta³o u¿yte w sposób
bezpo¶redni podczas definiowania regu³ki. PF zezwala tak¿e na du¿± swobodê je¶li
chodzi o kolejno¶æ u¿ywania s³ów kluczowych.

<a name="elim"></a>
<h3>Skracanie regu³ek</h3>
Aby okre¶liæ politykê "domy¶lnego blokowania", nale¿a³o u¿yæ dwóch regu³:
<blockquote>
<tt>
block in all<br>
block out all
</tt>
</blockquote>

<p>
Obecnie mo¿na skróciæ to do jednej:
<blockquote>
<tt>
block all
</tt>
</blockquote>

<p>
Kiedy kierunek ruchu pakietów nie jest podany, PF przyjmuje, ¿e chodzi zarówno o
datagramy przychodz±ce jak i wychodz±ce.

<p>Podobnie, klauzula "<tt>from any to any</tt> jak i "<tt>all</tt>" mog± zostaæ
pominiête, np.:
<blockquote>
<tt>
block in on rl0 all<br>
pass &nbsp;in quick log on rl0 proto tcp from any to any port 22 keep state
</tt>
</blockquote>

mo¿e zostaæ uproszczone do:
<blockquote>
<tt>
block in on rl0<br>
pass &nbsp;in quick log on rl0 proto tcp to port 22 keep state
</tt>
</blockquote>

<p>
Pierwsza regu³ka zablokuje ruch wszystkich pakietów przybywaj±cych z ka¿dego
kierunku i wychodz±cych w dowolnym kierunku na interfejsie rl0, natomiast
druga przepuszcza ruch TCP na porcie 22 na interfejsie rl0.

<a name="return"></a>
<h3>Uproszczenie regu³ki <tt>return</tt></h3>
Zestaw regu³, który zablokuje wszystkie porty, a na wywo³anie którego¶ z nich
odpowie komunikatem TCP RST lub ICPM Unreachable, móg³by wygl±daæ tak:
<blockquote>
<tt>
block in all<br>
block return-rst in proto tcp all<br>
block return-icmp in proto udp all<br>
block out all<br>
block return-rst out proto tcp all<br>
block return-icmp out proto udp all
</tt>
</blockquote>

<p>
Ale mo¿e zostaæ uproszczony do:
<blockquote>
<tt>
block return
</tt>
</blockquote>

<p>
Gdy PF natrafi na s³owo <tt>return</tt>, ma ju¿ do¶æ informacji aby wys³aæ
w³a¶ciw± odpowied¼ (lub nie udzieliæ jej wcale), w zale¿no¶ci od protoko³u,
przy u¿yciu którego przesy³ane by³y odrzucone pakiety.

<a name="order"></a>
<h3>Kolejno¶æ s³ów kluczowych</h3>
<p>
Kolejno¶æ, w jakiej wszystkie s³owa kluczowe mog± zostaæ podane, jest w
wiêkszo¶ci przypadków do¶æ swobodna. Regu³ê mo¿na zapisaæ tak:
<blockquote>
<tt>
pass in log quick on rl0 proto tcp port 22 \<br> 
&nbsp;&nbsp;&nbsp;flags S/SA keep state queue ssh label ssh
</tt>
</blockquote>

<p>
Albo tak:
<blockquote>
<tt>
pass in quick log on rl0 proto tcp port 22 \<br>
&nbsp;&nbsp;&nbsp;queue ssh keep state label ssh flags S/SA
</tt>
</blockquote>

<p>
Inne, podobne kombinacje, bêd± tak¿e dzia³aæ.

<p>
[<a href="anchors.html">Wstecz: Zakotwiczenia i nazwane zestawy (pod)regu³</a>]
[<a href="index.html">Spis tre¶ci</a>]
[<a href="pools.html">Dalej: Pule adresów i kierowanie ruchem</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[wstecz]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
Originally [OpenBSD: shortcuts.html,v 1.5 ]<br>
$Translation: shortcuts.html,v 1.1 2003/08/28 09:44:13 pl-team Exp $<br>
$OpenBSD: shortcuts.html,v 1.1 2003/09/02 14:37:19 jufi Exp $
</small>

</body>
</html> 
