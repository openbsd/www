<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Przekierowania ruchu</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-2">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, Nick Holland <nick@openbsd.org>
Copyright (c) 2003-2005 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="nat.html">Wstecz: Translacje adresów (NAT)</a>]
[<a href="index.html">Spis tre¶ci</a>]
[<a href="shortcuts.html">Dalej: Skracanie zestawów regu³</a>]

<h1><font color="#e00000">PF: Przekierowania ruchu</font></h1>

<hr>

<h3>Spis tre¶ci</h3>
<ul>
<li><a href="#intro">Wstêp</a>
<li><a href="#filter">Przekierowania, a filtrowanie pakietów</a>
<li><a href="#security">Bezpieczeñstwo</a>
<li><a href="#reflect">Przekierowania i odbicia</a>
	<ul>
	<li><a href="#splitdns">Konfiguracja serwera DNS</a>
	<li><a href="#sepnet">Przeniesienie serwera do odseparowanej sieci
	lokalnej</a>
	<li><a href="#tcpproxy">TCP proxy</a>
	<li><a href="#rdrnat">Wspó³praca RDR (przekierowania) i NAT</a>
	</ul>
</ul>

<hr>

<a name="intro"></a>
<h2>Wstêp</h2>
Korzystaj±c w biurze z dobrodziejstw NAT, mo¿na mieæ pe³ny dostêp do Internetu
na ka¿dej maszynie. Co jednak zrobiæ, gdy zachodzi konieczno¶æ, by maszyna
znajduj±ca siê w sieci lokalnej by³a dostêpna z Internetu? Taka sytuacja zdarza
siê czêsto, i teraz nadchodzi w³a¶ciwa chwila, by napisaæ kilka s³ów o
przekierowaniach. Dziêki regu³om <tt>rdr</tt> mo¿liwe jest przes³anie
pakietów inicjalizuj±cych po³±czenie do maszyny znajduj±cej siê za bramk± NAT.

<p>
Oto bardzo prosty przyk³ad:
<blockquote>
<tt>
rdr on tl0 proto tcp from any to any port 80 -&gt; 192.168.1.20
</tt>
</blockquote>

<p>
Powy¿sza linijka przekierowuje ruch przeznaczony do portu 80 TCP (serwer www)
do maszyny o adresie 192.168.1.20 wewn±trz sieci lokalnej. Pomimo tego, ¿e
adres 192.168.1.20 jest adresem wewnêtrznym, mo¿na uzyskaæ do niego dostêp
z Internetu.

<p>
Fragment <tt>from any to any</tt> w regu³ce <tt>rdr</tt> mo¿na
dodatkowo zmodyfikowaæ - je¶li wiadome jest które sieci powinny mieæ dostêp
do komputera wewn±trz sieci lokalnej na porcie 80, mo¿na to zastrzec w tej
regu³ce:
<blockquote>
<tt>
rdr on tl0 proto tcp from 27.146.49.0/24 to any port 80 -&gt; \<br>
&nbsp;&nbsp;&nbsp;192.168.1.20
</tt>
</blockquote>

<p>
Pozwoli to na korzystanie z przekierowañ tylko wyselekcjonowanym podsieciom.
Jak mo¿na siê domy¶leæ, mo¿na przekierowywaæ ruch do ró¿nych miejsc
docelowych w zale¿no¶ci od jego ¼ród³a. W niektórych przypadkach mo¿e to byæ
naprawdê u¿yteczne. Dla przyk³adu, mo¿na mieæ u¿ytkowników, którzy posiadaæ
bêd± dostêp do innej maszyny w sieci w zale¿no¶ci od adresu z pod którego siê
³±cz±:
<blockquote>
<tt>
rdr on tl0 proto tcp from 27.146.49.14 to any port 80 -&gt; \<br>
&nbsp;&nbsp;&nbsp;192.168.1.20<br>
rdr on tl0 proto tcp from 16.114.4.89 to any port 80 -&gt; \<br>
&nbsp;&nbsp;&nbsp;192.168.1.22<br>
rdr on tl0 proto tcp from 24.2.74.178 to any port 80 -&gt; \<br>
&nbsp;&nbsp;&nbsp;192.168.1.23
</tt>
</blockquote>

<p>
Poprzez tak± sam± regu³ê mo¿liwe jest przekierowanie zakresu portów:
<blockquote>
<tt>
rdr on tl0 proto tcp from any to any port 5000:5500 -&gt; \<br>
&nbsp;&nbsp;&nbsp;192.168.1.20<br>
rdr on tl0 proto tcp from any to any port 5000:5500 -&gt; \<br>
&nbsp;&nbsp;&nbsp;192.168.1.20 port 6000<br>
rdr on tl0 proto tcp from any to any port 5000:5500 -&gt; \<br>
&nbsp;&nbsp;&nbsp;192.168.1.20 port 7000:*<br>
</tt>
</blockquote>

<p>
Przyk³ady te pokazuj± przekierowanie portów od 5000 do 5500 (w³±cznie) do
192.168.1.20.
W regule #1, port 5000 jest przekierowywany do 5000, 5001 do 5001, itd.
W regule #2, pe³ny zakres portów jest przekerowywany do portu 6000.
Oraz w regule #3, port 5000 jest przekierowywany do 7000, 5001 do 7001, itd.

<a name="filter"></a>
<h2>Przekierowania, a filtrowanie pakietów</h2>
<font color="#ff0000">UWAGA:</font> Przekierowywane pakiety
musz± nadal zostaæ zaakceptowane przez regu³y filtruj±ce pakiety, które
mog± je przepu¶ciæ b±d¼ zablokowaæ.

<p>
<i>Jedynym</i> wyj±tkiem jest sytuacja, gdy w regule <tt>rdr</tt>
u¿yte jest s³owo kluczowe <tt>pass</tt>. W tym przypadku, przekierowane
pakiety bêd± przepuszczane "stanowo" (statefully) przez filtr: regu³y
filtra nie bêd± uwzglêdniane przeciw tym pakietom.
Jest to pomocny skrót pozwalaj±cy unikn±æ umieszczania regu³ <tt>pass</tt>
dla ka¿dej przekierowuj±cej regu³y.
Pomy¶l o tym jako o normalnej regule <tt>rdr</tt> (bez klucza <tt>pass</tt>)
skoja¿onej z regu³± <tt>pass</tt> z kluczem <tt>keep state</tt>.
Jednak je¿eli chcesz u¿yæ bardziej specyficznych opcji filtrowania, takich
jak <tt>synproxy</tt>, <tt>modulate state</tt>, itd., wci±¿ bêdziesz 
musia³ u¿yæ dedykowanej regu³y <tt>pass</tt> gdy opcje te nie pasuj± do
regu³ przekierowuj±cych. 

<p>
Pamiêtaj, ¿e poniewa¿ translacje maj± miejsce <i>przed</i> filtrowaniem,
filtr bêdzie widzia³ <i>przekierowane</i> pakiety po zamianie ich
docelowych adresów IP/portów zgodnie z dan± regu³± <tt>rdr</tt>.
Aby lepiej to zrozumieæ proszê przyjrzeæ siê temu przyk³adowi:

<ul>
<li>192.0.2.1 - host w Internecie
<li>24.65.1.13 - zewnêtrzny adres routera OpenBSD
<li>192.168.1.5 - adres serwera po³o¿onego  w sieci lokalnej
</ul>

<p>
Regu³ka przekierowania:
<blockquote>
<tt>
rdr on tl0 proto tcp from 192.0.2.1 to 24.65.1.13 port 80 \<br>
&nbsp;&nbsp;&nbsp;-&gt; 192.168.1.5 port 8000
</tt>
</blockquote>

<p>
Pakiet przed przej¶ciem przez regu³kê <tt>rdr</tt>:
<ul>
<li>¬ród³owy adres: 192.0.2.1
<li>¬ród³owy port: 4028 (wybrany niezale¿nie przez system operacyjny)
<li>Docelowy adres: 24.65.1.13
<li>Docelowy port: 80
</ul>

<p>
Pakiet po przej¶ciu przez regu³kê <tt>rdr</tt>:
<ul>
<li>¬ród³owy adres: 192.0.2.1
<li>¬ród³owy port: 4028
<li>Docelowy adres: 192.168.1.5
<li>Docelowy port: 8000
</ul>

<p>
Zanim datagramy trafi± do filtra pakietów, bêd± ju¿ mia³y zmieniony
adres docelowy zgodnie z regu³± przekierowuj±c±.

<a name="security"></a>
<h2>Bezpieczeñstwo</h2>
Przekierowania nale¿y stosowaæ ostro¿nie. Zezwolenie na dostêp do lokalnej
maszyny z zewn±trz otwiera do niej drogê dla potencjalnych intruzów.
Przyk³adowo: gdy ruch jest przekierowany do wewnêtrznego serwera www,
nowo odkryta luka w oprogramowaniu serwera b±d¼ skrypcie CGI uruchomionym
na tym serwerze, mo¿e daæ intruzowi dostêp do systemu wewn±trz sieci
lokalnej. Z tego punktu, atakuj±cy ma otwart± drogê, aby dokonaæ penetracji
wewnêtrznej sieci.

<p>
Takie ryzyko mo¿e zostaæ zmniejszone poprzez wydzielenie systemów dostêpnych
z zewn±trz i umieszczenie ich w wydzielonej sieci. Czêsto tego typu sieæ
nazywa siê Stref± Zdemilitaryzowan± (Demilitarized Zone - DMZ) lub
sieci± prywatn± (Private Service Network - PSN). W tej sytuacji, je¶li
zabezpieczenia serwera www zostan± prze³amane, konsekwencje z tym zwi±zane
ogranicz± siê jedynie do sieci DMZ/PSN, oczywi¶cie je¶li bêdziemy ostro¿nie
filtrowaæ ruch wchodz±cy i wychodz±cy sieci DMZ/PSN.

<a name="reflect"></a>
<h2>Przekierowania i odbicia</h2>
Czêsto przekierowania wykorzystywane s± do udostêpnienia z poziomu Internetu
lokalnego serwera maj±cego prywatny adres w naszej sieci, jak np:
<blockquote>
<tt>
server = 192.168.1.40<br>
<br>
rdr on $ext_if proto tcp from any to $ext_if port 80 -&gt; $server \<br>
&nbsp;&nbsp;&nbsp;port 80
</tt>
</blockquote>

<p>
Sprawdzaj±c poprawno¶æ dzia³ania takiej regu³ki z komputera umieszczonego
w sieci lokalnej oka¿e siê, ¿e wydaje siê ona nie dzia³aæ. Przyczyn± jest to,
¿e regu³ka przekierowuj±ca okre¶la interfejs wej¶ciowy dla pakietów
(<tt>$ext_if</tt> - zewnêtrzny interfejs).
Po³±czenie z zewnêtrznym adresem komputera
z firewallem z komputera w sieci lokalnej wcale nie oznacza, ¿e pakiety musz±
wêdrowaæ przez zewnêtrzny interfejs. Stos TCP/IP firewalla porównuje adres
przeznaczenia przychodz±cych pakietów z w³asnymi adresami oraz ich aliasami,
wykrywaj±c w ten sposób po³±czenia do siebie samego w momencie, gdy przesz³y
tylko przez wewnêtrzny interfejs. Takie pakiety fizycznie
nie wêdruj± przez zewnêtrzny interfejs, a stos TCP/IP nie symuluje w ¿aden
sposób takiej sytuacji. PF nigdy nie widzia³ tych pakietów na zewnêtrznym
interfejsie i dlatego w³a¶nie regu³ka przekierowuj±ca, wy³apuj±ca pakiety
wêdruj±ce do zewnêtrznego interfejsu nie akceptuje po³±czeñ pochodz±cych
z sieci LAN.

<p>
Dodanie drugiej regu³ki przekierowuj±cej nie rozwi±¿e w tym przypadku
problemu. Gdy klient z sieci lokalnej ³±czy siê z zewnêtrznym adresem IP
firewalla pakiet inicjuj±cy po³±czenie TCP dochodzi do maszyny z firewallem
przez wewnêtrzny interfejs.
Nowa regu³ka przekierowuj±ca akceptuje ten pakiet i adres docelowy zostaje
zast±piony adresem lokalnego serwera.
Pakiet zostaje przekierowany ponownie na wewnêtrzny interfejs i dociera
do serwera. Jednak nie zosta³ przet³umaczony adres ¼ród³owy i zawiera
on adres klienta, wiêc serwer ode¶le odpowied¼ bezpo¶rednio do niego.
Firewall nigdy nie dostanie odpowiedzi od serwera, któr± móg³by poprawnie
przes³aæ z powrotem do klienta, co spowoduje, ¿e klient otrzyma pakiet TCP
ze ¼ród³a, którego siê nie spodziewa³ i go odrzuci, nawi±zywanie po³±czenia
nie powiedzie siê.


<p>
Czêsto wymaga siê, aby hosty w sieci LAN mog³y ³±czyæ siê z tym samym
serwerem lokalnym tak jak hosty z zewn±trz, transparentnie (bez dodatkowej
wiedzy o faktycznym adresie oraz po³o¿eniu serwera).
Oto kilka pomys³ów, które mog± pomóc w rozwi±zaniu problemu:

<a name="splitdns"></a>
<h3>Konfiguracja serwera DNS</h3>
Mo¿liwe jest skonfigurowanie serwera DNS tak, aby odpowiada³ na zapytania
z sieci lokalnej inaczej ni¿ na zapytania z zewn±trz, tak wiêc klient
w sieci lokalnej mo¿e otrzymaæ od serwera nazw adres lokalny serwera.
Po³±czy siê wtedy z nim bezpo¶rednio, bez zaanga¿owania w tê operacjê
firewalla. Zredukuje to ruch, poniewa¿ pakiety nie bêd± niepotrzebnie
wêdrowa³y przez firewall.

<a name="sepnet"></a>
<h3>Przeniesienie serwera do odseparowanej sieci lokalnej</h3>
Do³±czenie dodatkowego interfejsu sieciowego do komputera z firewallem
i przeniesienie serwera do takiej sieci dedykowanej (DMZ) pozwoli na
przekierowywanie po³±czeñ od lokalnych klientów w taki sam sposób
jak klientom z zewn±trz. Wykorzystanie odseparowanej sieci ma kilka
innych zalet, w³±czaj±c zwiêkszenie bezpieczeñstwa poprzez odseparowanie
serwera tak¿e od klientów lokalnych. Jednak¿e nale¿y pamiêtaæ o tym,
¿e w takim przypadku nasz serwer nie bêdzie mia³ bezpo¶redniego dostêpu
do hostów lokalnych - wszystkie po³±czenia bêd± musia³y przej¶æ przez
firewall.

<a name="tcpproxy"></a>
<h3>TCP proxy</h3>
TCP proxy mo¿e byæ skonfigurowany na ho¶cie, na którym pracuje firewall,
nas³uchuj±c na porcie który ma zostaæ przekierowany oraz przechwytuj±c
po³±czenia z interfejsu lokalnego i przekierowywaæ je do portu, na którym
nas³uchuje. Gdy lokalny klient ³±czy siê z firewallem, proxy akceptuje
po³±czenie otwieraj±c drugie po³±czenie z serwerem i przekierowuj±c
ruch pomiêdzy ustanowionymi po³±czeniami.

<p>
Proste proxy mo¿na zrobiæ korzystaj±c z 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=inetd&amp;sektion=8&amp;manpath=OpenBSD+3.7"
>inetd(8)</a> oraz
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=nc&amp;sektion=1&amp;manpath=OpenBSD+3.7"
>nc(1)</a>. Poni¿szy wpis w <tt>/etc/inetd.conf</tt> tworzy gniazdo nas³uchuj±ce
przypisane do adresu loopback (127.0.0.1) oraz portu 5000.
Po³±czenia przekierowywane s± do portu 80 serwera o adresie
192.168.1.10.
<blockquote>
<tt>
127.0.0.1:5000 stream tcp nowait nobody /usr/bin/nc nc -w \<br>
&nbsp;&nbsp;&nbsp;20 192.168.1.10 80
</tt>
</blockquote>

<p>
Poni¿sza regu³ka PF przekierowuje ruch portu 80 na wewnêtrznym interfejsie
do proxy:
<blockquote>
<tt>
rdr on $int_if proto tcp from $int_net to $ext_if port 80 -&gt; \<br>
&nbsp;&nbsp;&nbsp;127.0.0.1 port 5000
</tt>
</blockquote>

<a name="rdrnat"></a>
<h3>Wspó³praca RDR (przekierowania) i NAT</h3>
Mo¿na równie¿ uzyskaæ translacjê adresu ¼ród³owego poprzez wprowadzenie
dodatkowej regu³ki NAT dotycz±cej wewnêtrznego interfejsu.
<blockquote>
<tt>
rdr on $int_if proto tcp from $int_net to $ext_if port 80 -&gt; \<br>
&nbsp;&nbsp;&nbsp;$server
<br>
no nat on $int_if proto tcp from $int_if to $int_net<br>
nat on $int_if proto tcp from $int_net to $server port 80 -&gt; \<br>
&nbsp;&nbsp;&nbsp;$int_if
</tt>
</blockquote>

<p>
Spowoduje to, ¿e inicjalizuj±cy po³±czenie pakiet pochodz±cy od klienta,
zostanie ponownie poddany NAT w chwili, gdy zostanie przekierowany na
zewnêtrzny interfejs, adres ¼ród³owy klienta zostanie zamieniony na adres
interfejsu wewnêtrznego serwera. Serwer prze¶le swoj± odpowied¼ do firewalla,
który potrafi zamieniæ regu³kê RDR na NAT gdy klientem jest host w sieci
lokalnej. Taka konstrukcja jest do¶æ z³o¿ona dziêki temu, ¿e tworzy
dwa oddzielne stany dla ka¿dego po³±czenia.
Trzeba zwróciæ uwagê na odpowiedni± konfiguracjê NAT w taki sposób, aby
regu³ki nie akceptowa³y innych pakietów ni¿ te, które dopuszczasz, dla
przyk³adu, po³±czenia pochodz±ce od hostów z poza naszej sieci lub samego
firewalla. Zauwa¿, ¿e regu³ka rdr powy¿ej, spowoduje, ¿e stos TCP/IP bêdzie
widzia³ pakiety przychodz±ce do wewnêtrznego interfejsu z adresem docelowym
naszej sieci lokalnej.

<p>
Dla wiêkszo¶ci przypadków, rozwi±zania omawiane powy¿ej s± w zupe³no¶ci
wystarczaj±ce.

<p>
[<a href="nat.html">Wstecz: Translacja adresów (NAT)</a>]
[<a href="index.html">Spis tre¶ci</a>]
[<a href="shortcuts.html">Dalej: Skracanie zestawów regu³</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[wstecz]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: rdr.html,v 1.23 ]<br>
$Translation: rdr.html,v 1.5 2005/08/24 11:43:14 pl-team Exp $<br>
-->
$OpenBSD: rdr.html,v 1.5 2005/08/24 12:58:45 saad Exp $
</small>
</body>
</html> 
