<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Преобразование Сетевых Адресов (NAT)</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=UTF8">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, Nick Holland <nick@openbsd.org>
Copyright (c) 2003, 2004, Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="filter.html">Предыдущая: Фильтрация Пакетов</a>]
[<a href="index.html">Содержание</a>]
[<a href="rdr.html">Следующая: Перенаправление трафика (Проброс портов)</a>]

<p>
<h1><font color="#e00000">PF: Преобразование сетевых адресов (NAT)</font></h1>

<hr>

<h3>Содержание</h3>
<ul>
<li><a href="#intro">Вступление</a>
<li><a href="#works">Как работает NAT</a>
<li><a href="#filter">NAT и Фильтрация пакетов</a>
<li><a href="#ipfwd">IP Forwarding</a>
<li><a href="#config">Настройка NAT</a>
<li><a href="#binat">Двунаправленное отображение (отображение 1:1)</a>
<li><a href="#except">Исключения правил трансляции</a>
<li><a href="#status">Проверка NAT статуса</a>
</ul>

<hr>

<a name="intro"></a>
<h2>Вступление</h2>
Преобразование Сетевых Адресов (NAT) это способ разместить целую сеть(или
сети) за одном IP адресом. NAT необходим, когда количество IP адресов 
выданных вам вам провайдером меньше, чем количество компьютером, которым
вы хотите обеспечить выход в Интернет. NAT описан в
<a href="http://www.geektools.com/rfc/rfc1631.txt">RFC 1631</a>,
"The IP Network Address Translator (NAT)."

<p>
NAT позволяет вам использовать зарезервированные блоки адресов, описанные в
<a href="http://www.geektools.com/rfc/rfc1918.txt">RFC 1918</a>,
"Address Allocation for Private Internets."
Обычно, ваша внутренняя сеть будет настроена на использование одного или более
этих блоков. Блоки адресов:
<pre>
	10.0.0.0/8       (10.0.0.0 - 10.255.255.255)
	172.16.0.0/12    (172.16.0.0 - 172.31.255.255)
	192.168.0.0/16   (192.168.0.0 - 192.168.255.255)
</pre>

<p>
Чтобы сделать NAT OpenBSD система должна иметь, по крайней мере два сетевых
адаптера, один для Интернета, другой для вашей внутренней сети. NAT будет
переводить запросы из внутренней сети, поэтому они все они буду идти от
вашей OpenBSD NAT системы.

<a name="works"></a>
<h2>Как работает NAT</h2>
<p>
Когда клиент из внетренней сети связывается с машиной в Интернете, он
посылает IP пакеты, предназначенные этой машине. Эти пакеты содержат всю
необходимую информацию об адресате. NAT работает с этой информацией:
<ul>
<li>Исходный IP адрес (например, 192.168.1.35)
<li>Исходный TCP или UDP порт (например, 2132)
</ul>

<p>
Когда пакеты проходят через NAT шлюз, они будут изменены таким образом,
что они будут представляться этим шлюзом. NAT шлюз будет записывать
изменения, которые он делает в таблицу состояний, поэтому он может сделать
a) обратное преобразование ответных пакетов и b) убедиться, что 
ответные пакеты прошли через брандмауэр и не были блокированы. Например,
могут быть сделаны следующие изменения:
<ul>
<li>Исходный IP: заменить внешним адресом шлюза(например, 24.5.0.5)
<li>Исходный порт: заменить случайно выбранным, не используемым портом
шлюза (например, 53136)
</ul>

<p>
Ни внутренняя машины, ни хост в интернете не знают об этим преобразованиях.
Для внутреннней машины, NAT система это всего лишь Интернет шлюз.
Для интернет хоста, пакеты приходят на прямую от NAT системы; он точно
не знает о существовании внутренней машины.

<p>
Когда интернет хост отвечает внутренней машине, они будут адресованы
IP NAT шлюза (24.5.0.5) на заменённый порт (53136). NAT шлюз будет
просматривать таблицу состояний, чтобы определить принадлежат ли ответные
пакеты уже установившемуся соединению. Соответствие будет найдено на основе
комбинации IP/port, котороая сообщит PF о том, что пакеты принадлежат
соединению инициировванному машиной 192.168.1.35. PF сделает обратное
преобразование и отправит ответные пакеты внутренней машине.

<p>
Преобразование ICMP пакетов происходит таким же образом, но без модификации
исходного порта.

<a name="filter"></a>
<h2>NAT и Фильтрация пакетов</h2>
<p>
<font color="#ff0000">Обратите внимание:</font> Преобзразумые пакеты должны
проходить через фильтр и будут блокированы или пропущены, в зависимости
от фильтрующих правил, которые были заданы.
<i>Единственное</i> исключение из этих правил, это когда используется ключевое
слово <tt>pass</tt> с правилом <tt>nat</tt>.
В этом случает пакеты проходящие NAT преобразования будут проходить без
проверки правилами.

<p>
Таже помните, что трансляция происходит до фильтраци, фильтр будет видеть
уже преобразованные пакеты с преобразованным
IP адресом и портом, как описано в <a href="#works">Как работает NAT</a>.

<!-- legacy anchor; can eventually be removed -->
<a name="enable"></a>
<a name="ipfwd"></a>
<h2>IP Forwarding</h2>
<p>
Поскольку NAT постоянно используется на роутерах и сетевых шлюзах, необходимо
включить поддержку проброса пакетов IP forwarding, для того, чтобы пакеты
могли ходить между сетевыми интерфейсами на OpenBSD машине.
IP forwarding включается использованием механизма
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&amp;sektion=3"
>sysctl(3)</a>:
<blockquote>
<tt>
# sysctl net.inet.ip.forwarding=1<br>
# sysctl net.inet6.ip6.forwarding=1 <i>(if using IPv6)</i>
</tt>
</blockquote>

<p>
Чтобы сделать эти изменения постоянными, необходимо добавить следующие
строки в файл
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl.conf&amp;sektion=5"
><tt>/etc/sysctl.conf</tt></a>:
<blockquote>
<tt>
net.inet.ip.forwarding=1<br>
net.inet6.ip6.forwarding=1
</tt>
</blockquote>

<p>
Эти строки присутствуют там по умолчанию, но закомментированы <tt>#</tt>.
Уберите <tt>#</tt> и сохраните файл. IP forwarding будет включен, когда
машина будет перезагружена.

<a name="config"></a>
<h2>Настройка NAT</h2>
Основной формат правил NAT в <tt>pf.conf</tt> выглядит как:
<blockquote>
<tt>
nat [pass] [log] on <i>interface</i> [<i>af</i>] from <i>src_addr</i> 
[port <i>src_port</i>] to \<br>
&nbsp;&nbsp;&nbsp;<i>dst_addr</i> [port <i>dst_port</i>] -&gt; 
<i>ext_addr</i> [<i>pool_type</i>] [static-port]
</tt>
</blockquote>

<dl>
<dt><tt>nat</tt>
<dd>ключевое слово, с которого начинается правилоа NAT

<dt><tt>pass</tt>
<dd>Причина того, что преобразованные пакеты не обрабатываются правилами фильтрации

<dt><tt>log</tt>
<dd>логировать подходящие пакет с помощью
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&amp;sektion=8&amp;manpath=OpenBSD+4.4"
>pflogd(8)</a>.
Обычно только первый пакет заноситя в журнал.
Для логирования всех пакетов, используйте <tt>log (all)</tt>.

<dt><tt><i>interface</i></tt>
<dd>Название интерфейса, или группы интерфейсов на котором будую производиться преобразования.

<dt><tt><i>af</i></tt>
<dd>Семейство адресов, <tt>inet</tt> для IPv4 или <tt>inet6</tt>
для IPv6. PF как правило самостоятельно в состояние определить этот
папаметр, c помощью исходных адресов и адресов назначения.

<dt><tt><i>src_addr</i></tt>
<dd>Исходные (внутренние) адреса пакетов, которые будут преобразованы.
Исходные адреса могыт быть указаны, как:
<ul>
<li>Одиночные IPv4 или IPv6 адреса.
<li>Сетевой блок <a href="http://public.pacbell.net/dedicated/cidr.html">CIDR</a> 
<li>Полное доменное имя, которое будет отрезолвено через DNS, когда правила будут подгружены.
Все отрезолвенные адреса будут подставлены в правило.
<li>Название сетевого интерфейса или группа сетевых интерфейсов.
Любые IP адреса принадлежащие интерфейсу будут подставлены в правило,
во время загрузки.
<li>Имя сетевого интерфейса сопровождающегося 
<tt>/<i>netmask</i></tt> (например, <tt>/24</tt>). Каждый IP адрес на интерфейсе,
совмещённый с сетевой маской, образует блок CIDR и оказывается в правиле.
<li>Название сетевого интерфейса или группы сетевых интерфейсов, сопровождающихся
модификаторами:
  <ul>
  <li><tt>:network</tt> - заменяется сетевым блоком CIDR (например,
  192.168.0.0/24)
  <li><tt>:broadcast</tt> - заменяется широковещательным адресом сети
  (например, 192.168.0.255)
  <li><tt>:peer</tt> - заменяются peer IP адреса на point-to-point линк
  </ul>
  <dl>
  <dd>В дополнение, модификатор <tt>:0</tt> может быть добавлен к любому интерфейсу
  или к любому из вышеуказанных модификаторов, для указания, что PF не должен включать
  alias IP адреса. Этот модификатор может использоваться, при указании интерфейса
  в круглых скобках.
  Пример: <tt>fxp0:network:0</tt>
  </dl>
<li>A <a href="tables.html">таблица</a>.
<li>Любое из вышеперечисленного, но в отрицании, используя модифкатор <tt>!</tt> ("не").
<li>Набор адресов, используя<a href="macros.html#lists">списки</a>.
<li>Ключевое слово <tt>any</tt> обозначающее все адреса
</ul>

<dt><tt><i>src_port</i></tt>
<dd>Исходный порт в заголовке пакета. Порты могут быть указаны, как:
<ul>
<li>Номер от 1 до 65535
<li>Актуальное название сервиса смотрите в
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=services&amp;sektion=5"
><tt>/etc/services</tt></a>
<li>Набор портов, используя <a href="macros.html#lists">списки</a>
<li>Диапозон:
	<ul>
	<li><tt>!=</tt> (не равно)
	<li><tt>&lt;</tt> (меньше)
	<li><tt>&gt;</tt> (больше)
	<li><tt>&lt;=</tt> (меньше или равно)
	<li><tt>&gt;=</tt> (больше или равно)
	<li><tt>&gt;&lt;</tt> (диапозон)
	<li><tt>&lt;&gt;</tt> (обратный диапозон)
	<dl>
	<dd>Последние два бинарных оператора (они используют два аргумента)
       	не включают аргументы в этот диапазон
	</dl>
	<li><tt>:</tt> (включающий диапозон)
	<dl>
	<dd>Включающий диапозон, также бинарные операторы и
	включают аргументы в диапозон.
	</dl>
	</ul>
</ul>

Опция <tt>port</tt> не часто используется в <tt>nat</tt> правилах,
потому что обычно задача натить весь трафик, не зависим от используемых
портов.

<dt><tt><i>dst_addr</i></tt>
<dd>Адрес назначения преобразуемых пакетов. Адрес назначения указывается
также, как и исходный адрес.

<dt><tt><i>dst_port</i></tt>
<dd>Порт назначения. Порт указывается также, как и исходный порт.

<dt><tt><i>ext_addr</i></tt>
<dd>Внешний (преобразуемый) адрес на NAT шлюзе, в который будут
пробразованы пакеты. Внешний адрес может быть указан как:
<ul>
<li>Одиночные IPv4 или IPv6 адреса.
<li>Сетевой блок <a href="http://public.pacbell.net/dedicated/cidr.html">CIDR</a> 
<li>Полное доменное имя, которое будет отрезолвено через DNS, когда правила будут подгружены.
Все отрезолвенные адреса будут подставлены в правило.
<li>Название сетевого интерфейса. Любые IP адреса принадлежащие интерфейсу будут подставлены
в правило, во время загрузки.
<li>Название сетевого интерфейса указанного в круглых скобках <tt>( )</tt>.
Это говорит PF обновлять правило, если IP адрес(а) на указанном интерфейсе
сменился. Это полезно на интерфейсах, которые получают IP адреса по DHCP
или используют dial-up, чтобы каждый раз при смене адреса не перегружать
правила.
<li>Название сетевого интерфейса, сопровождающееся одним из этих
модификаторов:
  <ul>
  <li><tt>:network</tt> - заменяется сетевым блоком CIDR (например,
  192.168.0.0/24)
  <li><tt>:peer</tt> - заменяет peer IP адрес на point-to-point линк
  </ul>
  <dl>
  <dd>Кроме того, модификатор <tt>:0</tt> может быть добавлен к любому интерфейсу
  или к любому из вышеуказанных модификаторов, для указания, что PF
  не должен включать alias IP адреса. Этот модификатор может использоваться,
  при указании интерфейса в круглых скобках.
  Пример: <tt>fxp0:network:0</tt>
  </dl>
<li>Ряд адресов, используя <a href="macros.html#lists">список</a>.
</ul>

<dt><tt><i>pool_type</i></tt>
<dd>Указывается тип <a href="pools.html">диапозона адресов</a> используемого для
трансляции.

<dt><tt>static-port</tt>
<dd>Указывает PF не преобразовывать исходные порты в TCP и UDP пакетах.

</dl>

<p>
Как правило, для большинства подойдёт что то вроде этого:
<blockquote>
<tt>
nat on tl0 from 192.168.1.0/24 to any -&gt; 24.5.0.5
</tt>
</blockquote>

<p>
Эти правила говоря выполнять NAT на интерфейсе <tt>tl0</tt> для любых
входящих пакетов из 192.168.1.0/24 и заменять исходный IP адрес на
24.5.0.5.

<p>
Не смотря на то, что вышеуказанное правило является корректным, использовать
подобную форму не рекомендуется. Обслуживание может оказаться сложным, поскольку
любое изменение чисел внешней или внутренней сети потребует изменения правил.
Сравните с более простым в ослуживании правилом (<tt>tl0</tt> внешний интерфей,
<tt>dc0</tt>, внутренний):
<blockquote>
<tt>
nat on tl0 from dc0:network to any -&gt; tl0
</tt>
</blockquote>

<p>
Преимущество должно быть достаточно ясным: вы можете менять IP адреса на
любом интерфейсе без изменения правила.

<p>
Когда указывается название интерфейса для трансляции адресов как в примере
выше, то IP адрес определяется в pf.conf во время <i>загрузки</i>, а не
на "lету". Если вы используете DHCP для настройки ваших внешних интерфейсов,
это может оказаться проблемой. Если ваши присваимые IP адреса меняеются, NAT
будет продолжать преобразовывать исходящие пакеты используя старый
IP адрес. Это приведёт к остановке функционирования исходящих соединений.
Чтобы этого избежать, вы можете сказать PF автоматически обновлять преобразуемый
адрес, указав круглые скобки вокруг названия интерфейса:
<blockquote>
<tt>
nat on tl0 from dc0:network to any -&gt; (tl0)
</tt>
</blockquote>

<p>
Этот метод работает для преобразования обоих IPv4 и IPv6 адресов.

<a name="binat"></a>
<h2>Двунаправленное отображение (отображение 1:1)</h2>
Двунаправленное отображение может быть установлено использованием
правила <tt>binat</tt>. Правило <tt>binat</tt> устанавливает один к одному
отображение между внутренним IP адресом и внешним. Это может быть полезно,
например, для предоставления веб сервера на внутренней сети со своим личным
внешним IP адресом. Соединения из Интернета на внешний адрес будет транслироваться
на внутренний адрес и соединения от веб сервера (такие как DNS запрос) будут
преобразовываться во внешний адрес. TCP и UDP порты никогда не изменяются
с <tt>binat</tt> правилом поскольку они с <tt>nat</tt> правилами.

<p>
Пример:
<blockquote>
<tt>
web_serv_int = "192.168.1.100"<br>
web_serv_ext = "24.5.0.6"<br>
<br>
binat on tl0 from $web_serv_int to any -&gt; $web_serv_ext<br>
</tt>
</blockquote>

<a name="except"></a>
<h2>Исключения правил трансляции</h2>
Исключения в правилах трансляции могут быть сделаны используя
ключевое слово <tt>no</tt>. Например, если изменить пример указанный выше,
то он будет выглядеть так:
<blockquote>
<tt>
no nat on tl0 from 192.168.1.208 to any<br>
nat on tl0 from 192.168.1.0/24 to any -&gt; 24.2.74.79
</tt>
</blockquote>

<p>
Тогда указанная сеть 192.168.1.0/24 будет транслироваться через внешний
адре 24.2.74.79, за исключением адреса 192.168.1.208.

<p>
Обратите внимание, что первое правило главнее; Если существует ключевое слово
<tt>no</tt>, тогда пакеты не транслируются.
Ключевое слово <tt>no</tt> также может быть использовано с
<tt>binat</tt> и <a href="rdr.html"><tt>rdr</tt></a> правилами.

<a name="status"></a>
<h2>Проверка NAT статуса</h2>
Для просмотра активных NAT трансляций используется
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+4.4"
>pfctl(8)</a> с опцией <tt>-s state</tt>. Эта опция выведет список
всех текущих NAT сессиий:

<pre>
   # pfctl -s state
   fxp0 TCP 192.168.1.35:2132 -&gt; 24.5.0.5:53136 -&gt; 65.42.33.245:22 TIME_WAIT:TIME_WAIT
   fxp0 UDP 192.168.1.35:2491 -&gt; 24.5.0.5:60527 -&gt; 24.2.68.33:53   MULTIPLE:SINGLE
</pre>

<p>
Объяснение (только первая строка):

<dl>
<dt>fxp0
<dd>Отображает интерфейс к которому привязан стейт. Слово
<tt>self</tt> будет отображаться если стейт плавающий
<a href="options.html#state-policy"><tt>floating</tt></a>.
</dl>

<dl>
<dt>TCP
<dd>Используемый соединением протокол.
</dl>

<dl>
<dt>192.168.1.35:2132
<dd>IP адрес (192.168.1.35) машины во внутренней сети.
Исходный порт (2132) показан после адреса. Это также адресс, который находится
в IP заголовке.
</dl>

<dl>
<dt>24.5.0.5:53136
<dd>IP адрес (24.5.0.5) и порт (53136) на шлюзе, в который
будут транслированы пакеты.
</dl>

<dl>
<dt>65.42.33.245:22
<dd>IP адрес (65.42.33.245) и порт (22) к которому внутренняя
машина соединяется.
</dl>

<dl>

<dt>TIME_WAIT:TIME_WAIT
<dd>Показывает в каком состоянии прибывает TCP соединение
</dl>

<p>
[<a href="filter.html">Предыдущая: Фильтрация Пакетов</a>]
[<a href="index.html">Содержание</a>]
[<a href="rdr.html">Следующая: Перенаправление трафика (Проброс Портов)</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../images/back.gif" border="0" alt="[back]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<!--
Originally [OpenBSD: nat.html,v 1.29 ]<br>
$Translation: nat.html,v 1.1 2009/04/23 16:11:02 vladimir Exp $<br>
-->
<small>$OpenBSD: nat.html,v 1.1 2009/04/26 15:44:20 tobias Exp $</small>

</body>
</html> 
