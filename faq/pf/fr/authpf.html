<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF : Authpf : Shell Utilisateur pour les Passerelles
d'Authentification</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--

Copyright (c) 2003-2005 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../fr/index.html">
<img alt="[OpenBSD]" height="30" width="141" src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="ftp.html">Précédent : Problèmes avec FTP</a>]
[<a href="index.html">Index</a>]
[<a href="example1.html">Suivant : Exemple 1 : Pare-feu SoHo </a>]

<h1><font color="#e00000">PF : Authpf : Shell Utilisateur pour les
    Passerelles d'Authentification</font></h1>

<hr>

<h3>Table des Matières</h3>
<ul>
<li><a href="#intro">Introduction</a>
<li><a href="#config">Configuration</a>
        <ul>
        <li><a href="#enable">Activer Authpf</a>
        <li><a href="#linkmain">Attacher Authpf au Jeu de Règles
            Principal</a>
        <li><a href="#loadrules">Configurer les Règles Chargées</a>
        <li><a href="#acl">Les Listes de Contrôle d'Accès</a>
        <li><a href="#message">Présenter un Message de Login</a>
        <li><a href="#shell">Attribuer Authpf comme Shell
            Utilisateur</a>
        </ul>
<li><a href="#loginclasse">Créer une classe d'authentification Authpf</a>
<li><a href="#wholog">Voir Les Personnes Connectées</a>
<li><a href="#moreinfo">Plus d'Information</a>
<li><a href="#example">Exemple</a>
</ul>

<hr>

<a name="intro"></a>
<h2>Introduction</h2>
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=authpf&amp;sektion=8&amp;manpath=OpenBSD+3.6">Authpf(8)</a> 
est un shell utilisateur pour les passerelles d'authentification. Une
passerelle d'authentification est comme n'importe quelle passerelle
réseau normale (un routeur) excepté que les utilisateurs doivent d'abord
s'authentifier sur la passerelle avant que celle-ci ne permette au
trafic généré par les utilisateurs de la traverser. Quand le shell d'un
utilisateur est
<tt>/usr/sbin/authpf</tt> (au lieu que son shell soit
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ksh&amp;sektion=1&amp;manpath=OpenBSD+3.6"
>ksh(1)</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=csh&amp;sektion=1&amp;manpath=OpenBSD+3.6">csh(1)</a>, 
etc) et que l'utilisateur se connecte en utilisant SSH, authpf fera les
modifications nécessaires au jeu de règles
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4&amp;manpath=OpenBSD+3.6">pf(4)</a> 
actif de telle manière à permettre au trafic généré par l'utilisateur de
passer à travers les filtres et/ou d'être traduit en utilisant la
Traduction d'Adresses IP ("NAT") ou d'être redirigé. Une fois que
l'utilisateur se déconnecte ou que sa session est terminée, authpf
supprimera toutes les règles chargées pour l'utilisateur et enlevera
toutes les connexions avec maintien d'état que l'utilisateur aura
ouvertes. Ainsi, le trafic de l'utilisateur ne passera à travers la
passerelle que si l'utilisateur garde sa session SSH ouverte.

<p>
Authpf charge les règles de filtres et de NAT dans un <a href="anchors.html">
point d'ancrage</a> unique.
L'ancre est nommée par la combinaison de l'identifiant UNIX de l'utilisateur
et de l'id du processus authpf dans le format "<tt>identifiant(PID)</tt>".
Chaque ancre utilisateur est stockée dans l'ancre <tt>authpf</tt> qui est
elle même ancrée dans le jeu de règles principal.

Le "chemin d'ancrage complet" devient dès lors :

<blockquote>
<tt>
<i>jeu_de_regles_principal</i>/authpf/<i>identifiant</i>(<i>PID</i>)
</tt>
</blockquote>

<p>

Les règles qu'authpf charge peuvent être configurées par utilisateur ou
globalement.

<p>
Voici quelques exemples d'utilisation d'authpf :
<ul>
<li>Exiger que les utilisateurs s'authentifient avant de permettre un
    accès à Internet.
<li>Permettre à certains utilisateurs -- tels que les administrateurs --
    l'accès à certaines parties restreintes du réseau.
<li>Permettre uniquement aux utilisateurs connus l'accès au reste du
    réseau ou à Internet depuis un segment de réseau sans fil.
<li>Permettre à des travailleurs d'accèder à des ressources du système
    d'information de l'entreprise depuis chez eux, lorsqu'ils sont sur
    la route... Les utilisateurs en dehors des bureaux peuvent avoir
    accès au réseau d'entreprise et aussi être redirigés vers des
    ressources spécifiques (leur propre station de travail par exemple)
    selon le nom d'utilisateur qu'ils utilisent pour s'authentifier.
<li>Dans une configuration telle que celle d'une bibliothèque ou un
    autre lieu équipé de terminaux avec un accès Internet public, PF
    peut être configuré pour permettre un accès limité à Internet aux
    utilisateurs de passage. Authpf peut alors être utilisé pour
    permettre aux utilisateurs connus un accès complet.
</ul>

<p>
Authpf enregistre le nom d'utilisateur et l'adresse IP de chaque
utilisateur qui réussit à s'authentifier ainsi que le début et la fin de
leur session. L'enregistrement se fait via
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=syslogd&amp;sektion=8&amp;manpath=OpenBSD+3.6">syslogd(8)</a>. 
En utilisant cette information, un administrateur peut déterminer qui
s'est connecté et responsabiliser les utilisateurs par rapport à leur
trafic réseau.

<a name="config"></a>
<h2>Configuration</h2>
La section suivante fournit les étapes de base nécessaires pour
configurer authpf. Pour une description complète de la configuration
d'authpf, veuillez consulter la
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=authpf&amp;sektion=8&amp;manpath=OpenBSD+3.6">page du manuel authpf</a>.

<a name="enable"></a>
<h3>Activer Authpf</h3>

<p>
Authpf ne se lancera pas si le fichier de configuration <tt>/etc/authpf/authpf.conf</tt>
n'est pas présent.
Même si le fichier est vide (de taille nulle), il doit être présent ou Authpf
se fermera automatiquement après qu'un utilisateur s'authentifie correctement.

<p>
Les directives de configuration suivantes peuvent êtres placées dans
<tt>authpf.conf</tt> :

<ul>
<li><tt>anchor=<i>nom</i></tt> - Utiliser
<a href="anchors.html">l'ancre</a> nom spécifiée au lieu de "authpf".
<li><tt>table=<i>nom</i></tt> - Utiliser la table
<a href="tables.html">table</a> nom spécifiée au lieu de "authpf_users".
</ul>

<a name="linkmain"></a>
<h3>Attacher Authpf au Jeu de Règles Principal</h3>
Authpf peut être rattaché au jeu de règles principal en utilisant des
règles d'ancrage. Ces règles utilisent le mot-clé <tt>anchor</tt> :
<blockquote>
<tt>
nat-anchor "authpf/*"<br>
rdr-anchor "authpf/*"<br>
binat-anchor "authpf/*"<br>
anchor "authpf/*"<br>
</tt>
</blockquote>

<p>
PF &quot;sortira&quot; du jeu de règles principal pour évaluer les
règles authpf à l'endroit où les règles <tt>anchor</tt> sont placées
dans le jeu de règles. Il n'est pas nécessaire que les quatre règles
<tt>anchor</tt> soient présentes. Par exemple, si authpf ne doit charger
aucune règle de traduction <tt>nat</tt>, la règle <tt>nat-anchor</tt>
peut être omise.

<a name="loadrules"></a>
<h3>Configurer les Règles Chargées</h3>
Authpf charge les règles à partir d'un des deux fichiers suivants :
<ul>
<li><tt>/etc/authpf/users/$USER/authpf.rules</tt>
<li><tt>/etc/authpf/authpf.rules</tt>
</ul>

<p>
Le premier fichier contient des règles qui seront uniquement chargées
lorsque l'utilisateur <tt>$USER</tt> (cette variable étant à remplacer
par le nom d'utilisateur) se connecte. La configuration spécifique par
utilisateur est utilisée lorsqu'un utilisateur donné -- un
administrateur par exemple -- nécessite un jeu de règles différent du
jeu de règles authpf par défaut. Le deuxième fichier contient les règles
par défaut qui sont chargées pour tout utilisateur qui ne possède pas
son propre fichier <tt>authpf.rules</tt>. Si le fichier spécifique à
l'utilisateur existe, il est chargé au lieu du fichier par défaut. Au
moins un des fichiers doit exister. Autrement authpf ne fonctionnera
pas.

<p>
Les règles de filtrage et de traduction ont la même syntaxe que pour
n'importe quel autre jeu de règles PF avec une seule exception : Authpf
permet l'utilisateur de deux macros prédéfinies :
<ul>
<li><tt>$user_ip</tt> - l'adresse IP de l'utilisateur connecté
<li><tt>$user_id</tt> - le nom d'utilisateur de l'utilisateur connecté
</ul>

<p>
Il est recommandé d'utiliser la macro <tt>$user_ip</tt> pour ne
permettre que le trafic provenant de la machine de l'utilisateur
authentifié.

<p>
An plus de la macro <tt>$user_ip</tt>, authpf utilisera la table
<tt>authpf_users</tt> (si elle existe) pour stocker les adresses IP
de tous les utilisateurs authentifiés.
Soyez sûrs de définir la table avant de vouloir l'utiliser :

<blockquote>
<tt>
table &lt;authpf_users&gt; persist<br>
pass in on $ext_if proto tcp from &lt;authpf_users&gt; \<br>
&nbsp;&nbsp;&nbsp;&nbsp;to port  smtp flags S/SA keep state
</tt>
</blockquote>

<p>
Cette table ne devrait être utilisée que pour les règles devant s'appliquer
à tous les utilisateurs authentifiés.

<a name="acl"></a>
<h3>Les Listes de Contrôle d'Accès</h3>
On peut empêcher les utilisateurs d'utiliser authpf en créant un fichier
sous le répertoire <tt>/etc/authpf/banned/</tt>. Le fichier doit avoir
comme nom le nom de l'utilisateur banni. Le contenu du fichier sera
affiché à l'utilisateur avant qu'authpf ne le déconnecte. Cette
fonctionnalité fournit une méthode pratique pour notifier un utilisateur
ou lui dire pourquoi son accès n'est pas autorisé et la personne qu'il
doit contacter pour la restauration de son accès.

<p>
Autrement, il est aussi possible d'autoriser uniquement l'accès à des
utilisateurs spécifiques en mettant leur nom d'utilisateur dans le
fichier <tt>/etc/authpf/authpf.allow</tt>. Si le fichier
<tt>/etc/authpf/authpf.allow</tt> n'existe pas ou contient "<tt>*</tt>",
authpf permettra l'accès à n'importe quel utilisateur qui a réussi à se
connecter via SSH et qui n'est pas explicitement banni.

<p>
Si authpf n'est pas capable de déterminer s'il doit autoriser ou
interdire l'accès à un utilisateur, il affichera un message bref et
déconnectera l'utilisateur. Une entrée dans le fichier
<tt>/etc/authpf/banned/</tt> est toujours prise en compte avant une
entrée dans le fichier <tt>/etc/authpf/authpf.allow</tt>.

<a name="message"></a>
<h3>Présenter un Message de Login</h3>

<p>
Chaque fois qu'un utilisateur s'authentifie correctement à authpf,
un message indiquant que l'utilisateur est correctement authentifié est affiché.

<blockquote>
<tt>
Hello charlie. You are authenticated from host "64.59.56.140"
</tt>
</blockquote>

<p>
Ce message peut être suivi par un message personnalisé dans
<tt>/etc/authpf/authpf.message</tt>. 
Le contenu de ce fichier sera affiché après le message d'accueil
par défaut.

<a name="shell"></a>
<h3>Attribuer Authpf comme Shell Utilisateur</h3>
Afin qu'authpf fonctionne, il doit être attribué à l'utilisateur en tant
que shell de connexion ("login shell"). Lorsque l'utilisateur
s'authentifie selon les mécanismes offerts par
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sshd&amp;sektion=8&amp;manpath=OpenBSD+3.6">sshd(8)</a>, 
authpf sera executé comme shell de l'utilisateur. Authpf vérifiera
ensuite si l'utilisateur est autorisé à utiliser authpf, chargera les
règles à partir du fichier approprié, etc.

<p>
Il existe plusieurs méthodes pour attribuer authpf à un utilisateur
comme shell de connexion :
<ol>
<li>Manuellement pour chaque utilisateur en utilisant 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=chsh&amp;sektion=1&amp;manpath=OpenBSD+3.6"
>chsh(1)</a>, 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vipw&amp;sektion=8&amp;manpath=OpenBSD+3.6"
>vipw(8)</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=useradd&amp;sektion=8&amp;manpath=OpenBSD+3.6"
>useradd(8)</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=usermod&amp;sektion=8&amp;manpath=OpenBSD+3.6"
>usermod(8)</a>, etc.
<li>En affectant les utilisateurs à une classe de connexion et en
    changeant l'option <tt>shell</tt> dans
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=login.conf&amp;sektion=5&amp;manpath=OpenBSD+3.6"
><tt>/etc/login.conf</tt></a>.
</ol>

<a name="loginclass"></a>
<h2>Créer une classe d'authentification authpf</h2>
Lors de l'utilisation d'authpfsur un système qui dispose de comptes normaux
et de comptes utilisateurs authpf, il peux être intéressant de créer une
classe d'authentification authpf séparée pour les utilisateurs authpf.
Cela autorise certains changements sur ces comptes à être faits
de manière globale ainsi que de placer des politiques différentes
sur les comptes normaux et les comptes authpf.

Quelques exemples de ces polices peuvent être :

<ul>
<li><b>shell</b> - Spécifier un shell utilisateur de connexion.
Cela peut être utilisé pour forcer un shell utilisateur à <tt>authpf</>>
quelque soit l'entrée dans la base
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=passwd&amp;sektion=5"
>passwd(5)</a>.
<li><b>welcome</b> - Spécifie quel fichier de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=motd&amp;sektion=5"
>motd(5)</a> utiliser lorsqu'un utilisateur se connecte.
Cela est très utile pour afficher des messages ne concernant que les
utilisateurs authpf.
</ul>

<p>
Les classes d'authentifications sont créées dans le fichier
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=login.conf&amp;sektion=5"
>login.conf(5)</a>.
Un exemple de classe d'authentification pour les utilisateurs authpf :

<blockquote>
<tt>
authpf:\<br>
&nbsp;&nbsp;&nbsp;&nbsp;:welcome=/etc/motd.authpf:\<br>
&nbsp;&nbsp;&nbsp;&nbsp;:shell=/usr/sbin/authpf:\<br>
&nbsp;&nbsp;&nbsp;&nbsp;:tc=default:
</tt>
</blockquote>

<p>
Les utilisateurs sont assignés à une classe d'authentification par l'édition
du champ <tt>class</tt> de la base d'utilisateurs passwd(5).
Une méthode pour le faire est l'utilisation de la commande

<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=chsh&amp;sektion=1"
>chsh(1)</a>.

<a name="wholog"></a>
<h2>Voir Les Personnes Connectées</h2>
Une fois l'utilisateur connecté et les règles chargées par authpf, ce
dernier changera son nom de processus pour indiquer le nom d'utilisateur
et l'adresse IP de l'utilisateur connecté :
<pre>
    # ps -ax | grep authpf
    23664 p0  Is+     0:00.11 -authpf: charlie@192.168.1.3 (authpf)
</pre>

<p>
Dans l'exemple ci-dessus, <tt>charlie</tt> est connecté depuis la
machine 192.168.1.3. En envoyant un signal SIGTERM au processus authpf,
on peut déconnecter l'utilisateur. Authpf supprimera aussi toute règle
chargée pour l'utilisateur et supprimer toutes les connexions à état que
l'utilisateur aura ouvert.
<pre>
    # kill -TERM 23664
</pre>

<a name="example"></a>
<h2>Exemple</h2>
Dans cet exemple, authpf est utilisé sur une passerelle OpenBSD pour
authentifier des utilisateurs sur un réseau sans fil faisant partie d'un
réseau de campus plus grand. Une fois les utilisateurs authentifiés, et
en supposant qu'ils ne font pas partie de la liste des utilisateurs
bannis, ils seront autorisés à établir des sessions SSH vers l'extérieur
et de naviguer sur le web (y compris sur les sites web sécurisés). De
plus, ils pourront accéder à un des serveurs DNS du campus.

<p>
Le fichier <tt>/etc/authpf/authpf.rules</tt> contient les règles
suivantes :<br>
<br>

<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
wifi_if = "wi0"

pass in quick on $wifi_if proto tcp from $user_ip to port { ssh, http, \
   https } flags S/SA keep state
</pre>
</td></tr>
</table>

<p>
L'administrateur <tt>charlie</tt> devra être capable d'accéder aux
serveurs SMTP et POP3 du campus en plus des droits d'accès précités. Les
règles suivantes font partie du fichier
<tt>/etc/authpf/users/charlie/authpf.rules</tt> :<br>
<br>

<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
wifi_if = "wi0"
smtp_server = "10.0.1.50"
pop3_server = "10.0.1.51"

pass in quick on $wifi_if proto tcp from $user_ip to $smtp_server \
   port smtp flags S/SA keep state
pass in quick on $wifi_if proto tcp from $user_ip to $pop3_server \
   port pop3 flags S/SA keep state
pass in quick on $wifi_if proto tcp from $user_ip to port { ssh, http, \
   https } flags S/SA keep state
</pre>
</td></tr>
</table>

<p>
Voici le contenu du jeu de règles principal figurant dans le fichier
<tt>/etc/pf.conf</tt> :<br>
<br>

<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
# macros
wifi_if = "wi0"
ext_if  = "fxp0"
dns_servers = "{ 10.0.1.56, 10.0.2.56 }"

table &lt;authpf_users&gt; persist

scrub in all

# filtrage
block drop all

pass out quick on $ext_if inet proto tcp from \
   { $wifi_if:network, $ext_if } flags S/SA modulate state
pass out quick on $ext_if inet proto { udp, icmp } from \
   { $wifi_if:network, $ext_if } keep state

pass in quick on $wifi_if inet proto tcp from $wifi_if:network to $wifi_if \
   port ssh flags S/SA keep state

pass in quick on $wifi_if inet proto { tcp, udp } from &lt;authpf_users&gt; \
   to $dns_servers port domain keep state

anchor "authpf/*" in on $wifi_if
</pre>
</td></tr>
</table>

<p>
Le jeu de règles est très simple :
<ul>
<li>Bloquer tout par défaut.
<li>Autoriser les trafics TCP, UDP et ICMP sortants sur l'interface
    externe en provenance du réseau sans fil et depuis la passerelle
    elle même.
<li>Autoriser le trafic SSH entrant en provenance du réseau sans
    fil et destiné à la passerelle. Cette règle est nécessaire pour
    permettre aux utilisateurs de s'authentifier.
<li>Autoriser les requêtes DNS entrantes provenant de tous les utilisateurs
authpf authentifiés et destinées aux serveurs DNS du campus.
<li>Créer le point d'ancrage "authpf" pour le trafic entrant sur
    l'interface sans fil.
</ul>

<p>
Le jeu de règles par défaut est utilisé pour bloquer tout trafic non
strictement nécessaire pour le fonctionnement de l'architecture. Le
trafic sortant de l'interface externe est autorisé. Cependant le trafic
en entrée de l'interface sans fil est interdit. Une fois l'utilisateur
authentifié, leur trafic est autorisé à traverser l'interface sans fil
et à accéder au reste du réseau. Le mot-clé <tt>quick</tt> est utilisé
un peu partout afin que PF n'évalue pas tous les jeux de règles nommés
quand une nouvelle connexion traverse la passerelle.

<p>
[<a href="ftp.html">Précédent : Problèmes avec FTP</a>]
[<a href="index.html">Index</a>]
[<a href="example1.html">Suivant : Exemple : Pare-feu SoHo </a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[back]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: authpf.html,v 1.14 ]<br>
$Translation: authpf.html,v 1.16 2005/02/13 16:52:28 svincent Exp $<br>
-->
$OpenBSD: authpf.html,v 1.14 2005/02/13 17:41:41 saad Exp $
</small>

</body>
</html> 
