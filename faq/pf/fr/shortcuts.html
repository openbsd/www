<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF : Raccourcis pour la Création de Jeux de
Règles</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, 2004, Nick Holland <nick@openbsd.org>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif">
<p>
[<a href="rdr.html">Précédent : Redirection de Trafic
("Forwarding" de Ports)</a>]
[<a href="index.html">Index</a>]
[<a href="options.html">Suivant : Options de Fonctionnement</a>]

<p>
<h1>
<font color="#e00000">PF : Raccourcis pour la Création de Jeux de
Règles</font>
</h1>

<hr>

<h3>Table des Matières</h3>
<ul>
<li><a href="#intro">Introduction</a>
<li><a href="#macros">Utiliser les Macros</a>
<li><a href="#lists">Utiliser les Listes</a>
<li><a href="#grammar">Grammaire de PF</a>
        <ul>
        <li><a href="#elim">Suppression de Mots-clés</a>
        <li><a href="#return">Simplification des Règles avec
            <tt>return</tt></a>
        <li><a href="#order">Ordonnancement de Mots-clés</a>
        </ul>
</ul>

<hr>

<a name="intro"></a>
<h2>Introduction</h2>
PF offre plusieurs moyens pour simplifier un jeu de règles.
Quelques bons exemples sont les
<a href="macros.html#macros">macros</a> et les
<a href="macros.html#lists">listes</a>.
De plus, le langage d'écriture des jeux de règles, ou
grammaire, offre aussi quelques raccourcis pour rendre un jeu de
règles plus simple. En règle générale, plus
un jeu de règles est facile plus il est facile de le comprendre
et le maintenir.

<a name="macros"></a>
<h2>Utiliser les Macros</h2>
Les macros sont utiles car elles fournissent une alternative au codage
en dur des adresses, des numéros de ports, des noms d'interfaces
etc. dans un jeu de règles. Est-ce que l'adresse IP d'un serveur
a été modifiée ? Pas de problème, il suffit
de mettre à jour la macro; nul besoin de retoucher les
règles de filtrage que vous avez mis du temps et de
l'énergie à construire selon vos besoins.

<p>
Une convention usuelle dans l'écriture des jeux de règles
PF est de définir une macro pour chaque interface réseau.
Si une carte réseau doit être remplacée par une
autre carte qui utilise un pilote différent (en changeant une
3Com par une Intel par exemple), la macro est mise à jour et les
règles de filtrage fonctionneront comme avant. Un autre
bénéfice est le déploiement du même jeu de
règles sur plusieurs machines. Certaines de ces machines peuvent
avoir des cartes réseau différentes. L'utilisation de
macros pour définir les cartes réseau permet d'installer
les jeux de règles avec un minimum d'édition.
L'utilisation de macros pour définir des informations dans un jeu
de règles sujet à changements, telles que les
numéros de ports, les adresses IP, et les noms d'interfaces, est
une pratique recommandée.
<blockquote>
<tt>
# définition de macros pour chaque interface réseau<br>
IntIF = "dc0"<br>
ExtIF = "fxp0"<br>
DmzIF = "fxp1"
</tt>
</blockquote>

<p>
Une autre convention usuelle est d'utiliser les macros pour
définir des adresses IP et les blocs réseau. Ceci aura
pour effet de réduire de manière significative les
opérations de maintenance d'un jeu de règles lorsque les
adresses IP y figurant changent.
<blockquote>
<tt>
# définition de nos réseaux<br>
IntNet = "192.168.0.0/24"<br>
ExtAdd = "24.65.13.4"<br>
DmzNet = "10.0.0.0/24"
</tt>
</blockquote>

<p>
Si le réseau interne doit être étendu ou
modifié, il suffit de mettre à jour la macro :
<blockquote>
<tt>
IntNet = "{ 192.168.0.0/24, 192.168.1.0/24 }"
</tt>
</blockquote>

<p>
Une fois le jeu de règles rechargé, tout fonctionnera
comme avant.

<a name="lists"></a>
<h2>Utiliser les Listes</h2>
Prenons comme exemple quelques bonnes règles à inclure
dans vos jeux de règles pour gérer les adresses

<a href="http://www.geektools.com/rfc/rfc1918.txt">RFC 1918</a>
qui ne doivent pas être routées sur Internet et qui
d'habitude, sont utilisées dans un but malicieux :
<blockquote>
<tt>
block in &nbsp;quick on tl0 inet from 127.0.0.0/8 to any<br>
block in &nbsp;quick on tl0 inet from 192.168.0.0/16 to any<br>
block in &nbsp;quick on tl0 inet from 172.16.0.0/12 to any<br>
block in &nbsp;quick on tl0 inet from 10.0.0.0/8 to any<br>
block out quick on tl0 inet from any to 127.0.0.0/8<br>
block out quick on tl0 inet from any to 192.168.0.0/16<br>
block out quick on tl0 inet from any to 172.16.0.0/12<br>
block out quick on tl0 inet from any to 10.0.0.0/8
</tt>
</blockquote>

<p>
Simplifions maintenant les règles ci-dessus :
<blockquote>
<tt>
block in &nbsp;quick on tl0 inet from { 127.0.0.0/8, 192.168.0.0/16, \<br>
&nbsp;&nbsp;&nbsp;172.16.0.0/12, 10.0.0.0/8 } to any<br>
block out quick on tl0 inet from any to { 127.0.0.0/8, \<br>
&nbsp;&nbsp;&nbsp;192.168.0.0/16, 172.16.0.0/12, 10.0.0.0/8 }
</tt>
</blockquote>

<p>
Le jeu de règles a été réduit de six lignes
: on est passé de huit lignes à deux. On peut encore
simplifier en utilisant des macros en conjonction d'une liste :

<blockquote>
<tt>
NoRouteIPs = "{ 127.0.0.0/8, 192.168.0.0/16, 172.16.0.0/12, \<br>
&nbsp;&nbsp;&nbsp;10.0.0.0/8 }"
<br>
ExtIF = "tl0"<br>
block in &nbsp;quick on $ExtIF from $NoRouteIPs to any<br>
block out quick on $ExtIF from any to $NoRouteIPs
</tt>
</blockquote>

<p>
Notez que les macros et les listes simplifient le fichier
<tt>pf.conf</tt> mais que les lignes sont en réalité
interprétées par
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+3.5">pfctl(8)</a> 
en plusieurs lignes. Ainsi l'exemple précédent est
interprété comme suit :
<blockquote>
<tt>
block in &nbsp;quick on tl0 inet from 127.0.0.0/8 to any<br>
block in &nbsp;quick on tl0 inet from 192.168.0.0/16 to any<br>
block in &nbsp;quick on tl0 inet from 172.16.0.0/12 to any<br>
block in &nbsp;quick on tl0 inet from 10.0.0.0/8 to any<br>
block out quick on tl0 inet from any to 10.0.0.0/8<br>
block out quick on tl0 inet from any to 172.16.0.0/12<br>
block out quick on tl0 inet from any to 192.168.0.0/16<br>
block out quick on tl0 inet from any to 127.0.0.0/8
</tt>
</blockquote>

<p>
Comme vous pouvez le voir, la simplification des règles figurant
dans le fichier <tt>pf.conf</tt> est une facilité offerte
à l'auteur et à la personne chargée de la
maintenance de ce fichier. Ce n'est pas une simplification réelle
des règles traitées par
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4&amp;manpath=OpenBSD+3.5">pf(4)</a>.

<p>
Les macros peuvent être utilisées n'importe où dans
le fichier de règles PF et pas seulement pour définir des
adresses et des ports :
<blockquote>
<tt>
pre  = "pass in quick on ep0 inet proto tcp from "<br>
post = "to any port { 80, 6667 } keep state"<br>
<br>
# classe de David<br>
$pre 21.14.24.80 $post<br>
<br>
# logement de Nick<br>
$pre 24.2.74.79 $post<br>
$pre 24.2.74.178 $post
</tt>
</blockquote>

<p>
Les macros précédentes sont interprétées
comme suit :
<blockquote>
<tt>
pass in quick on ep0 inet proto tcp from 21.14.24.80 to any \<br>
&nbsp;&nbsp;&nbsp;port = 80 keep state<br>
pass in quick on ep0 inet proto tcp from 21.14.24.80 to any \<br>
&nbsp;&nbsp;&nbsp;port = 6667 keep state<br>
pass in quick on ep0 inet proto tcp from 24.2.74.79 to any \<br>
&nbsp;&nbsp;&nbsp;port = 80 keep state<br>
pass in quick on ep0 inet proto tcp from 24.2.74.79 to any \<br>
&nbsp;&nbsp;&nbsp;port = 6667 keep state<br>
pass in quick on ep0 inet proto tcp from 24.2.74.178 to any \<br>
&nbsp;&nbsp;&nbsp;port = 80 keep state<br>
pass in quick on ep0 inet proto tcp from 24.2.74.178 to any \<br>
&nbsp;&nbsp;&nbsp;port = 6667 keep state
</tt>
</blockquote>

<a name="grammar"></a>
<h2>Grammaire de PF</h2>
La grammaire de PF est assez flexible ce qui permet une grande
flexibilité dans les jeux de règles. PF est capable de
supposer certains mots-clés ce qui veut dire qu'ils n'ont pas
besoin d'être explicitement inclus dans une règle, et
l'ordonnancement des mots-clés est relâché de telle
façon à ce qu'il ne soit pas nécessaire de
mémoriser une syntaxe stricte.

<a name="elim"></a>
<h3>Elimination of Keywords</h3>
<p>
Pour définir une politique de blocage par défaut, deux
règles sont utilisés :
<blockquote>
<tt>
block in &nbsp;all<br>
block out all
</tt>
</blockquote>

<p>
Ceci peut être réduit à :
<blockquote>
<tt>
block all
</tt>
</blockquote>

<p>
Quand aucune direction n'est spécifiées, PF suppose que la
règle s'applique aux paquets passant dans les deux sens.

<p>
De manière similaire, les clauses "<tt>from any to any</tt>" et
"<tt>all</tt>" peuvent ne pas figurer dans une règle. Par exemple
:
<blockquote>
<tt>
block in on rl0 all<br>
pass &nbsp;in quick log on rl0 proto tcp from any to any port 22 keep state
</tt>
</blockquote>

<p>
peut être simplifiée de la manière suivante :
<blockquote>
<tt>
block in on rl0<br>
pass &nbsp;in quick log on rl0 proto tcp to port 22 keep state</tt>
</blockquote>

<p>
La première règle bloque tous les paquets en entrée
de n'importe où vers n'importe où sur l'interface rl0, et
la deuxième règle laisse passer le trafic TCP sur rl0
à destination du port 22.

<a name="return"></a>
<h3>Simplification des Règles avec <tt>return</tt></h3>
<p>
Un jeu de règles utilisé pour bloquer des paquets et
répondre avec un TCP RST ou un ICMP Unreachable peut être
écrit comme suit :
<blockquote>
<tt>
block in all<br>
block return-rst in proto tcp all<br>
block return-icmp in proto udp all<br>
block out all<br>
block return-rst out proto tcp all<br>
block return-icmp out proto udp all
</tt>
</blockquote>

<p>
Il peut être largement simplifié comme suit :
<blockquote>
<tt>
block return
</tt>
</blockquote>

<p>
Quand PF voit le mot-clé <tt>return</tt>, il "sait" ce qu'il faut
envoyer comme réponse (ou pas en envoyer du tout), selon le
protocole du paquet bloqué.

<a name="order"></a>
<h3>Ordonnancement de Mots-clés</h3>
<p>
L'ordre selon lequel les mots-clés sont spécifiés
est flexible dans la plupart des cas. Par exemple, une règle
écrite comme suit :
<blockquote>
<tt>
pass in log quick on rl0 proto tcp to port 22 \<br> 
&nbsp;&nbsp;&nbsp;flags S/SA keep state queue ssh label ssh
</tt>
</blockquote>

<p>
Peut aussi être écrite de cette façon :
<blockquote>
<tt>
pass in quick log on rl0 proto tcp to port 22 \<br>
&nbsp;&nbsp;&nbsp;queue ssh keep state label ssh flags S/SA
</tt>
</blockquote>

<p>
Des variations similaires fonctionneront aussi.

<p>
[<a href="rdr.html">Précédent : Redirection de Trafic
("Forwarding" de Ports)</a>]
[<a href="index.html">Index</a>]
[<a href="options.html">Suivant : Options de Fonctionnement</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[back]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
Originally [OpenBSD: shortcuts.html,v 1.12 ]<br>
$Translation: shortcuts.html,v 1.6 2004/10/11 12:24:36 saad Exp $<br>
$OpenBSD: shortcuts.html,v 1.6 2004/10/11 16:17:48 jufi Exp $
</small>

</body>
</html> 
