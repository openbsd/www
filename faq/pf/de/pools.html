<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Adress-Pools und Load Balancing</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta http-equiv="Content-Language" content="de">
<meta name="description"   content="die OpenBSD-FAQ-Seite">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, 2004 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../de/index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="queueing.html">Zurück: Paket-Queueing und Priorisierung</a>]
[<a href="index.html">Inhalt</a>]
[<a href="tagging.html">Weiter: Pakete markieren</a>]

<p>
<h1>
<font color="#e00000">PF: Adress-Pools und Load Balancing</font>
</h1>

<hr>

<h3>Inhaltsverzeichnis</h3>
<ul>
<li><a href="#intro">Einführung</a>
<li><a href="#nat">NAT-Adress-Pool</a>
<li><a href="#incoming">Load Balancing für eingehende Verbindungen</a>
<li><a href="#outgoing">Load Balancing für ausgehende Verbindungen</a>
	<ul>
	<li><a href="#outexample">Regelsatz-Beispiel</a>
	</ul>
</ul>

<hr>

<a name="intro"></a>
<h2>Einführung</h2>
Ein Adress-Pool ist eine Ansammlung von zwei oder mehreren Adressen,
derren Verwendung unter einer Gruppe an Benutzern geteilt wird.
Ein Adress-Pool kann als Umleitungs-Adresse in
<a href="rdr.html"><tt>rdr</tt></a>-Regeln, als Übersetzungs-Adresse
in <a href="nat.html"><tt>nat</tt></a>-Regeln und als Ziel-Adresse
in <tt>route-to</tt>-, <tt>reply-to</tt>- und
<tt>dup-to</tt>-<a href="filter.html">Filter</a>-Optionen angegeben
werden.

<p>
Es gibt vier Methoden, um einen Adress-Pool zu verwenden:
<ul>
<li><tt>bitmask</tt> - setzt den Netzwerk-Teil der Pool-Adresse über
die Adresse, die modifiziert wird (Source-Adresse für <tt>nat</tt>-Regeln,
Ziel-Adresse für <tt>rdr</tt>-Regeln).
Beispiel: wenn der Adress-Pool 192.0.2.1/24 und die zu modifizierende
Adresse 10.0.0.50 ist, dann wird die resultierende Adresse 192.0.2.50
sein. Wenn der Adress-Pool 192.0.2.1/25 und die zu modifizierende
Adresse 10.0.0.130 ist, dann wird die resultierende Adresse 192.0.2.2
sein.
<li><tt>random</tt> - Wählt zufällig eine Adresse aus dem Pool aus.
<li><tt>source-hash</tt> - Verwenden einen ,hash' der Source-Adresse,
um zu ermitteln, welche Adresse aus dem Pool verwendet werden soll.
Diese Methode stellt sicher, dass die gegebene Source-Adresse immer
zur gleichen Pool-Adresse zugewiesen wird.
Der Schlüssel, der dem ,hashing'-Algorithmus übergeben wird, kann
gegebenenfalls nach dem <tt>source-hash</tt>-Schlüsselwortes im
Hex-Format oder als Zeichenkette angegeben werden. Standardmäßig
wird
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+3.6"
>pfctl(8)</a> einen zufälligen Schlüssel jedes Mal erzeugen, wenn der
Regelsatz geladen wird.
<li><tt>round-robin</tt> - Läuft in Reihe durch den Adress-Pool.
Dies ist die standardmäßige Methode und ebenfalls die einzige zulässige,
wenn der Adress-Pool unter Verwendung einer <a href="tables.html">Tabelle</a>
angegeben wurde.
</ul>

<p>
Abgesehen von der <tt>round-robin</tt>-Methode, muss der Adress-Pool
als ein
<a href="http://public.pacbell.net/dedicated/cidr.html">CIDR</a>-
(Classless Inter-Domain Routing) Netzwerkblock angegeben werde. Die
<tt>round-robin</tt>-Methode wird mehrere individuelle Adressen
annehmen, die in einer <a href="macros.html#lists">Liste</a> oder
<a href="tables.html">Tabelle</a> angegeben worden sind.

<p>
Die <tt>sticky-address</tt>-Option kann mit den <tt>random</tt>- und
<tt>round-robin</tt>-Pool-Arten verwendet werden, um sicherzustellen,
dass eine bestimmte Source-Adresse jedesmals zur gleichen
Umleitungs-Adresse zugewiesen wird.

<a name="nat"></a>
<h2>NAT-Adress-Pool</h2>
Ein Adress-Pool kann als Übersetzungs-Adresse in
<a href="nat.html"><tt>nat</tt></a>-Regeln verwendet werden. Die
Source-Adresse einer Verbindung wird somit immer in eine Adresse
übersetzt, die aus dem Pool stammt, je nach gewählter Methode.
Dies kann in Situationen gebräuchlich sein, in denen PF als
NAT für ein sehr großes Netzwerk arbeitet. Da die Anzahl der
Verbindungen, auf die NAT angewandt wurde, pro Übersetzungs-Adresse
begrenzt ist, wird das Hinzufügen zusätzlicher Übersetzungs-Adressen
dem NAT-Gateway erlauben, eine noch größere Anzahl an Anwendern
verwalten zu können.

<p>
In diesem Beispiel wird ein Pool, der aus zwei Adressen besteht,
verwendet, um ausgehende Pakete zu übersetzen. Für jede ausgehende
Verbindung wird PF durch die Adressen in einer ,round-robin'-Manier
wechseln.
<blockquote>
<tt>
nat on $ext_if inet from any to any -&gt; { 192.0.2.5, 192.0.2.10 }
</tt>
</blockquote>

<p>
Ein Nachteil bei dieser Methode ist, dass erfolgreiche Verbindungen
von der gleichen internen Adresse nicht immer mit der gleichen
Übersetzungs-Adresse übersetzt werden. Dies kann Störungen
verursachen, zum Beispiel, wenn Webseiten besucht werden, die
Benutzerlogins anhand der IP-Adresse verfolgen. Ein anderer Weg ist
das Verwenden der <tt>source-hash</tt>-Methode, sodass jede interne
Adresse immer mit der gleichen Übersetzungs-Adresse übersetzt wird.
Um das zu machen, muss der Adress-Pool ein
<a href="http://public.pacbell.net/dedicated/cidr.html">CIDR</a>-Netzwerkblock
sein.
<blockquote>
<tt>
nat on $ext_if inet from any to any -&gt; 192.0.2.4/31 source-hash
</tt>
</blockquote>

<p>
Diese <tt>nat</tt>-Regel verwende den Adress-Pool 192.0.2.4/31
(192.0.2.4 - 192.0.2.5) als Übersetzungs-Adresse für ausgehende
Pakete. Jede interne Adresse wird wegen dem
<tt>source-hash</tt>-Schlüsselwort immer mit der gleichen
Übersetzungs-Adresse übersetzt.

<a name="incoming"></a>
<h2>Load Balance für eingehende Verbindungen</h2>
Adress-Pools können verwendet werdem, um Load Balance für eingehende
Verbindungen durchzuführen. Zum Beispiel können eingehende
Webserver-Verbindungen über eine Webserver-Farm verteilt werden:
<blockquote>
<tt>
web_servers = "{ 10.0.0.10, 10.0.0.11, 10.0.0.13 }"<br>
<br>
rdr on $ext_if proto tcp from any to any port 80 -&gt; $web_servers \<br>
&nbsp;&nbsp;&nbsp;&nbsp;round-robin sticky-address
</tt>
</blockquote>

<p>
Erfolgreiche Verbindungen werden zu den Webservern in einer
,round-robin'-Manier verteilt und zwar mit Verbindungen der
gleichen Quelle, die zum gleichen Webserver gesendet werden.
Die ,sticky Verbindung' wird existieren, so lange ,states' zu dieser
Verbindung verweisen.
Sobald der ,state' ausläuft, wird auch die ,sticky' Verbindung
verschwinden.
Weitere Verbindungen von diesem Host werden zum nächsten
Webserver in der Runde umgeleitet.

<a name="outgoing"></a>
<h2>Load Balance für ausgehende Verbindungen</h2>
Adress-Pools können in Verbindung mit der <tt>route-to</tt>-Filteroption
verwendet werden, um Load Balance mit zwei oder mehr Internetverbindungen
zu erreichen, wenn ein ordentliches ,multi-path routing'-Protokoll
(wie zum Beispiel
<a href="http://www.rfc-editor.org/rfc/rfc1771.txt">BGP4</a>) nicht
verfügbar ist.
Mit der Verwendung von <tt>route-to</tt> in Verbindung mit einem
<tt>round-robin</tt>-Adress-Pools, werden ausgehende Verbindung
gleichmäßig über mehrere Ausgänge verteilt.

<p>
Eine weitere Information, die benötigt wird, um dies machen zu können, ist
die IP-Adresse des angrenzenden Routers jeder Internetverbindung.
Diese wird der <tt>route-to</tt>-Option übergeben, um das Ziel der
ausgehenden Pakete zu kontrollieren.

<p>
Das folgende Beispiel teilt den ausgehenden Verkehr auf zwei
Internetverbindungen auf:
<blockquote>
<tt>
lan_net = "192.168.0.0/24"<br>
int_if &nbsp;= "dc0"<br>
ext_if1 = "fxp0"<br>
ext_if2 = "fxp1"<br>
ext_gw1 = "68.146.224.1"<br>
ext_gw2 = "142.59.76.1"<br>
<br>
pass in on $int_if route-to \<br>
&nbsp;&nbsp;&nbsp;{ ($ext_if1 $ext_gw1), ($ext_if2 $ext_gw2) } round-robin \<br>
&nbsp;&nbsp;&nbsp;from $lan_net to any keep state
</tt>
</blockquote>

<p>
Die <tt>route-to</tt>-Option wird auf den Verkehr, der durch
<i>in</i> in das <i>interne</i> Interface kommt, angewandt, um
die ausgehenden Interfaces anzugeben, über die der Verkehr aufgeteilt
werden soll, mit den jeweiligen Gateways. Bedenke, dass die
<tt>route-to</tt>-Option bei <i>jeder</i> Filterregel anwesend sein
muss, für die der Verkehr aufgeteilt wird. Antwort-Pakete werden
über das gleiche externe Interface zurückgeleitet, das sie verlassen
haben (dies wird durch die ISPs gemacht) und normal zurück zum
internen Netzwerk geleitet.

<p>
Um sicherzustellen, dass Pakete mit einer Source-Adresse, die zum
<tt>$ext_if1</tt> gehören, immer über <tt>$ext_gw1</tt> geleitet werden
(und so ähnlich auch für <tt>$ext_if2</tt> und <tt>$ext_gw2</tt>),
sollten die folgenden beiden Zeilen in den Regelsatz eingefügt werden:
<blockquote>
<tt>
pass out on $ext_if1 route-to ($ext_if2 $ext_gw2) from $ext_if2 \<br>
&nbsp;&nbsp;&nbsp;to any<br>
pass out on $ext_if2 route-to ($ext_if1 $ext_gw1) from $ext_if1 \<br>
&nbsp;&nbsp;&nbsp;to any 
</tt>
</blockquote>

<p>
Schlussendlich kann NAT ebenfalls auf alle ausgehenden Interfaces
angewendet werden:
<blockquote>
<tt>
nat on $ext_if1 from $lan_net to any -&gt; ($ext_if1)<br>
nat on $ext_if2 from $lan_net to any -&gt; ($ext_if2)
</tt>
</blockquote>

<a name="outexample"></a>
<p>
Ein komplettes Beispiel, das ,load balancing' auf den ausgehenden
Verkehr ausübt, kann so ähnlich wiefolgt aussehen:

<p>
<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
lan_net = "192.168.0.0/24"
int_if  = "dc0"
ext_if1 = "fxp0"
ext_if2 = "fxp1"
ext_gw1 = "68.146.224.1"
ext_gw2 = "142.59.76.1"

#  nat auf ausgehende Verbindungen auf jedem Internet-Interface anwenden
nat on $ext_if1 from $lan_net to any -&gt; ($ext_if1)
nat on $ext_if2 from $lan_net to any -&gt; ($ext_if2)

#  standardmäßiges Blocken
block in  from any to any
block out from any to any

#  lasse alle ausgehenden Pakete durch das interne Interface
pass out on $int_if from any to $lan_net
#  lasse ,quick' (schnell) alle Pakete, die für das Gateway selbst
#  bestimmt sind, durch
pass in quick on $int_if from $lan_net to $int_if
#  ,load balancing' auf ausgehenden tcp-Verkehr für das interne Netzwerk
pass in on $int_if route-to \
    { ($ext_if1 $ext_gw1), ($ext_if2 $ext_gw2) } round-robin \
    proto tcp from $lan_net to any flags S/SA modulate state
#  ,load balancing' für ausgehenden udp- und icmp-Verkehr vom internen
#  Netzwerk
pass in on $int_if route-to \
    { ($ext_if1 $ext_gw1), ($ext_if2 $ext_gw2) } round-robin \
    proto { udp, icmp } from $lan_net to any keep state

#  generelle ,pass out'-Regeln für die externen Interfaces
pass out on $ext_if1 proto tcp from any to any flags S/SA modulate state
pass out on $ext_if1 proto { udp, icmp } from any to any keep state
pass out on $ext_if2 proto tcp from any to any flags S/SA modulate state
pass out on $ext_if2 proto { udp, icmp } from any to any keep state

#  leite Pakete von jeder IP vom $ext_if1 zum $ext_gw1 und das gleiche
#  für $ext_if2 und $ext_gw2
pass out on $ext_if1 route-to ($ext_if2 $ext_gw2) from $ext_if2 to any 
pass out on $ext_if2 route-to ($ext_if1 $ext_gw1) from $ext_if1 to any 
</pre>
</td></tr>
</table>

<p>
[<a href="queueing.html">Zurück: Paket-Queueing und Priorisierung</a>]
[<a href="index.html">Inhalt</a>]
[<a href="tagging.html">Weiter: Pakete markieren</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../images/back.gif" border="0" alt="[zurück]"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
Originally [OpenBSD: pools.html,v 1.14 ]<br>
$Translation: pools.html,v 1.4 2004/12/22 12:29:54 paldium Exp $<br>
$OpenBSD: pools.html,v 1.4 2004/12/22 20:00:48 jufi Exp $
</small>

</body>
</html> 
