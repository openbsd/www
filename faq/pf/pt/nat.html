<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Tradução do Endereço de Rede (NAT)</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, Nick Holland <nick@openbsd.org>
Copyright (c) 2003, 2004, Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->


<a href="../../../pt/index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="filter.html">Anterior: Filtragem de Pacotes</a>]
[<a href="index.html">Conteúdo</a>]
[<a href="rdr.html">Próximo: Redirecionamento de Tráfego
("Port Forwarding")</a>]

<p>
<h1><font color="#e00000">PF: Tradução do Endereço de Rede (NAT)</font></h1>

<hr>

<h3>Conteúdo</h3>
<ul>
<li><a href="#intro">Introdução</a>
<li><a href="#works">Como Funciona a NAT</a>
<li><a href="#filter">NAT e Filtragem de Pacotes</a>
<li><a href="#ipfwd">IP Forwarding</a>
<li><a href="#config">Configuração da NAT</a>
<li><a href="#binat">Mapeamento Bidirecional (mapeamento 1:1)</a>
<li><a href="#except">Exceções em Regras de Tradução</a>
<li><a href="#status">Verificação do Status da NAT</a>
</ul>

<hr>

<a name="intro"></a>
<h2>Introdução</h2>
A Tradução do Endereço de Rede (NAT, "Network Address Translation") é
uma forma de mapear toda uma rede (ou redes) para apenas um endereço IP.
NAT é necessária quando o número de endereços IP atribuídos a você pelo
seu Provedor de Serviços de Internet é menor que o número total de
computadores para os quais você quer prover acesso à Internet.
NAT está descrita na
<a href="http://www.geektools.com/rfc/rfc1631.txt">RFC 1631</a>,
"The IP Network Address Translator (NAT)".

<p>
NAT permite que você faça uso dos blocos de endereços reservados
descritos na
<a href="http://www.geektools.com/rfc/rfc1918.txt">RFC 1918</a>,
"Address Allocation for Private Internets".
Tipicamente, sua rede interna é configurada com endereços IP de
um ou mais desses blocos de redes. São eles:
<pre>
	10.0.0.0/8       (10.0.0.0 - 10.255.255.255)
	172.16.0.0/12    (172.16.0.0 - 172.31.255.255)
	192.168.0.0/16   (192.168.0.0 - 192.168.255.255)
</pre>

<p>
Um sistema OpenBSD fazendo NAT deve ter ao menos dois adaptadores de
rede, um para a Internet e outro para a rede interna. A NAT
traduz as requisições da rede interna de forma que elas pareçam
se originar do sistema OpenBSD fazendo NAT.

<a name="works"></a>
<h2>Como Funciona a NAT</h2>
<p>
Quando um cliente na rede interna procura uma máquina na Internet,
ele envia pacotes IP destinados a essa máquina. Esses pacotes contêm
toda a informação de endereçamento necessária para chegar a seu
destino. Informação pertinente à NAT:
<ul>
<li>Endereço IP de origem (por exemplo, 192.168.1.35)
<li>Porta TCP ou UDP de origem (por exemplo, 2132)
</ul>

<p>
Quando o pacote passa pelo gateway NAT, ele é alterado para que pareça
ter sido originado no próprio gateway. O gateway NAT registra então as
alterações feitas por ele em sua tabela de estados para que ele
possa a) reverter as alterações nos pacotes que retornam e b)
certificar-se de que os pacotes que retornam cruzem o firewall sem
serem bloqueados. Por exemplo, as seguintes alterações devem ser feitas:
<ul>
<li>Endereço IP de origem: substituído pelo endereço externo do gateway
(por exemplo, 24.5.0.5)
<li>Porta de origem: substituída por uma porta disponível no gateway,
escolhida dinamicamente (por exemplo, 53136)
</ul>

<p>
Nem a máquina interna nem a máquina na Internet percebem esse trabalho
de tradução. Para a máquina interna, o sistema de NAT é simplesmente um
gateway de Internet. Para a máquina na Internet, os pacotes parecem vir
diretamente do sistema NAT; ele nem mesmo suspeita da existência da
estação de trabalho interna.

<p>
Quando a máquina na Internet responde aos pacotes da máquina interna,
eles são endereçados ao IP externo do gateway NAT (24.5.0.5) na porta
da tradução (53136). O gateway NAT então pesquisa na sua tabela de
estados para determinar se os pacotes de resposta correspondem a uma
conexão já estabelecida. Uma ocorrência única será encontrada
baseando-se na combinação endereço IP/porta, que diz ao PF que os
pacotes pertencem à conexão iniciada pela máquina interna 192.168.1.35.
O PF então faz as alterações reversas feitas nos pacotes que
estabeleceram a conexão e transfere os pacotes de resposta para a
máquina interna.

<p>
A tradução de pacotes ICMP ocorre de maneira similar, mas sem alteração
da porta de origem.

<a name="filter"></a>
<h2>NAT e Filtragem de Pacotes</h2>
<p>
<font color="#ff0000">NOTA:</font> Pacotes traduzidos ainda devem
passar pelo sistema de filtragem e serão aceitos ou bloqueados
baseando-se nas regras de filtragem definidas.
A <i>única</i> exceção à regra se dá quando a palavra-chave
<tt>pass</tt> é usada em uma regra <tt>nat</tt>.
Isso faz com que os pacotes "NATeados" passem direto pelo sistema
de filtragem.

<p>
Saiba também que, como a tradução ocorre <i>antes</i> da filtragem, o
sistema de filtragem enxerga o pacote já <i>traduzido</i> para o
endereço IP e porta conforme explicado em
<a href="#works">Como Funciona a NAT</a>.

<!-- legacy anchor; can eventually be removed -->
<a name="enable"></a>
<a name="ipfwd"></a>
<h2>IP Forwarding</h2>
<p>
Como a NAT é quase sempre usada em roteadores e gateways de rede,
provavelmente será necessário habilitar o IP forwarding para que
pacotes possam trafegar entre as interfaces de rede na máquina OpenBSD.
IP forwarding é habilitado usando o mecanismo
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&amp;sektion=3"
>sysctl(3)</a>:
<blockquote>
<tt>
# sysctl net.inet.ip.forwarding=1<br>
# sysctl net.inet6.ip6.forwarding=1 <i>(se estiver usando IPv6)</i>
</tt>
</blockquote>

<p>
Para que essa alteração seja permanente, as linhas a seguir devem ser
acrescentadas ao arquivo
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl.conf&amp;sektion=5"
><tt>/etc/sysctl.conf</tt></a>:
<blockquote>
<tt>
net.inet.ip.forwarding=1<br>
net.inet6.ip6.forwarding=1
</tt>
</blockquote>

<p>
Essas linhas estão presentes, mas comentadas
(prefixadas por <tt>#</tt>). Remova o <tt>#</tt> e salve o arquivo.
O IP forwarding será habilitado quando a máquina for reinicializada.

<a name="config"></a>
<h2>Configuração da NAT</h2>
A forma geral de regras NAT no arquivo <tt>pf.conf</tt> se parece com:
<blockquote>
<tt>
nat [pass] [log] on <i>interface</i> [<i>fam_de_end</i>] from <i>end_de_or</i>
[port <i>porta_de_or</i>] to \<br>
&nbsp;&nbsp;&nbsp;<i>end_de_dest</i> [port <i>porta_de_dest</i>] -&gt;
<i>end_ext</i> [<i>tipo_de_grupo</i>] [static-port]
</tt>
</blockquote>

<dl>
<dt><tt>nat</tt>
<dd>A palavra-chave que inicia uma regra NAT.

<dt><tt>pass</tt>
<dd>Faz com que pacotes traduzidos passem direto pelas regras de
filtragem.

<dt><tt>log</tt>
<dd>Pacotes que corresponderam são registrados via
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&amp;sektion=8&amp;manpath=OpenBSD+4.5"
>pflogd(8)</a>.
Normalmente, apenas o primeiro pacote que corresponde é registrado.
Para registrar todos os pacotes que corresponderam, use
<tt>log (all)</tt>.

<dt><tt><i>interface</i></tt>
<dd>O nome ou grupo da interface de rede onde os pacotes devem ser
traduzidos.

<dt><tt><i>fam_de_end</i></tt>
<dd>A família de endereço, <tt>inet</tt> para IPv4 ou
<tt>inet6</tt> para IPv6. Normalmente o PF pode determinar essa
informação com base no(s) endereço(s) de origem/destino.

<dt><tt><i>end_de_or</i></tt>
<dd>O endereço de origem (interno) dos pacotes que serão
traduzidos. O endereço de origem pode ser especificado como:
<ul>
<li>Um endereço IPv4 ou IPv6 simples.
<li>Um bloco de rede
    <a href="http://public.pacbell.net/dedicated/cidr.html">CIDR</a>.
<li>Um nome de domínio totalmente qualificado que será resolvido pelo
    DNS quando o conjunto de regras for carregado. Todos os endereços IP
    resultantes da pesquisa serão substituídos na regra.
<li>O nome ou grupo de uma interface de rede. Quaisquer endereços IP
    na interface serão substituídos quando a regra for carregada.
<li>O nome de uma interface de rede seguido de uma
    <tt>/<i>máscara</i></tt> (por exemplo, <tt>/24</tt>). Cada endereço
    IP na interface é combinado com a máscara para formar um bloco de
    rede CIDR que será substituído na regra.
<li>O nome ou grupo de uma interface de rede seguido de qualquer um
    destes modificadores:
    <ul>
    <li><tt>:network</tt> - substitui o bloco de rede CIDR (por exemplo,
        192.168.0.0/24)
    <li><tt>:broadcast</tt> - substitui o endereço de broadcast
        (por exemplo, 192.168.0.255)
    <li><tt>:peer</tt> - substitui o endereço da outra ponta em um
        link ponto a ponto
    </ul>
    <dl>
    <dd>Além disso, o modificador <tt>:0</tt> pode ser acrescentado a um
    nome/grupo de interface ou a qualquer um dos modificadores acima
    para dizer ao PF para não incluir apelidos de endereços IP na
    substituição.
    Esses modificadores também podem ser usados quando a interface está
    entre parêntesis.
    Exemplo: <tt>fxp0:network:0</tt>
    </dl>
<li>Uma <a href="tables.html">tabela</a>.
<li>Qualquer um dos apresentados acima, mas negado usando o modificador
    <tt>!</tt> ("não").
<li>Um grupo de endereços usando-se uma
    <a href="macros.html#lists">lista</a>.
<li>A palavra-chave <tt>any</tt>, indicando todos os endereços
</ul>

<dt><tt><i>porta_de_or</i></tt>
<dd>A porta de origem no cabeçalho da Camada 4 do pacote. Portas
são especificadas como:
<ul>
<li>Um número entre 1 e 65535
<li>Um nome de serviço válido de
    <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=services&amp;sektion=5"
    ><tt>/etc/services</tt></a>
<li>Um grupo de portas usando-se uma
    <a href="macros.html#lists">lista</a>
<li>Uma faixa:
	<ul>
	<li><tt>!=</tt> (diferente de)
	<li><tt>&lt;</tt> (menor que)
	<li><tt>&gt;</tt> (maior que)
	<li><tt>&lt;=</tt> (menor ou igual a)
	<li><tt>&gt;=</tt> (maior ou igual a)
	<li><tt>&gt;&lt;</tt> (faixa)
	<li><tt>&lt;&gt;</tt> (faixa inversa)
	<dl>
	<dd>Os dois últimos são operadores binários (recebem dois
	argumentos) e não incluem os argumentos na faixa.
	</dl>
	<li><tt>:</tt> (faixa inclusiva)
	<dl>
	<dd>O operador de faixa inclusiva também é um operador binário
        e inclui os argumentos na faixa.
	</dl>
	</ul>
</ul>
A opção <tt>port</tt> geralmente não é usada em regras <tt>nat</tt>
porque o objetivo geralmente é fazer NAT de todo o tráfego,
independente da(s) porta(s) sendo utilizada(s).

<dt><tt><i>end_de_dest</i></tt>
<dd>O endereço de destino dos pacotes a serem traduzidos.
Ele é especificado da mesma forma que o endereço de origem.

<dt><tt><i>porta_de_dest</i></tt>
<dd>A porta de destino no cabeçalho da Camada 4 do pacote. Essa porta
é especificada da mesma forma que a porta de origem.

<dt><tt><i>end_ext</i></tt>
<dd>O endereço externo (de tradução) do gateway NAT em que os pacotes
serão traduzidos. O endereço externo pode ser especificado como:
<ul>
<li>Um endereço IPv4 ou IPv6 simples.
<li>Um bloco de rede
    <a href="http://public.pacbell.net/dedicated/cidr.html">CIDR</a>.
<li>Um nome de domínio totalmente qualificado que será resolvido pelo
    servidor DNS quando a regra for carregada.
<li>O nome da interface de rede externa. Quaisquer endereços IP
    atribuídos à interface serão substituídos na regra quando for
    carregada.
<li>O nome da interface de rede externa entre parêntesis
    <tt>( )</tt>. Isso informa ao PF para atualizar a regra caso o(s)
    endereço(s) da interface sofra(m) alterações. É muito útil quando a
    interface externa tem seu endereço IP atribuído via DHCP ou discada,
    pois o conjunto de regras não precisa ser recarregado toda vez que
    o endereço mudar.
<li>O nome da interface de rede seguido de um destes modificadores:
  <ul>
  <li><tt>:network</tt> - substitui o bloco de rede CIDR (por exemplo,
      192.168.0.0/24)
  <li><tt>:peer</tt> - substitui o endereço IP da outra ponta em um
      link ponto a ponto
  </ul>
  <dl>
  <dd>Além disso, o modificador <tt>:0</tt> pode ser acrescentado a um
  nome de interface ou a qualquer um dos modificadores acima para
  indicar que o PF não deve incluir apelidos de endereços IP na
  substituição.
  Esses modificadores também podem ser usados quando a interface está
  entre parêntesis.
  Exemplo: <tt>fxp0:network:0</tt>
  </dl>
<li>Um grupo de endereços usando-se uma
    <a href="macros.html#lists">lista</a>.
</ul>

<dt><tt><i>tipo_de_grupo</i></tt>
<dd>Especifica o tipo de <a href="pools.html">grupo de endereços</a> a
usar para tradução.

<dt><tt>static-port</tt>
<dd>Informa ao PF para não traduzir a porta de origem em pacotes TCP e
UDP.

</dl>

<p>
Isso nos levaria à criação de uma regra básica similar a esta:
<blockquote>
<tt>
nat on tl0 from 192.168.1.0/24 to any -&gt; 24.5.0.5
</tt>
</blockquote>

<p>
Essa regra diz para fazer NAT na interface <tt>tl0</tt> para quaisquer
pacotes vindos de 192.168.1.0/24 e substituir o endereço IP de origem
por 24.5.0.5.

<p>
Embora a regra acima esteja correta, essa forma de uso não é
recomendada.
A manutenção pode se tornar difícil, porque caso algum endereço na
interface externa ou interna seja alterado, a linha também precisará
ser alterada.
Faça a comparação com uma linha que facilita um pouco a
manutenção (<tt>tl0</tt> é externa, <tt>dc0</tt> interna):
<blockquote>
<tt>
nat on tl0 from dc0:network to any -&gt; tl0
</tt>
</blockquote>

<p>
A vantagem deve ser clara: podemos alterar o endereço IP de qualquer
interface sem haver necessidade de se alterar a regra.

<p>
Ao especificar um nome de interface para a tradução de endereços como
mostrado acima, o endereço IP é determinado no <i>carregamento</i> do
pf.conf, e não em tempo real. Caso esteja usando DHCP para configurar
sua interface externa, isso pode se tornar um problema. Se o endereço
atribuído for alterado, a NAT continua traduzindo pacotes saindo do
firewall usando o endereço IP antigo. Isso faz com que as conexões
parem de funcionar.
Para evitar esse problema, você pode dizer ao PF para atualizar o
endereço de tradução automaticamente, colocando o nome da interface
entre parêntesis:
<blockquote>
<tt>
nat on tl0 from dc0:network to any -&gt; (tl0)
</tt>
</blockquote>

<p>
Esse método funciona para tradução tanto de endereços IPv4 quanto IPv6.

<a name="binat"></a>
<h2>Mapeamento Bidirecional (mapeamento 1:1)</h2>
Um mapeamento bidirecional pode ser estabelecido através do uso da
regra <tt>binat</tt>. Uma regra <tt>binat</tt> estabelece o mapeamento
um para um entre um endereço IP interno e um endereço externo.
Isso pode ser útil, por exemplo, para disponibilizar um servidor Web
na rede interna que possua seu próprio IP externo.
As conexões vindas da Internet para esse endereço externo serão
traduzidas para o endereço interno e as conexões do servidor Web
(como pesquisas DNS) serão traduzidas para o endereço externo.
Portas TCP e UDP nunca são alteradas por regras <tt>binat</tt> como
acontece com regras <tt>nat</tt>.

<p>
Exemplo:
<blockquote>
<tt>
web_serv_int = "192.168.1.100"<br>
web_serv_ext = "24.5.0.6"<br>
<br>
binat on tl0 from $web_serv_int to any -&gt; $web_serv_ext<br>
</tt>
</blockquote>

<a name="except"></a>
<h2>Exceções em Regras de Tradução</h2>
Exceções às regras de tradução podem ser feitas usando-se a
palavra-chave <tt>no</tt>. Por exemplo, se o exemplo de NAT acima fosse
alterado para:
<blockquote>
<tt>
no nat on tl0 from 192.168.1.208 to any<br>
nat on tl0 from 192.168.1.0/24 to any -&gt; 24.2.74.79
</tt>
</blockquote>

<p>
Então toda a rede 192.168.1.0/24 teria seus pacotes traduzidos para
o endereço externo 24.2.74.79, exceto a máquina 192.168.1.208.

<p>
Note que a primeira regra que corresponde vence; se for uma regra
<tt>no</tt>, o pacote não é traduzido. A palavra-chave <tt>no</tt>
também pode ser usada com regras <tt>binat</tt> e
<a href="rdr.html"><tt>rdr</tt></a>.

<a name="status"></a>
<h2>Verificação do Status da NAT</h2>
O
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+4.5"
>pfctl(8)</a>
com a opção <tt>-s state</tt> é usado para verificar as traduções
NAT ativas.
Essa opção lista todas as sessões NAT ativas:

<pre>
   # pfctl -s state
   fxp0 TCP 192.168.1.35:2132 -&gt; 24.5.0.5:53136 -&gt; 65.42.33.245:22 TIME_WAIT:TIME_WAIT
   fxp0 UDP 192.168.1.35:2491 -&gt; 24.5.0.5:60527 -&gt; 24.2.68.33:53   MULTIPLE:SINGLE
</pre>

<p>
Explicações (apenas da primeira linha):

<dl>
<dt>fxp0
<dd>Indica a interface a qual o estado está vinculado. A palavra
<tt>self</tt> aparecerá caso o estado seja
<a href="options.html#state-policy"><tt>floating</tt></a>.
</dl>

<dl>
<dt>TCP
<dd>O protocolo usado pela conexão.
</dl>

<dl>
<dt>192.168.1.35:2132
<dd>O endereço IP (192.168.1.35) da máquina na rede interna.
A porta de origem (2132) é mostrada após o endereço. Esse também é
o endereço substituído no cabeçalho IP.
</dl>

<dl>
<dt>24.5.0.5:53136
<dd>O endereço IP (24.5.0.5) e a porta (53136) no gateway onde os
pacotes estão sendo traduzidos.
</dl>

<dl>
<dt>65.42.33.245:22
<dd>O endereço IP (65.42.33.245) e a porta (22) onde a máquina interna
está se conectando.
</dl>

<dl>

<dt>TIME_WAIT:TIME_WAIT
<dd>Indica em qual estado o PF acredita que a conexão TCP esteja.
</dl>

<p>
[<a href="filter.html">Anterior: Filtragem de Pacotes</a>]
[<a href="index.html">Conteúdo</a>]
[<a href="rdr.html">Próximo: Redirecionamento de Tráfego
("Port Forwarding")</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[voltar]"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: nat.html,v 1.30 ]<br>
$Translation: nat.html,v 1.10 2009/10/13 19:12:28 alan Exp $<br>
-->
$OpenBSD: nat.html,v 1.10 2009/10/17 15:58:26 ajacoutot Exp $
</small>

</body>
</html>
