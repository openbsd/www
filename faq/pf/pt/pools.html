<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Grupos de Endereços e Balanceamento de Carga</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, 2004 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../pt/index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="queueing.html">Anterior: Enfileiramento de Pacotes e
Priorização</a>]
[<a href="index.html">Conteúdo</a>]
[<a href="tagging.html">Próximo: Marcação de Pacotes</a>]

<p>
<h1>
<font color="#e00000">PF: Grupos de Endereços e Balanceamento de Carga</font>
</h1>

<hr>

<h3>Conteúdo</h3>
<ul>
<li><a href="#intro">Introdução</a>
<li><a href="#nat">Grupos de Endereços NAT</a>
<li><a href="#incoming">Balanceamento de Conexões de Entrada</a>
<li><a href="#outgoing">Balanceamento de Tráfego de Saída</a>
	<ul>
	<li><a href="#outexample">Exemplo de Conjunto de Regras</a>
	</ul>
</ul>

<hr>

<a name="intro"></a>
<h2>Introdução</h2>
Um grupo de endereços é como um estoque de dois ou mais endereços
que têm seu uso compartilhado entre um grupo de usuários.
Um grupo de endereços pode ser especificado como
endereços de destino nas opções para 
<a href="filter.html">regras</a> <tt>nat-to</tt>, <tt>rdr-to</tt>, 
<tt>route-to</tt>, <tt>reply-to</tt> e <tt>dup-to</tt>.

<p>
Existem quatro métodos de uso de grupos de endereços:
<ul>
<li><tt>bitmask</tt> - monta a porção de rede do endereço do grupo
    no endereço sendo modificado (endereço de origem para regras
    <tt>nat-to</tt>, endereço de destino para regras <tt>rdr-to</tt>).
    Exemplo: se o grupo de endereços é 192.0.2.1/24 e o endereço
    sendo modificado é 10.0.0.50, o endereço resultante será
    192.0.2.50. Se o grupo de endereços for 192.0.2.1/25
    e o endereço sendo modificado 10.0.0.130, o endereço resultante
    será 192.0.2.2.
<li><tt>random</tt> - escolhe um endereço do grupo aleatoriamente.
<li><tt>source-hash</tt> - usa uma dispersão do endereço de origem para
    determinar qual endereço do grupo utilizar. Esse método
    garante que um determinado endereço de origem seja sempre mapeado
    para o mesmo endereço no grupo.
    A chave usada pelo algoritmo de dispersão pode ser opcionalmente
    especificada após a palavra-chave <tt>source-hash</tt>, em formato
    hexadecimal ou como uma string. Por padrão, o
    <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+5.4"
    >pfctl(8)</a> gera uma chave aleatória toda vez que o
    conjunto de regras é carregado.
<li><tt>round-robin</tt> - executa um laço através do
    grupo de endereços em sequência.
    Esse é o método padrão e também o único permitido quando o grupo
    é especificado usando-se uma <a href="tables.html">tabela</a>.
</ul>

<p>
Exceto para o método <tt>round-robin</tt>, o grupo de endereços
deve ser especificado em notação
<a href="http://public.swbell.net/dedicated/cidr.html">CIDR</a>
("Classless Inter-Domain Routing"). O método <tt>round-robin</tt>
aceita múltiplos endereços individuais usando-se
uma <a href="macros.html#lists">lista</a> ou
<a href="tables.html">tabela</a>.

<p>
A opção <tt>sticky-address</tt> pode ser usada com os
tipos de grupo <tt>random</tt> e <tt>round-robin</tt> para se certificar
de que um endereço de origem em particular seja sempre mapeado para o
mesmo endereço de redirecionamento.

<a name="nat"></a>
<h2>Grupos de Endereços NAT</h2>
Um grupo de endereços pode ser usado como endereço de
tradução em regras <a href="nat.html"><tt>nat-to</tt></a>.
As conexões terão seus endereços de origem traduzidos para
um endereço no grupo baseando-se no método escolhido.
Isso pode ser útil em situações onde o PF faz NAT para uma rede
muito grande. Como o número de conexões "NATeadas" por endereço
de tradução é limitado, adicionar mais endereços de tradução para
a tradução fornece poder de escalabilidade ao gateway NAT
para servir um grande número de usuários.

<p>
Neste exemplo, um grupo de dois endereços está sendo
usado para traduzir pacotes que saem da rede. Para cada conexão
o PF alterna entre os endereços utilizando o método round robin.
<blockquote>
<tt>
match out on $ext_if inet nat-to { 192.0.2.5, 192.0.2.10 }
</tt>
</blockquote>

<p>
Uma desvantagem desse método é que conexões sucessivas do mesmo
endereço interno não serão sempre traduzidas para o mesmo endereço de
tradução.
Isso pode causar interferência, por exemplo, ao navegar em sítios Web
que registram sessões de usuários baseando-se no endereço IP.
Um método alternativo é usar o método <tt>source-hash</tt> para que cada
endereço interno seja sempre traduzido para o mesmo
endereço de tradução. Para que isso seja possível, o grupo de
endereços deve ser um bloco de rede
<a href="http://public.swbell.net/dedicated/cidr.html">CIDR</a>.
<blockquote>
<tt>
match out on $ext_if inet nat-to 192.0.2.4/31 source-hash
</tt>
</blockquote>

<p>
Essa regra usa o grupo de endereços 192.0.2.4/31
(192.0.2.4 - 192.0.2.5) como seu endereço de tradução
para pacotes saindo da rede. Cada endereço interno será sempre
traduzido para o mesmo endereço de tradução por causa da palavra-chave
<tt>source-hash</tt>.

<a name="incoming"></a>
<h2>Balanceamento de Conexões de Entrada</h2>
Grupos de endereços também podem ser usados para balancear conexões
de entrada. Por exemplo, pedidos de conexões para um servidor Web
podem ser distribuídos entre vários servidores.
<blockquote>
<tt>
web_servers = "{ 10.0.0.10, 10.0.0.11, 10.0.0.13 }"<br>
<br>
match in on $ext_if proto tcp to port 80 rdr-to $web_servers \<br>
&nbsp;&nbsp;&nbsp;&nbsp;round-robin sticky-address
</tt>
</blockquote>

<p>
Conexões sucessivas serão redirecionadas para os servidores Web
usando o método round robin, com conexões da mesma
origem sendo enviadas ao mesmo servidor Web.
Essa "conexão fixa" existirá enquanto existirem estados na
tabela de estados que referenciem essa conexão.
Uma vez que os estados expiram, expira também a conexão fixa.
As demais conexões originadas daquela máquina serão redirecionadas
para o próximo servidor Web no método round robin.

<a name="outgoing"></a>
<h2>Balanceamento de Tráfego de Saída</h2>
Grupos de endereços podem ser usados em combinação com a
opção de filtragem <tt>route-to</tt> para balancear tráfego entre duas
ou mais conexões com a Internet quando um protocolo apropriado de rota
multicaminhos
(como o <a href="http://www.rfc-editor.org/rfc/rfc1771.txt">BGP4</a>)
não está disponível. Ao usar <tt>route-to</tt> com um grupo de
endereços <tt>round-robin</tt>, conexões de saída podem
ser distribuídas até mesmo entre múltiplos caminhos de saída.

<p>
Outra informação necessária é o endereço IP do roteador adjacente em
cada conexão com a Internet. Esse endereço é informado na opção
<tt>route-to</tt> para controlar o destino dos pacotes de saída.

<p>
O exemplo a seguir balanceia o tráfego de saída entre duas conexões
com a Internet:
<blockquote>
<tt>
lan_net = "192.168.0.0/24"<br>
int_if &nbsp;= "dc0"<br>
ext_if1 = "fxp0"<br>
ext_if2 = "fxp1"<br>
ext_gw1 = "68.146.224.1"<br>
ext_gw2 = "142.59.76.1"<br>
<br>
pass in on $int_if from $lan_net \<br>
&nbsp;&nbsp;&nbsp;route-to { ($ext_if1 $ext_gw1), ($ext_if2 $ext_gw2) }\<br>
&nbsp;&nbsp;&nbsp;round-robin</tt>
</blockquote>

<p>
A opção <tt>route-to</tt> é utilizada no tráfego chegando/entrando
(<i>in</i>) na interface <i>interna</i> para especificar as interfaces
de saída entre as quais será balanceado o tráfego, bem como seus
respectivos gateways.
Note que a opção <tt>route-to</tt> deve estar presente em 
<i>cada</i> regras de filtragem cujo tráfego esteja sendo balanceado
(essa opção não pode ser usada com regras do tipo <tt>match</tt>).

<p>
Para ter certeza de que pacotes com endereço de origem pertencentes
a <tt>$ext_if1</tt> são sempre roteados para <tt>$ext_gw1</tt>
(e da mesma forma para <tt>$ext_if2</tt> e <tt>$ext_gw2</tt>),
as duas regras a seguir devem ser inseridas no conjunto de regras:
<blockquote>
<tt>
pass out on $ext_if1 from $ext_if2 \<br>
&nbsp;&nbsp;&nbsp;route-to ($ext_if2 $ext_gw2)<br>
pass out on $ext_if2 from $ext_if1 \<br>
&nbsp;&nbsp;&nbsp;route-to ($ext_if1 $ext_gw1) 
</tt>
</blockquote>

<p>
Finalmente, NAT pode ser usada em cada interface de saída:
<blockquote>
<tt>
match out on $ext_if1 from $lan_net nat-to ($ext_if1)<br>
match out on $ext_if2 from $lan_net nat-to ($ext_if2)
</tt>
</blockquote>

<a name="outexample"></a>
<p>
Um exemplo completo que faz o balanceamento de tráfego de saída deve
ficar mais ou menos assim:

<p>
<table border="0" width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
lan_net = "192.168.0.0/24"
int_if  = "dc0"
ext_if1 = "fxp0"
ext_if2 = "fxp1"
ext_gw1 = "68.146.224.1"
ext_gw2 = "142.59.76.1"

# nat em conexões de saída para cada interface de Internet
match out on $ext_if1 from $lan_net nat-to ($ext_if1)
match out on $ext_if2 from $lan_net nat-to ($ext_if2)

# Nega por padrão
block in
block out

# Passa todo o tráfego de saída na interface interna
pass out on $int_if to $lan_net
# Aceita e passa direto quaisquer pacotes destinados ao próprio gateway
pass in quick on $int_if from $lan_net to $int_if
# Balanceamento do tráfego de saída partindo da rede interna.
pass in on $int_if from $lan_net \
    route-to { ($ext_if1 $ext_gw1), ($ext_if2 $ext_gw2) } \
    round-robin
# Manter tráfego HTTPS por apenas umas das conexões de saída para Internet;
#  algumas aplicações "mais seguras" não permitem alteração das sessões HTTPS
pass in on $int_if proto tcp from $lan_net to port https \
    route-to ($ext_if1 $ext_gw1)

# Regras gerais de permissão de tráfego de saída para as
# interfaces externas
pass out on $ext_if1
pass out on $ext_if2

# Roteia pacotes de quaisquer IPs na $ext_if1 para $ext_gw1, e faz
# o mesmo para $ext_if2 e $ext_gw2
pass out on $ext_if1 from $ext_if2 route-to ($ext_if2 $ext_gw2)
pass out on $ext_if2 from $ext_if1 route-to ($ext_if1 $ext_gw1)
</pre>
</td></tr>
</table>

<p>
[<a href="queueing.html">Anterior: Enfileiramento de Pacotes e
Priorização</a>]
[<a href="index.html">Conteúdo</a>]
[<a href="tagging.html">Próximo: Marcação de Pacotes</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[voltar]"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: pool.html,v 1.35 ]<br>
$Translation: pools.html,v 1.18 2013/12/01 12:44:33 egypcio Exp $<br>
-->
$OpenBSD: pools.html,v 1.18 2013/12/06 20:52:46 ajacoutot Exp $
</small>

</body>
</html>
