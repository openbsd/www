<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Grupos de Endereços e Balanceamento de Carga</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, 2004 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../pt/index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="queueing.html">Anterior: Fila de Pacotes e Priorização</a>]
[<a href="index.html">Conteúdo</a>]
[<a href="tagging.html">Próximo: Marcação de Pacotes</a>]

<p>
<h1>
<font color="#e00000">PF: Grupos de Endereços e Balanceamento de Carga</font>
</h1>

<hr>

<h3>Conteúdo</h3>
<ul>
<li><a href="#intro">Introdução</a>
<li><a href="#nat">Grupos de Endereços NAT</a>
<li><a href="#incoming">Balanceamento de Conexões Entrantes</a>
<li><a href="#outgoing">Balanceando Tráfego de Saída</a>
	<ul>
	<li><a href="#outexample">Exemplo de Regras</a>
	</ul>
</ul>

<hr>

<a name="intro"></a>
<h2>Introdução</h2>
Um grupo de endereços é como um estoque de dois ou mais endereços
que têm seu uso compartilhado entre os usuários.
Pode ser usado como endereço de redirecionamento em regras
<a href="rdr.html"><tt>rdr</tt></a>, em traduções de endereços em
regras <a href="nat.html"><tt>nat</tt></a> e como alvo de regras de
<a href="filter.html">filtragem</a> com opções
<tt>route-to</tt>, <tt>reply-to</tt> e <tt>dup-to</tt>.

<p>
Existem quatro métodos de uso de grupos de endereçamento:
<ul>
<li><tt>bitmask</tt> - monta a porção de rede do endereço do grupo
    no endereço sendo modificado (endereço de origem para regras
    <tt>nat</tt>, endereço de destino para regras <tt>rdr</tt>).
    Exemplo: se o grupo de endereçamento é 192.0.2.1/24 e o endereço
    sendo modificado é 10.0.0.50, o endereço resultante será
    192.0.2.50. Se o grupo de endereçamento for 192.0.2.1/25
    e o endereço sendo modificado 10.0.0.130, o endereço resultante
    será 192.0.2.2.
<li><tt>random</tt> - escolhe um endereço do grupo aleatoriamente.
<li><tt>source-hash</tt> - usa um hash do endereço de origem para
    determinar qual endereço do grupo utilizar. Esse método
    garante que um endereço de origem seja sempre mapeado para o
    mesmo endereço no grupo.
    A chave usada pelo algoritmo de hash pode ser opcionalmente
    especificada após a palavra-chave <tt>source-hash</tt> em formato
    hexadecimal ou como uma string. Por padrão, o
    <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+4.5"
    >pfctl(8)</a> gera uma chave aleatória toda vez que as
    regras forem carregadas.
<li><tt>round-robin</tt> - usa o grupo de endereços em sequência.
    Esse é o método padrão e também o único permitido caso o grupo
    seja especificado usando-se uma <a href="tables.html">tabela</a>.
</ul>

<p>
Exceto para o método <tt>round-robin</tt>, o grupo de endereçamento
deve ser especificado em notação
<a href="http://public.pacbell.net/dedicated/cidr.html">CIDR</a>
(Classless Inter-Domain Routing). O método <tt>round-robin</tt>
aceitará múltiplos endereços individuais usando
uma <a href="macros.html#lists">lista</a> ou
<a href="tables.html">tabela</a>.

<p>
A opção <tt>sticky-address</tt> pode ser usada com os tipos de
agrupamento <tt>random</tt> e <tt>round-robin</tt> para se
certificar de que um endereço de origem em particular seja sempre
redirecionado para o mesmo endereço.

<a name="nat"></a>
<h2>Grupos de Endereços NAT</h2>
Um grupo de endereços pode ser usado como endereços de
tradução em regras <a href="nat.html"><tt>nat</tt></a>.
As conexões terão seus endereços de origem traduzidos para
um endereço no grupo baseado no método escolhido.
Isso pode ser útil em situações onde o PF faz NAT para uma rede
muito grande. Como o número de conexões NATeadas por endereço
válido é limitado, adicionar mais endereços válidos para a
tradução fornecerá poder de escalabilidade ao gateway NAT
para servir um grande número de usuários.

<p>
Neste exemplo, um grupo de dois endereços está sendo
usado para traduzir pacotes que saem da rede. Para cada conexão
o PF alterna entre os endereços utilizando o método
round-robin.
<blockquote>
<tt>
nat on $ext_if inet from any to any -&gt; { 192.0.2.5, 192.0.2.10 }
</tt>
</blockquote>

<p>
Uma desvantagem desse método é que conexões sucessivas do mesmo
endereço interno não serão sempre traduzidas para o mesmo endereço.
Isso pode causar interferência, por exemplo, ao navegar em sites web que
registram logins de usuário baseado no endereço IP.
Um método alternativo é usar <tt>source-hash</tt> para que cada
endereço interno seja sempre traduzido no mesmo endereço.
Para que isso seja possível, o grupo de
endereços deve estar em notação
<a href="http://public.pacbell.net/dedicated/cidr.html">CIDR</a>.
<blockquote>
<tt>
nat on $ext_if inet from any to any -&gt; 192.0.2.4/31 source-hash
</tt>
</blockquote>

<p>
Essa regra <tt>nat</tt> usa a faixa de endereçamento 192.0.2.4/31
(192.0.2.4 - 192.0.2.5) como seus endereços de tradução
para pacotes saindo da rede. Cada endereço interno será sempre
traduzido para o mesmo endereço, por causa da palavra-chave
<tt>source-hash</tt>.

<a name="incoming"></a>
<h2>Balanceamento de Conexões Entrantes</h2>
Grupos de endereços também podem ser usados para balancear conexões
entrantes. Por exemplo, pedidos de conexões para um servidor web
podem ser distribuídos entre vários servidores.
<blockquote>
<tt>
web_servers = "{ 10.0.0.10, 10.0.0.11, 10.0.0.13 }"<br>
<br>
rdr on $ext_if proto tcp from any to any port 80 -&gt; $web_servers \<br>
&nbsp;&nbsp;&nbsp;&nbsp;round-robin sticky-address
</tt>
</blockquote>

<p>
Conexões sucessivas serão redirecionadas para os servidores web
alternadamente usando o método round-robin com conexões com o mesmo
endereço de origem sendo redirecionadas ao mesmo servidor web.
Essa "conexão fixa" (sticky) existirá enquanto existirem estados na
tabela que referenciem essa conexão.
Uma vez expirado o estado, expirará também a "conexão fixa".
As demais conexões originadas desse host serão redirecionadas
para o próximo servidor web na sequência round robin.

<a name="outgoing"></a>
<h2>Balanceando Tráfego de Saída</h2>
Grupos de endereços podem ser usados em combinação com a
opção de filtragem <tt>route-to</tt> para balancear tráfego entre duas
ou mais conexões com a Internet quando um protocolo apropriado de rota
multi-path
(como o <a href="http://www.rfc-editor.org/rfc/rfc1771.txt">BGP4</a>)
não está disponível. Usando <tt>route-to</tt> com o método
<tt>round-robin</tt>, conexões com destino externo podem ser
distribuídas até mesmo entre múltiplos caminhos de saída.

<p>
Outra informação necessária é o endereço IP do roteador adjacente em
cada conexão com a Internet. Esse endereço é informado na opção
<tt>route-to</tt> para controlar o destino de saída do pacote.

<p>
O exemplo a seguir balanceia o tráfego de saída entre duas conexões
com a Internet:
<blockquote>
<tt>
lan_net = "192.168.0.0/24"<br>
int_if &nbsp;= "dc0"<br>
ext_if1 = "fxp0"<br>
ext_if2 = "fxp1"<br>
ext_gw1 = "68.146.224.1"<br>
ext_gw2 = "142.59.76.1"<br>
<br>
pass in on $int_if route-to \<br>
&nbsp;&nbsp;&nbsp;{ ($ext_if1 $ext_gw1), ($ext_if2 $ext_gw2) } round-robin \<br>
&nbsp;&nbsp;&nbsp;from $lan_net to any keep state
</tt>
</blockquote>

<p>
A opção <tt>route-to</tt> é utilizada no tráfego entrando
(<i>in</i>) na interface <i>interna</i> para especificar as interfaces
de saída entre as quais será balanceado o tráfego, bem como seus
respectivos gateways. Note que a opção <tt>route-to</tt> deve estar
presente em <i>cada</i> regra de filtragem que o tráfego deva ser
balanceado.
Pacotes de retorno serão roteados de volta na mesma interface
externa em que eles saíram (isso é feito pelos ISPs) e
retornará para a rede interna normalmente.

<p>
Para ter certeza de que pacotes com endereço de origem pertencentes
a <tt>$ext_if1</tt> são sempre roteados para <tt>$ext_gw1</tt>
(e da mesma forma para <tt>$ext_if2</tt> e <tt>$ext_gw2</tt>),
as duas regras a seguir devem ser inseridas:
<blockquote>
<tt>
pass out on $ext_if1 route-to ($ext_if2 $ext_gw2) from $ext_if2 \<br>
&nbsp;&nbsp;&nbsp;to any<br>
pass out on $ext_if2 route-to ($ext_if1 $ext_gw1) from $ext_if1 \<br>
&nbsp;&nbsp;&nbsp;to any
</tt>
</blockquote>

<p>
Finalmente, NAT pode ser usado em cada interface de saída:
<blockquote>
<tt>
nat on $ext_if1 from $lan_net to any -&gt; ($ext_if1)<br>
nat on $ext_if2 from $lan_net to any -&gt; ($ext_if2)
</tt>
</blockquote>

<a name="outexample"></a>
<p>
Um exemplo completo que balanceia tráfego de saída deve ficar assim:

<p>
<table border="0" width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
lan_net = "192.168.0.0/24"
int_if  = "dc0"
ext_if1 = "fxp0"
ext_if2 = "fxp1"
ext_gw1 = "68.146.224.1"
ext_gw2 = "142.59.76.1"

#  Faz nat em ambas as interfaces da internet
nat on $ext_if1 from $lan_net to any -&gt; ($ext_if1)
nat on $ext_if2 from $lan_net to any -&gt; ($ext_if2)

#  Nega por padrão
block in  from any to any
block out from any to any

#  Passa todo o tráfego de saída na interface interna
pass out on $int_if from any to $lan_net
#  Aceita (quick) quaisquer pacotes destinados ao próprio gateway
pass in quick on $int_if from $lan_net to $int_if
#  Faz balanceamento de carga no tráfego da rede interna.
pass in on $int_if route-to \
    { ($ext_if1 $ext_gw1), ($ext_if2 $ext_gw2) } round-robin \
    proto tcp from $lan_net to any flags S/SA modulate state
#  Balanceamento de carga em pacotes udp e icmp vindos da rede interna
pass in on $int_if route-to \
    { ($ext_if1 $ext_gw1), ($ext_if2 $ext_gw2) } round-robin \
    proto { udp, icmp } from $lan_net to any keep state

#  Regras gerais "pass out" para as interfaces externas
pass out on $ext_if1 proto tcp from any to any flags S/SA modulate state
pass out on $ext_if1 proto { udp, icmp } from any to any keep state
pass out on $ext_if2 proto tcp from any to any flags S/SA modulate state
pass out on $ext_if2 proto { udp, icmp } from any to any keep state

#  Roteia pacotes de qualquer IP na $ext_if1 para $ext_gw1 e o mesmo para
#  $ext_if2 e $ext_gw2
pass out on $ext_if1 route-to ($ext_if2 $ext_gw2) from $ext_if2 to any
pass out on $ext_if2 route-to ($ext_if1 $ext_gw1) from $ext_if1 to any
</pre>
</td></tr>
</table>

<p>
[<a href="queueing.html">Anterior: Fila de Pacotes e Priorização</a>]
[<a href="index.html">Conteúdo</a>]
[<a href="tagging.html">Próximo: Marcação de Pacotes</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[voltar]"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: pool.html,v 1.23 ]<br>
$Translation: pools.html,v 1.12 2009/05/10 17:44:16 alan Exp $<br>
-->
$OpenBSD: pools.html,v 1.12 2009/05/16 08:59:12 ajacoutot Exp $
</small>

</body>
</html>
