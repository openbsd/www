<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Atalhos na Criação de Conjuntos de Regras</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, 2004 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../pt/index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="rdr.html">Anterior: Redirecionamento de Tráfego
("Port Forwarding")</a>]
[<a href="index.html">Conteúdo</a>]
[<a href="options.html">Próximo: Opções em Tempo de Execução</a>]

<p>
<h1>
<font color="#e00000">PF: Atalhos na Criação de Conjuntos de Regras</font>
</h1>

<hr>

<h3>Conteúdo</h3>
<ul>
<li><a href="#intro">Introdução</a>
<li><a href="#macros">Uso de Macros</a>
<li><a href="#lists">Uso de Listas</a>
<li><a href="#grammar">Gramática do PF</a>
	<ul>
	<li><a href="#elim">Eliminação de Palavras-chave</a>
	<li><a href="#return">Simplificação de <tt>Return</tt></a>
	<li><a href="#order">Ordenação de Palavras-chave</a>
	</ul>
</ul>

<hr>

<a name="intro"></a>
<h2>Introdução</h2>
O PF oferece várias formas de simplificar conjuntos de regras.
Alguns bons exemplos são através do uso de
<a href="macros.html#macros">macros</a> e
<a href="macros.html#lists">listas</a>.
Além disso, a linguagem do conjunto de regras, ou gramática, também
oferece alguns atalhos para tornar o conjunto de regras mais simples.
Como uma regra geral, quanto mais simples as regras, mais fácil de
entender e mantê-las.

<a name="macros"></a>
<h2>Uso de Macros</h2>
Macros são úteis porque são uma alternativa para se referenciar
endereços, números de portas, nomes de interfaces, etc., em um
conjunto de regras.
O endereço IP de um servidor mudou? Sem problema, apenas atualize a
macro; não é necessário sair alterando regras de filtragem que você
teve tanto trabalho para aperfeiçoar às suas necessidades.

<p>
Um costume comum em conjuntos de regras do PF é definir macros para cada
interface de rede.
Se em um dado momento uma placa de rede precisar ser substituída
por uma com driver diferente (por exemplo, trocar uma 3Com por uma
Intel), a macro pode ser atualizada e as regras de filtragem funcionarão
como antes.
Outro benefício é quando se usa o mesmo conjunto de regras em diferentes
máquinas.
Certas máquinas podem ter placas de rede diferentes, e utilizar macros
para defini-las permite usar o conjunto de regras com o mínimo de
edição.
É prática recomendada usar macros para definir informações sujeitas à
alterações, como números de porta, endereços IP e nomes de interface.
<blockquote>
<tt>
# Define macros para cada interface de rede<br>
IntIF = "dc0"<br>
ExtIF = "fxp0"<br>
DmzIF = "fxp1"
</tt>
</blockquote>

<p>
Outra convenção comum é o uso de macros para definir endereços IP e
blocos de rede. Isso reduz bastante o trabalho de manutenção do
conjunto de regras quando endereços IP são alterados.
<blockquote>
<tt>
# Define nossas redes<br>
IntNet = "192.168.0.0/24"<br>
ExtAdd = "24.65.13.4"<br>
DmzNet = "10.0.0.0/24"
</tt>
</blockquote>

<p>
Caso a rede interna for expandida ou mesmo reconfigurada em outro
bloco de endereçamento IP, a macro pode ser atualizada:
<blockquote>
<tt>
IntNet = "{ 192.168.0.0/24, 192.168.1.0/24 }"
</tt>
</blockquote>

<p>
Uma vez recarregado o conjunto de regras, tudo funcionará como antes.

<a name="lists"></a>
<h2>Uso de Listas</h2>
Vamos dar uma olhada em um bom grupo de regras para você ter no seu
conjunto de regras para lidar com endereços especificados na
<a href="http://www.geektools.com/rfc/rfc1918.txt">RFC 1918</a>,
que simplesmente não podem ficar vagando na Internet, e quando
são encontrados, provavelmente estão tentando causar algum problema:
<blockquote>
<tt>
block in &nbsp;quick on tl0 inet from 127.0.0.0/8 to any<br>
block in &nbsp;quick on tl0 inet from 192.168.0.0/16 to any<br>
block in &nbsp;quick on tl0 inet from 172.16.0.0/12 to any<br>
block in &nbsp;quick on tl0 inet from 10.0.0.0/8 to any<br>
block out quick on tl0 inet from any to 127.0.0.0/8<br>
block out quick on tl0 inet from any to 192.168.0.0/16<br>
block out quick on tl0 inet from any to 172.16.0.0/12<br>
block out quick on tl0 inet from any to 10.0.0.0/8
</tt>
</blockquote>

<p>
Agora veja a simplificação:
<blockquote>
<tt>
block in &nbsp;quick on tl0 inet from { 127.0.0.0/8, 192.168.0.0/16, \<br>
&nbsp;&nbsp;&nbsp;172.16.0.0/12, 10.0.0.0/8 } to any<br>
block out quick on tl0 inet from any to { 127.0.0.0/8, \<br>
&nbsp;&nbsp;&nbsp;192.168.0.0/16, 172.16.0.0/12, 10.0.0.0/8 }
</tt>
</blockquote>

<p>
O conjunto de regras foi reduzido de oito linhas para apenas duas.
Tudo fica melhor ainda quando se usa macros junto com listas:
<blockquote>
<tt>
NoRouteIPs = "{ 127.0.0.0/8, 192.168.0.0/16, 172.16.0.0/12, \<br>
&nbsp;&nbsp;&nbsp;10.0.0.0/8 }"
<br>
ExtIF = "tl0"<br>
block in &nbsp;quick on $ExtIF from $NoRouteIPs to any<br>
block out quick on $ExtIF from any to $NoRouteIPs
</tt>
</blockquote>

<p>
Note que macros e listas simplificam o arquivo <tt>pf.conf</tt>,
mas as linhas são expandidas em múltiplas regras pelo
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+5.4"
>pfctl(8)</a>. Portanto, o exemplo acima na verdade é expandido para
as seguintes regras:
<blockquote>
<tt>
block in &nbsp;quick on tl0 inet from 127.0.0.0/8 to any<br>
block in &nbsp;quick on tl0 inet from 192.168.0.0/16 to any<br>
block in &nbsp;quick on tl0 inet from 172.16.0.0/12 to any<br>
block in &nbsp;quick on tl0 inet from 10.0.0.0/8 to any<br>
block out quick on tl0 inet from any to 10.0.0.0/8<br>
block out quick on tl0 inet from any to 172.16.0.0/12<br>
block out quick on tl0 inet from any to 192.168.0.0/16<br>
block out quick on tl0 inet from any to 127.0.0.0/8
</tt>
</blockquote>

<p>
Como você pode ver, a expansão do PF é puramente uma conveniência para
quem escreve e mantém o arquivo <tt>pf.conf</tt>, não uma simplificação
das regras processadas pelo
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4&amp;manpath=OpenBSD+5.4"
>pf(4)</a>.

<p>
Macros podem ser usadas para definir mais do que endereços e portas;
elas podem ser usadas em qualquer lugar em um arquivo de regras do PF:
<blockquote>
<tt>
pre  = "pass in quick on ep0 inet proto tcp from "<br>
post = "to any port { 80, 6667 }"<br>
<br>
# Sala de aula do David<br>
$pre 21.14.24.80 $post<br>
<br>
# Casa do Nick<br>
$pre 24.2.74.79 $post<br>
$pre 24.2.74.178 $post
</tt>
</blockquote>

<p>
Expande para:
<blockquote>
<tt>
pass in quick on ep0 inet proto tcp from 21.14.24.80 to any \<br>
&nbsp;&nbsp;&nbsp;port = 80<br>
pass in quick on ep0 inet proto tcp from 21.14.24.80 to any \<br>
&nbsp;&nbsp;&nbsp;port = 6667<br>
pass in quick on ep0 inet proto tcp from 24.2.74.79 to any \<br>
&nbsp;&nbsp;&nbsp;port = 80<br>
pass in quick on ep0 inet proto tcp from 24.2.74.79 to any \<br>
&nbsp;&nbsp;&nbsp;port = 6667<br>
pass in quick on ep0 inet proto tcp from 24.2.74.178 to any \<br>
&nbsp;&nbsp;&nbsp;port = 80<br>
pass in quick on ep0 inet proto tcp from 24.2.74.178 to any \<br>
&nbsp;&nbsp;&nbsp;port = 6667
</tt>
</blockquote>

<a name="grammar"></a>
<h2>Gramática do PF</h2>
A gramática do PF é bem flexível, o que permite grande flexibilidade
em um conjunto de regras. O PF pode até mesmo deduzir certas
palavras-chave, o que significa que elas não precisam ser declaradas
explicitamente em uma regra, e a ordenação de palavra-chave é relaxada,
de forma que não se faz necessário memorizar uma sintaxe precisa.

<a name="elim"></a>
<h3>Eliminação de Palavras-chave</h3>
<p>
Para definir uma política "negar por padrão", duas regras são
utilizadas:
<blockquote>
<tt>
block in &nbsp;all<br>
block out all
</tt>
</blockquote>

<p>
Isso pode ser reduzido para:
<blockquote>
<tt>
block
</tt>
</blockquote>

<p>
Quando a direção não é especificada, o PF assume que a regra se aplica
a pacotes se movendo em ambas as direções.

<p>
De maneira similar, as cláusulas "<tt>from any to any</tt>" e
"<tt>all</tt>" podem ser deixadas de lado em uma regra, por exemplo:
<blockquote>
<tt>
block in on rl0 all<br>
pass &nbsp;in quick log on rl0 proto tcp from any to any port 22 keep state
</tt>
</blockquote>

<p>
pode ser simplificada como:
<blockquote>
<tt>
block in on rl0<br>
pass &nbsp;in quick log on rl0 proto tcp to port 22 keep state</tt>
</blockquote>

<p>
A primeira regra bloqueia todo tráfego de entrada de pacotes vindos de
qualquer lugar para qualquer lugar em rl0, e a segunda regra aceita
tráfego TCP com destino a porta 22 em rl0.

<a name="return"></a>
<h3>Simplificação de <tt>Return</tt></h3>
<p>
Um conjunto de regras usado para bloquear pacotes e responder com
um pacote TCP RST ou ICMP de Inalcançável pode ficar assim:
<blockquote>
<tt>
block in all<br>
block return-rst in proto tcp all<br>
block return-icmp in proto udp all<br>
block out all<br>
block return-rst out proto tcp all<br>
block return-icmp out proto udp all
</tt>
</blockquote>

<p>
Ou podem ser simplificadas como:
<blockquote>
<tt>
block return
</tt>
</blockquote>

<p>
Quando o PF encontra a palavra-chave <tt>return</tt>, ele é inteligente
o bastante para enviar a resposta apropriada, ou nenhuma resposta,
dependendo do protocolo do pacote sendo bloqueado.

<a name="order"></a>
<h3>Ordenação de Palavras-chave</h3>
<p>
A ordem em que as palavras-chave são especificadas, na maioria dos
casos, é bem flexível. Por exemplo, uma regra escrita assim:
<blockquote>
<tt>
pass in log quick on rl0 proto tcp to port 22 \<br>
&nbsp;&nbsp;&nbsp;flags S/SA keep state queue ssh label ssh
</tt>
</blockquote>

<p>
Também pode ser escrita assim:
<blockquote>
<tt>
pass in quick log on rl0 proto tcp to port 22 \<br>
&nbsp;&nbsp;&nbsp;queue ssh keep state label ssh flags S/SA
</tt>
</blockquote>

<p>
Variações similares também funcionarão.

<p>
[<a href="rdr.html">Anterior: Redirecionamento de Tráfego
("Port Forwarding")</a>]
[<a href="index.html">Conteúdo</a>]
[<a href="options.html">Próximo: Opções em Tempo de Execução</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[voltar]"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: shortcuts.html,v 1.32 ]<br>
$Translation: shortcuts.html,v 1.19 2013/12/01 12:44:33 egypcio Exp $<br>
-->
$OpenBSD: shortcuts.html,v 1.19 2013/12/06 20:52:46 ajacoutot Exp $
</small>

</body>
</html>
