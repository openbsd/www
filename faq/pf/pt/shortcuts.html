<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Atalhos na Cria&ccedil;&atilde;o de Regras</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description" content="the OpenBSD FAQ page">
<meta name="keywords" content="openbsd,faq,pf">
<meta name="distribution" content="global">
</head>

<!--
Copyright (c) 2003, 2004 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../pt/index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="rdr.html">Anterior: Redirecionamento de Tr&aacute;fego (Port Forwarding)</a>]
[<a href="index.html">Conte&uacute;do</a>]
[<a href="options.html">Pr&oacute;ximo: Op&ccedil;&otilde;es em Tempo de Execu&ccedil;&atilde;o</a>]

<p>
<h1>
<font color="#e00000">PF: Atalhos na Cria&ccedil;&atilde;o de Regras</font>
</h1>

<hr>

<h3>Conte&uacute;do</h3>
<ul>
<li><a href="#intro">Introdu&ccedil;&atilde;o</a>
<li><a href="#macros">Usando Macros</a>
<li><a href="#lists">Usando Listas</a>
<li><a href="#grammar">Gram&aacute;tica do PF</a>
	<ul>
	<li><a href="#elim">Elimina&ccedil;&atilde;o de Palavras-Chave</a>
	<li><a href="#return">Simplifica&ccedil;&atilde;o de <tt>Return</tt></a>
	<li><a href="#order">Ordena&ccedil;&atilde;o de Palavras</a>
	</ul>
</ul>

<hr>

<a name="intro"></a>
<h2>Introdu&ccedil;&atilde;o</h2>
O PF oferece v&aacute;rias formas de simplificar regras. Alguns bons 
exemplos s&atilde;o atrav&eacute;s do uso de
<a href="macros.html#macros">macros</a> e
<a href="macros.html#lists">listas</a>.
Al&eacute;m disso, a linguagem das regras, ou gram&aacute;tica, tamb&eacute;m oferece 
alguns atalhos para tornar as regras mais simples.  Como uma regra geral, quanto 
mais simples as regras, mais f&aacute;cil entender e manter.

<a name="macros"></a>
<h2>Usando Macros</h2>
Macros s&atilde;o &uacute;teis porque s&atilde;o uma alternativa para se referenciar 
endere&ccedil;os, n&uacute;meros de portas, nomes de interfaces, etc, em uma regra. 
O endere&ccedil;o IP de um servidor mudou? Sem problema, apenas atualize a macro; 
n&atilde;o &eacute; necess&aacute;rio sair alterando regras de filtragem que voc&ecirc; teve 
tanto trabalho para aperfei&ccedil;oar as suas necessidades.

<p>
Um costume comum em regras PF &eacute; definir macros para cada interface de
rede. Se em dado momento uma placa de rede precisar ser substitu&iacute;da
por uma com driver diferente, por exemplo trocar uma 3Com por uma Intel, 
a macro pode ser atualizada e as regras de filtragem funcionar&atilde;o como antes.
Outro benef&iacute;cio &eacute; quando se usa as mesmas regras em diferentes m&aacute;quinas. 
Certas m&aacute;quinas podem ter placas de rede diferentes, e utilizar macros 
para defini-las permite usar as regras com o m&iacute;nimo de edi&ccedil;&atilde;o. &Eacute; 
pr&aacute;tica recomendada usar macros para definir informa&ccedil;&otilde;es sujeitas a 
altera&ccedil;&atilde;o como n&uacute;meros de porta, endere&ccedil;os IP e nomes de interface.
<blockquote>
<tt>
# define macros para cada interface de rede<br>
IntIF = "dc0"<br>
ExtIF = "fxp0"<br>
DmzIF = "fxp1"
</tt>
</blockquote>

<p>
Outra conven&ccedil;&atilde;o comum &eacute; o uso de macros para definir endere&ccedil;os IP e 
blocos de rede. Isso reduz bastante o trabalho de manuten&ccedil;&atilde;o de regras quando 
endere&ccedil;os IP s&atilde;o alterados.
<blockquote>
<tt>
# define nossas redes<br>
IntNet = "192.168.0.0/24"<br>
ExtAdd = "24.65.13.4"<br>
DmzNet = "10.0.0.0/24"
</tt>
</blockquote>

<p>
Caso a rede interna for expandida ou mesmo reconfigurada em outro 
bloco de endere&ccedil;amento IP, a macro pode ser atualizada:
<blockquote>
<tt>
IntNet = "{ 192.168.0.0/24, 192.168.1.0/24 }"
</tt>
</blockquote>

<p>
Uma vez recarregas as regras, tudo funcionar&aacute; como antes.

<a name="lists"></a>
<h2>Usando Listas</h2>
Vejamos algumas regras para lidar com endere&ccedil;os especificados na 
<a href="http://www.geektools.com/rfc/rfc1918.txt">RFC 1918</a>,
que simplesmente n&atilde;o podem ficar vagando na Internet, e quando
s&atilde;o encontrados, provavelmente est&atilde;o tentando causar algum 
problema:
<blockquote>
<tt>
block in &nbsp;quick on tl0 inet from 127.0.0.0/8 to any<br>
block in &nbsp;quick on tl0 inet from 192.168.0.0/16 to any<br>
block in &nbsp;quick on tl0 inet from 172.16.0.0/12 to any<br>
block in &nbsp;quick on tl0 inet from 10.0.0.0/8 to any<br>
block out quick on tl0 inet from any to 127.0.0.0/8<br>
block out quick on tl0 inet from any to 192.168.0.0/16<br>
block out quick on tl0 inet from any to 172.16.0.0/12<br>
block out quick on tl0 inet from any to 10.0.0.0/8
</tt>
</blockquote>

<p>
Agora veja a simplifica&ccedil;&atilde;o:
<blockquote>
<tt>
block in &nbsp;quick on tl0 inet from { 127.0.0.0/8, 192.168.0.0/16, \<br>
&nbsp;&nbsp;&nbsp;172.16.0.0/12, 10.0.0.0/8 } to any<br>
block out quick on tl0 inet from any to { 127.0.0.0/8, \<br>
&nbsp;&nbsp;&nbsp;192.168.0.0/16, 172.16.0.0/12, 10.0.0.0/8 }
</tt>
</blockquote>

<p>
As regras foram reduzidas de oito linhas para apenas duas.
Tudo fica melhor ainda quando se usa macros junto com listas:
<blockquote>
<tt>
NoRouteIPs = "{ 127.0.0.0/8, 192.168.0.0/16, 172.16.0.0/12, \<br>
&nbsp;&nbsp;&nbsp;10.0.0.0/8 }"
<br>
ExtIF = "tl0"<br>
block in &nbsp;quick on $ExtIF from $NoRouteIPs to any<br>
block out quick on $ExtIF from any to $NoRouteIPs
</tt>
</blockquote>

<p>
Note que macros e listas simplificam o arquivo 
<tt>pf.conf</tt>, mas as linhas s&atilde;o expandidas em m&uacute;ltiplas regras pelo 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+3.7"
>pfctl(8)</a>.  Portanto, o exemplo acima &eacute; expandido na verdade para as seguintes regras:
<blockquote>
<tt>
block in &nbsp;quick on tl0 inet from 127.0.0.0/8 to any<br>
block in &nbsp;quick on tl0 inet from 192.168.0.0/16 to any<br>
block in &nbsp;quick on tl0 inet from 172.16.0.0/12 to any<br>
block in &nbsp;quick on tl0 inet from 10.0.0.0/8 to any<br>
block out quick on tl0 inet from any to 10.0.0.0/8<br>
block out quick on tl0 inet from any to 172.16.0.0/12<br>
block out quick on tl0 inet from any to 192.168.0.0/16<br>
block out quick on tl0 inet from any to 127.0.0.0/8
</tt>
</blockquote>

<p>
Como pode ver, a expans&atilde;o do PF &eacute; puramente uma conveni&ecirc;ncia para 
quem escreve e mant&eacute;m o arquivo <tt>pf.conf</tt>, n&atilde;o uma simplifica&ccedil;&atilde;o 
das regras processadas pelo 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4&amp;manpath=OpenBSD+3.7"
>pf(4)</a>.

<p>
Macros podem ser usadas para definir mais do que endere&ccedil;os e portas; elas podem 
ser usadas em qualquer lugar num arquivo de regras PF:
<blockquote>
<tt>
pre  = "pass in quick on ep0 inet proto tcp from "<br>
post = "to any port { 80, 6667 } keep state"<br>
<br>
# Classe do David<br>
$pre 21.14.24.80 $post<br>
<br>
# Casa do Nick<br>
$pre 24.2.74.79 $post<br>
$pre 24.2.74.178 $post
</tt>
</blockquote>

<p>
Expande para:
<blockquote>
<tt>
pass in quick on ep0 inet proto tcp from 21.14.24.80 to any \<br>
&nbsp;&nbsp;&nbsp;port = 80 keep state<br>
pass in quick on ep0 inet proto tcp from 21.14.24.80 to any \<br>
&nbsp;&nbsp;&nbsp;port = 6667 keep state<br>
pass in quick on ep0 inet proto tcp from 24.2.74.79 to any \<br>
&nbsp;&nbsp;&nbsp;port = 80 keep state<br>
pass in quick on ep0 inet proto tcp from 24.2.74.79 to any \<br>
&nbsp;&nbsp;&nbsp;port = 6667 keep state<br>
pass in quick on ep0 inet proto tcp from 24.2.74.178 to any \<br>
&nbsp;&nbsp;&nbsp;port = 80 keep state<br>
pass in quick on ep0 inet proto tcp from 24.2.74.178 to any \<br>
&nbsp;&nbsp;&nbsp;port = 6667 keep state
</tt>
</blockquote>

<a name="grammar"></a>
<h2>Gram&aacute;tica do PF</h2>
A gram&aacute;tica do PF &eacute; bem flex&iacute;vel, o que permite grande flexibilidade 
na constru&ccedil;&atilde;o de regras. PF pode at&eacute; mesmo deduzir certas palavras,
o que significa que elas n&atilde;o precisam ser declaradas explicitamente 
numa regra, e a ordem de constru&ccedil;&atilde;o &eacute; relaxada, de forma que n&atilde;o se 
faz necess&aacute;rio memorizar uma sintaxe precisa.

<a name="elim"></a>
<h3>Elimina&ccedil;&atilde;o de Palavras-Chave</h3>
<p>
Para definir uma pol&iacute;tica "negar por padr&atilde;o", duas regras s&atilde;o utilizadas:
<blockquote>
<tt>
block in &nbsp;all<br>
block out all
</tt>
</blockquote>

<p>
Isso pode ser reduzido para:
<blockquote>
<tt>
block all
</tt>
</blockquote>

<p>
Quando a dire&ccedil;&atilde;o n&atilde;o &eacute; especificada, PF assume que a regra se aplica a
pacotes movendo em ambas as dire&ccedil;&otilde;es.

<p>
De maneira similar, as cl&aacute;usulas "<tt>from any to any</tt>" e "<tt>all</tt>" 
podem ser deixadas de lado numa regra, por exemplo:
<blockquote>
<tt>
block in on rl0 all<br>
pass &nbsp;in quick log on rl0 proto tcp from any to any port 22 keep state
</tt>
</blockquote>

<p>
pode ser simplificada como:
<blockquote>
<tt>
block in on rl0<br>
pass &nbsp;in quick log on rl0 proto tcp to port 22 keep state</tt>
</blockquote>

<p>
A primeira regra bloqueia todo tr&aacute;fego entrante de pacotes vindos de 
qualquer lugar em rl0 para qualquer lugar, e a segunda regra aceita 
tr&aacute;fego TCP com destino &agrave; porta 22 em rl0.

<a name="return"></a>
<h3>Simplifica&ccedil;&atilde;o de <tt>Return</tt></h3>
<p>
Regras usadas para bloquear pacotes e responder com TCP 
RST ou ICMP Unreachable podem ficar assim:
<blockquote>
<tt>
block in all<br>
block return-rst in proto tcp all<br>
block return-icmp in proto udp all<br>
block out all<br>
block return-rst out proto tcp all<br>
block return-icmp out proto udp all
</tt>
</blockquote>

<p>
Ou podem ser simplificadas como:
<blockquote>
<tt>
block return
</tt>
</blockquote>

<p>
Quando PF encontra a palavra <tt>return</tt>, ele &eacute; inteligente o 
bastante para enviar a resposta apropriada, ou nenhuma resposta, 
dependendo do protocolo do pacote sendo bloqueado.

<a name="order"></a>
<h3>Ordena&ccedil;&atilde;o de Palavras</h3>
<p>
A ordem em que as palavras-chave s&atilde;o especificadas na maioria 
dos casos &eacute; bem flex&iacute;vel. Por exemplo, uma regra escrita assim:
<blockquote>
<tt>
pass in log quick on rl0 proto tcp to port 22 \<br> 
&nbsp;&nbsp;&nbsp;flags S/SA keep state queue ssh label ssh
</tt>
</blockquote>

<p>
Tamb&eacute;m pode ser escrita assim:
<blockquote>
<tt>
pass in quick log on rl0 proto tcp to port 22 \<br>
&nbsp;&nbsp;&nbsp;queue ssh keep state label ssh flags S/SA
</tt>
</blockquote>

<p>
Varia&ccedil;&otilde;es similares tamb&eacute;m funcionar&atilde;o.

<p>
[<a href="rdr.html">Anterior: Redirecionamento de Tr&aacute;fego (Port Forwarding)</a>]
[<a href="index.html">Conte&uacute;do</a>]
[<a href="options.html">Pr&oacute;ximo: Op&ccedil;&otilde;es em Tempo de Execu&ccedil;&atilde;o</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[back]"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
Originally [OpenBSD: shortcuts.html,v 1.15 ]<br>
$Translation: shortcuts.html,v 1.2 2005/05/27 15:11:33 dsantos Exp $<br>
$OpenBSD: shortcuts.html,v 1.2 2005/05/30 13:52:07 saad Exp $ 
</small>

</body>
</html>
