<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Marcação de Pacotes (Filtragem por Política)</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003-2007 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../pt/index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="pools.html">Anterior: Grupos de Endereços e
Balanceamento de Carga</a>]
[<a href="index.html">Conteúdo</a>]
[<a href="logging.html">Próximo: Registro de Dados</a>]

<p>
<h1><font color="#e00000">PF: Marcação de Pacotes (Filtragem por Política)</font></h1>

<hr>

<h3>Conteúdo</h3>
<ul>
<li><a href="#intro">Introdução</a>
<li><a href="#assign">Atribuição de Etiquetas a Pacotes</a>
<li><a href="#check">Verificação de Etiquetas Aplicadas</a>
<li><a href="#policy">Filtragem por Política</a>
<li><a href="#ethernet">Marcação de Quadros Ethernet</a>
</ul>

<hr>

<a name="intro"></a>
<h2>Introdução</h2>
Marcação de pacotes é uma forma de colocar um identificador interno
que pode ser usado mais tarde como critério em regras de filtragem ou
tradução. Com a marcação é possível fazer coisas como criar
"relações de confiança" entre interfaces e determinar se pacotes
foram processados por regras de tradução.
Também é possível sair do esquema de filtragem baseado em regras e
partir para a filtragem baseada em política.

<a name="assign"></a>
<h2>Atribuição de Etiquetas a Pacotes</h2>
Para adicionar uma etiqueta a um pacote, use a
palavra-chave <tt>tag</tt>:
<blockquote>
<tt>
pass in on $int_if all tag INTERNAL_NET keep state
</tt>
</blockquote>

<p>
A etiqueta <tt>INTERNAL_NET</tt> será adicionada a qualquer pacote que
corresponda à regra acima.

<p>
Uma etiqueta também pode ser atribuída usando-se uma
<a href="macros.html#macros">macro</a>.
Por exemplo:

<blockquote>
<tt>
name = "INTERNAL_NET"<br>
pass in on $int_if all tag $name keep state
</tt>
</blockquote>

<p>
Existe um conjunto de macros predefinidas que também podem ser usadas.
<ul>
<li><tt>$if</tt> - A interface
<li><tt>$srcaddr</tt> - Endereço IP de origem
<li><tt>$dstaddr</tt> - Endereço IP de destino
<li><tt>$srcport</tt> - A especificação da porta de origem
<li><tt>$dstport</tt> - A especificação da porta de destino
<li><tt>$proto</tt> - O protocolo
<li><tt>$nr</tt> - O número da regra
</ul>

<p>
Essas macros são expandidas em tempo de carregamento do
conjunto de regras, e NÃO em tempo de execução.

<p>
A marcação segue as seguintes regras:
<ul>
<li>Etiquetas são "fixas". Uma vez marcado por uma regra, a etiqueta no
    pacote não pode ser removida. Ela pode, contudo, ser substituída por
    uma etiqueta diferente.
<li>Por causa da "fixação" da etiqueta, um pacote pode ter uma etiqueta
    mesmo se a última regra correspondente não utilizar a
    palavra-chave <tt>tag</tt>.
<li>Um pacote pode ter no máximo uma etiqueta por vez.
<li>Etiquetas são identificadores <i>internos</i>. Etiquetas não são
    enviadas para outras máquinas.
<li>O nome de uma etiqueta pode ter no máximo 63 caracteres.
    No OpenBSD 4.0 e versões anteriores, os nomes de etiquetas eram
    limitados a 15 caracteres.
</ul>

<p>
Tomemos o seguinte conjunto de regras como exemplo.
<blockquote>
<tt>
(1) pass in on $int_if tag INT_NET keep state<br>
(2) pass in quick on $int_if proto tcp to port 80 tag \<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INT_NET_HTTP keep state<br>
(3) pass in quick on $int_if from 192.168.1.5 keep state
</tt>
</blockquote>

<p>
<ul>
<li>Pacotes vindo pela interface <tt>$int_if</tt> serão marcados
    com <tt>INT_NET</tt> pela regra #1.
<li>Pacotes TCP vindo pela interface <tt>$int_if</tt> e com
    destino a porta 80 serão primeiro marcados com
    <tt>INT_NET</tt> pela regra #1. Essa etiqueta é então
    substituída por <tt>INT_NET_HTTP</tt> pela regra #2.
<li>Pacotes vindo pela interface <tt>$int_if</tt> do IP
    192.168.1.5 serão marcados de duas formas.
    Se o pacote foi destinado à porta TCP 80, ele corresponde à regra #2
    e será marcado com <tt>INT_NET_HTTP</tt>.
    Caso contrário o pacote corresponde à regra #3 e será
    marcado com <tt>INT_NET</tt>.
    Como o pacote corresponde à regra #1, a etiqueta <tt>INT_NET</tt> é
    aplicada e não é removida até que uma regra subsequente
    correspondente especifique uma etiqueta (essa é a "fixação" de uma
    etiqueta).
</ul>

<p>
Além de aplicar etiquetas com regras de filtragem,
as regras de <tt>nat</tt>, <tt>rdr</tt> e <tt>binat</tt> também
podem aplicar etiquetas em pacotes utilizando a
palavra-chave <tt>tag</tt>.

<a name="check"></a>
<h2>Verificação de Etiquetas Aplicadas</h2>
Para verificar por etiquetas aplicadas previamente, utilize a
palavra-chave <tt>tagged</tt>:
<blockquote>
<tt>
pass out on $ext_if tagged INT_NET keep state
</tt>
</blockquote>

<p>
Pacotes saindo pela interface <tt>$ext_if</tt> devem estar marcados com
a etiqueta <tt>INT_NET</tt> para corresponder à regra acima.
O inverso também pode ser feito utilizando o operador <tt>!</tt>
para corresponder a pacotes que não estiverem marcados.
<blockquote>
<tt>
pass out on $ext_if ! tagged WIFI_NET keep state
</tt>
</blockquote>

<p>
Regras de tradução (<tt>nat</tt>/<tt>rdr</tt>/<tt>binat</tt>) também
podem usar a palavra-chave <tt>tagged</tt> para corresponder a pacotes.

<a name="policy"></a>
<h2>Filtragem por Política</h2>
Filtragem por política é uma forma diferente de se escrever um
conjunto de regras de filtragem.
Uma política é definida, a qual configura as regras para quais
tipos de tráfego são permitidos e quais tipos são bloqueados.
Os pacotes são então classificados, baseando-se no critério tradicional
de endereço IP/porta de origem/destino, protocolo, etc.
Por exemplo, veja a seguinte política de firewall:
<ul>
<li>Tráfego vindo da LAN interna para a Internet é
    permitido (LAN_INET) e deve ser traduzido (LAN_INET_NAT)
<li>Tráfego vindo da LAN interna para DMZ é permitido
    (LAN_DMZ)
<li>Tráfego vindo da Internet para os servidores na DMZ é
    permitido (INET_DMZ)
<li>Tráfego vindo da Internet e que está sendo redirecionado para o
    <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=spamd&amp;sektion=8"
    >spamd(8)</a> é permitido (SPAMD)
<li>Qualquer outro tipo de tráfego é bloqueado
</ul>

<p>
Perceba a forma como a política cobre <i>todo</i> o tráfego que passa
pelo firewall.
A palavra entre parêntesis indica qual etiqueta será usada para cada
item na política.

<p>
Agora devem ser definidas regras de filtragem e tradução para
classificar os pacotes na política.
<blockquote>
<tt>
rdr on $ext_if proto tcp from &lt;spamd&gt; to port smtp \<br>
&nbsp;&nbsp;&nbsp;tag SPAMD -&gt; 127.0.0.1 port 8025<br>
nat on $ext_if tag LAN_INET_NAT tagged LAN_INET -&gt; ($ext_if)<br>
<br>
block all<br>
pass in on $int_if from $int_net tag LAN_INET keep state<br>
pass in on $int_if from $int_net to $dmz_net tag LAN_DMZ keep state<br>
pass in on $ext_if proto tcp to $www_server port 80 tag INET_DMZ keep state
</tt>
</blockquote>

<p>
Agora as regras que definem a política são configuradas.
<blockquote>
<tt>
pass in &nbsp;quick on $ext_if tagged SPAMD keep state<br>
pass out quick on $ext_if tagged LAN_INET_NAT keep state<br>
pass out quick on $dmz_if tagged LAN_DMZ keep state<br>
pass out quick on $dmz_if tagged INET_DMZ keep state
</tt>
</blockquote>

<p>
Agora que todo o conjunto de regras está pronto, fazer alterações no
firewall é uma questão de modificar as regras de classificação de
pacotes.
Por exemplo, se for adicionado um servidor POP3/SMTP na DMZ, será
necessário adicionar regras de classificação para tráfego
POP3 e SMTP, desta forma:
<blockquote>
<tt>
mail_server = "192.168.0.10"<br>
...<br>
pass in on $ext_if proto tcp to $mail_server port { smtp, pop3 } \<br>
&nbsp;&nbsp;&nbsp;tag INET_DMZ keep state
</tt>
</blockquote>

<p>
Tráfego de correio eletrônico será aceito como parte da entrada de
política INET_DMZ.

<p>
O conjunto de regras completo:
<table border="0" width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
# Macros
int_if  = "dc0"
dmz_if  = "dc1"
ext_if  = "ep0"
int_net = "10.0.0.0/24"
dmz_net = "192.168.0.0/24"
www_server = "192.168.0.5"
mail_server = "192.168.0.10"

table &lt;spamd&gt; persist file "/etc/spammers"

# Classificação -- classifica pacotes com base na política
# do firewall.
rdr on $ext_if proto tcp from &lt;spamd&gt; to port smtp \
    tag SPAMD -&gt; 127.0.0.1 port 8025
nat on $ext_if tag LAN_INET_NAT tagged LAN_INET -&gt; ($ext_if)

block all
pass in on $int_if from $int_net tag LAN_INET keep state
pass in on $int_if from $int_net to $dmz_net tag LAN_DMZ keep state
pass in on $ext_if proto tcp to $www_server port 80 tag INET_DMZ keep state
pass in on $ext_if proto tcp to $mail_server port { smtp, pop3 } \
    tag INET_DMZ keep state

# Aplicação da política -- permite/bloqueia com base na política
# do firewall.
pass in  quick on $ext_if tagged SPAMD keep state
pass out quick on $ext_if tagged LAN_INET_NAT keep state
pass out quick on $dmz_if tagged LAN_DMZ keep state
pass out quick on $dmz_if tagged INET_DMZ keep state
</pre>
</td></tr>
</table>

<a name="ethernet"></a>
<h2>Marcação de Quadros Ethernet</h2>
A marcação pode ser feita a nível Ethernet caso a máquina que realiza
marcação/filtragem esteja também agindo como
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=bridge&amp;sektion=4"
>bridge(4)</a>.
Ao criar regras de filtragem de bridge(4) que usem a palavra-chave
<tt>tag</tt>, o PF pode filtrar com base no endereço MAC de origem ou
destino. Regras bridge(4) são criadas usando o comando
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=brconfig&amp;sektion=8"
>brconfig(8)</a>. Exemplo:
<blockquote>
<tt>
# brconfig bridge0 rule pass in on fxp0 src 0:de:ad:be:ef:0 \<br>
&nbsp;&nbsp;&nbsp;tag USER1
</tt>
</blockquote>

<p>
E então no <tt>pf.conf</tt>:
<blockquote>
<tt>
pass in on fxp0 tagged USER1
</tt>
</blockquote>

<p>
[<a href="pools.html">Anterior: Grupos de Endereços e
Balanceamento de Carga</a>]
[<a href="index.html">Conteúdo</a>]
[<a href="logging.html">Próximo: Registro de Dados</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[voltar]"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: tagging.html,v 1.18 ]<br>
$Translation: tagging.html,v 1.13 2009/10/13 19:12:28 alan Exp $<br>
-->
$OpenBSD: tagging.html,v 1.13 2009/10/17 15:58:26 ajacoutot Exp $
</small>

</body>
</html>
