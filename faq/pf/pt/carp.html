<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Redundância de Firewall com CARP e pfsync</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf,carp,pfsync">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2005-2007 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../pt/index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="authpf.html">Anterior: Shell de Usuário para
Gateways de Autenticação</a>]
[<a href="index.html">Conteúdo</a>]
[<a href="example1.html">Próximo: Firewall para Casa ou Pequeno Escritório</a>]

<p>
<h1><font color="#e00000">PF: Redundância de Firewall com CARP
e pfsync</font></h1>

<hr>

<h3>Conteúdo</h3>
<ul>
<li><a href="#carpintro">Introdução ao CARP</a>
<li><a href="#carpop">Funcionamento do CARP</a>
<li><a href="#carpconfig">Configuração do CARP</a>
<li><a href="#carpex">Exemplo de configuração do CARP</a>
<li><a href="#pfsyncintro">Introdução ao pfsync</a>
<li><a href="#pfsyncop">Funcionamento do pfsync</a>
<li><a href="#pfsyncconfig">Configuração do pfsync</a>
<li><a href="#pfsyncex">Exemplo de configuração do pfsync</a>
<li><a href="#failover">Combinando CARP e pfsync para "Failover" e
    Redundância</a>
<li><a href="#ops">Problemas Operacionais</a>
	<ul>
	<li><a href="#bootconfig">Configuração do CARP e pfsync Durante
            a Inicialização</a>
	<li><a href="#forcefail">Forçando "Failover" do Mestre</a>
	<li><a href="#RulesetTips">Dicas de Conjunto de Regras</a>
	</ul>
<li><a href="#ref">Outras Referências</a>
</ul>

<hr>

<a name="carpintro"></a>
<h2>Introdução ao CARP</h2>
CARP é o Protocolo de Redundância de Endereço Comum
("Common Address Redundancy Protocol").
Seu objetivo principal é permitir que múltiplas máquinas no mesmo
segmento de rede compartilhem um endereço IP.
CARP é uma alternativa livre e segura ao
<a href="http://www.ietf.org/rfc/rfc3768.txt">Protocolo de Redundância de Roteador Virtual</a>
(VRRP - "Virtual Router Redundancy Protocol")
e ao
<a href="http://www.ietf.org/rfc/rfc2281.txt">Protocolo de Roteador de Espera a Quente</a>
(HSRP - "Hot Standby Router Protocol").

<p>
CARP funciona permitindo a um grupo de máquinas no mesmo
segmento de rede compartilhar um endereço IP.
Esse grupo de máquinas é referido como um "grupo de redundância".
Ao grupo de redundância é atribuído um endereço IP que é compartilhado
entre os membros do grupo.
Dentro do grupo, uma máquina é designada como "mestre" e o resto como
"backups".
A máquina mestre é a que atualmente "segura" o IP compartilhado; ela
responde a qualquer tráfego ou requisições ARP direcionadas a ele.
Cada máquina pode pertencer a mais de um grupo de redundância por vez.

<p>
Um uso comum para o CARP é criar um grupo de firewalls redundantes.
O IP virtual que é atribuído ao grupo de redundância é configurado nas
máquinas clientes como o gateway padrão.
Caso o firewall mestre sofra uma falha ou seja desligado, o IP se moverá
para um dos firewalls backup e o serviço vai continuar sem ser afetado.

<p>
CARP suporta IPv4 e IPv6.


<a name="carpop"></a>
<h2>Funcionamento do CARP</h2>
A máquina mestre no grupo envia regularmente anúncios à rede local,
assim as máquinas backup sabem que ela ainda está ativa.
Se as máquinas backup não ouvirem um anúncio do mestre por um período de
tempo, então uma delas tomará conta dos deveres do mestre (qualquer
máquina backup com os valores mais baixos definidos para
<tt>advbase</tt> e <tt>advskew</tt>).

<p>
É possível que múltiplos grupos CARP existam no mesmo segmento de rede.
Anúncios CARP contêm o ID de Máquina Virtual (VHID - "Virtual Host ID")
que permite aos membros do grupo identificar a que grupo de redundância
pertencem.

<p>
Para prevenir que um usuário malicioso no segmento de rede falsifique
anúncios CARP, cada grupo pode ser configurado com uma senha.
Cada pacote CARP enviado ao grupo é então protegido por um HMAC SHA1.

<p>
Como o CARP é seu próprio protocolo, ele deve ter uma regra de permissão
explícita no conjunto de regras de filtragem:

<blockquote>
<tt>
pass out on $carp_dev proto carp keep state
</tt>
</blockquote>

<p>
<tt>$carp_dev</tt> deve ser a interface física por onde o CARP se
comunica.


<a name="carpconfig"></a>
<h2>Configuração do CARP</h2>
Cada grupo de redundância é representado por uma interface
de rede virtual
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=carp&amp;sektion=4&amp;manpath=OpenBSD+5.3"
>carp(4)</a>. Assim o CARP é configurado usando o
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ifconfig&amp;sektion=8"
>ifconfig(8)</a>.

<blockquote>
<tt>
ifconfig <i>carpN</i> create<br>
<br>
ifconfig <i>carpN</i> vhid <i>vhid</i> [pass <i>senha</i>]
[carpdev <i>carpdev</i>] \<br>
&nbsp;&nbsp;&nbsp;[advbase <i>advbase</i>] [advskew <i>advskew</i>]
[state <i>estado</i>] [group|-group <i>grupo</i>] \<br>
&nbsp;&nbsp;&nbsp;<i>endereço_ip</i> netmask <i>máscara</i>
</tt>
</blockquote>
<!-- XXX someone who understands carpnodes should add a piece -->

<dl>
<dt><tt><i>carpN</i></tt>
<dd>O nome da interface virtual carp(4), onde <i>N</i> é um número
inteiro que representa o número da interface (por exemplo, carp10).

<dt><tt><i>vhid</i></tt>
<dd>O ID de Host Virtual. Esse é um número único que é usado para
identificar o grupo de redundância aos outros nós no grupo e 
distingui-lo entre grupos numa mesma rede. 
Valores aceitos são de 1 a 255.
Este valor deve ser o mesmo para todos os hosts percentes ao grupo.

<dt><tt><i>senha</i></tt>
<dd>A senha de autenticação a usar quando estiver conversando com
outras máquinas CARP nesse grupo de redundância.
Deve ser a mesma para todos os membros do grupo.

<dt><tt><i>carpdev</i></tt>
<dd>Esse parâmetro opcional especifica a interface de rede física
que pertence a esse grupo de redundância.
Por padrão, o CARP tenta determinar qual interface usar procurando
pela interface física que está na mesma sub-rede da combinação
<i>endereço_ip</i> e <i>máscara</i> dada à interface carp(4).

<dt><tt><i>advbase</i></tt>
<dd>Esse parâmetro opcional especifica com que frequência, em segundos,
anunciar que somos um membro do grupo de redundância.
O padrão é 1 segundo.
Valores aceitos são de 1 a 255.

<dt><tt><i>advskew</i></tt>
<dd>Esse parâmetro opcional especifica o quanto desviar o
<tt><i>advbase</i></tt> ao enviar anúncios CARP.
Ao manipular o <tt><i>advskew</i></tt>, a máquina CARP mestre pode ser
escolhida. Quanto mais alto o número, <i>menos</i> preferida
será a máquina durante a escolha do mestre.
O padrão é 0.
Valores aceitos são de 0 a 254.

<dt><tt><i>estado</i></tt>
<dd>Força uma interface carp(4) em um certo estado. Estados válidos são
<tt>init</tt>, <tt>backup</tt> e <tt>master</tt>.

<dt><tt><i>grupo</i></tt>
<dd>Adiciona ou remove uma interface carp(4) a um determinado grupo. 
Por padrão, todas as interfaces carp(4) são adicionadas ao grupo 
<tt>carp</tt>. Cada grupo tem um contador <tt>carpdemote</tt> 
englobando todas as interfaces daquele grupo. Como descrito 
<a href="#demote">abaixo</a>, isso pode ser útil para agrupar 
determinadas interfaces juntas com propósito de utilizar failover.

<dt><tt><i>endereço_ip</i></tt>
<dd>Esse é o endereço IP compartilhado atribuído ao
grupo de redundância.
Esse endereço não tem que estar na mesma sub-rede que o endereço IP na
interface física (se presente).
Esse endereço, contudo, precisa ser o mesmo em todas as máquinas no
grupo.

<dt><tt><i>máscara</i></tt>
<dd>A máscara de sub-rede do IP compartilhado.
</dl>

<p>
Além disso, o comportamento do CARP pode ser controlado via
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&amp;sektion=8"
>sysctl(8)</a>.

<dl>
<dt><tt>net.inet.carp.allow</tt>
<dd>Aceita ou não a entrada de pacotes CARP. O padrão é 1 (sim).

<dt><tt>net.inet.carp.preempt</tt>
<dd>Permite à máquinas dentro de um grupo de redundância que tenham
melhores <tt>advbase</tt> e <tt>advskew</tt> tomarem o lugar do mestre.
Adicionalmente, essa opção habilita "failing over" em um grupo de 
interfaces caso uma das interfaces venha a entrar em estado de shutdown.
Se uma interface física CARP cair, o CARP incrementa o contador 
(<tt>carpdemote</tt>) nos grupos cuja interface física faz parte em 1,
fazendo com que todas as outras interfaces possam assumir o failover juntas.
Por padrão, <tt>net.inet.carp.preempt</tt> é 0 (desabilitada).

<dt><tt>net.inet.carp.log</tt>
<dd>Registra mudanças de estado, pacotes mal formados e outros erros.
O valor pode variar de 0 até 7, de acordo com propriedades do syslog(3).
Por padrão, o valor usado é 2 (registra apenas mudanças de estado).
</dl>


<a name="carpex"></a>
<h2>Exemplo de configuração do CARP</h2>
Este é um exemplo de configuração do CARP.

<blockquote>
<tt>
# sysctl -w net.inet.carp.allow=1<br>
# ifconfig carp1 create<br>
# ifconfig carp1 vhid 1 pass mekmitasdigoat carpdev em0 \<br>
&nbsp;&nbsp;&nbsp;&nbsp;advskew 100 10.0.0.1 netmask 255.255.255.0<br>
</tt>
</blockquote>

<p>
Isso configura o seguinte:
<ul>
<li>Habilita a recepção de pacotes CARP (essa é a configuração
    padrão).
<li>Cria uma interface carp(4), <tt>carp1</tt>.
<li>Configura <tt>carp1</tt> para a máquina virtual número 1, habilita
    uma senha, define <tt>em0</tt> como a interface pertencente ao
    grupo, e faz dessa máquina uma máquina backup devido ao
    <tt>advskew</tt> de <tt>100</tt>
    (assumindo, é claro, que a máquina mestre seja configurada com um
    <tt>advskew</tt> menor do que 100).
    O IP compartilhado atribuído a esse grupo é 10.0.0.1/255.255.255.0.
</ul>

<p>
Executar o <tt>ifconfig</tt> na <tt>carp1</tt> mostra o status da
interface.

<blockquote>
<tt>
# ifconfig carp1<br>
carp1: flags=8802&lt;UP,BROADCAST,SIMPLEX,MULTICAST&gt; mtu 1500<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;carp: BACKUP carpdev em0 vhid 1 advbase 1
advskew 100<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;groups: carp<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inet 10.0.0.1 netmask 0xffffff00 broadcast
10.0.0.255
</tt>
</blockquote>


<a name="pfsyncintro"></a>
<h2>Introdução ao pfsync</h2>
A interface de rede
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfsync&amp;sektion=4&amp;manpath=OpenBSD+5.3"
>pfsync(4)</a> expõe certas alterações feitas na tabela de estados do
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4&amp;manpath=OpenBSD+5.3"
>pf(4)</a>.
Ao monitorar esse dispositivo usando o
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcpdump&amp;sektion=8"
>tcpdump(8)</a>, alterações na tabela de estados podem ser observadas
em tempo real.
Além disso, a interface pfsync(4) pode enviar essas mensagens de
alterações de estados para a rede, de modo que outros nós executando o
PF possam mesclar as alterações em suas próprias tabelas de estados.
Da mesma forma, o pfsync(4) também pode ouvir a rede por mensagens
que chegam.


<a name="pfsyncop"></a>
<h2>Funcionamento do pfsync</h2>
Por padrão, o pfsync(4) não envia ou recebe atualizações da
tabela de estados na rede; entretanto, atualizações ainda podem ser
monitoradas usando o tcpdump(8) ou outras ferramentas na máquina local.

<p>
Quando o pfsync(4) está configurado para enviar e receber
atualizações na rede, o comportamento padrão é enviar atualizações
"multicast" na rede local.
Todas as atualizações são enviadas sem autenticação.
A prática mais comum é:

<ol>
<li>Conectar os dois nós que trocarão atualizações com um
    cabo cruzado e usar a interface como o <tt>syncdev</tt>
    (veja <a href="#pfsyncconfig">abaixo</a>).
<li>Usar a opção <tt>syncpeer</tt> do ifconfig(8) (veja
    <a href="#pfsyncconfig">abaixo</a>), assim as atualizações são
    direcionadas com "unicast" para o nó, e então configurar o
    <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsec&amp;sektion=4"
    >ipsec(4)</a> entre as máquinas para proteger o tráfego pfsync(4).
</ol>

<p>
Quando as atualizações estão sendo enviadas e recebidas na rede, os
pacotes pfsync devem ser aceitos no conjunto de regras de filtragem.

<blockquote>
<tt>
pass on $sync_if proto pfsync
</tt>
</blockquote>

<p>
<tt>$sync_if</tt> deve ser a interface física por onde o pfsync(4) se
comunica.


<a name="pfsyncconfig"></a>
<h2>Configuração do pfsync</h2>
Visto que pfsync(4) é uma interface de rede virtual, ela é configurada
usando o
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ifconfig&amp;sektion=8"
>ifconfig(8)</a>.

<blockquote>
<tt>
ifconfig <i>pfsyncN</i> syncdev <i>syncdev</i> [syncpeer
<i>syncpeer</i>] [defer|-defer]
</tt>
</blockquote>

<dl>
<dt><tt><i>pfsyncN</i></tt>
<dd>O nome da interface pfsync(4). A <tt>pfsync0</tt> existe
por padrão quando estiver usando o kernel <tt>GENERIC</tt>.

<dt><tt><i>syncdev</i></tt>
<dd>O nome da interface física usada para enviar atualizações pfsync.

<dt><tt><i>syncpeer</i></tt>
<dd>Esse parâmetro opcional especifica o endereço IP de uma máquina para
trocar atualizações pfsync.
Por padrão as atualizações pfsync são "multicast" na rede local.
Essa opção cancela esse comportamento e, em vez disso, envia
atualizações "unicasts" para o <tt><i>syncpeer</i></tt> especificado.

<dt><tt><i>defer</i></tt>
<dd>Se a flag de <tt>defer</tt> for usada, o pacote inicial de uma nova
conexão que passe através da firewall não será transmitido
até que outro sistema com pfsync(4) reconheça sua adição na 
tabela de estados ou o tempo limite expire.
Isto adiciona pequenos atrasos, mas permite ao tráfego fluir quando mais de
um firewall pode estar, ativamente, manipulando pacotes ("ativo/ativo").
Por exemplo, em certos cenários e configurações com ospfd(8), bgpd(8) ou carp(4).

</dl>


<a name="pfsyncex"></a>
<h2>Exemplo de configuração do pfsync</h2>
Este é um exemplo de configuração do pfsync.

<blockquote>
<tt>
# ifconfig pfsync0 syncdev em1 up<br>
</tt>
</blockquote>

Isso habilita o pfsync na interface <tt>em1</tt>.
As atualizações enviadas serão "multicast" na rede, permitindo que
qualquer outra máquina executando o pfsync possa recebê-las.


<a name="failover"></a>
<h2>Combinando CARP e pfsync Para Failover</h2>
Ao combinar os recursos do CARP e do pfsync, um grupo de dois ou
mais firewalls pode ser usado para criar um cluster de firewalls
completamente redundante e de alta disponibilidade.

<dl>
<dt>CARP:
<dd>Trata o failover automático de um firewall para outro.

<dt>pfsync:
<dd>Sincroniza a tabela de estados entre todos os firewalls.
Caso aconteça um failover, o tráfego pode fluir ininterrupto
através do novo firewall mestre.
</dl>

<p>
Um cenário de exemplo.
Dois firewalls, <tt>fw1</tt> e <tt>fw2</tt>.

<pre>
         +----| WAN/Internet |----+
         |                        |
      em2|                        |em2
      +-----+                  +-----+
      | fw1 |-em1----------em1-| fw2 |
      +-----+                  +-----+
      em0|                        |em0
         |                        |
      ---+----LAN Compartilhada---+---
</pre>

<p>
Os firewalls estão conectados diretamente com um cabo cruzado
em <tt>em1</tt>.
Ambos estão conectados à LAN em <tt>em0</tt> e a uma conexão
WAN/Internet em <tt>em2</tt>.
Os endereços IP são os seguintes:

<ul>
<li>fw1 em0: 172.16.0.1
<li>fw1 em1: 10.10.10.1
<li>fw1 em2: 192.0.2.1
<li>fw2 em0: 172.16.0.2
<li>fw2 em1: 10.10.10.2
<li>fw2 em2: 192.0.2.2
<li>IP compartilhado da LAN: 172.16.0.100
<li>IP compartilhado da WAN/Internet: 192.0.2.100
</ul>

<p>
A política de rede é que <tt>fw1</tt> será o mestre preferido.

<p>
Configuração do fw1:

<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
! Habilita a função de tomar o lugar e o failover de interface de grupo
# sysctl -w net.inet.carp.preempt=1

! Configura o pfsync
# ifconfig em1 10.10.10.1 netmask 255.255.255.0
# ifconfig pfsync0 syncdev em1
# ifconfig pfsync0 up

! Configura o CARP no lado LAN
# ifconfig carp1 create
# ifconfig carp1 vhid 1 carpdev em0 pass lanpasswd \
     172.16.0.100 netmask 255.255.255.0

! Configura o CARP no lado WAN/Internet
# ifconfig carp2 create
# ifconfig carp2 vhid 2 carpdev em2 pass netpasswd \
    192.0.2.100 netmask 255.255.255.0
</pre>
</td></tr>
</table>

<p>
Configuração do fw2:

<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
! Habilita a função de tomar o lugar e o failover de interface de grupo
# sysctl -w net.inet.carp.preempt=1

! Configura o pfsync
# ifconfig em1 10.10.10.2 netmask 255.255.255.0
# ifconfig pfsync0 syncdev em1
# ifconfig pfsync0 up

! Configura o CARP no lado LAN
# ifconfig carp1 create
# ifconfig carp1 vhid 1 carpdev em0 pass lanpasswd \
     advskew 128 172.16.0.100 netmask 255.255.255.0

! Configura o CARP no lado WAN/Internet
# ifconfig carp2 create
# ifconfig carp2 vhid 2 carpdev em2 pass netpasswd \
    advskew 128 192.0.2.100 netmask 255.255.255.0
</pre>
</td></tr>
</table>


<a name="ops"></a>
<h2>Problemas Operacionais</h2>
Alguns problemas operacionais comuns encontrados com CARP/pfsync.

<a name="bootconfig"></a>
<h3>Configuração do CARP e pfsync Durante a Inicialização</h3>
Visto que carp(4) e pfsync(4) são ambos tipos de interfaces de rede,
elas podem ser configuradas durante a inicialização criando-se um
arquivo
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=hostname.if&amp;sektion=5"
>hostname.if(5)</a>.
O script de inicialização
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=netstart&amp;sektion=8"
>netstart</a> cuidará de criar as interfaces e configurá-las.

<p>
Exemplos:

<dl>
<dt>/etc/hostname.carp1</dt>
<dd>
inet 172.16.0.100 255.255.255.0 172.16.0.255 vhid 1 carpdev em0 \<br>
&nbsp;&nbsp;&nbsp;&nbsp;pass lanpasswd
</dd>
</dl>

<dl>
<dt>/etc/hostname.pfsync0</dt>
<dd>
up syncdev em1
</dd>
</dl>

<a name="forcefail"></a>
<h3>Forçando "Failover" do Mestre</h3>
De tempos em tempos é necessário fazer o "failover" ou derrubar o nó
mestre de propósito.
Exemplos incluem derrubar o nó mestre para manutenção ou quando estiver
resolvendo um problema.
O objetivo aqui é elegantemente passar ("fail over") o tráfego para uma
das máquinas backups de modo que os usuários não observem nenhum
impacto.

<p>
Para failover de um grupo CARP em particular, derrube a interface
carp(4) no nó mestre.
Isso faz com que o mestre anuncie a si mesmo com um
<tt>advbase</tt> e <tt>advskew</tt> "infinito".
A(s) máquina(s) backup vê(eem) isso e imediatamente toma(m) o
lugar da máquina mestre.

<blockquote>
<tt>
# ifconfig carp1 down
</tt>
</blockquote>

<p>
Uma alternativa é aumentar o <tt>advskew</tt> para um valor mais alto
que o <tt>advskew</tt> na(s) máquina(s) backup.
Isso causa um failover, mas ainda permite ao mestre participar
no grupo CARP.


<a name="demote"></a>
<p>
Um outro método para failover é ajustar o contador demotion do CARP.
O contador demotion é uma medida de como "pronta" uma máquina
está para se tornar o mestre do grupo CARP.
Por exemplo, enquanto uma máquina está no meio do processo de
inicialização é uma má ideia para ela tornar-se um mestre CARP até que
todas as interfaces estejam configuradas, todos os serviços de rede
estejam iniciados, etc.
Máquinas anunciando um valor demotion alto terão menos preferência como
mestre.

<p>
Um contador demotion é armazenado em cada grupo de interfaces que a
interface CARP pertence.
Por padrão, todas as interfaces CARP são membros do grupo de interfaces
"carp".
O valor atual de um contador demotion pode ser visto usando o
ifconfig(8):

<blockquote>
<tt>
# ifconfig -g carp<br>
carp: carp demote count 0
</tt>
</blockquote>

<p>
Nesse exemplo o contador associado com o grupo de interface "carp"
é mostrado.
Quando uma máquina CARP anuncia a si mesma na rede, ela pega a soma dos
contadores demotion para cada grupo de interfaces que a interface
carp(4) pertence e anuncia esse valor como seu valor demotion.

<p>
Agora assuma o seguinte exemplo.
Dois firewalls executando CARP com as seguintes interfaces CARP:

<ul>
<li>carp1 -- Departamento de Contabilidade
<li>carp2 -- Empregados Comuns
<li>carp3 -- Internet
<li>carp4 -- DMZ
</ul>

<p>
O objetivo é apenas fazer failover dos grupos carp1 e carp2 para
o firewall secundário.

<p>
Primeiro, associe cada grupo a um novo grupo de interfaces, neste caso
nomeado como "internal":

<blockquote>
<tt>
# ifconfig carp1 group internal<br>
# ifconfig carp2 group internal<br>
# ifconfig internal<br>
carp1: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; mtu 1500<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;carp: MASTER carpdev em0 vhid 1 advbase 1
advskew 100<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;groups: carp internal<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inet 10.0.0.1 netmask 0xffffff00 broadcast
10.0.0.255<br>
carp2: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; mtu 1500<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;carp: MASTER carpdev em1 vhid 2 advbase 1
advskew 100<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;groups: carp internal<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inet 10.0.1.1 netmask 0xffffff00 broadcast
10.0.1.255
</tt>
</blockquote>

<p>
Agora aumente o contador demotion para o grupo "internal" usando o
ifconfig(8):

<blockquote>
<tt>
# ifconfig -g internal<br>
internal: carp demote count 0<br>
# ifconfig -g internal carpdemote 50<br>
# ifconfig -g internal<br>
internal: carp demote count 50<br>
</tt>
</blockquote>

<p>
O firewall agora faz elegantemente o failover nos grupos carp1 e carp2
para o outro firewall no cluster, enquanto ainda se mantém como mestre
nos grupos carp3 e carp4.
Se o outro firewall começar a anunciar um valor demotion maior
do que 50 ou se parar de anunciar completamente, então esse firewall
tomaria novamente a liderança do mestre nos grupos carp1 e carp2.

<p>
Para voltar (fail back) para o firewall primário, reverta as mudanças:

<blockquote>
<tt>
# ifconfig -g internal -carpdemote 50<br>
# ifconfig -g internal<br>
internal: carp demote count 0<br>
</tt>
</blockquote>

<p>
Daemons de rede como
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=bgpd&amp;sektion=8"
>OpenBGPD</a> e
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sasyncd&amp;sektion=8"
>sasyncd(8)</a>
fazem uso do contador demotion para garantir que o firewall não
se torne mestre até que as sessões BGP estejam estabelecidas e SAs
IPsec estejam sincronizados.

<a name="RulesetTips"></a>
<h3>Dicas de Conjunto de Regras</h3>
<b>Filtre a interface física.</b>
Até o ponto que o PF está preocupado, o tráfego da rede vem da
interface física, não da interface virtual CARP (ou seja,
<tt>carp0</tt>).
Assim, escreva seu conjunto de regras de acordo.
Não se esqueça de que um nome de interface em uma regra do PF pode
ser tanto o nome da interface física ou um endereço associado a
essa interface. Por exemplo, esta regra pode estar correta:
<blockquote><tt>
pass in on fxp0 inet proto tcp from any to carp0 port 22
</tt></blockquote>
mas substituir o <tt>fxp0</tt> por <tt>carp0</tt> não
funcionaria como você deseja.

<p>
<b>NÃO se esqueça</b> de uma regra de permissão de tráfego para
<tt>proto carp</tt> e <tt>proto pfsync</tt>!

<p>

<a name="ref"></a>
<h2>Outras Referências</h2>
Por favor veja estas outras fontes para obter mais informações:

<ul>
<li>
    <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=carp&amp;sektion=4&amp;manpath=OpenBSD+5.3"
    >carp(4)</a>
<li>
    <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfsync&amp;sektion=4&amp;manpath=OpenBSD+5.3"
    >pfsync(4)</a>
<li>
    <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ifconfig&amp;sektion=8"
    >ifconfig(8)</a>
<li>
    <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=hostname.if&amp;sektion=5"
    >hostname.if(5)</a>
<li>
    <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf.conf&amp;sektion=5&amp;manpath=OpenBSD+5.3"
    >pf.conf(5)</a>
<li>
    <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ifstated&amp;sektion=8"
    >ifstated(8)</a>
<li>
    <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ifstated.conf&amp;sektion=5"
    >ifstated.conf(5)</a>
</ul>


<p>
[<a href="authpf.html">Anterior: Shell de Usuário para
Gateways de Autenticação</a>]
[<a href="index.html">Conteúdo</a>]
[<a href="example1.html">Próximo: Firewall para Casa ou Pequeno Escritório</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[voltar]"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: carp.html,v 1.34 ]<br>
$Translation: carp.html,v 1.16 2013/05/02 22:48:46 renato Exp $<br>
-->
$OpenBSD: carp.html,v 1.16 2013/05/03 05:53:48 ajacoutot Exp $
</small>

</body>
</html>
