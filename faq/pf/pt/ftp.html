<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Problemas com FTP</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, Nick Holland <nick@openbsd.org>
Copyright (c) 2003, 2004, Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../pt/index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="perf.html">Anterior: Desempenho</a>]
[<a href="index.html">Conteúdo</a>]
[<a href="authpf.html">Próximo: Authpf: Shell de Usuário para Gateways
de Autenticação</a>]

<p>
<h1><font color="#e00000">PF: Problemas com FTP</font></h1>
<hr>

<h3>Conteúdo</h3>
<ul>
<li><a href="#modes">Modos do FTP</a>
<li><a href="#client">Cliente FTP Atrás do Firewall</a>
<li><a href="#server">Servidor FTP Protegido pelo PF</a>
<li><a href="#natserver">Servidor FTP Protegido por um Firewall PF
    Externo Fazendo NAT</a>
<li><a href="#info">Mais Informações sobre FTP</a>
<li><a href="#tftp-proxy">Proxy de TFTP</a>
</ul>

<hr>

<a name="modes"></a>
<h2>Modos do FTP</h2>
FTP é um protocolo que data dos primórdios da Internet, quando esta
era uma pequena e amigável coleção de computadores onde todo mundo
se conhecia. Naquele tempo não havia necessidade de filtragem e altos
requisitos de segurança. O FTP não foi desenvolvido para ser filtrado,
atravessar firewalls, ou trabalhar com NAT.

<p>
Você pode usar o FTP em dois modos: passivo e ativo. Geralmente a
escolha de modo passivo ou ativo é feita para determinar de quem
será o problema com o firewall. Na verdade, você precisa suportar
ambos para deixar seus usuários contentes.

<p>
Com FTP ativo, quando um usuário se conecta ao servidor FTP remoto e
solicita informações ou um arquivo, o servidor FTP abre uma nova
conexão com o cliente para transferir os dados. Essa é a chamada
<i>conexão de dados</i>. Para iniciar, o cliente FTP escolhe uma porta
aleatória para receber a conexão de dados. O cliente envia o número da
porta escolhida para o servidor FTP e fica esperando uma conexão nessa
porta. Então o servidor FTP inicia a conexão com o endereço do cliente
na porta escolhida e transfere os dados.
Isso se torna um problema para usuários atrás de um gateway NAT tentando
se conectar a servidores FTP. Por causa da forma como NAT funciona, o
servidor FTP inicializa a conexão de dados se conectando ao endereço
externo do gateway NAT na porta escolhida.
A máquina fazendo NAT recebe o pedido, mas como não possui mapeamento
para o pacote na tabela de estados, descarta o pacote sem entregá-lo
ao cliente.

<p>
No modo FTP passivo (o modo padrão no cliente
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp&amp;sektion=1"
>ftp(1)</a> do OpenBSD), o cliente pede ao servidor que escolha uma
porta aleatória para ouvir, esperando a conexão de dados. O servidor
informa ao cliente a porta escolhida e o cliente se conecta na porta
para transferir os dados.
Infelizmente, isso nem sempre é possível ou desejável, por causa
da possibilidade do firewall em frente ao servidor FTP bloquear
a conexão de dados. O ftp(1) do OpenBSD usa o modo passivo por padrão;
para forçar o modo ativo, use o sinalizador -A no ftp, ou defina o modo
passivo para "off" usando o comando "<tt>passive off</tt>" no prompt
"<tt>ftp&gt;</tt>".


<a name="client"></a>
<h2>Cliente FTP Atrás do Firewall</h2>
Como explicado anteriormente, o FTP não se dá muito bem com
NAT e firewalls.

<p>
O Packet Filter fornece uma solução para essa situação através do
redirecionamento do tráfego FTP para um servidor proxy de FTP.
Esse processo age como "guia" do tráfego FTP através do
gateway/firewall NAT, adicionando as regras necessárias e removendo-as
do sistema quando não forem mais necessárias através do sistema de
<a href="anchors.html">âncoras</a>.
O proxy de FTP usado pelo PF é o
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+4.5"
>ftp-proxy(8)</a>.

<p>
Para ativá-lo, insira algo assim na seção de NAT do <tt>pf.conf</tt>:

<blockquote>
<tt>
nat-anchor "ftp-proxy/*"<br>
rdr-anchor "ftp-proxy/*"<br>
rdr on $int_if proto tcp from any to any port 21 -&gt; 127.0.0.1 \<br>
&nbsp;&nbsp;&nbsp;port 8021
</tt>
</blockquote>

<p>
As primeiras duas linhas são <a href="anchors.html">âncoras</a>, as
quais são usadas pelo ftp-proxy para adicionar regras em tempo de
execução para gerenciar seu tráfego FTP.
A última linha redireciona o tráfego FTP de seus clientes para o
programa ftp-proxy(8), que está escutando na sua máquina, na porta 8021.

<p>
Você também precisa de uma âncora na seção de regras:

<blockquote>
<tt>
anchor "ftp-proxy/*"
</tt>
</blockquote>

<p>
O servidor proxy tem que ser iniciado e estar em execução na máquina
OpenBSD. Isso é feito inserindo a linha abaixo em
<tt>/etc/rc.conf.local</tt>:

<blockquote>
<tt>
ftpproxy_flags=""
</tt>
</blockquote>

<p>
O programa ftp-proxy pode ser iniciado como root, para ativá-lo sem
precisar reinicializar.

<p>
O ftp-proxy escuta na porta 8021, a mesma porta que a instrução
<tt>rdr</tt> acima está enviando o tráfego FTP.

<p>
Para habilitar conexões de modo ativo, você precisa do comutador '-r' no
ftp-proxy(8) (para isso você tem que executar o proxy antigo com
"-u root").


<a name="server"></a>
<h2>Servidor FTP Protegido pelo PF</h2>
Nesse caso, o PF está em execução no próprio servidor FTP em vez de um
firewall dedicado. Ao servir uma conexão FTP passiva, o FTP usa
uma porta TCP alta e escolhida aleatoriamente para os dados que chegam.
Por padrão, o servidor FTP
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftpd&amp;sektion=8"
>ftpd(8)</a> nativo do OpenBSD utiliza a faixa de portas de
49152 a 65535.
Obviamente, essa faixa de portas deve ter permissão de passar pelas
regras de filtragem, junto com a porta 21 (a porta de controle FTP):

<blockquote>
<tt>
pass in on $ext_if proto tcp from any to any port 21 keep state<br>
pass in on $ext_if proto tcp from any to any port &gt; 49151 \<br>
&nbsp;&nbsp;&nbsp;keep state
</tt>
</blockquote>

<p>
Perceba que se você quiser, pode restringir consideravelmente a faixa de
portas. No caso do programa
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftpd&amp;sektion=8"
>ftpd(8)</a> do OpenBSD, isso é feito utilizando as variáveis do
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&amp;sektion=8"
>sysctl(8)</a> <tt>net.inet.ip.porthifirst</tt> e
<tt>net.inet.ip.porthilast</tt>.

<a name="natserver"></a>
<h2>Servidor FTP Protegido por um Firewall PF Externo Fazendo NAT</h2>
Nesse caso, o firewall deve redirecionar o tráfego para o servidor FTP
além de não bloquear as portas necessárias.
Para conseguir isso, voltamos para o ftp-proxy(8).

<p>
O ftp-proxy(8) pode executar em um modo que faz com que ele redirecione
todas as conexões FTP para um servidor FTP específico.
Basicamente, configuramos o proxy para escutar na porta 21 do firewall
e redirecionamos todas as conexões de volta para o servidor.

<p>
Edite o arquivo <tt>/etc/rc.conf.local</tt> e adicione o seguinte:

<blockquote>
<tt>
ftpproxy_flags="-R 10.10.10.1 -p 21 -b 192.168.0.1"
</tt>
</blockquote>

<p>
Aqui o 10.10.10.1 é o endereço IP do servidor FTP real, 21 é a porta
que queremos que o ftp-proxy(8) escute e 192.168.0.1 é o endereço no
firewall para o proxy.

<p>
Agora para as regras do pf.conf:

<blockquote>
<tt>
ext_ip = "192.168.0.1"<br>
ftp_ip = "10.10.10.1"<br>
<br>
nat-anchor "ftp-proxy/*"<br>
nat on $ext_if inet from $int_if -&gt; ($ext_if)<br>
rdr-anchor "ftp-proxy/*"<br>
<br>
pass in on $ext_if inet proto tcp to $ext_ip port 21 \<br>
&nbsp;&nbsp;&nbsp;&nbsp;flags S/SA keep state<br>
pass out on $int_if inet proto tcp to $ftp_ip port 21 \<br>
&nbsp;&nbsp;&nbsp;&nbsp;user proxy flags S/SA keep state<br>
anchor "ftp-proxy/*"
</tt>
</blockquote>

<p>
Aqui nós permitimos a conexão vindo para a porta 21 na
interface externa, bem como a conexão de saída correspondente para o
servidor FTP.
O "user proxy" na regra de saída garante que apenas as conexões
iniciadas pelo ftp-proxy(8) sejam permitidas.

<p>
Note que se você quer executar o ftp-proxy(8) para proteger um servidor
FTP, bem como permitir que clientes façam FTP para fora do firewall,
duas instâncias do ftp-proxy serão necessárias.


<a name="info"></a>
<h2>Mais Informações sobre FTP</h2>
Mais informações sobre filtragem de tráfego FTP e funcionamento geral
do FTP podem ser encontradas neste documento:
<ul>
<li><a href="http://www.pintday.org/whitepapers/ftp-review.shtml">FTP
    Reviewed</a>
</ul>

<a name="tftp-proxy"></a>
<h2>Proxy de TFTP</h2>

<p>
O Protocolo de Transferência de Arquivos Trivial
(TFTP, "Trivial File Transfer Protocol") sofre algumas das mesmas
limitações que o FTP quando tenta passar através de um firewall.
Felizmente, o PF tem um proxy de TFTP chamado
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+4.5"
>tftp-proxy(8)</a>.

<p>
O tftp-proxy(8) é configurado da mesma forma que o ftp-proxy(8) foi
configurado na seção
<a href="#client">Cliente FTP Atrás do Firewall</a> acima.

<blockquote>
<tt>
nat on $ext_if from $int_if -&gt; ($ext_if)<br>
rdr-anchor "tftp-proxy/*"<br>
rdr on $int_if proto udp from $int_if to port tftp -&gt; \<br>
&nbsp;&nbsp;&nbsp;&nbsp;127.0.0.1 port 6969<br>
<br>
anchor "tftp-proxy/*"
</tt>
</blockquote>

<p>
As regras acima permitem a saída de tráfego TFTP da rede interna para
servidores TFTP na rede externa.

<p>
O último passo é habilitar o tftp-proxy no
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=inetd.conf&amp;sektion=5"
>inetd.conf(5)</a>
para que ele escute na mesma porta que a regra <tt>rdr</tt> especificada
acima, nesse caso a porta 6969.

<blockquote>
<tt>
127.0.0.1:6969  dgram   udp   wait  root  /usr/libexec/tftp-proxy tftp-proxy
</tt>
</blockquote>

<p>
Diferentemente do ftp-proxy(8), o tftp-proxy(8) é chamado a partir do
inetd.


<p>
[<a href="perf.html">Anterior: Desempenho</a>]
[<a href="index.html">Conteúdo</a>]
[<a href="authpf.html">Próximo: Authpf: Shell de Usuário para Gateways
de Autenticação</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[voltar]"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: index.html,v 1.28 ]<br>
$Translation: ftp.html,v 1.10 2009/10/13 19:12:27 alan Exp $<br>
-->
$OpenBSD: ftp.html,v 1.10 2009/10/17 15:58:26 ajacoutot Exp $
</small>

</body>
</html>
